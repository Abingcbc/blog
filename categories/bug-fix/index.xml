<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Bug Fix | Abing's Blog</title><link>https://blog.abingcbc.cn/categories/bug-fix/</link><atom:link href="https://blog.abingcbc.cn/categories/bug-fix/index.xml" rel="self" type="application/rss+xml"/><description>Bug Fix</description><generator>Hugo Blox Builder (https://hugoblox.com)</generator><language>zh-cn</language><lastBuildDate>Sat, 13 Mar 2021 12:27:49 +0000</lastBuildDate><item><title>Kubernetes Ingress Nginx DNS æŠ¥é”™æ—¥å¿— Bug Fix</title><link>https://blog.abingcbc.cn/posts/ingress-nginx-bug-fix/</link><pubDate>Sat, 13 Mar 2021 12:27:49 +0000</pubDate><guid>https://blog.abingcbc.cn/posts/ingress-nginx-bug-fix/</guid><description>&lt;h2 id="é—®é¢˜" class="relative group">é—®é¢˜ &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%97%ae%e9%a2%98" aria-label="é”šç‚¹">#&lt;/a>&lt;/span>&lt;/h2>
&lt;p>ç›®å‰ï¼Œå½“æŒ‡å®šè®¿é—®é›†ç¾¤å¤–éƒ¨åœ°å€ä¸º IP æ—¶ï¼Œingress-nginx controller çš„æ—¥å¿—ä¸­å­˜åœ¨å¤§é‡çš„ DNS æŠ¥é”™çš„åƒåœ¾æ—¥å¿—ã€‚è™½ç„¶ä¸å½±å“æ­£å¸¸è¿è¡Œï¼ˆçŒœæµ‹å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½æ³¢åŠ¨ï¼Œå¯¹æ¯”è§æœ€åï¼‰ï¼Œä½†æ˜¯æŸ¥çœ‹ Nginx æ—¥å¿— debug æ—¶æ•ˆç‡ä¸¥é‡é™ä½ã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./error.png" alt="" />
&lt;/figure>
&lt;/p>
&lt;h2 id="åŸå› " class="relative group">åŸå›  &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%8e%9f%e5%9b%a0" aria-label="é”šç‚¹">#&lt;/a>&lt;/span>&lt;/h2>
&lt;p>è¯¦ç»†çš„è®¨è®ºè§ï¼š
&lt;a
href="https://github.com/coredns/coredns/issues/2324"
target="_blank" rel="noreferrer noopener"
>https://github.com/coredns/coredns/issues/2324&lt;/a>&lt;/p>
&lt;p>ç®€ç•¥æ€»ç»“ä¸‹ï¼Œå¯¼è‡´è®¿é—®å¤–éƒ¨ IPï¼ŒNginx æŠ¥ DNS è§£æé”™è¯¯çš„åŸå› åœ¨äº Kubernetes è‡ªèº«çš„bugï¼Œç¼ºå°‘äº†ä¸€ä¸ªéªŒè¯ã€‚&lt;/p>
&lt;p>å‡ºç°é—®é¢˜çš„æƒ…å†µæ˜¯é€šè¿‡ ExternalName ç±»å‹çš„ Service è®¿é—®å¤–éƒ¨æœåŠ¡çš„ã€‚å®šä¹‰çš„ yaml ç±»ä¼¼äºä¸‹é¢è¿™ç§ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">demo2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ExternalName&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">externalName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">xxx.xxx.xxx.xxx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äº Kubernetes çš„è®¾è®¡æ¥è¯´ï¼ŒExternalName å°±æ˜¯ä¸€ä¸ªåŸŸåã€‚K8s å®˜æ–¹æ˜¯è¿™æ ·ä»‹ç»çš„&lt;/p>
&lt;blockquote>
&lt;p>ExternalName: Maps the service to the contents of the externalName field (e.g. foo.bar.example.com), by returning aCNAMErecord with its value. No proxying of any kind is set up.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>Note:ExternalName accepts an IPv4 address string, but as a DNS names comprised of digits, not as an IP address. ExternalNames that resemble IPv4 addresses are not resolved by CoreDNS or ingress-nginx because ExternalName is intended to specify a canonical DNS name.&lt;/p>
&lt;/blockquote>
&lt;p>ä»å®ç°ä¸Šæ¥çœ‹ï¼ŒExternalName ç±»å‹çš„ Service å…¶å®å°±æ˜¯åœ¨ CoreDNS é‡Œçš„ä¸€æ¡ CNAME è®°å½•ã€‚ CNAME æ˜¯ä¸€æ¡åŸŸåæŒ‡å‘å¦ä¸€ä¸ªåŸŸåçš„è®°å½•ï¼Œåœ¨ K8s ä¸­ï¼Œè¿™æ¡ record è®°è½½çš„å°±æ˜¯ Service åå­—æŒ‡å‘ ExtenalName çš„ä¸€ä¸ªæ˜ å°„ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œå½“ ExternalName ç±»å‹çš„ Service ä¸­è®¾å®šçš„æ˜¯ IP æ—¶ï¼ŒK8s å¹¶æ²¡æœ‰å¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼Œä»ç„¶å…è®¸å…¶æ­£å¸¸åˆ›å»ºã€‚&lt;/p>
&lt;p>åŒæ—¶ï¼ŒNginx æœ¬èº«å­˜åœ¨ç€ä¸€ä¸ªè½®è¯¢æœºåˆ¶ï¼Œä¼šä¸æ–­çš„å‘ DNS æœåŠ¡æ‹‰å–è®°å½•è¿›è¡Œç¼“å­˜ã€‚
&lt;a
href="https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util/dns.lua"
target="_blank" rel="noreferrer noopener"
>https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util/dns.lua&lt;/a>&lt;/p>
&lt;p>åœ¨æ¯æ¬¡æ‹‰å–ç¼“å­˜æ—¶ä¼šå‘ç”Ÿä»¥ä¸‹çš„è¿‡ç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>Nginx ä» CoreDNS æ‹‰å–åˆ°äº†ä¸€ä¸ª CNAME è®°å½•ï¼Œä¾‹å¦‚ï¼šdemo2 -&amp;gt; xxx.xxx.xxx.xxx&lt;/li>
&lt;li>æ¥ç€ï¼ŒNginx å°è¯•è§£æ xxx.xxx.xxx.xxx è¿™ä¸ªåŸŸåï¼ŒCoreDNS è‡ªç„¶æ˜¯å¯¹è¿™ä¸ªé•¿æˆ IP æ ·å­çš„åŸŸåè§£æä¸å‡ºæ¥çš„ï¼Œäºæ˜¯è§£æå¤±è´¥ï¼Œå¯¼è‡´æŠ¥é”™&lt;/li>
&lt;/ol>
&lt;hr>
&lt;p>è‡³äºä¸ºä»€ä¹ˆ DNS è§£æå¤±è´¥ä¹‹åï¼ŒNginx ä»ç„¶èƒ½å¤ŸæˆåŠŸè½¬å‘è¯·æ±‚ï¼ŒåŸå› æ˜¯ ingress-nginx controller åœ¨å®ç°ä¸Šå¹¶æ²¡æœ‰å¯¹è¿™ä¸ªè¿›è¡ŒåŒºåˆ†ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œå…ˆç®€å•ä»‹ç»ä¸‹ controller çš„åŸç†ã€‚Ingress-nginx controller ä¸€ç›´ç›‘å¬ç€ k8s ç³»ç»Ÿä¸­çš„ ingress èµ„æºã€‚å½“æœ‰æ–°çš„ ingress åˆ›å»ºæ—¶ï¼Œcontroller ä¼šå¼€å§‹æ›´æ–° Nginx çš„é…ç½®æ–‡ä»¶ï¼Œå‘å…¶ä¸­æ·»åŠ è½¬å‘è§„åˆ™ï¼Œå¹¶é‡å¯ Nginxã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯ controller è§£ææŒ‡å‘ ExternalName çš„ ingressï¼Œç„¶ååˆ›å»º upstream çš„é€»è¾‘
&lt;a
href="https://github.com/kubernetes/ingress-nginx/blob/5f1a37a624ca38e8cccc87cb7a36d7dbcbe70b01/internal/ingress/controller/endpoints.go#L52"
target="_blank" rel="noreferrer noopener"
>https://github.com/kubernetes/ingress-nginx/blob/5f1a37a624ca38e8cccc87cb7a36d7dbcbe70b01/internal/ingress/controller/endpoints.go#L52&lt;/a>&lt;/p>
&lt;p>
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./nginx-code.png" alt="" />
&lt;/figure>
&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œcontroller æ˜¯æ²¡æœ‰å¼ºåˆ¶è§£æ ExternalName æˆåŸŸåçš„ï¼Œæ‰€ä»¥å†™è¿› nginx.conf çš„ upstream ä¹Ÿæ˜¯ ip å½¢å¼ï¼Œè¿™æ · nginx ä¼šè‡ªç„¶åœ°å°† ExternalName è§£ææˆ IPï¼Œä»è€Œå¯ä»¥æ­£å¸¸å·¥ä½œã€‚&lt;/p>
&lt;h2 id="è§£å†³æ–¹æ³•" class="relative group">è§£å†³æ–¹æ³• &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95" aria-label="é”šç‚¹">#&lt;/a>&lt;/span>&lt;/h2>
&lt;p>åœ¨ä¸Šé¢æåˆ°çš„ Github Issue çš„è®¨è®ºä¸­ï¼Œæœ‰å¤§ä½¬å·²ç»ç»™å‡ºäº†è§£å†³æ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡ Service without selectors çš„æ–¹å¼ã€‚
&lt;a
href="https://kubernetes.io/docs/concepts/services-networking/service/#services-without-selectors"
target="_blank" rel="noreferrer noopener"
>https://kubernetes.io/docs/concepts/services-networking/service/#services-without-selectors&lt;/a>&lt;/p>
&lt;p>å¸¸è§çš„ K8s Service éƒ½æ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼Œé€‰æ‹©ä¸€ç³»åˆ— Pod ä½œä¸ºåç«¯ï¼ŒK8s endpoint controller ä¼šè‡ªåŠ¨æ ¹æ® Service çš„å£°æ˜å»ä¸º Service çš„æ¯ä¸ªç«¯å£åˆ›å»ºä¸€ä¸ª endpointã€‚Endpoint æ˜¯ K8s ä¸­å®é™…è¿›è¡ŒæœåŠ¡è·¯ç”±çš„èµ„æºã€‚&lt;/p>
&lt;p>è€Œåˆ›å»º Service without selectorsï¼Œå°±éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»åˆ›å»ºä¸€ä¸ªä¸ Service åŒåçš„ endpointã€‚è¿™æ ·å°±ä¸éœ€è¦æŒ‡å®š Service ä¸º ExternalName çš„ç±»å‹ï¼ŒCoreDNS ä¸­å°±ä¼šå°†å…¶è§†ä½œä¸€æ¡ A è®°å½•ï¼Œè€Œä¸æ˜¯ä¸€æ¡ CNAME è®°å½•ã€‚Nginx æ‹‰å– DNS ç¼“å­˜æ—¶ä¹Ÿä¸ä¼šæŠŠ IP å½“åšåŸŸåäº†ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">demo2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">clusterIP&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">None&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">grpc&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">32443&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Endpoints&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">demo2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">subsets&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">addresses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">ip&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">xxx.xxx.xxx.xxx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">32443&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">grpc&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å¯¹æ¯”" class="relative group">å¯¹æ¯” &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%af%b9%e6%af%94" aria-label="é”šç‚¹">#&lt;/a>&lt;/span>&lt;/h2>
&lt;p>åœ¨ä¸¤ä¸ªå¯¹ç­‰çš„é›†ç¾¤å‘ç”Ÿé€šä¿¡æ—¶ï¼Œdemo1 ä¿®å¤ï¼Œdemo2ä¸ä¿®å¤ï¼Œå¯¹æ¯”ä¸¤ä¾§çš„ CPU ä½¿ç”¨æƒ…å†µ&lt;/p>
&lt;p>demo1ï¼š
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./demo1.png" alt="" />
&lt;/figure>
&lt;/p>
&lt;p>demo2ï¼š
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./demo2.png" alt="" />
&lt;/figure>
&lt;/p>
&lt;p>demo2 å¤§çº¦æ¯” demo1 æ¶ˆè€— CPU å¤š 0.020 ä¸ªæ ¸ã€‚è™½ç„¶è¿™ä¸ªæŠ¥é”™ä¼šç¨å¾®å¢åŠ ä¸€ç‚¹ CPU çš„ä½¿ç”¨é‡ï¼Œä½†å¹¶ä¸å¤šã€‚&lt;/p></description></item><item><title>Spring Cloud IPv6ç«¯å£é—®é¢˜æ’å‘</title><link>https://blog.abingcbc.cn/posts/spring-ipv6/</link><pubDate>Sun, 07 Mar 2021 23:59:22 +0000</pubDate><guid>https://blog.abingcbc.cn/posts/spring-ipv6/</guid><description>&lt;h2 id="åœºæ™¯" class="relative group">åœºæ™¯ &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%9c%ba%e6%99%af" aria-label="é”šç‚¹">#&lt;/a>&lt;/span>&lt;/h2>
&lt;p>ä½¿ç”¨ Spring Cloud Eureka æ­å»ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œä½¿ç”¨ Zuul æ­å»ºæœåŠ¡ç½‘å…³ï¼Œä¸€å¥—æ¯”è¾ƒä¼ ç»Ÿçš„å¾®æœåŠ¡æ¶æ„ã€‚
æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„åœ°å€ä¸º http://localhost:8888ï¼ŒZuul ç½‘å…³åœ°å€ä¸º http://localhost:8080ï¼Œ å¦å¤–æ­å»ºä¸€ä¸ªæœåŠ¡åä¸º metadata-service çš„æœåŠ¡ï¼Œåœ°å€ä¸º http://localhost:8088ã€‚&lt;/p>
&lt;h2 id="é—®é¢˜" class="relative group">é—®é¢˜ &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%97%ae%e9%a2%98" aria-label="é”šç‚¹">#&lt;/a>&lt;/span>&lt;/h2>
&lt;p>åœ¨ metadata-service ä¸­æä¾›ä¸€ä¸ªæµ‹è¯•çš„æ¥å£&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-Java" data-lang="Java">&lt;span class="line">&lt;span class="cl">&lt;span class="nd">@RestController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">MetadataController&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">â€‹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@GetMapping&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;/test&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">getTest&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå‘ç°ç›´æ¥è¯·æ±‚ http://localhost:8088/test å³ metadata-service çš„åœ°å€ï¼Œå¯ä»¥æ­£å¸¸å¾—åˆ°ç»“æœ&lt;/p>
&lt;p>
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./1.jpg" alt="" />
&lt;/figure>
&lt;/p>
&lt;p>è€Œé€šè¿‡ç½‘å…³ï¼Œä½¿ç”¨ Zuul é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œè°ƒç”¨æœåŠ¡ï¼Œä¼šå‡ºç° 404 çš„é”™è¯¯&lt;/p>
&lt;p>
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./2.jpg" alt="" />
&lt;/figure>
&lt;/p>
&lt;h2 id="åˆ†æ" class="relative group">åˆ†æ &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%88%86%e6%9e%90" aria-label="é”šç‚¹">#&lt;/a>&lt;/span>&lt;/h2>
&lt;p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ http://localhost:8888 æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ³¨å†Œåˆ°äº†æœåŠ¡æ³¨å†Œä¸­å¿ƒ&lt;/p>
&lt;p>
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./3.jpg" alt="" />
&lt;/figure>
&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚
é‚£ä¹ˆï¼Œæˆ‘ä»¬å†æ£€æŸ¥ç½‘å…³æœ‰æ²¡æœ‰è·å–åˆ° metadata-service çš„è·¯ç”±ã€‚å¯ä»¥é€šè¿‡ http://localhost:8080/actuator/routes æŸ¥çœ‹ï¼ˆactuatoré»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡é…ç½® management.endpoints.web.exposure.include=* å¼€å¯ï¼‰ã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./4.jpg" alt="" />
&lt;/figure>
&lt;/p>
&lt;p>åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚
é‚£ä¹ˆï¼Œå°±å¾ˆå¥‡æ€ªäº†ğŸ¤¨ï¼ŒæœåŠ¡æœ¬èº«æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œç›´æ¥è°ƒç”¨ä¹Ÿå¯ä»¥è®¿é—®ï¼Œè€Œé€šè¿‡ç½‘å…³ä¸€è½¬å‘ï¼Œä¸ºä»€ä¹ˆå°± 404 äº†å‘¢ï¼Ÿåœ¨ç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹åˆï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°æœ‰äººé‡åˆ°è¿‡ç±»ä¼¼çš„é—®é¢˜ã€‚ã€‚ã€‚ğŸ˜±
é—®é¢˜çš„å…³é”®åœ¨æˆ‘å…³é—­æœåŠ¡åå†æ¬¡è¯·æ±‚ http://localhost:8088/test æ—¶ç»ˆäºæ‰¾åˆ°äº†ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå…³é—­äº†æœåŠ¡åï¼Œåº”è¯¥æ²¡æœ‰è¿”å›çš„ responseï¼Œä½†å‘å‡ºè¯·æ±‚è¿‡åä»ç„¶æ˜¯ 404&lt;/p>
&lt;p>
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./5.jpg" alt="" />
&lt;/figure>
&lt;/p>
&lt;p>é‚£ä¹ˆï¼Œå°±å¾ˆæ˜æ˜¾äº†ï¼Œæœ‰å¦ä¸€ä¸ªè¿›ç¨‹ä¹Ÿåœ¨ç›‘å¬ 8088 ç«¯å£ ï¼ï¼ï¼
ä½†è¿˜æ˜¯å¾ˆå¥‡æ€ªï¼Œé‚£ä¸ºä»€ä¹ˆæœåŠ¡å¯åŠ¨çš„æ—¶å€™æ²¡æœ‰æŠ¥ç«¯å£è¢«å ç”¨çš„é”™è¯¯å‘¢ï¼Ÿï¼Ÿï¼Ÿ
é‡æ–°å¯åŠ¨æœåŠ¡ï¼Œä½¿ç”¨ lsof -i tcp:8088 ï¼ˆMac OSï¼‰æŸ¥çœ‹ç«¯å£å ç”¨æƒ…å†µ&lt;/p>
&lt;p>
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./6.jpg" alt="" />
&lt;/figure>
&lt;/p>
&lt;p>æœç„¶æœ‰ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶åœ¨ç›‘å¬ï¼Œè€Œä¸€ä¸ªæ˜¯ IPv4ï¼Œä¸€ä¸ªæ˜¯ IPv6çš„ã€‚
é¦–å…ˆï¼Œæ ¹æ®è¿™ç¯‡æ–‡ç«  &lt;a
href="https://blog.csdn.net/jiyiqinlovexx/article/details/50959351"
target="_blank" rel="noreferrer noopener"
>https://blog.csdn.net/jiyiqinlovexx/article/details/50959351&lt;/a> çš„è§£é‡Šï¼Œå¤šä¸ªè¿›ç¨‹æ˜¯å®Œå…¨å¯ä»¥åŒæ—¶ç›‘å¬åŒä¸€ä¸ªç«¯å£çš„ã€‚
è€Œä» Java 7 å¼€å§‹ï¼Œé»˜è®¤ä½¿ç”¨ IPv6 è€Œä¸æ˜¯ IPv4 ï¼ˆhttps://stackoverflow.com/questions/35470838/localhost-vs-127-0-0-1-in-spring-frameworkï¼‰ï¼Œæ‰€ä»¥å¯¹äº Spring çš„ localhost æ¥è¯´ï¼Œå…¶å®çœŸæ­£ä½¿ç”¨çš„ IP åœ°å€æ˜¯ ::1ï¼Œè€Œä¸æ˜¯ 127.0.0.1 ã€‚ä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥å‘ç° http://[::1]:8088/test å¾—åˆ°æ­£å¸¸ç»“æœï¼Œè€Œ http://127.0.0.1:8088/test åˆ™ä¸º 404 ã€‚è¿™å°±å®Œç¾åœ°è§£é‡Šäº†å¼€å¯æœåŠ¡ä¸åœæ­¢æœåŠ¡ï¼Œè¿”å›ç»“æœä¸åŒçš„é—®é¢˜ï¼ŒSpring æœåŠ¡æ‰€å¯¹åº”çš„æ­£æ˜¯é‚£ä¸ª IPv6 çš„è¿›ç¨‹ã€‚
é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆç½‘å…³è½¬å‘å°±åˆ°äº† IPv4 å‘¢ï¼Ÿæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æœåŠ¡æ³¨å†Œä¸­å¿ƒé‡Œçš„ä¿¡æ¯&lt;/p>
&lt;p>
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./7.jpg" alt="" />
&lt;/figure>
&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°å…¶å® Eureka ä¿å­˜çš„æ˜¯æ¯ä¸ªæœåŠ¡çš„ IP åœ°å€æ˜¯æœ¬æœºçš„ IPv4 çš„å†…ç½‘åœ°å€ï¼Œè€Œä¸æ˜¯ä¿å­˜åŸŸåï¼Œè¿™å°±æ˜¯é—®é¢˜çš„å…³é”®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Postman å‘é€è¯·æ±‚ http://localhost:8080/metadata-service/test åï¼Œä½¿ç”¨å‘½ä»¤ lsof -i tcp:8088 è¿›è¡ŒéªŒè¯ã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img class="mx-auto my-0 rounded-md" src="./8.jpg" alt="" />
&lt;/figure>
&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°çš„ç¡®æ˜¯å‘å†…ç½‘ IP åœ°å€ï¼Œè€Œä¸æ˜¯å‘ localhost è½¬å‘è¯·æ±‚ã€‚&lt;/p>
&lt;h2 id="è§£å†³æ–¹æ¡ˆ" class="relative group">è§£å†³æ–¹æ¡ˆ &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" aria-label="é”šç‚¹">#&lt;/a>&lt;/span>&lt;/h2>
&lt;p>è‡³æ­¤ï¼Œé—®é¢˜çš„åŸå› å·²ç»å®Œå…¨æ¸…æ¥šäº†ï¼Œæœç„¶ç¨‹åºéƒ½æ˜¯ debug de å‡ºæ¥çš„ã€‚
æœ€ç®€å•çš„æ–¹æ³•ä¹Ÿå¾ˆæ¸…æ¥šäº†ï¼Œæ¢ä¸ªç«¯å£å·å°± OK äº†ã€‚&lt;/p>
&lt;p>å¦‚æœæœ¬æ–‡æœ‰é”™è¯¯æˆ–è€…ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ï¼ï¼ï¼ğŸ˜†&lt;/p>
&lt;p>é‚£ä¹ˆï¼Œå äº† 8088 ç«¯å£çš„ IPv4 è¿›ç¨‹æ˜¯å“ªä¸ªç¨‹åºå‘¢ï¼ŸğŸ¤¨&lt;/p>
&lt;p>ã€‚ã€‚ã€‚ã€‚Hadoop å‡ºæ¥æŒ¨æ‰“ï¼ï¼ï¼ğŸ˜­ğŸ˜­ğŸ˜­&lt;/p></description></item></channel></rss>