{"meta":{"version":1,"warehouse":"4.0.1"},"models":{"Asset":[{"_id":"themes/one-paper/source/css/a11y-dark.min.css","path":"css/a11y-dark.min.css","modified":1,"renderable":1},{"_id":"themes/one-paper/source/css/fonts.css","path":"css/fonts.css","modified":1,"renderable":1},{"_id":"themes/one-paper/source/css/markdown.css","path":"css/markdown.css","modified":1,"renderable":1},{"_id":"themes/one-paper/source/css/reset.css","path":"css/reset.css","modified":1,"renderable":1},{"_id":"themes/one-paper/source/css/style.css","path":"css/style.css","modified":1,"renderable":1},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-600.woff","path":"fonts/montserrat-v23-latin-600.woff","modified":1,"renderable":1},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-600.woff2","path":"fonts/montserrat-v23-latin-600.woff2","modified":1,"renderable":1},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-600italic.woff","path":"fonts/montserrat-v23-latin-600italic.woff","modified":1,"renderable":1},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-600italic.woff2","path":"fonts/montserrat-v23-latin-600italic.woff2","modified":1,"renderable":1},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-italic.woff","path":"fonts/montserrat-v23-latin-italic.woff","modified":1,"renderable":1},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-italic.woff2","path":"fonts/montserrat-v23-latin-italic.woff2","modified":1,"renderable":1},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-regular.woff","path":"fonts/montserrat-v23-latin-regular.woff","modified":1,"renderable":1},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-regular.woff2","path":"fonts/montserrat-v23-latin-regular.woff2","modified":1,"renderable":1},{"_id":"themes/one-paper/source/img/favicon.png","path":"img/favicon.png","modified":1,"renderable":1},{"_id":"themes/one-paper/source/img/one-paper.png","path":"img/one-paper.png","modified":1,"renderable":1},{"_id":"themes/one-paper/source/js/highlight.min.js","path":"js/highlight.min.js","modified":1,"renderable":1},{"_id":"themes/one-paper/source/js/highlightjs-line-numbers.js","path":"js/highlightjs-line-numbers.js","modified":1,"renderable":1},{"_id":"source/asset/gzh.jpeg","path":"asset/gzh.jpeg","modified":1,"renderable":0},{"_id":"source/asset/wechat.jpg","path":"asset/wechat.jpg","modified":1,"renderable":0},{"_id":"source/images/favicon.png","path":"images/favicon.png","modified":1,"renderable":0},{"_id":"source/images/logo.png","path":"images/logo.png","modified":1,"renderable":0},{"_id":"source/asset/casbin-ramp-up/2022-06-23-17-50-00-image.png","path":"asset/casbin-ramp-up/2022-06-23-17-50-00-image.png","modified":1,"renderable":0},{"_id":"source/asset/casbin-ramp-up/detail.png","path":"asset/casbin-ramp-up/detail.png","modified":1,"renderable":0},{"_id":"source/asset/casbin-ramp-up/overview.png","path":"asset/casbin-ramp-up/overview.png","modified":1,"renderable":0},{"_id":"source/asset/casbin-ramp-up/pml.png","path":"asset/casbin-ramp-up/pml.png","modified":1,"renderable":0},{"_id":"source/asset/ingress-nginx-bug-fix/demo1.png","path":"asset/ingress-nginx-bug-fix/demo1.png","modified":1,"renderable":0},{"_id":"source/asset/ingress-nginx-bug-fix/demo2.png","path":"asset/ingress-nginx-bug-fix/demo2.png","modified":1,"renderable":0},{"_id":"source/asset/ingress-nginx-bug-fix/error.png","path":"asset/ingress-nginx-bug-fix/error.png","modified":1,"renderable":0},{"_id":"source/asset/ingress-nginx-bug-fix/nginx-code.png","path":"asset/ingress-nginx-bug-fix/nginx-code.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/1.png","path":"asset/k8s-ramp-up/1.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/10.png","path":"asset/k8s-ramp-up/10.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/11.png","path":"asset/k8s-ramp-up/11.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/12.png","path":"asset/k8s-ramp-up/12.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/13.png","path":"asset/k8s-ramp-up/13.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/14.png","path":"asset/k8s-ramp-up/14.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/15.png","path":"asset/k8s-ramp-up/15.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/16.png","path":"asset/k8s-ramp-up/16.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/17.png","path":"asset/k8s-ramp-up/17.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/18.png","path":"asset/k8s-ramp-up/18.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/19.png","path":"asset/k8s-ramp-up/19.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/2.png","path":"asset/k8s-ramp-up/2.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/20.png","path":"asset/k8s-ramp-up/20.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/3.png","path":"asset/k8s-ramp-up/3.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/4.png","path":"asset/k8s-ramp-up/4.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/5.png","path":"asset/k8s-ramp-up/5.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/6.png","path":"asset/k8s-ramp-up/6.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/7.png","path":"asset/k8s-ramp-up/7.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/8.png","path":"asset/k8s-ramp-up/8.png","modified":1,"renderable":0},{"_id":"source/asset/k8s-ramp-up/9.png","path":"asset/k8s-ramp-up/9.png","modified":1,"renderable":0},{"_id":"source/asset/spring_ipv6/1.jpg","path":"asset/spring_ipv6/1.jpg","modified":1,"renderable":0},{"_id":"source/asset/spring_ipv6/2.jpg","path":"asset/spring_ipv6/2.jpg","modified":1,"renderable":0},{"_id":"source/asset/spring_ipv6/3.jpg","path":"asset/spring_ipv6/3.jpg","modified":1,"renderable":0},{"_id":"source/asset/spring_ipv6/4.jpg","path":"asset/spring_ipv6/4.jpg","modified":1,"renderable":0},{"_id":"source/asset/spring_ipv6/5.jpg","path":"asset/spring_ipv6/5.jpg","modified":1,"renderable":0},{"_id":"source/asset/spring_ipv6/6.jpg","path":"asset/spring_ipv6/6.jpg","modified":1,"renderable":0},{"_id":"source/asset/spring_ipv6/7.jpg","path":"asset/spring_ipv6/7.jpg","modified":1,"renderable":0},{"_id":"source/asset/spring_ipv6/8.jpg","path":"asset/spring_ipv6/8.jpg","modified":1,"renderable":0},{"_id":"source/asset/tidb-lightning/1.png","path":"asset/tidb-lightning/1.png","modified":1,"renderable":0},{"_id":"source/asset/time2graph/dist_seg.png","path":"asset/time2graph/dist_seg.png","modified":1,"renderable":0},{"_id":"source/asset/time2graph/dist_series.png","path":"asset/time2graph/dist_series.png","modified":1,"renderable":0},{"_id":"source/asset/time2graph/dtw.png","path":"asset/time2graph/dtw.png","modified":1,"renderable":0},{"_id":"source/asset/time2graph/edge_weight.png","path":"asset/time2graph/edge_weight.png","modified":1,"renderable":0},{"_id":"source/asset/time2graph/graph.png","path":"asset/time2graph/graph.png","modified":1,"renderable":0},{"_id":"source/asset/time2graph/graph_algo.png","path":"asset/time2graph/graph_algo.png","modified":1,"renderable":0},{"_id":"source/asset/time2graph/loss_function.png","path":"asset/time2graph/loss_function.png","modified":1,"renderable":0},{"_id":"source/asset/time2graph/representation.png","path":"asset/time2graph/representation.png","modified":1,"renderable":0},{"_id":"source/asset/time2graph/segment.png","path":"asset/time2graph/segment.png","modified":1,"renderable":0},{"_id":"source/asset/time2graph/transition.png","path":"asset/time2graph/transition.png","modified":1,"renderable":0}],"Cache":[{"_id":"source/_posts/2021.md","hash":"0545709a27a989548b57de1fa6d25c9943289cf6","modified":1657634099033},{"_id":"source/_posts/Spring IPv6.md","hash":"b4adb3b6cbd5cc1c495a0989dab33cd62be7f3f7","modified":1657634099033},{"_id":"source/_posts/casbin-ramp-up.md","hash":"b12b4941756519fe6fe46c046cc8a8c72a15fee3","modified":1657634099033},{"_id":"source/_posts/ingress-nginx-bug-fix.md","hash":"1950e0dfb7868fd1f37ed7bd6f2e9cc858c690f9","modified":1657634099033},{"_id":"source/_posts/k8s-cronjob.md","hash":"dd7c5483287ea4507364f6a12456fea261e2ff74","modified":1657634099033},{"_id":"source/_posts/k8s-ramp-up.md","hash":"6bec53ebfdf62ad12bc6f14d9ab1e818603c49ca","modified":1657634099037},{"_id":"source/_posts/tidb-lightning.md","hash":"e7489c069ae87d361fabae3db5d3fc551dd5b742","modified":1657634099037},{"_id":"source/_posts/time2graph.md","hash":"b43727631ac7f026ffec630b32a296a7f83b19ff","modified":1657634099037},{"_id":"source/about/index.md","hash":"6e9df2520bea6f7be80a8346baae33e38508f1e8","modified":1657634099037},{"_id":"source/asset/gzh.jpeg","hash":"f4b4ef81c04cbb3db2b6c3cb98aa5b27bf7a51c8","modified":1657634099041},{"_id":"source/images/favicon.png","hash":"560e57ba077640c78fd41236652e7534816ec009","modified":1657634099065},{"_id":"source/links/index.md","hash":"0979ebfaa38310bc48f38a264a97eb80c2db38ac","modified":1657634099065},{"_id":"source/asset/casbin-ramp-up/2022-06-23-17-50-00-image.png","hash":"85dbee6e8a4e8a580796afdaca0d519c4b81b982","modified":1657634099037},{"_id":"source/asset/ingress-nginx-bug-fix/demo1.png","hash":"d1c15eebd8aa34dedff6d51450cc5a64d4279816","modified":1657634099041},{"_id":"source/asset/ingress-nginx-bug-fix/demo2.png","hash":"07e0faffc6e009107087727cd35b12c85b5881af","modified":1657634099041},{"_id":"source/asset/k8s-ramp-up/1.png","hash":"1145d712a9399a51a454f775f974e5862b44f98c","modified":1657634099045},{"_id":"source/asset/k8s-ramp-up/10.png","hash":"d3921df8340cdf5c5d9de6753980ed05dc4ecd06","modified":1657634099045},{"_id":"source/asset/k8s-ramp-up/11.png","hash":"49505e81f7ed4f201325cdca173f92402e1d694e","modified":1657634099045},{"_id":"source/asset/k8s-ramp-up/13.png","hash":"0e547f7ed382f42d554e2ddc2f56b1b55a35121a","modified":1657634099049},{"_id":"source/asset/k8s-ramp-up/14.png","hash":"236020ab61732ffb54c7f73d108627cab79e3780","modified":1657634099049},{"_id":"source/asset/k8s-ramp-up/15.png","hash":"13dfe7c37ce4ae14152f31b65cd78b98258417c8","modified":1657634099049},{"_id":"source/asset/k8s-ramp-up/16.png","hash":"bfc1602be4127162d5a27c53abcbe08565ed38a0","modified":1657634099049},{"_id":"source/asset/k8s-ramp-up/17.png","hash":"7fdada3095564db64c1a5766ebe60400040185e1","modified":1657634099053},{"_id":"source/asset/k8s-ramp-up/18.png","hash":"7097617a943f79f44293b875bd380d0343f7a1ed","modified":1657634099053},{"_id":"source/asset/k8s-ramp-up/19.png","hash":"f190e9ea5ce21409f6aa6acf21698cedf1296f16","modified":1657634099053},{"_id":"source/asset/k8s-ramp-up/2.png","hash":"67564259b9f4cc49111db67cf344e3c315220d04","modified":1657634099053},{"_id":"source/asset/k8s-ramp-up/20.png","hash":"2b79e55f2b4022ab98679f6cc9ce315cc93c82d4","modified":1657634099053},{"_id":"source/asset/k8s-ramp-up/3.png","hash":"9b61eafd03c74e9f1581294ae784e3b388a43060","modified":1657634099053},{"_id":"source/asset/k8s-ramp-up/7.png","hash":"3039d3abcb057f70af3f0544990973af1d32028b","modified":1657634099057},{"_id":"source/asset/k8s-ramp-up/8.png","hash":"fbd07cba2115dc1eec09d47d8206212f71c5739c","modified":1657634099057},{"_id":"source/asset/k8s-ramp-up/9.png","hash":"f2a631454ba533aace37b5434455bc67e3245010","modified":1657634099057},{"_id":"source/asset/spring_ipv6/1.jpg","hash":"906e5182a059d051b7ffab73fcfe166b28b31dbe","modified":1657634099057},{"_id":"source/asset/spring_ipv6/2.jpg","hash":"c18e62cbf298d52caa5b0d4faf4d9a692ed6da35","modified":1657634099057},{"_id":"source/asset/spring_ipv6/3.jpg","hash":"bbbcd41f80a39c98639a646aade9d0bda86eda8b","modified":1657634099057},{"_id":"source/asset/spring_ipv6/4.jpg","hash":"352ccca707eeb3283ca4ac10d527957e7857abae","modified":1657634099057},{"_id":"source/asset/spring_ipv6/5.jpg","hash":"ef9044806637a7c8859d68c3a6278759d80d1fac","modified":1657634099057},{"_id":"source/asset/tidb-lightning/1.png","hash":"a9ea9c9a6539847d38a68e77d82c6ce1f3fec0d4","modified":1657634099061},{"_id":"source/asset/time2graph/dist_seg.png","hash":"f193d5d4793b8661a110a33741cf6d5e378011a3","modified":1657634099061},{"_id":"source/asset/time2graph/dist_series.png","hash":"0e899b88e99c163dd7ea2f0a649e0aaee56c99eb","modified":1657634099061},{"_id":"source/asset/time2graph/edge_weight.png","hash":"f513a48ad11a011510687d036da37b4501f7074e","modified":1657634099061},{"_id":"source/asset/time2graph/loss_function.png","hash":"f193d5d4793b8661a110a33741cf6d5e378011a3","modified":1657634099061},{"_id":"source/asset/time2graph/segment.png","hash":"320e2b64f2caa5168692778a6b87c72eb12d8964","modified":1657634099061},{"_id":"themes/one-paper/LICENSE","hash":"aad1dcb7deccd18a89508fa2ad78101dafa10cc9","modified":1657634099081},{"_id":"themes/one-paper/README.md","hash":"39b4a0d2b37a27f5d247339b8e851ed4d89e0851","modified":1657634099081},{"_id":"themes/one-paper/_config.yml","hash":"23d1ee5eb17a24f1da14b0da3b5bec73e0c6011c","modified":1657634099081},{"_id":"themes/one-paper/layout/index.ejs","hash":"2efe70d35a8be1e8431fd70942fd9c6908b0f1b8","modified":1657634099081},{"_id":"themes/one-paper/layout/index1.ejs","hash":"c9f87f50f9e97761aa2334fe47e427b97d811836","modified":1657634099081},{"_id":"themes/one-paper/layout/layout.ejs","hash":"68d1bb31fccbe9810b9c8a6cd54b53938e0318a2","modified":1657634099081},{"_id":"themes/one-paper/layout/post.ejs","hash":"8fc34f7d71eac6690e4e2b99088c7b1760f6d250","modified":1657634099081},{"_id":"themes/one-paper/layout/_partial/footer.ejs","hash":"87498f5131b82e48e48a7ed05e35490c6cdd30c1","modified":1657634099081},{"_id":"themes/one-paper/layout/_partial/head.ejs","hash":"9a5bf16974fd66f6d790662858f9d7c936bb7e0c","modified":1657634099081},{"_id":"themes/one-paper/layout/_partial/header.ejs","hash":"2b54259f35942eeb1b99482c2a4517152fc87f0c","modified":1657634099081},{"_id":"themes/one-paper/layout/_partial/paginator.ejs","hash":"980bf0a0be798c19df4b0827aa4b90b35c872425","modified":1657634099081},{"_id":"themes/one-paper/layout/_partial/post-header.ejs","hash":"f6fa471122459b25a9948405d72cb5f197d2fc25","modified":1657634099081},{"_id":"themes/one-paper/source/css/a11y-dark.min.css","hash":"e0a3294faa7dfa1eae300caea5a01f438b643b93","modified":1657634099081},{"_id":"themes/one-paper/source/css/fonts.css","hash":"bd6171c8de8d9f4efafca3802c4d20099d7fca1c","modified":1657634099081},{"_id":"themes/one-paper/source/css/markdown.css","hash":"8116b5049847ca524b99e10a501b945dcff0f29d","modified":1657634099081},{"_id":"themes/one-paper/source/css/reset.css","hash":"f6184d3f74dc704f077ca4e0b91003652a9db978","modified":1657634099081},{"_id":"themes/one-paper/source/css/style.css","hash":"1fc1cf8671c8f2a50aea2e168a712401d02b4902","modified":1657634099081},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-600.woff","hash":"925d9f095488dc77dd84e8414422f0113f4628a9","modified":1657634099081},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-600.woff2","hash":"2fe30978041c41a2994ac0fd491e83d32a3203b7","modified":1657634099081},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-600italic.woff","hash":"c0e80c18fac1cd10469c4f922ad92e81fc8b3b94","modified":1657634099081},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-600italic.woff2","hash":"1f24e9edcccd42d4694a4020d6a8f9b9cb28f471","modified":1657634099081},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-italic.woff","hash":"fca5ee87a17c57eb53265da1c2c75db7305ad69c","modified":1657634099081},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-regular.woff","hash":"285adda1da1fc15583ad53160d66032aeccb45ea","modified":1657634099081},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-regular.woff2","hash":"f7eefafb7bfdc6b5572714fa267268b845a67cf4","modified":1657634099081},{"_id":"themes/one-paper/source/img/favicon.png","hash":"0845678601e8b144ae45c448a25650f4d3d2182d","modified":1657634099081},{"_id":"themes/one-paper/source/js/highlightjs-line-numbers.js","hash":"690e96133591495fa847d828573bd0576b2d168a","modified":1657634099085},{"_id":"source/images/logo.png","hash":"e592e037815d3557acb05c4d64156dcf2d100b11","modified":1657634099065},{"_id":"themes/one-paper/source/fonts/montserrat-v23-latin-italic.woff2","hash":"ce1eae3f714702a82c1e9c05b5ba302a9e91ac20","modified":1657634099081},{"_id":"source/asset/casbin-ramp-up/pml.png","hash":"67b4266d1be6921cb896a25476ad95706dbf180b","modified":1657634099041},{"_id":"source/asset/spring_ipv6/8.jpg","hash":"071e4d22f20b22683d78ca8b328484e239f791c2","modified":1657634099057},{"_id":"source/asset/time2graph/dtw.png","hash":"8a4ae6f36b3c32b2093159e15484b87e9a3f3897","modified":1657634099061},{"_id":"source/asset/time2graph/graph_algo.png","hash":"59b2cb4afea4e79669eb16389f89ec5d82a775c9","modified":1657634099061},{"_id":"source/asset/time2graph/representation.png","hash":"cc40893416b246fb57a65fe6a338aa310f05df73","modified":1657634099061},{"_id":"source/asset/time2graph/transition.png","hash":"d942684dfc94087b7131fa3ccefffce571fcec62","modified":1657634099061},{"_id":"source/asset/spring_ipv6/7.jpg","hash":"3d111ed99d1fa8bbcb514391c34543693b023d56","modified":1657634099057},{"_id":"source/asset/spring_ipv6/6.jpg","hash":"b8aafcca7247b087cdc9e0882c698738f95c21eb","modified":1657634099057},{"_id":"themes/one-paper/source/js/highlight.min.js","hash":"d264ad16bdf39cfec2b06c20223b87fcb37ad27b","modified":1657634099085},{"_id":"source/asset/wechat.jpg","hash":"6bc1d7fab98a60524d136f1387805d233fc2ad53","modified":1657634099065},{"_id":"source/asset/k8s-ramp-up/4.png","hash":"c9a7ff67e06993bc632029af641f27bfe8409796","modified":1657634099053},{"_id":"source/asset/casbin-ramp-up/overview.png","hash":"3f0f7dc338aa80ffed952127f7bb876db21f63a7","modified":1657634099037},{"_id":"source/asset/time2graph/graph.png","hash":"f82e9eef1608afb0116be9358690665a1cd32fef","modified":1657634099061},{"_id":"source/asset/k8s-ramp-up/6.png","hash":"3718c5ba7b63809eccfb9c92ffd3063b8fbd0309","modified":1657634099057},{"_id":"source/asset/ingress-nginx-bug-fix/error.png","hash":"5816144a23ecd7690a25adc2492973eb920ed1e9","modified":1657634099041},{"_id":"source/asset/ingress-nginx-bug-fix/nginx-code.png","hash":"67bdbe585956405d3780bad1b08e686b824c5321","modified":1657634099045},{"_id":"source/asset/k8s-ramp-up/5.png","hash":"5187e67252cf14c89b7397833ad2618c6b89421b","modified":1657634099057},{"_id":"source/asset/casbin-ramp-up/detail.png","hash":"d6348e860505ce70f269432e2ca8a03079453069","modified":1657634099037},{"_id":"themes/one-paper/source/img/one-paper.png","hash":"eadd349e5316a154099cb06e41abe5a105940e37","modified":1657634099085},{"_id":"source/asset/k8s-ramp-up/12.png","hash":"c873022232968a954dfd899a7d717c155615c71e","modified":1657634099049},{"_id":"public/sitemap.xml","hash":"42e02ee7b35886c682565985e145140bbd9acb1a","modified":1657634128266},{"_id":"public/sitemap.txt","hash":"61d2a584483586104521a70fc758bbe2dee3bbe0","modified":1657634128266},{"_id":"public/submit_urls.txt","hash":"0a891234cb522430e53e31c5cb3c87589a373920","modified":1657634128266},{"_id":"public/about/index.html","hash":"0a42a1d92e6f48f4e70d5235f8363db96148b3b3","modified":1657634128266},{"_id":"public/links/index.html","hash":"e123646e5a883754a1aa4d0e70ad3bb8783deb18","modified":1657634128266},{"_id":"public/2022/06/01/2021/index.html","hash":"f6375f7eda3c3ccabe25017ee5d7ddccc13686a8","modified":1657634128266},{"_id":"public/2021/09/06/time2graph/index.html","hash":"b2a20ce5da53275967e686e3c0c8692925193b4b","modified":1657634128266},{"_id":"public/2021/03/19/tidb-lightning/index.html","hash":"a58613f31cf98980238f1273fa57269a1054615a","modified":1657634128266},{"_id":"public/2021/03/13/ingress-nginx-bug-fix/index.html","hash":"5a08a77543c06dd9a082fac771a457fb6f4b6a42","modified":1657634128266},{"_id":"public/2021/03/08/k8s-cronjob/index.html","hash":"0a5bbe895b4e6d05cc8f44c1dee8355519f5dd3a","modified":1657634128266},{"_id":"public/2021/03/07/Spring IPv6/index.html","hash":"b8a87adca1ee272ee46086ac75dd1efab567eb1c","modified":1657634128266},{"_id":"public/archives/index.html","hash":"08dac2e83470b74b6a913d2c456279b7e3ce54e6","modified":1657634128266},{"_id":"public/archives/2021/index.html","hash":"4741ca2aaf64a9dcf663b0e62409e005aef65a7e","modified":1657634128266},{"_id":"public/archives/2021/03/index.html","hash":"9b73b4905f18cbb5d960377d7908458c790b720e","modified":1657634128266},{"_id":"public/archives/2021/09/index.html","hash":"9ba9fd2d7ed69ca18082309fdd58545f9e8e8585","modified":1657634128266},{"_id":"public/archives/2022/index.html","hash":"4edaeb2013a3745fd27107d67e7da0d0abcb429e","modified":1657634128266},{"_id":"public/archives/2022/06/index.html","hash":"4edaeb2013a3745fd27107d67e7da0d0abcb429e","modified":1657634128266},{"_id":"public/index.html","hash":"08dac2e83470b74b6a913d2c456279b7e3ce54e6","modified":1657634128266},{"_id":"public/2022/06/22/casbin-ramp-up/index.html","hash":"cc95bd596a5556dbd13059af9e5ad20b52a19fb6","modified":1657634128266},{"_id":"public/2021/03/15/k8s-ramp-up/index.html","hash":"49d78013a73fe18d187564e5d0db43a2b6c885e4","modified":1657634128266},{"_id":"public/fonts/montserrat-v23-latin-600.woff","hash":"925d9f095488dc77dd84e8414422f0113f4628a9","modified":1657634128266},{"_id":"public/fonts/montserrat-v23-latin-600.woff2","hash":"2fe30978041c41a2994ac0fd491e83d32a3203b7","modified":1657634128266},{"_id":"public/fonts/montserrat-v23-latin-600italic.woff","hash":"c0e80c18fac1cd10469c4f922ad92e81fc8b3b94","modified":1657634128266},{"_id":"public/fonts/montserrat-v23-latin-600italic.woff2","hash":"1f24e9edcccd42d4694a4020d6a8f9b9cb28f471","modified":1657634128266},{"_id":"public/fonts/montserrat-v23-latin-italic.woff","hash":"fca5ee87a17c57eb53265da1c2c75db7305ad69c","modified":1657634128266},{"_id":"public/fonts/montserrat-v23-latin-italic.woff2","hash":"ce1eae3f714702a82c1e9c05b5ba302a9e91ac20","modified":1657634128266},{"_id":"public/fonts/montserrat-v23-latin-regular.woff","hash":"285adda1da1fc15583ad53160d66032aeccb45ea","modified":1657634128266},{"_id":"public/fonts/montserrat-v23-latin-regular.woff2","hash":"f7eefafb7bfdc6b5572714fa267268b845a67cf4","modified":1657634128266},{"_id":"public/img/favicon.png","hash":"0845678601e8b144ae45c448a25650f4d3d2182d","modified":1657634128266},{"_id":"public/asset/gzh.jpeg","hash":"f4b4ef81c04cbb3db2b6c3cb98aa5b27bf7a51c8","modified":1657634128266},{"_id":"public/images/favicon.png","hash":"560e57ba077640c78fd41236652e7534816ec009","modified":1657634128266},{"_id":"public/asset/casbin-ramp-up/2022-06-23-17-50-00-image.png","hash":"85dbee6e8a4e8a580796afdaca0d519c4b81b982","modified":1657634128266},{"_id":"public/asset/ingress-nginx-bug-fix/demo1.png","hash":"d1c15eebd8aa34dedff6d51450cc5a64d4279816","modified":1657634128266},{"_id":"public/asset/ingress-nginx-bug-fix/demo2.png","hash":"07e0faffc6e009107087727cd35b12c85b5881af","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/1.png","hash":"1145d712a9399a51a454f775f974e5862b44f98c","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/10.png","hash":"d3921df8340cdf5c5d9de6753980ed05dc4ecd06","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/11.png","hash":"49505e81f7ed4f201325cdca173f92402e1d694e","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/13.png","hash":"0e547f7ed382f42d554e2ddc2f56b1b55a35121a","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/14.png","hash":"236020ab61732ffb54c7f73d108627cab79e3780","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/16.png","hash":"bfc1602be4127162d5a27c53abcbe08565ed38a0","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/17.png","hash":"7fdada3095564db64c1a5766ebe60400040185e1","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/18.png","hash":"7097617a943f79f44293b875bd380d0343f7a1ed","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/19.png","hash":"f190e9ea5ce21409f6aa6acf21698cedf1296f16","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/2.png","hash":"67564259b9f4cc49111db67cf344e3c315220d04","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/15.png","hash":"13dfe7c37ce4ae14152f31b65cd78b98258417c8","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/7.png","hash":"3039d3abcb057f70af3f0544990973af1d32028b","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/8.png","hash":"fbd07cba2115dc1eec09d47d8206212f71c5739c","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/9.png","hash":"f2a631454ba533aace37b5434455bc67e3245010","modified":1657634128266},{"_id":"public/asset/spring_ipv6/1.jpg","hash":"906e5182a059d051b7ffab73fcfe166b28b31dbe","modified":1657634128266},{"_id":"public/asset/spring_ipv6/2.jpg","hash":"c18e62cbf298d52caa5b0d4faf4d9a692ed6da35","modified":1657634128266},{"_id":"public/asset/spring_ipv6/3.jpg","hash":"bbbcd41f80a39c98639a646aade9d0bda86eda8b","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/3.png","hash":"9b61eafd03c74e9f1581294ae784e3b388a43060","modified":1657634128266},{"_id":"public/asset/spring_ipv6/4.jpg","hash":"352ccca707eeb3283ca4ac10d527957e7857abae","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/20.png","hash":"2b79e55f2b4022ab98679f6cc9ce315cc93c82d4","modified":1657634128266},{"_id":"public/asset/spring_ipv6/5.jpg","hash":"ef9044806637a7c8859d68c3a6278759d80d1fac","modified":1657634128266},{"_id":"public/asset/spring_ipv6/6.jpg","hash":"b8aafcca7247b087cdc9e0882c698738f95c21eb","modified":1657634128266},{"_id":"public/asset/spring_ipv6/7.jpg","hash":"3d111ed99d1fa8bbcb514391c34543693b023d56","modified":1657634128266},{"_id":"public/asset/spring_ipv6/8.jpg","hash":"071e4d22f20b22683d78ca8b328484e239f791c2","modified":1657634128266},{"_id":"public/asset/tidb-lightning/1.png","hash":"a9ea9c9a6539847d38a68e77d82c6ce1f3fec0d4","modified":1657634128266},{"_id":"public/asset/time2graph/dist_seg.png","hash":"f193d5d4793b8661a110a33741cf6d5e378011a3","modified":1657634128266},{"_id":"public/asset/time2graph/dist_series.png","hash":"0e899b88e99c163dd7ea2f0a649e0aaee56c99eb","modified":1657634128266},{"_id":"public/asset/time2graph/edge_weight.png","hash":"f513a48ad11a011510687d036da37b4501f7074e","modified":1657634128266},{"_id":"public/asset/time2graph/loss_function.png","hash":"f193d5d4793b8661a110a33741cf6d5e378011a3","modified":1657634128266},{"_id":"public/asset/time2graph/segment.png","hash":"320e2b64f2caa5168692778a6b87c72eb12d8964","modified":1657634128266},{"_id":"public/images/logo.png","hash":"e592e037815d3557acb05c4d64156dcf2d100b11","modified":1657634128266},{"_id":"public/asset/casbin-ramp-up/pml.png","hash":"67b4266d1be6921cb896a25476ad95706dbf180b","modified":1657634128266},{"_id":"public/asset/time2graph/dtw.png","hash":"8a4ae6f36b3c32b2093159e15484b87e9a3f3897","modified":1657634128266},{"_id":"public/asset/time2graph/graph_algo.png","hash":"59b2cb4afea4e79669eb16389f89ec5d82a775c9","modified":1657634128266},{"_id":"public/asset/time2graph/representation.png","hash":"cc40893416b246fb57a65fe6a338aa310f05df73","modified":1657634128266},{"_id":"public/asset/time2graph/transition.png","hash":"d942684dfc94087b7131fa3ccefffce571fcec62","modified":1657634128266},{"_id":"public/css/a11y-dark.min.css","hash":"e0a3294faa7dfa1eae300caea5a01f438b643b93","modified":1657634128266},{"_id":"public/css/fonts.css","hash":"bd6171c8de8d9f4efafca3802c4d20099d7fca1c","modified":1657634128266},{"_id":"public/css/markdown.css","hash":"8116b5049847ca524b99e10a501b945dcff0f29d","modified":1657634128266},{"_id":"public/css/reset.css","hash":"f6184d3f74dc704f077ca4e0b91003652a9db978","modified":1657634128266},{"_id":"public/css/style.css","hash":"1fc1cf8671c8f2a50aea2e168a712401d02b4902","modified":1657634128266},{"_id":"public/js/highlightjs-line-numbers.js","hash":"690e96133591495fa847d828573bd0576b2d168a","modified":1657634128266},{"_id":"public/js/highlight.min.js","hash":"d264ad16bdf39cfec2b06c20223b87fcb37ad27b","modified":1657634128266},{"_id":"public/asset/wechat.jpg","hash":"6bc1d7fab98a60524d136f1387805d233fc2ad53","modified":1657634128266},{"_id":"public/asset/casbin-ramp-up/overview.png","hash":"3f0f7dc338aa80ffed952127f7bb876db21f63a7","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/4.png","hash":"c9a7ff67e06993bc632029af641f27bfe8409796","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/6.png","hash":"3718c5ba7b63809eccfb9c92ffd3063b8fbd0309","modified":1657634128266},{"_id":"public/asset/time2graph/graph.png","hash":"f82e9eef1608afb0116be9358690665a1cd32fef","modified":1657634128266},{"_id":"public/asset/ingress-nginx-bug-fix/error.png","hash":"5816144a23ecd7690a25adc2492973eb920ed1e9","modified":1657634128266},{"_id":"public/asset/ingress-nginx-bug-fix/nginx-code.png","hash":"67bdbe585956405d3780bad1b08e686b824c5321","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/5.png","hash":"5187e67252cf14c89b7397833ad2618c6b89421b","modified":1657634128266},{"_id":"public/img/one-paper.png","hash":"eadd349e5316a154099cb06e41abe5a105940e37","modified":1657634128266},{"_id":"public/asset/casbin-ramp-up/detail.png","hash":"d6348e860505ce70f269432e2ca8a03079453069","modified":1657634128266},{"_id":"public/asset/k8s-ramp-up/12.png","hash":"c873022232968a954dfd899a7d717c155615c71e","modified":1657634128266}],"Category":[],"Data":[],"Page":[{"title":"ABOUT","_content":"[<img src=\"https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&amp;logo=github&amp;logoColor=white\" alt=\"https://github.com/Abingcbc\" style=\"display:inline\">](https://github.com/Abingcbc) [<img src=\"https://img.shields.io/badge/Gmail-D14836?style=for-the-badge&amp;logo=gmail&amp;logoColor=white\" alt=\"mailto:abingcbc626@gmail.com\" style=\"display:inline\">](mailto:abingcbc626@gmail.com) [<img src=\"https://img.shields.io/badge/linkedin-%230077B5.svg?style=for-the-badge&amp;logo=linkedin&amp;logoColor=white\" alt=\"https://www.linkedin.com/in/bingchang-chen-8b3812183/\" style=\"display:inline\">](https://www.linkedin.com/in/bingchang-chen-8b3812183/) [<img src=\"https://img.shields.io/badge/zhihu-0078D4.svg?&style=for-the-badge\" alt=\"https://img.shields.io/badge/zhihu-0078D4.svg?&style=for-the-badge\" style=\"display:inline\">](https://www.zhihu.com/people/llll-48-29)\n<hr>\n\n### æ­£åœ¨å¯»æ‰¾2023å¹´æš‘æœŸå®ä¹  â¤ï¸\n### Open for 2023 Summer Internship â¤ï¸\n\n<hr>\n\næœ¬ç§‘å°±è¯»äºåŒæµå¤§å­¦è½¯ä»¶å­¦é™¢ï¼Œç›®å‰ç¡•å£«å°±è¯»äºåŒæµå¤§å­¦è®¾è®¡ä¸åˆ›æ„å­¦é™¢äººå·¥æ™ºèƒ½ä¸æ•°æ®è®¾è®¡ä¸“ä¸š IDvX å®éªŒå®¤ https://idvxlab.com/ã€‚\n\n#### å…¬ä¼—å·\n\n<img src=\"https://blog.abingcbc.cn/asset/gzh.jpeg\" alt=\"https://blog.abingcbc.cn/asset/gzh.jpeg\" style=\"width:300px;margin:0 auto\">\n\n#### Misc\n\n- ISFP æ‡’ç‹—\n- å°¼åº·å…š\n- è½»åº¦äºŒæ¬¡å…ƒ (å·¨äºº, é¬¼ç­, JoJo...)\n- å¡å°”è¾¾YYDS\n\n","source":"about/index.md","raw":"---\ntitle: ABOUT\n---\n[<img src=\"https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&amp;logo=github&amp;logoColor=white\" alt=\"https://github.com/Abingcbc\" style=\"display:inline\">](https://github.com/Abingcbc) [<img src=\"https://img.shields.io/badge/Gmail-D14836?style=for-the-badge&amp;logo=gmail&amp;logoColor=white\" alt=\"mailto:abingcbc626@gmail.com\" style=\"display:inline\">](mailto:abingcbc626@gmail.com) [<img src=\"https://img.shields.io/badge/linkedin-%230077B5.svg?style=for-the-badge&amp;logo=linkedin&amp;logoColor=white\" alt=\"https://www.linkedin.com/in/bingchang-chen-8b3812183/\" style=\"display:inline\">](https://www.linkedin.com/in/bingchang-chen-8b3812183/) [<img src=\"https://img.shields.io/badge/zhihu-0078D4.svg?&style=for-the-badge\" alt=\"https://img.shields.io/badge/zhihu-0078D4.svg?&style=for-the-badge\" style=\"display:inline\">](https://www.zhihu.com/people/llll-48-29)\n<hr>\n\n### æ­£åœ¨å¯»æ‰¾2023å¹´æš‘æœŸå®ä¹  â¤ï¸\n### Open for 2023 Summer Internship â¤ï¸\n\n<hr>\n\næœ¬ç§‘å°±è¯»äºåŒæµå¤§å­¦è½¯ä»¶å­¦é™¢ï¼Œç›®å‰ç¡•å£«å°±è¯»äºåŒæµå¤§å­¦è®¾è®¡ä¸åˆ›æ„å­¦é™¢äººå·¥æ™ºèƒ½ä¸æ•°æ®è®¾è®¡ä¸“ä¸š IDvX å®éªŒå®¤ https://idvxlab.com/ã€‚\n\n#### å…¬ä¼—å·\n\n<img src=\"https://blog.abingcbc.cn/asset/gzh.jpeg\" alt=\"https://blog.abingcbc.cn/asset/gzh.jpeg\" style=\"width:300px;margin:0 auto\">\n\n#### Misc\n\n- ISFP æ‡’ç‹—\n- å°¼åº·å…š\n- è½»åº¦äºŒæ¬¡å…ƒ (å·¨äºº, é¬¼ç­, JoJo...)\n- å¡å°”è¾¾YYDS\n\n","date":"2022-07-12T13:54:59.037Z","updated":"2022-07-12T13:54:59.037Z","path":"about/index.html","comments":1,"layout":"page","_id":"cl5i8k7xr00001rpf2nv352pg","content":"<p><a href=\"https://github.com/Abingcbc\"><img src=\"https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&amp;logo=github&amp;logoColor=white\" alt=\"https://github.com/Abingcbc\" style=\"display:inline\"></a> <a href=\"mailto:abingcbc626@gmail.com\"><img src=\"https://img.shields.io/badge/Gmail-D14836?style=for-the-badge&amp;logo=gmail&amp;logoColor=white\" alt=\"mailto:abingcbc626@gmail.com\" style=\"display:inline\"></a> <a href=\"https://www.linkedin.com/in/bingchang-chen-8b3812183/\"><img src=\"https://img.shields.io/badge/linkedin-%230077B5.svg?style=for-the-badge&amp;logo=linkedin&amp;logoColor=white\" alt=\"https://www.linkedin.com/in/bingchang-chen-8b3812183/\" style=\"display:inline\"></a> <a href=\"https://www.zhihu.com/people/llll-48-29\"><img src=\"https://img.shields.io/badge/zhihu-0078D4.svg?&style=for-the-badge\" alt=\"https://img.shields.io/badge/zhihu-0078D4.svg?&style=for-the-badge\" style=\"display:inline\"></a></p>\n<hr>\n\n<h3 id=\"æ­£åœ¨å¯»æ‰¾2023å¹´æš‘æœŸå®ä¹ -â¤ï¸\"><a href=\"#æ­£åœ¨å¯»æ‰¾2023å¹´æš‘æœŸå®ä¹ -â¤ï¸\" class=\"headerlink\" title=\"æ­£åœ¨å¯»æ‰¾2023å¹´æš‘æœŸå®ä¹  â¤ï¸\"></a>æ­£åœ¨å¯»æ‰¾2023å¹´æš‘æœŸå®ä¹  â¤ï¸</h3><h3 id=\"Open-for-2023-Summer-Internship-â¤ï¸\"><a href=\"#Open-for-2023-Summer-Internship-â¤ï¸\" class=\"headerlink\" title=\"Open for 2023 Summer Internship â¤ï¸\"></a>Open for 2023 Summer Internship â¤ï¸</h3><hr>\n\n<p>æœ¬ç§‘å°±è¯»äºåŒæµå¤§å­¦è½¯ä»¶å­¦é™¢ï¼Œç›®å‰ç¡•å£«å°±è¯»äºåŒæµå¤§å­¦è®¾è®¡ä¸åˆ›æ„å­¦é™¢äººå·¥æ™ºèƒ½ä¸æ•°æ®è®¾è®¡ä¸“ä¸š IDvX å®éªŒå®¤ <a href=\"https://idvxlab.com/%E3%80%82\">https://idvxlab.com/ã€‚</a></p>\n<h4 id=\"å…¬ä¼—å·\"><a href=\"#å…¬ä¼—å·\" class=\"headerlink\" title=\"å…¬ä¼—å·\"></a>å…¬ä¼—å·</h4><img src=\"https://blog.abingcbc.cn/asset/gzh.jpeg\" alt=\"https://blog.abingcbc.cn/asset/gzh.jpeg\" style=\"width:300px;margin:0 auto\">\n\n<h4 id=\"Misc\"><a href=\"#Misc\" class=\"headerlink\" title=\"Misc\"></a>Misc</h4><ul>\n<li>ISFP æ‡’ç‹—</li>\n<li>å°¼åº·å…š</li>\n<li>è½»åº¦äºŒæ¬¡å…ƒ (å·¨äºº, é¬¼ç­, JoJoâ€¦)</li>\n<li>å¡å°”è¾¾YYDS</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"https://github.com/Abingcbc\"><img src=\"https://img.shields.io/badge/github-%23121011.svg?style=for-the-badge&amp;logo=github&amp;logoColor=white\" alt=\"https://github.com/Abingcbc\" style=\"display:inline\"></a> <a href=\"mailto:abingcbc626@gmail.com\"><img src=\"https://img.shields.io/badge/Gmail-D14836?style=for-the-badge&amp;logo=gmail&amp;logoColor=white\" alt=\"mailto:abingcbc626@gmail.com\" style=\"display:inline\"></a> <a href=\"https://www.linkedin.com/in/bingchang-chen-8b3812183/\"><img src=\"https://img.shields.io/badge/linkedin-%230077B5.svg?style=for-the-badge&amp;logo=linkedin&amp;logoColor=white\" alt=\"https://www.linkedin.com/in/bingchang-chen-8b3812183/\" style=\"display:inline\"></a> <a href=\"https://www.zhihu.com/people/llll-48-29\"><img src=\"https://img.shields.io/badge/zhihu-0078D4.svg?&style=for-the-badge\" alt=\"https://img.shields.io/badge/zhihu-0078D4.svg?&style=for-the-badge\" style=\"display:inline\"></a></p>\n<hr>\n\n<h3 id=\"æ­£åœ¨å¯»æ‰¾2023å¹´æš‘æœŸå®ä¹ -â¤ï¸\"><a href=\"#æ­£åœ¨å¯»æ‰¾2023å¹´æš‘æœŸå®ä¹ -â¤ï¸\" class=\"headerlink\" title=\"æ­£åœ¨å¯»æ‰¾2023å¹´æš‘æœŸå®ä¹  â¤ï¸\"></a>æ­£åœ¨å¯»æ‰¾2023å¹´æš‘æœŸå®ä¹  â¤ï¸</h3><h3 id=\"Open-for-2023-Summer-Internship-â¤ï¸\"><a href=\"#Open-for-2023-Summer-Internship-â¤ï¸\" class=\"headerlink\" title=\"Open for 2023 Summer Internship â¤ï¸\"></a>Open for 2023 Summer Internship â¤ï¸</h3><hr>\n\n<p>æœ¬ç§‘å°±è¯»äºåŒæµå¤§å­¦è½¯ä»¶å­¦é™¢ï¼Œç›®å‰ç¡•å£«å°±è¯»äºåŒæµå¤§å­¦è®¾è®¡ä¸åˆ›æ„å­¦é™¢äººå·¥æ™ºèƒ½ä¸æ•°æ®è®¾è®¡ä¸“ä¸š IDvX å®éªŒå®¤ <a href=\"https://idvxlab.com/%E3%80%82\">https://idvxlab.com/ã€‚</a></p>\n<h4 id=\"å…¬ä¼—å·\"><a href=\"#å…¬ä¼—å·\" class=\"headerlink\" title=\"å…¬ä¼—å·\"></a>å…¬ä¼—å·</h4><img src=\"https://blog.abingcbc.cn/asset/gzh.jpeg\" alt=\"https://blog.abingcbc.cn/asset/gzh.jpeg\" style=\"width:300px;margin:0 auto\">\n\n<h4 id=\"Misc\"><a href=\"#Misc\" class=\"headerlink\" title=\"Misc\"></a>Misc</h4><ul>\n<li>ISFP æ‡’ç‹—</li>\n<li>å°¼åº·å…š</li>\n<li>è½»åº¦äºŒæ¬¡å…ƒ (å·¨äºº, é¬¼ç­, JoJoâ€¦)</li>\n<li>å¡å°”è¾¾YYDS</li>\n</ul>\n"},{"title":"å‹æƒ…é“¾æ¥","_content":"## å‹æƒ…é“¾æ¥\n\nğŸˆ [å¡æ‹‰äº‘ä½ä»£ç å·¥å…·](https://kalacloud.com)","source":"links/index.md","raw":"title: å‹æƒ…é“¾æ¥\n---\n## å‹æƒ…é“¾æ¥\n\nğŸˆ [å¡æ‹‰äº‘ä½ä»£ç å·¥å…·](https://kalacloud.com)","date":"2022-07-12T13:54:59.065Z","updated":"2022-07-12T13:54:59.065Z","path":"links/index.html","comments":1,"layout":"page","_id":"cl5i8k7xz00021rpfdzk09lu1","content":"<h2 id=\"å‹æƒ…é“¾æ¥\"><a href=\"#å‹æƒ…é“¾æ¥\" class=\"headerlink\" title=\"å‹æƒ…é“¾æ¥\"></a>å‹æƒ…é“¾æ¥</h2><p>ğŸˆ <a href=\"https://kalacloud.com/\">å¡æ‹‰äº‘ä½ä»£ç å·¥å…·</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"å‹æƒ…é“¾æ¥\"><a href=\"#å‹æƒ…é“¾æ¥\" class=\"headerlink\" title=\"å‹æƒ…é“¾æ¥\"></a>å‹æƒ…é“¾æ¥</h2><p>ğŸˆ <a href=\"https://kalacloud.com/\">å¡æ‹‰äº‘ä½ä»£ç å·¥å…·</a></p>\n"}],"Post":[{"title":"2021 å¹´ç»ˆæ€»ç»“ â€”â€” ç¿»å¤©è¦†åœ°","date":"2022-06-01T00:19:16.000Z","updated":"2022-06-01T00:19:16.000Z","_content":"2021å¹´è¿™ä¸€å¹´çš„æ—¶é—´é‡Œï¼Œå‘ç”Ÿäº†å¤ªå¤šçš„äº‹ï¼Œå¦‚æœä¸å†™ä¸‹æ¥çš„è¯ï¼Œåœ¨è„‘æµ·ä¸­åªä¼šæœ‰ä¸€äº›æ¨¡ç³Šçš„å°è±¡ï¼Œä¸æ¸…æ¥šè‡ªå·±å–å¾—äº†å“ªäº›æˆç»©ï¼Œåˆæœ‰å“ªé‡Œä¸å°½äººæ„ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä»ä¸€ä¸ªæ—è§‚è€…çš„è§†è§’ï¼Œæ¥è§‚å¯Ÿè‡ªå·±è¿™ä¸€å¹´æœ‰æ²¡æœ‰è™šåº¦å…‰é˜´ã€‚æ‰€ä»¥ï¼Œå°±ä»2021å¹´å¼€å§‹ï¼Œå¼€å§‹æ¯å¹´å¯¹è¿‡å»çš„ä¸€å¹´è¿›è¡Œä¸€ä¸ªè®°å½•å§~\n## æŠ€æœ¯\n### K8s\nåœ¨å¹´åˆçš„æ—¶å€™ï¼Œé˜…è¯»äº†ã€ŠKubernetes in Actionã€‹è¿™æœ¬ä¹¦ï¼Œå—ç›ŠåŒªæµ…ï¼Œå†åŠ ä¸Šå®ä¹ ä¸­çš„å®è·µï¼Œå¯¹ K8s çš„äº†è§£æ›´åŠ æ·±å…¥äº†ã€‚K8s ä½œä¸ºç›®å‰ Cloud çš„å®é™…ä»£åè¯ï¼Œåœ¨åº”ç”¨å¼€å‘ä¸­å·²ç»æ˜¯æ— æ³•æ›¿ä»£çš„å­˜åœ¨äº†ã€‚ä½œä¸ºäº‘åŸç”Ÿçš„åŸºç¡€è®¾æ–½ï¼Œå¯¹äº K8s çš„å­¦ä¹ ï¼Œé™¤äº†æŒæ¡å…¶åŸºç¡€çš„æ“ä½œï¼Œä¾‹å¦‚ Deploymentã€Ingress ç­‰ç­‰ç»„ä»¶çš„ä½¿ç”¨ï¼Œæ¥æ»¡è¶³ä¸Šå±‚çš„åº”ç”¨å¼€å‘ä»¥å¤–ï¼Œå¯¹äº K8s æœ¬èº«çš„å­¦ä¹ ï¼Œä¹Ÿæ˜¯ååˆ†é‡è¦çš„ã€‚å› ä¸º K8s æœ¬èº«å°±æ˜¯ä¸€ä¸ªåºå¤§å¤æ‚çš„ç³»ç»Ÿï¼Œè€Œä¸”ç»è¿‡æ— æ•°ä¸šç•Œå¤§ä½¬çš„æ‰“ç£¨ï¼Œç³»ç»Ÿä¸Šçš„è®¾è®¡æ— ç–‘æ˜¯å¾ˆå¤šé—®é¢˜çš„ best practiceã€‚æ·±å…¥ç†è§£ K8s çš„è®¾è®¡ï¼Œå¯¹äºæœªæ¥è®¾è®¡è‡ªå·±çš„åº”ç”¨æ¶æ„è‚¯å®šä¼šå¸¦æ¥å¾ˆå¤§çš„å¸®åŠ©ã€‚\n### è‡ªåŠ¨åŒ–éƒ¨ç½²\næˆ‘åœ¨å®ä¹ æœŸé—´è´Ÿè´£çš„ä¸»è¦çš„ä¸€éƒ¨åˆ†å†…å®¹å°±æ˜¯è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚éšç€ç°åœ¨å¾®æœåŠ¡åŒ–çš„è¶‹åŠ¿ä»¥åŠç³»ç»Ÿå†…ç¬¬ä¸‰æ–¹ä¾èµ–ç»„ä»¶çš„æ•°é‡çš„å¢åŠ ï¼Œéƒ¨ç½²å…¶å®æ˜¯ä¸€ä¸ªéå¸¸éº»çƒ¦çš„é—®é¢˜ã€‚åœ¨å…¬æœ‰äº‘çš„åœºæ™¯ä¸‹ï¼Œéƒ¨åˆ†ç¬¬ä¸‰æ–¹ç»„ä»¶æˆ–è®¸å¯ä»¥é€šè¿‡å¤–éƒ¨æœåŠ¡çš„å½¢å¼è§£å†³ã€‚ä½†åœ¨ç§æœ‰äº‘çš„æƒ…å†µä¸‹ï¼Œéƒ¨ç½²éœ€è¦åŒæ—¶éƒ¨ç½²è¿™äº›ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œæ— ç–‘ç»™éƒ¨ç½²å¢åŠ äº†å¾ˆå¤§çš„å¤æ‚åº¦ã€‚ä¸ä»…ä»…å¦‚æ­¤ï¼Œå¯¹äºä»»ä½•ç°ä»£åŒ–çš„è½¯ä»¶æ¥è¯´ï¼Œéƒ¨ç½²éƒ½æ˜¯éœ€è¦è¿›è¡Œæ ‡å‡†åŒ–çš„ã€‚é€šè¿‡éƒ¨ç½²æ–‡æ¡£ï¼Œç±»ä¼¼æ‰‹å·¥ä½œåŠè¿›è¡Œçš„éƒ¨ç½²æ–¹å¼ï¼Œæ˜¯æ— æ³•æŒä¹…çš„ï¼Œäººå› çš„é”™è¯¯æ˜¯æ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹ä¸­å¾ˆå¤§çš„ä¸ç¨³å®šå› ç´ ã€‚è¿™æ–¹é¢ä¹Ÿæœ‰å¾ˆå¤šåšçš„æ¯”è¾ƒå¥½çš„å¼€æºé¡¹ç›®ï¼Œæ¯”å¦‚è¯´ TiDB çš„ TiUP ç­‰ç­‰ã€‚\n### å¯è§†åŒ–\nå®è¯è¯´ï¼Œåœ¨æ­£å¼è¿›å…¥ç¡•å£«å­¦ä¹ ä¹‹å‰ï¼Œæˆ‘å¯¹äºå¯è§†åŒ–çš„äº†è§£å¯èƒ½éƒ½æ¯”è¾ƒæµ…è–„ï¼ˆè™½ç„¶æ˜çŸ¥é“è¿™æ˜¯è‡ªå·±ç¡•å£«çš„ç ”ç©¶æ–¹å‘ï¼‰ã€‚åœ¨å¬å®Œå¤§è€æ¿çš„è¯¾ä¹‹åï¼Œå¯¹äºè¿™ä¸ªé¢†åŸŸæœ‰äº†å…¨æ–°çš„è®¤çŸ¥ã€‚å¯è§†åŒ–è¿™ä¸ªé¢†åŸŸè™½ç„¶å¾ˆå°ï¼Œä½†å¹¶ä¸æ˜¯åƒå¤§ä¼—è®¤ä¸ºçš„åªæœ‰ç®€å•çš„å›¾è¡¨è€Œå·²ã€‚é¦–å…ˆï¼Œå›¾è¡¨æœ¬èº«çš„è®¾è®¡æœ‰ç€å¾ˆå¤šé—®é¢˜å€¼å¾—ç ”ç©¶ã€‚è®¾è®¡å¯èƒ½æ˜¯ä¸€ä¸ªä¸»è§‚æ„Ÿæ€§çš„è¡Œä¸ºï¼Œä½†æˆ‘å¤§è€æ¿çš„æƒ³æ³•æ˜¯é€šè¿‡design spaceç­‰æ–¹å¼ï¼Œå°†å…¶è½¬åŒ–ä¸ºç†æ€§ï¼Œæœ‰é€»è¾‘çš„è¡Œä¸ºã€‚æˆ‘å¯¹è¿™ä¸€ç‚¹éå¸¸è®¤åŒï¼Œç»™äº†æˆ‘ä¸€ç§èŒ…å¡é¡¿å¼€çš„æ„Ÿè§‰ï¼Œè®©æˆ‘å¯¹ä¹‹å‰å¾ˆå¤šçœ‹ä¼¼æ„Ÿæ€§çš„äº‹æƒ…æœ‰äº†æ–°çš„ç†è§£ã€‚å…¶æ¬¡ï¼Œå¯è§†åˆ†æä¹Ÿæ˜¯å¯è§†åŒ–ä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚å¾ˆå¤šé—®é¢˜ï¼Œé€šè¿‡å¯è§†åŒ–çš„å½¢å¼ï¼Œå°±å¯ä»¥å¾ˆæ¸…æ¥šå’Œå®¹æ˜“åœ°è¢«åˆ†æå‡ºæ¥ã€‚è¿™ä¸€ç±»ç³»ç»Ÿï¼Œæ„Ÿè§‰åœ¨ BI é¢†åŸŸåº”è¯¥æœ‰å¾ˆå¤§çš„å‘å±•ç©ºé—´ã€‚\n### Casbin\nä¸€ç›´ä»¥æ¥æƒ³åŠ å…¥ä¸€ä¸ªå¼€æºç¤¾åŒºï¼Œä¸º developer ä»¬åšå‡ºä¸€ç‚¹ç‚¹è‡ªå·±çš„è´¡çŒ®ã€‚äºæ˜¯é€šè¿‡ä¸€ä¸ªæ´»åŠ¨åŠ å…¥åˆ°äº† Casbinç¤¾åŒºã€‚Casbin æ˜¯ä¸€ä¸ªæƒé™æ ¡éªŒæ¡†æ¶ï¼Œé€šè¿‡ well-defined çš„ model ç»“æ„ï¼Œæ”¯æŒå¯¹å„ç§ç±»å‹çš„æ ¡éªŒæ¨¡å¼ï¼ˆæ¯”å¦‚RBACï¼ŒABACç­‰ç­‰ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è§‰å¾— Casbin èƒ½å¤Ÿè·å¾— 10k+ star çš„å¦ä¸€ä¸ªåŸå› æ˜¯ä»–çš„ç”Ÿæ€æ”¯æŒä¹Ÿå¤ªä¸°å¯Œäº†ã€‚å„ç§è¯­è¨€ï¼Œå„ç§å‰ç«¯åç«¯æ¡†æ¶ï¼Œå„ç§æ•°æ®åº“ï¼Œåªè¦æ˜¯æœ‰éœ€æ±‚ï¼Œéƒ½ä¼šè¿›è¡Œæ”¯æŒã€‚å…¶ä¸­å¦ä¸€ä¸ªæœ€é‡è¦çš„åº”è¯¥æ˜¯ Casdoorï¼Œä¸€ä¸ªç¬¬ä¸‰æ–¹ç»Ÿä¸€èº«ä»½è®¤è¯æ¡†æ¶ï¼Œä¸ KeyCloak ç›¸å¯¹æ ‡ã€‚\n\nè¿™ä¸¤ä¸ªé¡¹ç›®éƒ½éå¸¸æœ‰æ„ä¹‰ï¼ŒCasbin ä¸»è¦æ˜¯åƒä¸€ä¸ªè§£æå™¨ä¸€æ ·ï¼Œé¢å¯¹ä¸åŒçš„ model å’Œ policyå®šä¹‰ï¼Œéœ€è¦æä¾›æ­£ç¡®çš„æ ¡éªŒç»“æœï¼Œæˆ‘ä¸ªäººè¿˜æŒºå–œæ¬¢æ…¢æ…¢æ¨ç†ï¼Œå¯»æ‰¾å“ªä¸€æ­¥è§£æé”™è¯¯çš„è¿‡ç¨‹ã€‚è€Œ Casdoor åˆ™åƒä¸€ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œå¦‚ä½•å®ç°æ›´å¤šçš„ featureï¼Œå¦‚ä½•æå‡æ˜“ç”¨æ€§ï¼Œä¸æ›´å¤šçš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿè¿›è¡Œé›†æˆã€‚\n### Other\né™¤æ­¤ä¹‹å‰ï¼Œè¿™ä¸€å¹´é—´ä¹Ÿå¤šå¤šå°‘å°‘æ¥è§¦äº†å¾ˆå¤šå…¶ä»–æŠ€æœ¯ã€‚å®ä¹ çš„æ—¶å€™æ— æ‰€äº‹äº‹ï¼Œå¼€å§‹å†™èµ·æ¥äº† Augularï¼Œä½“éªŒäº†ä¸€æ¬¡åƒ Java ä¸€æ ·çš„å‰ç«¯çš„å¼€å‘æ¨¡å¼ï¼›æš‘å‡çš„æ—¶å€™å‚åŠ  GSoCï¼Œå€Ÿæœºæ¥è§¦äº†ä¸€ä¸‹ Rustï¼Œå¯¹è¿™é—¨è¯­è¨€äº§ç”Ÿäº†æ·±æ·±çš„æ•¬ç•ï¼Œä½†å¯æƒœæ²¡èƒ½æ·±å…¥å­¦ä¹ ä¸‹å»ï¼›å¼€å­¦ä»¥åæ¥è§¦äº†å¾ˆå¤šè®¾è®¡é¢†åŸŸçš„codingï¼Œåšäº†ä¸€äº›æ•°å­—åª’ä½“ç±»ä¼¼çš„è¯¾ç¨‹ä½œä¸š......\n## ç”Ÿæ´»\nä¸ŠåŠå¹´å®ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œæ„Ÿè§‰è‡ªå·±é€æ¸æ”¾å¼€äº†ã€‚åœ¨å®ä¹ æœŸé—´é‡åˆ°äº†å¾ˆå¤šä¼™ä¼´ï¼Œå¤§å®¶ä¸€èµ·å¿«ä¹æ‘¸é±¼ï¼ŒçœŸçš„æ˜¯åº¦è¿‡äº†ä¸€æ®µå¾ˆå¿«ä¹çš„æ—¶å…‰ã€‚æœ€é‡è¦çš„æ˜¯æ¯•ä¸šå•¦ï¼æœ€é«˜å­¦å†ç»ˆäºä»é«˜ä¸­å˜æˆäº†æœ¬ç§‘ã€‚è™½ç„¶æ¯•ä¸šæ—…è¡Œå› ä¸ºç–«æƒ…åŸå› æ²¡èƒ½æˆè¡Œï¼Œä½†æš‘å‡åœ¨å®¶å¿«ä¹æ‘¸é±¼ï¼Œç–¯ç‹‚é”»ç‚¼çŒé¾™æŠ€æœ¯ï¼Œè¿˜å·®ä¸€ç‚¹æŠŠå¡å°”è¾¾çš„å‘€å“ˆå“ˆå…¨æ”¶é›†ï¼Œä¹Ÿç®—å¿«ä¹çš„åº¦è¿‡äº†æœ€åä¸€ä¸ªæš‘å‡äº†ã€‚\n\nå¦‚æœè¯´ä¸ŠåŠå¹´æ˜¯æˆ‘äººç”Ÿæœ€å¿«ä¹çš„æ—¶å…‰ï¼Œé‚£ä¹ˆä¸‹åŠå¹´å¼€å­¦åï¼Œå°±æ˜¯æˆ‘ç›®å‰ä¸ºæ­¢æœ€ç—›è‹¦çš„æ—¥å­äº†ã€‚ä½†æ— è®ºæ˜¯å‰åå“ªä¸ªé˜¶æ®µï¼Œæˆ‘å…¶å®éƒ½æˆé•¿äº†éå¸¸å¤šï¼Œä¹Ÿç®—æ˜¯å€¼å¾—åº†å¹¸çš„äº‹ï¼Œèƒ½å¤Ÿåœ¨æ¥å—åˆ°ç¤¾ä¼šæ­£å¼çš„æ¯’æ‰“ä¹‹å‰ï¼Œæå‰æˆé•¿ã€‚\n\nä¸€æ–¹é¢çš„å‹åŠ›æ¥è‡ªäºè¯¾ç¨‹ï¼Œæ¯•ç«Ÿæˆ‘æ˜¯å±äºè·¨ä¸“ä¸šä¿ç ”åˆ°äº†è®¾åˆ›ï¼Œéš¾å…åœ¨ç ”ç©¶ç”Ÿé˜¶æ®µè¦æ¥è§¦åˆ°è®¾è®¡ç›¸å…³çš„è¯¾ç¨‹ã€‚åœ¨ç»„é˜Ÿä¸Šï¼Œå¤©çœŸåœ°ä»¥ä¸ºè€å¸ˆæ˜¯æŠ€æœ¯èƒŒæ™¯å‡ºèº«çš„ï¼Œé¡¹ç›®å¯èƒ½ä¹Ÿä¼šæ˜¯ï¼Œç»“æœå°±æ˜¯åœ¨è¯¾ç¨‹é¡¹ç›®ä¸Šè¢«è®¾è®¡èƒŒæ™¯çš„åŒå­¦åŠæ‰“ã€‚åœ¨ DDL å‰ç–¯ç‹‚çˆ†è‚ï¼Œä½†æ˜¯ä¹Ÿæ¢ä¸æ¥ç‰¹åˆ«é«˜çš„æˆç»©ã€‚ç ”ç©¶ç”Ÿè¯¾ç¨‹ä¸­æ²¡èƒ½æŠ±ä¸Šè®¾è®¡å¤§ä½¬ä»¬çš„å¤§è…¿ï¼Œæ²¡ä½“éªŒä¸€æ¬¡è¢«å¸¦é£çš„æ„Ÿè§‰ï¼Œç®—æ˜¯æ¯”è¾ƒå¯æƒœçš„äº†ã€‚\n\nå¦ä¸€æ–¹é¢æœ€å¤§çš„å‹åŠ›æ¥è‡ªäºå®éªŒå®¤ã€‚å¤§è€æ¿çš„ç—›éª‚ç¡®å®æ˜¯æœ‰æ•ˆçš„ã€‚åšäº‹ä¸å¤Ÿæ·±å…¥çš„é—®é¢˜ï¼Œåœ¨æˆ‘ä¹‹å‰çš„é¢è¯•ä»¥åŠå®ä¹ è¿‡ç¨‹ä¸­ï¼Œéƒ½å¤šæ¬¡è¢«å‰è¾ˆä»¬æåˆ°è¿‡ï¼Œä½†éƒ½é‡‡ç”¨ç›¸å¯¹å’Œè”¼çš„è¯­æ°”å’Œæ€åº¦ã€‚æˆ‘ä¹Ÿæ˜¯å±å®æœ‰ç‚¹æŠ–mäº†ï¼Œè¿™ç§ä¸ç—›ä¸ç—’çš„æ‰¹è¯„æ ¹æœ¬ä¸å¾€å¿ƒé‡Œå»ï¼Œä¹Ÿæ²¡æœ‰å‘è‡ªå†…å¿ƒåœ°å»çº æ­£è‡ªå·±çš„é—®é¢˜ï¼Œéè¦ç­‰åˆ°ç°åœ¨çš„å¤§è€æ¿çˆ†éª‚è‡ªå·±ï¼Œè‡ªå·±æ‰æ„è¯†åˆ°é—®é¢˜ã€‚ã€‚ã€‚\n\nå¹´æœ«åˆ°22å¹´åˆçš„çŠ¶æ€ç¡®å®ä¸å¤ªå¥½ï¼Œä¼¼ä¹æ¯å¹´çš„è¿™æ®µæ—¶é—´éƒ½å¾ˆemoã€‚åœ¨å¹´åº•DDLç»“æŸä¹‹åï¼Œè‡ªå·±çš„èŠ‚å¥ä¸€æ—¶é—´ä¹Ÿæ²¡è°ƒæ•´è¿‡æ¥ã€‚é—²ä¸‹æ¥ä»¥åï¼Œè„‘å­æ˜æ˜æ²‰æ²‰ï¼Œæ²¡äº†ç›®æ ‡ï¼Œæä¸æ¸…æ¥šè‡ªå·±çœŸæ­£æƒ³è¦ä»€ä¹ˆï¼Œä¸è®¨äººå–œæ¬¢ã€‚æœ€åä¹Ÿç®—é€ æˆäº†ä¸å¯å¼¥è¡¥çš„é”™è¯¯å§ï¼Œéå¸¸å¯æƒœã€‚ä¸è¿‡ï¼Œäººå„æœ‰å‘½å§ï¼Œä¹Ÿå­¦ä¹ åˆ°äº†å¾ˆå¤šï¼Œå‰åç›¸æ¯”ï¼Œç®—æ˜¯æˆç†Ÿäº†å¾ˆå¤šäº†ã€‚\n\næ‹–æ‹–æ‹‰æ‹‰ï¼Œå†™å®Œè¿™ç¯‡æ€»ç»“çš„æ—¶å€™ï¼Œ2022å¹´éƒ½å·²ç»è¿‡å»å››åˆ†ä¹‹ä¸€äº†ã€‚æ€»çš„æ¥è¯´ï¼Œ2022å¹´å¯ä»¥ç”¨â€œç¿»å¤©è¦†åœ°â€è¿™ä¸ªè¯æ¥æ¦‚æ‹¬ï¼Œåœ¨è¿™ä¸ªç—›è‹¦çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè§åˆ°äº†ä¸€ä¸ªä¸ä¸€æ ·çš„è‡ªå·±ã€‚è™½ç„¶2022å¹´çš„å¼€ç«¯ä¸ç®—é¡ºåˆ©ï¼Œå¾ˆå¤±è´¥ï¼Œä½†è¿™äº›é—®é¢˜å°±ç•™åˆ°æ˜å¹´çš„æ€»ç»“ä¸­æ¥å†™å§ã€‚æœ€åï¼Œå¸Œæœ›åœ¨2023å¹´æ€»ç»“ä»Šå¹´çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæ›´åŠ å¼€å¿ƒçš„å…³é”®è¯å§ã€‚","source":"_posts/2021.md","raw":"---\ntitle: 2021 å¹´ç»ˆæ€»ç»“ â€”â€” ç¿»å¤©è¦†åœ°\ndate: 2022-06-01 00:19:16\nupdated: 2022-06-01 00:19:16\n---\n2021å¹´è¿™ä¸€å¹´çš„æ—¶é—´é‡Œï¼Œå‘ç”Ÿäº†å¤ªå¤šçš„äº‹ï¼Œå¦‚æœä¸å†™ä¸‹æ¥çš„è¯ï¼Œåœ¨è„‘æµ·ä¸­åªä¼šæœ‰ä¸€äº›æ¨¡ç³Šçš„å°è±¡ï¼Œä¸æ¸…æ¥šè‡ªå·±å–å¾—äº†å“ªäº›æˆç»©ï¼Œåˆæœ‰å“ªé‡Œä¸å°½äººæ„ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä»ä¸€ä¸ªæ—è§‚è€…çš„è§†è§’ï¼Œæ¥è§‚å¯Ÿè‡ªå·±è¿™ä¸€å¹´æœ‰æ²¡æœ‰è™šåº¦å…‰é˜´ã€‚æ‰€ä»¥ï¼Œå°±ä»2021å¹´å¼€å§‹ï¼Œå¼€å§‹æ¯å¹´å¯¹è¿‡å»çš„ä¸€å¹´è¿›è¡Œä¸€ä¸ªè®°å½•å§~\n## æŠ€æœ¯\n### K8s\nåœ¨å¹´åˆçš„æ—¶å€™ï¼Œé˜…è¯»äº†ã€ŠKubernetes in Actionã€‹è¿™æœ¬ä¹¦ï¼Œå—ç›ŠåŒªæµ…ï¼Œå†åŠ ä¸Šå®ä¹ ä¸­çš„å®è·µï¼Œå¯¹ K8s çš„äº†è§£æ›´åŠ æ·±å…¥äº†ã€‚K8s ä½œä¸ºç›®å‰ Cloud çš„å®é™…ä»£åè¯ï¼Œåœ¨åº”ç”¨å¼€å‘ä¸­å·²ç»æ˜¯æ— æ³•æ›¿ä»£çš„å­˜åœ¨äº†ã€‚ä½œä¸ºäº‘åŸç”Ÿçš„åŸºç¡€è®¾æ–½ï¼Œå¯¹äº K8s çš„å­¦ä¹ ï¼Œé™¤äº†æŒæ¡å…¶åŸºç¡€çš„æ“ä½œï¼Œä¾‹å¦‚ Deploymentã€Ingress ç­‰ç­‰ç»„ä»¶çš„ä½¿ç”¨ï¼Œæ¥æ»¡è¶³ä¸Šå±‚çš„åº”ç”¨å¼€å‘ä»¥å¤–ï¼Œå¯¹äº K8s æœ¬èº«çš„å­¦ä¹ ï¼Œä¹Ÿæ˜¯ååˆ†é‡è¦çš„ã€‚å› ä¸º K8s æœ¬èº«å°±æ˜¯ä¸€ä¸ªåºå¤§å¤æ‚çš„ç³»ç»Ÿï¼Œè€Œä¸”ç»è¿‡æ— æ•°ä¸šç•Œå¤§ä½¬çš„æ‰“ç£¨ï¼Œç³»ç»Ÿä¸Šçš„è®¾è®¡æ— ç–‘æ˜¯å¾ˆå¤šé—®é¢˜çš„ best practiceã€‚æ·±å…¥ç†è§£ K8s çš„è®¾è®¡ï¼Œå¯¹äºæœªæ¥è®¾è®¡è‡ªå·±çš„åº”ç”¨æ¶æ„è‚¯å®šä¼šå¸¦æ¥å¾ˆå¤§çš„å¸®åŠ©ã€‚\n### è‡ªåŠ¨åŒ–éƒ¨ç½²\næˆ‘åœ¨å®ä¹ æœŸé—´è´Ÿè´£çš„ä¸»è¦çš„ä¸€éƒ¨åˆ†å†…å®¹å°±æ˜¯è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚éšç€ç°åœ¨å¾®æœåŠ¡åŒ–çš„è¶‹åŠ¿ä»¥åŠç³»ç»Ÿå†…ç¬¬ä¸‰æ–¹ä¾èµ–ç»„ä»¶çš„æ•°é‡çš„å¢åŠ ï¼Œéƒ¨ç½²å…¶å®æ˜¯ä¸€ä¸ªéå¸¸éº»çƒ¦çš„é—®é¢˜ã€‚åœ¨å…¬æœ‰äº‘çš„åœºæ™¯ä¸‹ï¼Œéƒ¨åˆ†ç¬¬ä¸‰æ–¹ç»„ä»¶æˆ–è®¸å¯ä»¥é€šè¿‡å¤–éƒ¨æœåŠ¡çš„å½¢å¼è§£å†³ã€‚ä½†åœ¨ç§æœ‰äº‘çš„æƒ…å†µä¸‹ï¼Œéƒ¨ç½²éœ€è¦åŒæ—¶éƒ¨ç½²è¿™äº›ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œæ— ç–‘ç»™éƒ¨ç½²å¢åŠ äº†å¾ˆå¤§çš„å¤æ‚åº¦ã€‚ä¸ä»…ä»…å¦‚æ­¤ï¼Œå¯¹äºä»»ä½•ç°ä»£åŒ–çš„è½¯ä»¶æ¥è¯´ï¼Œéƒ¨ç½²éƒ½æ˜¯éœ€è¦è¿›è¡Œæ ‡å‡†åŒ–çš„ã€‚é€šè¿‡éƒ¨ç½²æ–‡æ¡£ï¼Œç±»ä¼¼æ‰‹å·¥ä½œåŠè¿›è¡Œçš„éƒ¨ç½²æ–¹å¼ï¼Œæ˜¯æ— æ³•æŒä¹…çš„ï¼Œäººå› çš„é”™è¯¯æ˜¯æ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹ä¸­å¾ˆå¤§çš„ä¸ç¨³å®šå› ç´ ã€‚è¿™æ–¹é¢ä¹Ÿæœ‰å¾ˆå¤šåšçš„æ¯”è¾ƒå¥½çš„å¼€æºé¡¹ç›®ï¼Œæ¯”å¦‚è¯´ TiDB çš„ TiUP ç­‰ç­‰ã€‚\n### å¯è§†åŒ–\nå®è¯è¯´ï¼Œåœ¨æ­£å¼è¿›å…¥ç¡•å£«å­¦ä¹ ä¹‹å‰ï¼Œæˆ‘å¯¹äºå¯è§†åŒ–çš„äº†è§£å¯èƒ½éƒ½æ¯”è¾ƒæµ…è–„ï¼ˆè™½ç„¶æ˜çŸ¥é“è¿™æ˜¯è‡ªå·±ç¡•å£«çš„ç ”ç©¶æ–¹å‘ï¼‰ã€‚åœ¨å¬å®Œå¤§è€æ¿çš„è¯¾ä¹‹åï¼Œå¯¹äºè¿™ä¸ªé¢†åŸŸæœ‰äº†å…¨æ–°çš„è®¤çŸ¥ã€‚å¯è§†åŒ–è¿™ä¸ªé¢†åŸŸè™½ç„¶å¾ˆå°ï¼Œä½†å¹¶ä¸æ˜¯åƒå¤§ä¼—è®¤ä¸ºçš„åªæœ‰ç®€å•çš„å›¾è¡¨è€Œå·²ã€‚é¦–å…ˆï¼Œå›¾è¡¨æœ¬èº«çš„è®¾è®¡æœ‰ç€å¾ˆå¤šé—®é¢˜å€¼å¾—ç ”ç©¶ã€‚è®¾è®¡å¯èƒ½æ˜¯ä¸€ä¸ªä¸»è§‚æ„Ÿæ€§çš„è¡Œä¸ºï¼Œä½†æˆ‘å¤§è€æ¿çš„æƒ³æ³•æ˜¯é€šè¿‡design spaceç­‰æ–¹å¼ï¼Œå°†å…¶è½¬åŒ–ä¸ºç†æ€§ï¼Œæœ‰é€»è¾‘çš„è¡Œä¸ºã€‚æˆ‘å¯¹è¿™ä¸€ç‚¹éå¸¸è®¤åŒï¼Œç»™äº†æˆ‘ä¸€ç§èŒ…å¡é¡¿å¼€çš„æ„Ÿè§‰ï¼Œè®©æˆ‘å¯¹ä¹‹å‰å¾ˆå¤šçœ‹ä¼¼æ„Ÿæ€§çš„äº‹æƒ…æœ‰äº†æ–°çš„ç†è§£ã€‚å…¶æ¬¡ï¼Œå¯è§†åˆ†æä¹Ÿæ˜¯å¯è§†åŒ–ä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚å¾ˆå¤šé—®é¢˜ï¼Œé€šè¿‡å¯è§†åŒ–çš„å½¢å¼ï¼Œå°±å¯ä»¥å¾ˆæ¸…æ¥šå’Œå®¹æ˜“åœ°è¢«åˆ†æå‡ºæ¥ã€‚è¿™ä¸€ç±»ç³»ç»Ÿï¼Œæ„Ÿè§‰åœ¨ BI é¢†åŸŸåº”è¯¥æœ‰å¾ˆå¤§çš„å‘å±•ç©ºé—´ã€‚\n### Casbin\nä¸€ç›´ä»¥æ¥æƒ³åŠ å…¥ä¸€ä¸ªå¼€æºç¤¾åŒºï¼Œä¸º developer ä»¬åšå‡ºä¸€ç‚¹ç‚¹è‡ªå·±çš„è´¡çŒ®ã€‚äºæ˜¯é€šè¿‡ä¸€ä¸ªæ´»åŠ¨åŠ å…¥åˆ°äº† Casbinç¤¾åŒºã€‚Casbin æ˜¯ä¸€ä¸ªæƒé™æ ¡éªŒæ¡†æ¶ï¼Œé€šè¿‡ well-defined çš„ model ç»“æ„ï¼Œæ”¯æŒå¯¹å„ç§ç±»å‹çš„æ ¡éªŒæ¨¡å¼ï¼ˆæ¯”å¦‚RBACï¼ŒABACç­‰ç­‰ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è§‰å¾— Casbin èƒ½å¤Ÿè·å¾— 10k+ star çš„å¦ä¸€ä¸ªåŸå› æ˜¯ä»–çš„ç”Ÿæ€æ”¯æŒä¹Ÿå¤ªä¸°å¯Œäº†ã€‚å„ç§è¯­è¨€ï¼Œå„ç§å‰ç«¯åç«¯æ¡†æ¶ï¼Œå„ç§æ•°æ®åº“ï¼Œåªè¦æ˜¯æœ‰éœ€æ±‚ï¼Œéƒ½ä¼šè¿›è¡Œæ”¯æŒã€‚å…¶ä¸­å¦ä¸€ä¸ªæœ€é‡è¦çš„åº”è¯¥æ˜¯ Casdoorï¼Œä¸€ä¸ªç¬¬ä¸‰æ–¹ç»Ÿä¸€èº«ä»½è®¤è¯æ¡†æ¶ï¼Œä¸ KeyCloak ç›¸å¯¹æ ‡ã€‚\n\nè¿™ä¸¤ä¸ªé¡¹ç›®éƒ½éå¸¸æœ‰æ„ä¹‰ï¼ŒCasbin ä¸»è¦æ˜¯åƒä¸€ä¸ªè§£æå™¨ä¸€æ ·ï¼Œé¢å¯¹ä¸åŒçš„ model å’Œ policyå®šä¹‰ï¼Œéœ€è¦æä¾›æ­£ç¡®çš„æ ¡éªŒç»“æœï¼Œæˆ‘ä¸ªäººè¿˜æŒºå–œæ¬¢æ…¢æ…¢æ¨ç†ï¼Œå¯»æ‰¾å“ªä¸€æ­¥è§£æé”™è¯¯çš„è¿‡ç¨‹ã€‚è€Œ Casdoor åˆ™åƒä¸€ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œå¦‚ä½•å®ç°æ›´å¤šçš„ featureï¼Œå¦‚ä½•æå‡æ˜“ç”¨æ€§ï¼Œä¸æ›´å¤šçš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿè¿›è¡Œé›†æˆã€‚\n### Other\né™¤æ­¤ä¹‹å‰ï¼Œè¿™ä¸€å¹´é—´ä¹Ÿå¤šå¤šå°‘å°‘æ¥è§¦äº†å¾ˆå¤šå…¶ä»–æŠ€æœ¯ã€‚å®ä¹ çš„æ—¶å€™æ— æ‰€äº‹äº‹ï¼Œå¼€å§‹å†™èµ·æ¥äº† Augularï¼Œä½“éªŒäº†ä¸€æ¬¡åƒ Java ä¸€æ ·çš„å‰ç«¯çš„å¼€å‘æ¨¡å¼ï¼›æš‘å‡çš„æ—¶å€™å‚åŠ  GSoCï¼Œå€Ÿæœºæ¥è§¦äº†ä¸€ä¸‹ Rustï¼Œå¯¹è¿™é—¨è¯­è¨€äº§ç”Ÿäº†æ·±æ·±çš„æ•¬ç•ï¼Œä½†å¯æƒœæ²¡èƒ½æ·±å…¥å­¦ä¹ ä¸‹å»ï¼›å¼€å­¦ä»¥åæ¥è§¦äº†å¾ˆå¤šè®¾è®¡é¢†åŸŸçš„codingï¼Œåšäº†ä¸€äº›æ•°å­—åª’ä½“ç±»ä¼¼çš„è¯¾ç¨‹ä½œä¸š......\n## ç”Ÿæ´»\nä¸ŠåŠå¹´å®ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œæ„Ÿè§‰è‡ªå·±é€æ¸æ”¾å¼€äº†ã€‚åœ¨å®ä¹ æœŸé—´é‡åˆ°äº†å¾ˆå¤šä¼™ä¼´ï¼Œå¤§å®¶ä¸€èµ·å¿«ä¹æ‘¸é±¼ï¼ŒçœŸçš„æ˜¯åº¦è¿‡äº†ä¸€æ®µå¾ˆå¿«ä¹çš„æ—¶å…‰ã€‚æœ€é‡è¦çš„æ˜¯æ¯•ä¸šå•¦ï¼æœ€é«˜å­¦å†ç»ˆäºä»é«˜ä¸­å˜æˆäº†æœ¬ç§‘ã€‚è™½ç„¶æ¯•ä¸šæ—…è¡Œå› ä¸ºç–«æƒ…åŸå› æ²¡èƒ½æˆè¡Œï¼Œä½†æš‘å‡åœ¨å®¶å¿«ä¹æ‘¸é±¼ï¼Œç–¯ç‹‚é”»ç‚¼çŒé¾™æŠ€æœ¯ï¼Œè¿˜å·®ä¸€ç‚¹æŠŠå¡å°”è¾¾çš„å‘€å“ˆå“ˆå…¨æ”¶é›†ï¼Œä¹Ÿç®—å¿«ä¹çš„åº¦è¿‡äº†æœ€åä¸€ä¸ªæš‘å‡äº†ã€‚\n\nå¦‚æœè¯´ä¸ŠåŠå¹´æ˜¯æˆ‘äººç”Ÿæœ€å¿«ä¹çš„æ—¶å…‰ï¼Œé‚£ä¹ˆä¸‹åŠå¹´å¼€å­¦åï¼Œå°±æ˜¯æˆ‘ç›®å‰ä¸ºæ­¢æœ€ç—›è‹¦çš„æ—¥å­äº†ã€‚ä½†æ— è®ºæ˜¯å‰åå“ªä¸ªé˜¶æ®µï¼Œæˆ‘å…¶å®éƒ½æˆé•¿äº†éå¸¸å¤šï¼Œä¹Ÿç®—æ˜¯å€¼å¾—åº†å¹¸çš„äº‹ï¼Œèƒ½å¤Ÿåœ¨æ¥å—åˆ°ç¤¾ä¼šæ­£å¼çš„æ¯’æ‰“ä¹‹å‰ï¼Œæå‰æˆé•¿ã€‚\n\nä¸€æ–¹é¢çš„å‹åŠ›æ¥è‡ªäºè¯¾ç¨‹ï¼Œæ¯•ç«Ÿæˆ‘æ˜¯å±äºè·¨ä¸“ä¸šä¿ç ”åˆ°äº†è®¾åˆ›ï¼Œéš¾å…åœ¨ç ”ç©¶ç”Ÿé˜¶æ®µè¦æ¥è§¦åˆ°è®¾è®¡ç›¸å…³çš„è¯¾ç¨‹ã€‚åœ¨ç»„é˜Ÿä¸Šï¼Œå¤©çœŸåœ°ä»¥ä¸ºè€å¸ˆæ˜¯æŠ€æœ¯èƒŒæ™¯å‡ºèº«çš„ï¼Œé¡¹ç›®å¯èƒ½ä¹Ÿä¼šæ˜¯ï¼Œç»“æœå°±æ˜¯åœ¨è¯¾ç¨‹é¡¹ç›®ä¸Šè¢«è®¾è®¡èƒŒæ™¯çš„åŒå­¦åŠæ‰“ã€‚åœ¨ DDL å‰ç–¯ç‹‚çˆ†è‚ï¼Œä½†æ˜¯ä¹Ÿæ¢ä¸æ¥ç‰¹åˆ«é«˜çš„æˆç»©ã€‚ç ”ç©¶ç”Ÿè¯¾ç¨‹ä¸­æ²¡èƒ½æŠ±ä¸Šè®¾è®¡å¤§ä½¬ä»¬çš„å¤§è…¿ï¼Œæ²¡ä½“éªŒä¸€æ¬¡è¢«å¸¦é£çš„æ„Ÿè§‰ï¼Œç®—æ˜¯æ¯”è¾ƒå¯æƒœçš„äº†ã€‚\n\nå¦ä¸€æ–¹é¢æœ€å¤§çš„å‹åŠ›æ¥è‡ªäºå®éªŒå®¤ã€‚å¤§è€æ¿çš„ç—›éª‚ç¡®å®æ˜¯æœ‰æ•ˆçš„ã€‚åšäº‹ä¸å¤Ÿæ·±å…¥çš„é—®é¢˜ï¼Œåœ¨æˆ‘ä¹‹å‰çš„é¢è¯•ä»¥åŠå®ä¹ è¿‡ç¨‹ä¸­ï¼Œéƒ½å¤šæ¬¡è¢«å‰è¾ˆä»¬æåˆ°è¿‡ï¼Œä½†éƒ½é‡‡ç”¨ç›¸å¯¹å’Œè”¼çš„è¯­æ°”å’Œæ€åº¦ã€‚æˆ‘ä¹Ÿæ˜¯å±å®æœ‰ç‚¹æŠ–mäº†ï¼Œè¿™ç§ä¸ç—›ä¸ç—’çš„æ‰¹è¯„æ ¹æœ¬ä¸å¾€å¿ƒé‡Œå»ï¼Œä¹Ÿæ²¡æœ‰å‘è‡ªå†…å¿ƒåœ°å»çº æ­£è‡ªå·±çš„é—®é¢˜ï¼Œéè¦ç­‰åˆ°ç°åœ¨çš„å¤§è€æ¿çˆ†éª‚è‡ªå·±ï¼Œè‡ªå·±æ‰æ„è¯†åˆ°é—®é¢˜ã€‚ã€‚ã€‚\n\nå¹´æœ«åˆ°22å¹´åˆçš„çŠ¶æ€ç¡®å®ä¸å¤ªå¥½ï¼Œä¼¼ä¹æ¯å¹´çš„è¿™æ®µæ—¶é—´éƒ½å¾ˆemoã€‚åœ¨å¹´åº•DDLç»“æŸä¹‹åï¼Œè‡ªå·±çš„èŠ‚å¥ä¸€æ—¶é—´ä¹Ÿæ²¡è°ƒæ•´è¿‡æ¥ã€‚é—²ä¸‹æ¥ä»¥åï¼Œè„‘å­æ˜æ˜æ²‰æ²‰ï¼Œæ²¡äº†ç›®æ ‡ï¼Œæä¸æ¸…æ¥šè‡ªå·±çœŸæ­£æƒ³è¦ä»€ä¹ˆï¼Œä¸è®¨äººå–œæ¬¢ã€‚æœ€åä¹Ÿç®—é€ æˆäº†ä¸å¯å¼¥è¡¥çš„é”™è¯¯å§ï¼Œéå¸¸å¯æƒœã€‚ä¸è¿‡ï¼Œäººå„æœ‰å‘½å§ï¼Œä¹Ÿå­¦ä¹ åˆ°äº†å¾ˆå¤šï¼Œå‰åç›¸æ¯”ï¼Œç®—æ˜¯æˆç†Ÿäº†å¾ˆå¤šäº†ã€‚\n\næ‹–æ‹–æ‹‰æ‹‰ï¼Œå†™å®Œè¿™ç¯‡æ€»ç»“çš„æ—¶å€™ï¼Œ2022å¹´éƒ½å·²ç»è¿‡å»å››åˆ†ä¹‹ä¸€äº†ã€‚æ€»çš„æ¥è¯´ï¼Œ2022å¹´å¯ä»¥ç”¨â€œç¿»å¤©è¦†åœ°â€è¿™ä¸ªè¯æ¥æ¦‚æ‹¬ï¼Œåœ¨è¿™ä¸ªç—›è‹¦çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè§åˆ°äº†ä¸€ä¸ªä¸ä¸€æ ·çš„è‡ªå·±ã€‚è™½ç„¶2022å¹´çš„å¼€ç«¯ä¸ç®—é¡ºåˆ©ï¼Œå¾ˆå¤±è´¥ï¼Œä½†è¿™äº›é—®é¢˜å°±ç•™åˆ°æ˜å¹´çš„æ€»ç»“ä¸­æ¥å†™å§ã€‚æœ€åï¼Œå¸Œæœ›åœ¨2023å¹´æ€»ç»“ä»Šå¹´çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæ›´åŠ å¼€å¿ƒçš„å…³é”®è¯å§ã€‚","slug":"2021","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"cl5i8k7xv00011rpf5tmzbz9z","content":"<p>2021å¹´è¿™ä¸€å¹´çš„æ—¶é—´é‡Œï¼Œå‘ç”Ÿäº†å¤ªå¤šçš„äº‹ï¼Œå¦‚æœä¸å†™ä¸‹æ¥çš„è¯ï¼Œåœ¨è„‘æµ·ä¸­åªä¼šæœ‰ä¸€äº›æ¨¡ç³Šçš„å°è±¡ï¼Œä¸æ¸…æ¥šè‡ªå·±å–å¾—äº†å“ªäº›æˆç»©ï¼Œåˆæœ‰å“ªé‡Œä¸å°½äººæ„ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä»ä¸€ä¸ªæ—è§‚è€…çš„è§†è§’ï¼Œæ¥è§‚å¯Ÿè‡ªå·±è¿™ä¸€å¹´æœ‰æ²¡æœ‰è™šåº¦å…‰é˜´ã€‚æ‰€ä»¥ï¼Œå°±ä»2021å¹´å¼€å§‹ï¼Œå¼€å§‹æ¯å¹´å¯¹è¿‡å»çš„ä¸€å¹´è¿›è¡Œä¸€ä¸ªè®°å½•å§~</p>\n<h2 id=\"æŠ€æœ¯\"><a href=\"#æŠ€æœ¯\" class=\"headerlink\" title=\"æŠ€æœ¯\"></a>æŠ€æœ¯</h2><h3 id=\"K8s\"><a href=\"#K8s\" class=\"headerlink\" title=\"K8s\"></a>K8s</h3><p>åœ¨å¹´åˆçš„æ—¶å€™ï¼Œé˜…è¯»äº†ã€ŠKubernetes in Actionã€‹è¿™æœ¬ä¹¦ï¼Œå—ç›ŠåŒªæµ…ï¼Œå†åŠ ä¸Šå®ä¹ ä¸­çš„å®è·µï¼Œå¯¹ K8s çš„äº†è§£æ›´åŠ æ·±å…¥äº†ã€‚K8s ä½œä¸ºç›®å‰ Cloud çš„å®é™…ä»£åè¯ï¼Œåœ¨åº”ç”¨å¼€å‘ä¸­å·²ç»æ˜¯æ— æ³•æ›¿ä»£çš„å­˜åœ¨äº†ã€‚ä½œä¸ºäº‘åŸç”Ÿçš„åŸºç¡€è®¾æ–½ï¼Œå¯¹äº K8s çš„å­¦ä¹ ï¼Œé™¤äº†æŒæ¡å…¶åŸºç¡€çš„æ“ä½œï¼Œä¾‹å¦‚ Deploymentã€Ingress ç­‰ç­‰ç»„ä»¶çš„ä½¿ç”¨ï¼Œæ¥æ»¡è¶³ä¸Šå±‚çš„åº”ç”¨å¼€å‘ä»¥å¤–ï¼Œå¯¹äº K8s æœ¬èº«çš„å­¦ä¹ ï¼Œä¹Ÿæ˜¯ååˆ†é‡è¦çš„ã€‚å› ä¸º K8s æœ¬èº«å°±æ˜¯ä¸€ä¸ªåºå¤§å¤æ‚çš„ç³»ç»Ÿï¼Œè€Œä¸”ç»è¿‡æ— æ•°ä¸šç•Œå¤§ä½¬çš„æ‰“ç£¨ï¼Œç³»ç»Ÿä¸Šçš„è®¾è®¡æ— ç–‘æ˜¯å¾ˆå¤šé—®é¢˜çš„ best practiceã€‚æ·±å…¥ç†è§£ K8s çš„è®¾è®¡ï¼Œå¯¹äºæœªæ¥è®¾è®¡è‡ªå·±çš„åº”ç”¨æ¶æ„è‚¯å®šä¼šå¸¦æ¥å¾ˆå¤§çš„å¸®åŠ©ã€‚</p>\n<h3 id=\"è‡ªåŠ¨åŒ–éƒ¨ç½²\"><a href=\"#è‡ªåŠ¨åŒ–éƒ¨ç½²\" class=\"headerlink\" title=\"è‡ªåŠ¨åŒ–éƒ¨ç½²\"></a>è‡ªåŠ¨åŒ–éƒ¨ç½²</h3><p>æˆ‘åœ¨å®ä¹ æœŸé—´è´Ÿè´£çš„ä¸»è¦çš„ä¸€éƒ¨åˆ†å†…å®¹å°±æ˜¯è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚éšç€ç°åœ¨å¾®æœåŠ¡åŒ–çš„è¶‹åŠ¿ä»¥åŠç³»ç»Ÿå†…ç¬¬ä¸‰æ–¹ä¾èµ–ç»„ä»¶çš„æ•°é‡çš„å¢åŠ ï¼Œéƒ¨ç½²å…¶å®æ˜¯ä¸€ä¸ªéå¸¸éº»çƒ¦çš„é—®é¢˜ã€‚åœ¨å…¬æœ‰äº‘çš„åœºæ™¯ä¸‹ï¼Œéƒ¨åˆ†ç¬¬ä¸‰æ–¹ç»„ä»¶æˆ–è®¸å¯ä»¥é€šè¿‡å¤–éƒ¨æœåŠ¡çš„å½¢å¼è§£å†³ã€‚ä½†åœ¨ç§æœ‰äº‘çš„æƒ…å†µä¸‹ï¼Œéƒ¨ç½²éœ€è¦åŒæ—¶éƒ¨ç½²è¿™äº›ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œæ— ç–‘ç»™éƒ¨ç½²å¢åŠ äº†å¾ˆå¤§çš„å¤æ‚åº¦ã€‚ä¸ä»…ä»…å¦‚æ­¤ï¼Œå¯¹äºä»»ä½•ç°ä»£åŒ–çš„è½¯ä»¶æ¥è¯´ï¼Œéƒ¨ç½²éƒ½æ˜¯éœ€è¦è¿›è¡Œæ ‡å‡†åŒ–çš„ã€‚é€šè¿‡éƒ¨ç½²æ–‡æ¡£ï¼Œç±»ä¼¼æ‰‹å·¥ä½œåŠè¿›è¡Œçš„éƒ¨ç½²æ–¹å¼ï¼Œæ˜¯æ— æ³•æŒä¹…çš„ï¼Œäººå› çš„é”™è¯¯æ˜¯æ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹ä¸­å¾ˆå¤§çš„ä¸ç¨³å®šå› ç´ ã€‚è¿™æ–¹é¢ä¹Ÿæœ‰å¾ˆå¤šåšçš„æ¯”è¾ƒå¥½çš„å¼€æºé¡¹ç›®ï¼Œæ¯”å¦‚è¯´ TiDB çš„ TiUP ç­‰ç­‰ã€‚</p>\n<h3 id=\"å¯è§†åŒ–\"><a href=\"#å¯è§†åŒ–\" class=\"headerlink\" title=\"å¯è§†åŒ–\"></a>å¯è§†åŒ–</h3><p>å®è¯è¯´ï¼Œåœ¨æ­£å¼è¿›å…¥ç¡•å£«å­¦ä¹ ä¹‹å‰ï¼Œæˆ‘å¯¹äºå¯è§†åŒ–çš„äº†è§£å¯èƒ½éƒ½æ¯”è¾ƒæµ…è–„ï¼ˆè™½ç„¶æ˜çŸ¥é“è¿™æ˜¯è‡ªå·±ç¡•å£«çš„ç ”ç©¶æ–¹å‘ï¼‰ã€‚åœ¨å¬å®Œå¤§è€æ¿çš„è¯¾ä¹‹åï¼Œå¯¹äºè¿™ä¸ªé¢†åŸŸæœ‰äº†å…¨æ–°çš„è®¤çŸ¥ã€‚å¯è§†åŒ–è¿™ä¸ªé¢†åŸŸè™½ç„¶å¾ˆå°ï¼Œä½†å¹¶ä¸æ˜¯åƒå¤§ä¼—è®¤ä¸ºçš„åªæœ‰ç®€å•çš„å›¾è¡¨è€Œå·²ã€‚é¦–å…ˆï¼Œå›¾è¡¨æœ¬èº«çš„è®¾è®¡æœ‰ç€å¾ˆå¤šé—®é¢˜å€¼å¾—ç ”ç©¶ã€‚è®¾è®¡å¯èƒ½æ˜¯ä¸€ä¸ªä¸»è§‚æ„Ÿæ€§çš„è¡Œä¸ºï¼Œä½†æˆ‘å¤§è€æ¿çš„æƒ³æ³•æ˜¯é€šè¿‡design spaceç­‰æ–¹å¼ï¼Œå°†å…¶è½¬åŒ–ä¸ºç†æ€§ï¼Œæœ‰é€»è¾‘çš„è¡Œä¸ºã€‚æˆ‘å¯¹è¿™ä¸€ç‚¹éå¸¸è®¤åŒï¼Œç»™äº†æˆ‘ä¸€ç§èŒ…å¡é¡¿å¼€çš„æ„Ÿè§‰ï¼Œè®©æˆ‘å¯¹ä¹‹å‰å¾ˆå¤šçœ‹ä¼¼æ„Ÿæ€§çš„äº‹æƒ…æœ‰äº†æ–°çš„ç†è§£ã€‚å…¶æ¬¡ï¼Œå¯è§†åˆ†æä¹Ÿæ˜¯å¯è§†åŒ–ä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚å¾ˆå¤šé—®é¢˜ï¼Œé€šè¿‡å¯è§†åŒ–çš„å½¢å¼ï¼Œå°±å¯ä»¥å¾ˆæ¸…æ¥šå’Œå®¹æ˜“åœ°è¢«åˆ†æå‡ºæ¥ã€‚è¿™ä¸€ç±»ç³»ç»Ÿï¼Œæ„Ÿè§‰åœ¨ BI é¢†åŸŸåº”è¯¥æœ‰å¾ˆå¤§çš„å‘å±•ç©ºé—´ã€‚</p>\n<h3 id=\"Casbin\"><a href=\"#Casbin\" class=\"headerlink\" title=\"Casbin\"></a>Casbin</h3><p>ä¸€ç›´ä»¥æ¥æƒ³åŠ å…¥ä¸€ä¸ªå¼€æºç¤¾åŒºï¼Œä¸º developer ä»¬åšå‡ºä¸€ç‚¹ç‚¹è‡ªå·±çš„è´¡çŒ®ã€‚äºæ˜¯é€šè¿‡ä¸€ä¸ªæ´»åŠ¨åŠ å…¥åˆ°äº† Casbinç¤¾åŒºã€‚Casbin æ˜¯ä¸€ä¸ªæƒé™æ ¡éªŒæ¡†æ¶ï¼Œé€šè¿‡ well-defined çš„ model ç»“æ„ï¼Œæ”¯æŒå¯¹å„ç§ç±»å‹çš„æ ¡éªŒæ¨¡å¼ï¼ˆæ¯”å¦‚RBACï¼ŒABACç­‰ç­‰ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è§‰å¾— Casbin èƒ½å¤Ÿè·å¾— 10k+ star çš„å¦ä¸€ä¸ªåŸå› æ˜¯ä»–çš„ç”Ÿæ€æ”¯æŒä¹Ÿå¤ªä¸°å¯Œäº†ã€‚å„ç§è¯­è¨€ï¼Œå„ç§å‰ç«¯åç«¯æ¡†æ¶ï¼Œå„ç§æ•°æ®åº“ï¼Œåªè¦æ˜¯æœ‰éœ€æ±‚ï¼Œéƒ½ä¼šè¿›è¡Œæ”¯æŒã€‚å…¶ä¸­å¦ä¸€ä¸ªæœ€é‡è¦çš„åº”è¯¥æ˜¯ Casdoorï¼Œä¸€ä¸ªç¬¬ä¸‰æ–¹ç»Ÿä¸€èº«ä»½è®¤è¯æ¡†æ¶ï¼Œä¸ KeyCloak ç›¸å¯¹æ ‡ã€‚</p>\n<p>è¿™ä¸¤ä¸ªé¡¹ç›®éƒ½éå¸¸æœ‰æ„ä¹‰ï¼ŒCasbin ä¸»è¦æ˜¯åƒä¸€ä¸ªè§£æå™¨ä¸€æ ·ï¼Œé¢å¯¹ä¸åŒçš„ model å’Œ policyå®šä¹‰ï¼Œéœ€è¦æä¾›æ­£ç¡®çš„æ ¡éªŒç»“æœï¼Œæˆ‘ä¸ªäººè¿˜æŒºå–œæ¬¢æ…¢æ…¢æ¨ç†ï¼Œå¯»æ‰¾å“ªä¸€æ­¥è§£æé”™è¯¯çš„è¿‡ç¨‹ã€‚è€Œ Casdoor åˆ™åƒä¸€ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œå¦‚ä½•å®ç°æ›´å¤šçš„ featureï¼Œå¦‚ä½•æå‡æ˜“ç”¨æ€§ï¼Œä¸æ›´å¤šçš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿè¿›è¡Œé›†æˆã€‚</p>\n<h3 id=\"Other\"><a href=\"#Other\" class=\"headerlink\" title=\"Other\"></a>Other</h3><p>é™¤æ­¤ä¹‹å‰ï¼Œè¿™ä¸€å¹´é—´ä¹Ÿå¤šå¤šå°‘å°‘æ¥è§¦äº†å¾ˆå¤šå…¶ä»–æŠ€æœ¯ã€‚å®ä¹ çš„æ—¶å€™æ— æ‰€äº‹äº‹ï¼Œå¼€å§‹å†™èµ·æ¥äº† Augularï¼Œä½“éªŒäº†ä¸€æ¬¡åƒ Java ä¸€æ ·çš„å‰ç«¯çš„å¼€å‘æ¨¡å¼ï¼›æš‘å‡çš„æ—¶å€™å‚åŠ  GSoCï¼Œå€Ÿæœºæ¥è§¦äº†ä¸€ä¸‹ Rustï¼Œå¯¹è¿™é—¨è¯­è¨€äº§ç”Ÿäº†æ·±æ·±çš„æ•¬ç•ï¼Œä½†å¯æƒœæ²¡èƒ½æ·±å…¥å­¦ä¹ ä¸‹å»ï¼›å¼€å­¦ä»¥åæ¥è§¦äº†å¾ˆå¤šè®¾è®¡é¢†åŸŸçš„codingï¼Œåšäº†ä¸€äº›æ•°å­—åª’ä½“ç±»ä¼¼çš„è¯¾ç¨‹ä½œä¸šâ€¦â€¦</p>\n<h2 id=\"ç”Ÿæ´»\"><a href=\"#ç”Ÿæ´»\" class=\"headerlink\" title=\"ç”Ÿæ´»\"></a>ç”Ÿæ´»</h2><p>ä¸ŠåŠå¹´å®ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œæ„Ÿè§‰è‡ªå·±é€æ¸æ”¾å¼€äº†ã€‚åœ¨å®ä¹ æœŸé—´é‡åˆ°äº†å¾ˆå¤šä¼™ä¼´ï¼Œå¤§å®¶ä¸€èµ·å¿«ä¹æ‘¸é±¼ï¼ŒçœŸçš„æ˜¯åº¦è¿‡äº†ä¸€æ®µå¾ˆå¿«ä¹çš„æ—¶å…‰ã€‚æœ€é‡è¦çš„æ˜¯æ¯•ä¸šå•¦ï¼æœ€é«˜å­¦å†ç»ˆäºä»é«˜ä¸­å˜æˆäº†æœ¬ç§‘ã€‚è™½ç„¶æ¯•ä¸šæ—…è¡Œå› ä¸ºç–«æƒ…åŸå› æ²¡èƒ½æˆè¡Œï¼Œä½†æš‘å‡åœ¨å®¶å¿«ä¹æ‘¸é±¼ï¼Œç–¯ç‹‚é”»ç‚¼çŒé¾™æŠ€æœ¯ï¼Œè¿˜å·®ä¸€ç‚¹æŠŠå¡å°”è¾¾çš„å‘€å“ˆå“ˆå…¨æ”¶é›†ï¼Œä¹Ÿç®—å¿«ä¹çš„åº¦è¿‡äº†æœ€åä¸€ä¸ªæš‘å‡äº†ã€‚</p>\n<p>å¦‚æœè¯´ä¸ŠåŠå¹´æ˜¯æˆ‘äººç”Ÿæœ€å¿«ä¹çš„æ—¶å…‰ï¼Œé‚£ä¹ˆä¸‹åŠå¹´å¼€å­¦åï¼Œå°±æ˜¯æˆ‘ç›®å‰ä¸ºæ­¢æœ€ç—›è‹¦çš„æ—¥å­äº†ã€‚ä½†æ— è®ºæ˜¯å‰åå“ªä¸ªé˜¶æ®µï¼Œæˆ‘å…¶å®éƒ½æˆé•¿äº†éå¸¸å¤šï¼Œä¹Ÿç®—æ˜¯å€¼å¾—åº†å¹¸çš„äº‹ï¼Œèƒ½å¤Ÿåœ¨æ¥å—åˆ°ç¤¾ä¼šæ­£å¼çš„æ¯’æ‰“ä¹‹å‰ï¼Œæå‰æˆé•¿ã€‚</p>\n<p>ä¸€æ–¹é¢çš„å‹åŠ›æ¥è‡ªäºè¯¾ç¨‹ï¼Œæ¯•ç«Ÿæˆ‘æ˜¯å±äºè·¨ä¸“ä¸šä¿ç ”åˆ°äº†è®¾åˆ›ï¼Œéš¾å…åœ¨ç ”ç©¶ç”Ÿé˜¶æ®µè¦æ¥è§¦åˆ°è®¾è®¡ç›¸å…³çš„è¯¾ç¨‹ã€‚åœ¨ç»„é˜Ÿä¸Šï¼Œå¤©çœŸåœ°ä»¥ä¸ºè€å¸ˆæ˜¯æŠ€æœ¯èƒŒæ™¯å‡ºèº«çš„ï¼Œé¡¹ç›®å¯èƒ½ä¹Ÿä¼šæ˜¯ï¼Œç»“æœå°±æ˜¯åœ¨è¯¾ç¨‹é¡¹ç›®ä¸Šè¢«è®¾è®¡èƒŒæ™¯çš„åŒå­¦åŠæ‰“ã€‚åœ¨ DDL å‰ç–¯ç‹‚çˆ†è‚ï¼Œä½†æ˜¯ä¹Ÿæ¢ä¸æ¥ç‰¹åˆ«é«˜çš„æˆç»©ã€‚ç ”ç©¶ç”Ÿè¯¾ç¨‹ä¸­æ²¡èƒ½æŠ±ä¸Šè®¾è®¡å¤§ä½¬ä»¬çš„å¤§è…¿ï¼Œæ²¡ä½“éªŒä¸€æ¬¡è¢«å¸¦é£çš„æ„Ÿè§‰ï¼Œç®—æ˜¯æ¯”è¾ƒå¯æƒœçš„äº†ã€‚</p>\n<p>å¦ä¸€æ–¹é¢æœ€å¤§çš„å‹åŠ›æ¥è‡ªäºå®éªŒå®¤ã€‚å¤§è€æ¿çš„ç—›éª‚ç¡®å®æ˜¯æœ‰æ•ˆçš„ã€‚åšäº‹ä¸å¤Ÿæ·±å…¥çš„é—®é¢˜ï¼Œåœ¨æˆ‘ä¹‹å‰çš„é¢è¯•ä»¥åŠå®ä¹ è¿‡ç¨‹ä¸­ï¼Œéƒ½å¤šæ¬¡è¢«å‰è¾ˆä»¬æåˆ°è¿‡ï¼Œä½†éƒ½é‡‡ç”¨ç›¸å¯¹å’Œè”¼çš„è¯­æ°”å’Œæ€åº¦ã€‚æˆ‘ä¹Ÿæ˜¯å±å®æœ‰ç‚¹æŠ–mäº†ï¼Œè¿™ç§ä¸ç—›ä¸ç—’çš„æ‰¹è¯„æ ¹æœ¬ä¸å¾€å¿ƒé‡Œå»ï¼Œä¹Ÿæ²¡æœ‰å‘è‡ªå†…å¿ƒåœ°å»çº æ­£è‡ªå·±çš„é—®é¢˜ï¼Œéè¦ç­‰åˆ°ç°åœ¨çš„å¤§è€æ¿çˆ†éª‚è‡ªå·±ï¼Œè‡ªå·±æ‰æ„è¯†åˆ°é—®é¢˜ã€‚ã€‚ã€‚</p>\n<p>å¹´æœ«åˆ°22å¹´åˆçš„çŠ¶æ€ç¡®å®ä¸å¤ªå¥½ï¼Œä¼¼ä¹æ¯å¹´çš„è¿™æ®µæ—¶é—´éƒ½å¾ˆemoã€‚åœ¨å¹´åº•DDLç»“æŸä¹‹åï¼Œè‡ªå·±çš„èŠ‚å¥ä¸€æ—¶é—´ä¹Ÿæ²¡è°ƒæ•´è¿‡æ¥ã€‚é—²ä¸‹æ¥ä»¥åï¼Œè„‘å­æ˜æ˜æ²‰æ²‰ï¼Œæ²¡äº†ç›®æ ‡ï¼Œæä¸æ¸…æ¥šè‡ªå·±çœŸæ­£æƒ³è¦ä»€ä¹ˆï¼Œä¸è®¨äººå–œæ¬¢ã€‚æœ€åä¹Ÿç®—é€ æˆäº†ä¸å¯å¼¥è¡¥çš„é”™è¯¯å§ï¼Œéå¸¸å¯æƒœã€‚ä¸è¿‡ï¼Œäººå„æœ‰å‘½å§ï¼Œä¹Ÿå­¦ä¹ åˆ°äº†å¾ˆå¤šï¼Œå‰åç›¸æ¯”ï¼Œç®—æ˜¯æˆç†Ÿäº†å¾ˆå¤šäº†ã€‚</p>\n<p>æ‹–æ‹–æ‹‰æ‹‰ï¼Œå†™å®Œè¿™ç¯‡æ€»ç»“çš„æ—¶å€™ï¼Œ2022å¹´éƒ½å·²ç»è¿‡å»å››åˆ†ä¹‹ä¸€äº†ã€‚æ€»çš„æ¥è¯´ï¼Œ2022å¹´å¯ä»¥ç”¨â€œç¿»å¤©è¦†åœ°â€è¿™ä¸ªè¯æ¥æ¦‚æ‹¬ï¼Œåœ¨è¿™ä¸ªç—›è‹¦çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè§åˆ°äº†ä¸€ä¸ªä¸ä¸€æ ·çš„è‡ªå·±ã€‚è™½ç„¶2022å¹´çš„å¼€ç«¯ä¸ç®—é¡ºåˆ©ï¼Œå¾ˆå¤±è´¥ï¼Œä½†è¿™äº›é—®é¢˜å°±ç•™åˆ°æ˜å¹´çš„æ€»ç»“ä¸­æ¥å†™å§ã€‚æœ€åï¼Œå¸Œæœ›åœ¨2023å¹´æ€»ç»“ä»Šå¹´çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæ›´åŠ å¼€å¿ƒçš„å…³é”®è¯å§ã€‚</p>\n","site":{"data":{}},"excerpt":"","more":"<p>2021å¹´è¿™ä¸€å¹´çš„æ—¶é—´é‡Œï¼Œå‘ç”Ÿäº†å¤ªå¤šçš„äº‹ï¼Œå¦‚æœä¸å†™ä¸‹æ¥çš„è¯ï¼Œåœ¨è„‘æµ·ä¸­åªä¼šæœ‰ä¸€äº›æ¨¡ç³Šçš„å°è±¡ï¼Œä¸æ¸…æ¥šè‡ªå·±å–å¾—äº†å“ªäº›æˆç»©ï¼Œåˆæœ‰å“ªé‡Œä¸å°½äººæ„ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä»ä¸€ä¸ªæ—è§‚è€…çš„è§†è§’ï¼Œæ¥è§‚å¯Ÿè‡ªå·±è¿™ä¸€å¹´æœ‰æ²¡æœ‰è™šåº¦å…‰é˜´ã€‚æ‰€ä»¥ï¼Œå°±ä»2021å¹´å¼€å§‹ï¼Œå¼€å§‹æ¯å¹´å¯¹è¿‡å»çš„ä¸€å¹´è¿›è¡Œä¸€ä¸ªè®°å½•å§~</p>\n<h2 id=\"æŠ€æœ¯\"><a href=\"#æŠ€æœ¯\" class=\"headerlink\" title=\"æŠ€æœ¯\"></a>æŠ€æœ¯</h2><h3 id=\"K8s\"><a href=\"#K8s\" class=\"headerlink\" title=\"K8s\"></a>K8s</h3><p>åœ¨å¹´åˆçš„æ—¶å€™ï¼Œé˜…è¯»äº†ã€ŠKubernetes in Actionã€‹è¿™æœ¬ä¹¦ï¼Œå—ç›ŠåŒªæµ…ï¼Œå†åŠ ä¸Šå®ä¹ ä¸­çš„å®è·µï¼Œå¯¹ K8s çš„äº†è§£æ›´åŠ æ·±å…¥äº†ã€‚K8s ä½œä¸ºç›®å‰ Cloud çš„å®é™…ä»£åè¯ï¼Œåœ¨åº”ç”¨å¼€å‘ä¸­å·²ç»æ˜¯æ— æ³•æ›¿ä»£çš„å­˜åœ¨äº†ã€‚ä½œä¸ºäº‘åŸç”Ÿçš„åŸºç¡€è®¾æ–½ï¼Œå¯¹äº K8s çš„å­¦ä¹ ï¼Œé™¤äº†æŒæ¡å…¶åŸºç¡€çš„æ“ä½œï¼Œä¾‹å¦‚ Deploymentã€Ingress ç­‰ç­‰ç»„ä»¶çš„ä½¿ç”¨ï¼Œæ¥æ»¡è¶³ä¸Šå±‚çš„åº”ç”¨å¼€å‘ä»¥å¤–ï¼Œå¯¹äº K8s æœ¬èº«çš„å­¦ä¹ ï¼Œä¹Ÿæ˜¯ååˆ†é‡è¦çš„ã€‚å› ä¸º K8s æœ¬èº«å°±æ˜¯ä¸€ä¸ªåºå¤§å¤æ‚çš„ç³»ç»Ÿï¼Œè€Œä¸”ç»è¿‡æ— æ•°ä¸šç•Œå¤§ä½¬çš„æ‰“ç£¨ï¼Œç³»ç»Ÿä¸Šçš„è®¾è®¡æ— ç–‘æ˜¯å¾ˆå¤šé—®é¢˜çš„ best practiceã€‚æ·±å…¥ç†è§£ K8s çš„è®¾è®¡ï¼Œå¯¹äºæœªæ¥è®¾è®¡è‡ªå·±çš„åº”ç”¨æ¶æ„è‚¯å®šä¼šå¸¦æ¥å¾ˆå¤§çš„å¸®åŠ©ã€‚</p>\n<h3 id=\"è‡ªåŠ¨åŒ–éƒ¨ç½²\"><a href=\"#è‡ªåŠ¨åŒ–éƒ¨ç½²\" class=\"headerlink\" title=\"è‡ªåŠ¨åŒ–éƒ¨ç½²\"></a>è‡ªåŠ¨åŒ–éƒ¨ç½²</h3><p>æˆ‘åœ¨å®ä¹ æœŸé—´è´Ÿè´£çš„ä¸»è¦çš„ä¸€éƒ¨åˆ†å†…å®¹å°±æ˜¯è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚éšç€ç°åœ¨å¾®æœåŠ¡åŒ–çš„è¶‹åŠ¿ä»¥åŠç³»ç»Ÿå†…ç¬¬ä¸‰æ–¹ä¾èµ–ç»„ä»¶çš„æ•°é‡çš„å¢åŠ ï¼Œéƒ¨ç½²å…¶å®æ˜¯ä¸€ä¸ªéå¸¸éº»çƒ¦çš„é—®é¢˜ã€‚åœ¨å…¬æœ‰äº‘çš„åœºæ™¯ä¸‹ï¼Œéƒ¨åˆ†ç¬¬ä¸‰æ–¹ç»„ä»¶æˆ–è®¸å¯ä»¥é€šè¿‡å¤–éƒ¨æœåŠ¡çš„å½¢å¼è§£å†³ã€‚ä½†åœ¨ç§æœ‰äº‘çš„æƒ…å†µä¸‹ï¼Œéƒ¨ç½²éœ€è¦åŒæ—¶éƒ¨ç½²è¿™äº›ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œæ— ç–‘ç»™éƒ¨ç½²å¢åŠ äº†å¾ˆå¤§çš„å¤æ‚åº¦ã€‚ä¸ä»…ä»…å¦‚æ­¤ï¼Œå¯¹äºä»»ä½•ç°ä»£åŒ–çš„è½¯ä»¶æ¥è¯´ï¼Œéƒ¨ç½²éƒ½æ˜¯éœ€è¦è¿›è¡Œæ ‡å‡†åŒ–çš„ã€‚é€šè¿‡éƒ¨ç½²æ–‡æ¡£ï¼Œç±»ä¼¼æ‰‹å·¥ä½œåŠè¿›è¡Œçš„éƒ¨ç½²æ–¹å¼ï¼Œæ˜¯æ— æ³•æŒä¹…çš„ï¼Œäººå› çš„é”™è¯¯æ˜¯æ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹ä¸­å¾ˆå¤§çš„ä¸ç¨³å®šå› ç´ ã€‚è¿™æ–¹é¢ä¹Ÿæœ‰å¾ˆå¤šåšçš„æ¯”è¾ƒå¥½çš„å¼€æºé¡¹ç›®ï¼Œæ¯”å¦‚è¯´ TiDB çš„ TiUP ç­‰ç­‰ã€‚</p>\n<h3 id=\"å¯è§†åŒ–\"><a href=\"#å¯è§†åŒ–\" class=\"headerlink\" title=\"å¯è§†åŒ–\"></a>å¯è§†åŒ–</h3><p>å®è¯è¯´ï¼Œåœ¨æ­£å¼è¿›å…¥ç¡•å£«å­¦ä¹ ä¹‹å‰ï¼Œæˆ‘å¯¹äºå¯è§†åŒ–çš„äº†è§£å¯èƒ½éƒ½æ¯”è¾ƒæµ…è–„ï¼ˆè™½ç„¶æ˜çŸ¥é“è¿™æ˜¯è‡ªå·±ç¡•å£«çš„ç ”ç©¶æ–¹å‘ï¼‰ã€‚åœ¨å¬å®Œå¤§è€æ¿çš„è¯¾ä¹‹åï¼Œå¯¹äºè¿™ä¸ªé¢†åŸŸæœ‰äº†å…¨æ–°çš„è®¤çŸ¥ã€‚å¯è§†åŒ–è¿™ä¸ªé¢†åŸŸè™½ç„¶å¾ˆå°ï¼Œä½†å¹¶ä¸æ˜¯åƒå¤§ä¼—è®¤ä¸ºçš„åªæœ‰ç®€å•çš„å›¾è¡¨è€Œå·²ã€‚é¦–å…ˆï¼Œå›¾è¡¨æœ¬èº«çš„è®¾è®¡æœ‰ç€å¾ˆå¤šé—®é¢˜å€¼å¾—ç ”ç©¶ã€‚è®¾è®¡å¯èƒ½æ˜¯ä¸€ä¸ªä¸»è§‚æ„Ÿæ€§çš„è¡Œä¸ºï¼Œä½†æˆ‘å¤§è€æ¿çš„æƒ³æ³•æ˜¯é€šè¿‡design spaceç­‰æ–¹å¼ï¼Œå°†å…¶è½¬åŒ–ä¸ºç†æ€§ï¼Œæœ‰é€»è¾‘çš„è¡Œä¸ºã€‚æˆ‘å¯¹è¿™ä¸€ç‚¹éå¸¸è®¤åŒï¼Œç»™äº†æˆ‘ä¸€ç§èŒ…å¡é¡¿å¼€çš„æ„Ÿè§‰ï¼Œè®©æˆ‘å¯¹ä¹‹å‰å¾ˆå¤šçœ‹ä¼¼æ„Ÿæ€§çš„äº‹æƒ…æœ‰äº†æ–°çš„ç†è§£ã€‚å…¶æ¬¡ï¼Œå¯è§†åˆ†æä¹Ÿæ˜¯å¯è§†åŒ–ä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚å¾ˆå¤šé—®é¢˜ï¼Œé€šè¿‡å¯è§†åŒ–çš„å½¢å¼ï¼Œå°±å¯ä»¥å¾ˆæ¸…æ¥šå’Œå®¹æ˜“åœ°è¢«åˆ†æå‡ºæ¥ã€‚è¿™ä¸€ç±»ç³»ç»Ÿï¼Œæ„Ÿè§‰åœ¨ BI é¢†åŸŸåº”è¯¥æœ‰å¾ˆå¤§çš„å‘å±•ç©ºé—´ã€‚</p>\n<h3 id=\"Casbin\"><a href=\"#Casbin\" class=\"headerlink\" title=\"Casbin\"></a>Casbin</h3><p>ä¸€ç›´ä»¥æ¥æƒ³åŠ å…¥ä¸€ä¸ªå¼€æºç¤¾åŒºï¼Œä¸º developer ä»¬åšå‡ºä¸€ç‚¹ç‚¹è‡ªå·±çš„è´¡çŒ®ã€‚äºæ˜¯é€šè¿‡ä¸€ä¸ªæ´»åŠ¨åŠ å…¥åˆ°äº† Casbinç¤¾åŒºã€‚Casbin æ˜¯ä¸€ä¸ªæƒé™æ ¡éªŒæ¡†æ¶ï¼Œé€šè¿‡ well-defined çš„ model ç»“æ„ï¼Œæ”¯æŒå¯¹å„ç§ç±»å‹çš„æ ¡éªŒæ¨¡å¼ï¼ˆæ¯”å¦‚RBACï¼ŒABACç­‰ç­‰ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘è§‰å¾— Casbin èƒ½å¤Ÿè·å¾— 10k+ star çš„å¦ä¸€ä¸ªåŸå› æ˜¯ä»–çš„ç”Ÿæ€æ”¯æŒä¹Ÿå¤ªä¸°å¯Œäº†ã€‚å„ç§è¯­è¨€ï¼Œå„ç§å‰ç«¯åç«¯æ¡†æ¶ï¼Œå„ç§æ•°æ®åº“ï¼Œåªè¦æ˜¯æœ‰éœ€æ±‚ï¼Œéƒ½ä¼šè¿›è¡Œæ”¯æŒã€‚å…¶ä¸­å¦ä¸€ä¸ªæœ€é‡è¦çš„åº”è¯¥æ˜¯ Casdoorï¼Œä¸€ä¸ªç¬¬ä¸‰æ–¹ç»Ÿä¸€èº«ä»½è®¤è¯æ¡†æ¶ï¼Œä¸ KeyCloak ç›¸å¯¹æ ‡ã€‚</p>\n<p>è¿™ä¸¤ä¸ªé¡¹ç›®éƒ½éå¸¸æœ‰æ„ä¹‰ï¼ŒCasbin ä¸»è¦æ˜¯åƒä¸€ä¸ªè§£æå™¨ä¸€æ ·ï¼Œé¢å¯¹ä¸åŒçš„ model å’Œ policyå®šä¹‰ï¼Œéœ€è¦æä¾›æ­£ç¡®çš„æ ¡éªŒç»“æœï¼Œæˆ‘ä¸ªäººè¿˜æŒºå–œæ¬¢æ…¢æ…¢æ¨ç†ï¼Œå¯»æ‰¾å“ªä¸€æ­¥è§£æé”™è¯¯çš„è¿‡ç¨‹ã€‚è€Œ Casdoor åˆ™åƒä¸€ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼Œå¦‚ä½•å®ç°æ›´å¤šçš„ featureï¼Œå¦‚ä½•æå‡æ˜“ç”¨æ€§ï¼Œä¸æ›´å¤šçš„ç¬¬ä¸‰æ–¹ç³»ç»Ÿè¿›è¡Œé›†æˆã€‚</p>\n<h3 id=\"Other\"><a href=\"#Other\" class=\"headerlink\" title=\"Other\"></a>Other</h3><p>é™¤æ­¤ä¹‹å‰ï¼Œè¿™ä¸€å¹´é—´ä¹Ÿå¤šå¤šå°‘å°‘æ¥è§¦äº†å¾ˆå¤šå…¶ä»–æŠ€æœ¯ã€‚å®ä¹ çš„æ—¶å€™æ— æ‰€äº‹äº‹ï¼Œå¼€å§‹å†™èµ·æ¥äº† Augularï¼Œä½“éªŒäº†ä¸€æ¬¡åƒ Java ä¸€æ ·çš„å‰ç«¯çš„å¼€å‘æ¨¡å¼ï¼›æš‘å‡çš„æ—¶å€™å‚åŠ  GSoCï¼Œå€Ÿæœºæ¥è§¦äº†ä¸€ä¸‹ Rustï¼Œå¯¹è¿™é—¨è¯­è¨€äº§ç”Ÿäº†æ·±æ·±çš„æ•¬ç•ï¼Œä½†å¯æƒœæ²¡èƒ½æ·±å…¥å­¦ä¹ ä¸‹å»ï¼›å¼€å­¦ä»¥åæ¥è§¦äº†å¾ˆå¤šè®¾è®¡é¢†åŸŸçš„codingï¼Œåšäº†ä¸€äº›æ•°å­—åª’ä½“ç±»ä¼¼çš„è¯¾ç¨‹ä½œä¸šâ€¦â€¦</p>\n<h2 id=\"ç”Ÿæ´»\"><a href=\"#ç”Ÿæ´»\" class=\"headerlink\" title=\"ç”Ÿæ´»\"></a>ç”Ÿæ´»</h2><p>ä¸ŠåŠå¹´å®ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œæ„Ÿè§‰è‡ªå·±é€æ¸æ”¾å¼€äº†ã€‚åœ¨å®ä¹ æœŸé—´é‡åˆ°äº†å¾ˆå¤šä¼™ä¼´ï¼Œå¤§å®¶ä¸€èµ·å¿«ä¹æ‘¸é±¼ï¼ŒçœŸçš„æ˜¯åº¦è¿‡äº†ä¸€æ®µå¾ˆå¿«ä¹çš„æ—¶å…‰ã€‚æœ€é‡è¦çš„æ˜¯æ¯•ä¸šå•¦ï¼æœ€é«˜å­¦å†ç»ˆäºä»é«˜ä¸­å˜æˆäº†æœ¬ç§‘ã€‚è™½ç„¶æ¯•ä¸šæ—…è¡Œå› ä¸ºç–«æƒ…åŸå› æ²¡èƒ½æˆè¡Œï¼Œä½†æš‘å‡åœ¨å®¶å¿«ä¹æ‘¸é±¼ï¼Œç–¯ç‹‚é”»ç‚¼çŒé¾™æŠ€æœ¯ï¼Œè¿˜å·®ä¸€ç‚¹æŠŠå¡å°”è¾¾çš„å‘€å“ˆå“ˆå…¨æ”¶é›†ï¼Œä¹Ÿç®—å¿«ä¹çš„åº¦è¿‡äº†æœ€åä¸€ä¸ªæš‘å‡äº†ã€‚</p>\n<p>å¦‚æœè¯´ä¸ŠåŠå¹´æ˜¯æˆ‘äººç”Ÿæœ€å¿«ä¹çš„æ—¶å…‰ï¼Œé‚£ä¹ˆä¸‹åŠå¹´å¼€å­¦åï¼Œå°±æ˜¯æˆ‘ç›®å‰ä¸ºæ­¢æœ€ç—›è‹¦çš„æ—¥å­äº†ã€‚ä½†æ— è®ºæ˜¯å‰åå“ªä¸ªé˜¶æ®µï¼Œæˆ‘å…¶å®éƒ½æˆé•¿äº†éå¸¸å¤šï¼Œä¹Ÿç®—æ˜¯å€¼å¾—åº†å¹¸çš„äº‹ï¼Œèƒ½å¤Ÿåœ¨æ¥å—åˆ°ç¤¾ä¼šæ­£å¼çš„æ¯’æ‰“ä¹‹å‰ï¼Œæå‰æˆé•¿ã€‚</p>\n<p>ä¸€æ–¹é¢çš„å‹åŠ›æ¥è‡ªäºè¯¾ç¨‹ï¼Œæ¯•ç«Ÿæˆ‘æ˜¯å±äºè·¨ä¸“ä¸šä¿ç ”åˆ°äº†è®¾åˆ›ï¼Œéš¾å…åœ¨ç ”ç©¶ç”Ÿé˜¶æ®µè¦æ¥è§¦åˆ°è®¾è®¡ç›¸å…³çš„è¯¾ç¨‹ã€‚åœ¨ç»„é˜Ÿä¸Šï¼Œå¤©çœŸåœ°ä»¥ä¸ºè€å¸ˆæ˜¯æŠ€æœ¯èƒŒæ™¯å‡ºèº«çš„ï¼Œé¡¹ç›®å¯èƒ½ä¹Ÿä¼šæ˜¯ï¼Œç»“æœå°±æ˜¯åœ¨è¯¾ç¨‹é¡¹ç›®ä¸Šè¢«è®¾è®¡èƒŒæ™¯çš„åŒå­¦åŠæ‰“ã€‚åœ¨ DDL å‰ç–¯ç‹‚çˆ†è‚ï¼Œä½†æ˜¯ä¹Ÿæ¢ä¸æ¥ç‰¹åˆ«é«˜çš„æˆç»©ã€‚ç ”ç©¶ç”Ÿè¯¾ç¨‹ä¸­æ²¡èƒ½æŠ±ä¸Šè®¾è®¡å¤§ä½¬ä»¬çš„å¤§è…¿ï¼Œæ²¡ä½“éªŒä¸€æ¬¡è¢«å¸¦é£çš„æ„Ÿè§‰ï¼Œç®—æ˜¯æ¯”è¾ƒå¯æƒœçš„äº†ã€‚</p>\n<p>å¦ä¸€æ–¹é¢æœ€å¤§çš„å‹åŠ›æ¥è‡ªäºå®éªŒå®¤ã€‚å¤§è€æ¿çš„ç—›éª‚ç¡®å®æ˜¯æœ‰æ•ˆçš„ã€‚åšäº‹ä¸å¤Ÿæ·±å…¥çš„é—®é¢˜ï¼Œåœ¨æˆ‘ä¹‹å‰çš„é¢è¯•ä»¥åŠå®ä¹ è¿‡ç¨‹ä¸­ï¼Œéƒ½å¤šæ¬¡è¢«å‰è¾ˆä»¬æåˆ°è¿‡ï¼Œä½†éƒ½é‡‡ç”¨ç›¸å¯¹å’Œè”¼çš„è¯­æ°”å’Œæ€åº¦ã€‚æˆ‘ä¹Ÿæ˜¯å±å®æœ‰ç‚¹æŠ–mäº†ï¼Œè¿™ç§ä¸ç—›ä¸ç—’çš„æ‰¹è¯„æ ¹æœ¬ä¸å¾€å¿ƒé‡Œå»ï¼Œä¹Ÿæ²¡æœ‰å‘è‡ªå†…å¿ƒåœ°å»çº æ­£è‡ªå·±çš„é—®é¢˜ï¼Œéè¦ç­‰åˆ°ç°åœ¨çš„å¤§è€æ¿çˆ†éª‚è‡ªå·±ï¼Œè‡ªå·±æ‰æ„è¯†åˆ°é—®é¢˜ã€‚ã€‚ã€‚</p>\n<p>å¹´æœ«åˆ°22å¹´åˆçš„çŠ¶æ€ç¡®å®ä¸å¤ªå¥½ï¼Œä¼¼ä¹æ¯å¹´çš„è¿™æ®µæ—¶é—´éƒ½å¾ˆemoã€‚åœ¨å¹´åº•DDLç»“æŸä¹‹åï¼Œè‡ªå·±çš„èŠ‚å¥ä¸€æ—¶é—´ä¹Ÿæ²¡è°ƒæ•´è¿‡æ¥ã€‚é—²ä¸‹æ¥ä»¥åï¼Œè„‘å­æ˜æ˜æ²‰æ²‰ï¼Œæ²¡äº†ç›®æ ‡ï¼Œæä¸æ¸…æ¥šè‡ªå·±çœŸæ­£æƒ³è¦ä»€ä¹ˆï¼Œä¸è®¨äººå–œæ¬¢ã€‚æœ€åä¹Ÿç®—é€ æˆäº†ä¸å¯å¼¥è¡¥çš„é”™è¯¯å§ï¼Œéå¸¸å¯æƒœã€‚ä¸è¿‡ï¼Œäººå„æœ‰å‘½å§ï¼Œä¹Ÿå­¦ä¹ åˆ°äº†å¾ˆå¤šï¼Œå‰åç›¸æ¯”ï¼Œç®—æ˜¯æˆç†Ÿäº†å¾ˆå¤šäº†ã€‚</p>\n<p>æ‹–æ‹–æ‹‰æ‹‰ï¼Œå†™å®Œè¿™ç¯‡æ€»ç»“çš„æ—¶å€™ï¼Œ2022å¹´éƒ½å·²ç»è¿‡å»å››åˆ†ä¹‹ä¸€äº†ã€‚æ€»çš„æ¥è¯´ï¼Œ2022å¹´å¯ä»¥ç”¨â€œç¿»å¤©è¦†åœ°â€è¿™ä¸ªè¯æ¥æ¦‚æ‹¬ï¼Œåœ¨è¿™ä¸ªç—›è‹¦çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿè§åˆ°äº†ä¸€ä¸ªä¸ä¸€æ ·çš„è‡ªå·±ã€‚è™½ç„¶2022å¹´çš„å¼€ç«¯ä¸ç®—é¡ºåˆ©ï¼Œå¾ˆå¤±è´¥ï¼Œä½†è¿™äº›é—®é¢˜å°±ç•™åˆ°æ˜å¹´çš„æ€»ç»“ä¸­æ¥å†™å§ã€‚æœ€åï¼Œå¸Œæœ›åœ¨2023å¹´æ€»ç»“ä»Šå¹´çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæ›´åŠ å¼€å¿ƒçš„å…³é”®è¯å§ã€‚</p>\n"},{"title":"[BugFix] Spring Cloud IPv6ç«¯å£é—®é¢˜æ’å‘","date":"2021-03-07T23:59:22.000Z","updated":"2021-03-07T23:59:22.000Z","_content":"\n## åœºæ™¯\nä½¿ç”¨ Spring Cloud Eureka æ­å»ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œä½¿ç”¨ Zuul æ­å»ºæœåŠ¡ç½‘å…³ï¼Œä¸€å¥—æ¯”è¾ƒä¼ ç»Ÿçš„å¾®æœåŠ¡æ¶æ„ã€‚\næœåŠ¡æ³¨å†Œä¸­å¿ƒçš„åœ°å€ä¸º http://localhost:8888ï¼ŒZuul ç½‘å…³åœ°å€ä¸º http://localhost:8080ï¼Œ å¦å¤–æ­å»ºä¸€ä¸ªæœåŠ¡åä¸º metadata-service çš„æœåŠ¡ï¼Œåœ°å€ä¸º http://localhost:8088ã€‚\n## é—®é¢˜\nåœ¨ metadata-service ä¸­æä¾›ä¸€ä¸ªæµ‹è¯•çš„æ¥å£\n```Java\n@RestController\npublic class MetadataController {\nâ€‹\n    @GetMapping(value = \"/test\")\n    public int getTest() {\n        return 1;\n    }\n}\n```\nä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå‘ç°ç›´æ¥è¯·æ±‚ http://localhost:8088/test å³ metadata-service çš„åœ°å€ï¼Œå¯ä»¥æ­£å¸¸å¾—åˆ°ç»“æœ\n\n![](/asset/spring_ipv6/1.jpg)\n\nè€Œé€šè¿‡ç½‘å…³ï¼Œä½¿ç”¨ Zuul é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œè°ƒç”¨æœåŠ¡ï¼Œä¼šå‡ºç° 404 çš„é”™è¯¯\n\n![](/asset/spring_ipv6/2.jpg)\n\n## åˆ†æ\né¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ http://localhost:8888 æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ³¨å†Œåˆ°äº†æœåŠ¡æ³¨å†Œä¸­å¿ƒ\n\n![](/asset/spring_ipv6/3.jpg)\n\nå¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚\né‚£ä¹ˆï¼Œæˆ‘ä»¬å†æ£€æŸ¥ç½‘å…³æœ‰æ²¡æœ‰è·å–åˆ° metadata-service çš„è·¯ç”±ã€‚å¯ä»¥é€šè¿‡ http://localhost:8080/actuator/routes æŸ¥çœ‹ï¼ˆactuatoré»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡é…ç½® management.endpoints.web.exposure.include=* å¼€å¯ï¼‰ã€‚\n\n![](/asset/spring_ipv6/4.jpg)\n\nåŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚\né‚£ä¹ˆï¼Œå°±å¾ˆå¥‡æ€ªäº†ğŸ¤¨ï¼ŒæœåŠ¡æœ¬èº«æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œç›´æ¥è°ƒç”¨ä¹Ÿå¯ä»¥è®¿é—®ï¼Œè€Œé€šè¿‡ç½‘å…³ä¸€è½¬å‘ï¼Œä¸ºä»€ä¹ˆå°± 404 äº†å‘¢ï¼Ÿåœ¨ç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹åˆï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°æœ‰äººé‡åˆ°è¿‡ç±»ä¼¼çš„é—®é¢˜ã€‚ã€‚ã€‚ğŸ˜±\né—®é¢˜çš„å…³é”®åœ¨æˆ‘å…³é—­æœåŠ¡åå†æ¬¡è¯·æ±‚ http://localhost:8088/test æ—¶ç»ˆäºæ‰¾åˆ°äº†ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå…³é—­äº†æœåŠ¡åï¼Œåº”è¯¥æ²¡æœ‰è¿”å›çš„ responseï¼Œä½†å‘å‡ºè¯·æ±‚è¿‡åä»ç„¶æ˜¯ 404\n\n![](/asset/spring_ipv6/5.jpg)\n\né‚£ä¹ˆï¼Œå°±å¾ˆæ˜æ˜¾äº†ï¼Œæœ‰å¦ä¸€ä¸ªè¿›ç¨‹ä¹Ÿåœ¨ç›‘å¬ 8088 ç«¯å£ ï¼ï¼ï¼\nä½†è¿˜æ˜¯å¾ˆå¥‡æ€ªï¼Œé‚£ä¸ºä»€ä¹ˆæœåŠ¡å¯åŠ¨çš„æ—¶å€™æ²¡æœ‰æŠ¥ç«¯å£è¢«å ç”¨çš„é”™è¯¯å‘¢ï¼Ÿï¼Ÿï¼Ÿ\né‡æ–°å¯åŠ¨æœåŠ¡ï¼Œä½¿ç”¨ lsof -i tcp:8088 ï¼ˆMac OSï¼‰æŸ¥çœ‹ç«¯å£å ç”¨æƒ…å†µ\n\n![](/asset/spring_ipv6/6.jpg)\n\næœç„¶æœ‰ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶åœ¨ç›‘å¬ï¼Œè€Œä¸€ä¸ªæ˜¯ IPv4ï¼Œä¸€ä¸ªæ˜¯ IPv6çš„ã€‚\né¦–å…ˆï¼Œæ ¹æ®è¿™ç¯‡æ–‡ç«  https://blog.csdn.net/jiyiqinlovexx/article/details/50959351 çš„è§£é‡Šï¼Œå¤šä¸ªè¿›ç¨‹æ˜¯å®Œå…¨å¯ä»¥åŒæ—¶ç›‘å¬åŒä¸€ä¸ªç«¯å£çš„ã€‚\nè€Œä» Java 7 å¼€å§‹ï¼Œé»˜è®¤ä½¿ç”¨ IPv6 è€Œä¸æ˜¯ IPv4 ï¼ˆhttps://stackoverflow.com/questions/35470838/localhost-vs-127-0-0-1-in-spring-frameworkï¼‰ï¼Œæ‰€ä»¥å¯¹äº Spring çš„ localhost æ¥è¯´ï¼Œå…¶å®çœŸæ­£ä½¿ç”¨çš„ IP åœ°å€æ˜¯ ::1ï¼Œè€Œä¸æ˜¯ 127.0.0.1 ã€‚ä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥å‘ç° http://[::1]:8088/test å¾—åˆ°æ­£å¸¸ç»“æœï¼Œè€Œ http://127.0.0.1:8088/test åˆ™ä¸º 404 ã€‚è¿™å°±å®Œç¾åœ°è§£é‡Šäº†å¼€å¯æœåŠ¡ä¸åœæ­¢æœåŠ¡ï¼Œè¿”å›ç»“æœä¸åŒçš„é—®é¢˜ï¼ŒSpring æœåŠ¡æ‰€å¯¹åº”çš„æ­£æ˜¯é‚£ä¸ª IPv6 çš„è¿›ç¨‹ã€‚\né‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆç½‘å…³è½¬å‘å°±åˆ°äº† IPv4 å‘¢ï¼Ÿæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æœåŠ¡æ³¨å†Œä¸­å¿ƒé‡Œçš„ä¿¡æ¯\n\n![](/asset/spring_ipv6/7.jpg)\n\nå¯ä»¥çœ‹åˆ°å…¶å® Eureka ä¿å­˜çš„æ˜¯æ¯ä¸ªæœåŠ¡çš„ IP åœ°å€æ˜¯æœ¬æœºçš„ IPv4 çš„å†…ç½‘åœ°å€ï¼Œè€Œä¸æ˜¯ä¿å­˜åŸŸåï¼Œè¿™å°±æ˜¯é—®é¢˜çš„å…³é”®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Postman å‘é€è¯·æ±‚  http://localhost:8080/metadata-service/test åï¼Œä½¿ç”¨å‘½ä»¤ lsof -i tcp:8088 è¿›è¡ŒéªŒè¯ã€‚\n\n![](/asset/spring_ipv6/8.jpg)\n\nå¯ä»¥çœ‹åˆ°çš„ç¡®æ˜¯å‘å†…ç½‘ IP åœ°å€ï¼Œè€Œä¸æ˜¯å‘ localhost è½¬å‘è¯·æ±‚ã€‚\n## è§£å†³æ–¹æ¡ˆ\nè‡³æ­¤ï¼Œé—®é¢˜çš„åŸå› å·²ç»å®Œå…¨æ¸…æ¥šäº†ï¼Œæœç„¶ç¨‹åºéƒ½æ˜¯ debug de å‡ºæ¥çš„ã€‚\næœ€ç®€å•çš„æ–¹æ³•ä¹Ÿå¾ˆæ¸…æ¥šäº†ï¼Œæ¢ä¸ªç«¯å£å·å°± OK äº†ã€‚\n\nå¦‚æœæœ¬æ–‡æœ‰é”™è¯¯æˆ–è€…ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ï¼ï¼ï¼ğŸ˜†\n\né‚£ä¹ˆï¼Œå äº† 8088 ç«¯å£çš„ IPv4 è¿›ç¨‹æ˜¯å“ªä¸ªç¨‹åºå‘¢ï¼ŸğŸ¤¨\n\n\n\n\n\n\n\nã€‚ã€‚ã€‚ã€‚Hadoop å‡ºæ¥æŒ¨æ‰“ï¼ï¼ï¼ğŸ˜­ğŸ˜­ğŸ˜­","source":"_posts/Spring IPv6.md","raw":"---\ntitle: \"[BugFix] Spring Cloud IPv6ç«¯å£é—®é¢˜æ’å‘\"\ndate: 2021-03-07 23:59:22\nupdated: 2021-03-07 23:59:22\n---\n\n## åœºæ™¯\nä½¿ç”¨ Spring Cloud Eureka æ­å»ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œä½¿ç”¨ Zuul æ­å»ºæœåŠ¡ç½‘å…³ï¼Œä¸€å¥—æ¯”è¾ƒä¼ ç»Ÿçš„å¾®æœåŠ¡æ¶æ„ã€‚\næœåŠ¡æ³¨å†Œä¸­å¿ƒçš„åœ°å€ä¸º http://localhost:8888ï¼ŒZuul ç½‘å…³åœ°å€ä¸º http://localhost:8080ï¼Œ å¦å¤–æ­å»ºä¸€ä¸ªæœåŠ¡åä¸º metadata-service çš„æœåŠ¡ï¼Œåœ°å€ä¸º http://localhost:8088ã€‚\n## é—®é¢˜\nåœ¨ metadata-service ä¸­æä¾›ä¸€ä¸ªæµ‹è¯•çš„æ¥å£\n```Java\n@RestController\npublic class MetadataController {\nâ€‹\n    @GetMapping(value = \"/test\")\n    public int getTest() {\n        return 1;\n    }\n}\n```\nä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå‘ç°ç›´æ¥è¯·æ±‚ http://localhost:8088/test å³ metadata-service çš„åœ°å€ï¼Œå¯ä»¥æ­£å¸¸å¾—åˆ°ç»“æœ\n\n![](/asset/spring_ipv6/1.jpg)\n\nè€Œé€šè¿‡ç½‘å…³ï¼Œä½¿ç”¨ Zuul é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œè°ƒç”¨æœåŠ¡ï¼Œä¼šå‡ºç° 404 çš„é”™è¯¯\n\n![](/asset/spring_ipv6/2.jpg)\n\n## åˆ†æ\né¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ http://localhost:8888 æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ³¨å†Œåˆ°äº†æœåŠ¡æ³¨å†Œä¸­å¿ƒ\n\n![](/asset/spring_ipv6/3.jpg)\n\nå¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚\né‚£ä¹ˆï¼Œæˆ‘ä»¬å†æ£€æŸ¥ç½‘å…³æœ‰æ²¡æœ‰è·å–åˆ° metadata-service çš„è·¯ç”±ã€‚å¯ä»¥é€šè¿‡ http://localhost:8080/actuator/routes æŸ¥çœ‹ï¼ˆactuatoré»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡é…ç½® management.endpoints.web.exposure.include=* å¼€å¯ï¼‰ã€‚\n\n![](/asset/spring_ipv6/4.jpg)\n\nåŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚\né‚£ä¹ˆï¼Œå°±å¾ˆå¥‡æ€ªäº†ğŸ¤¨ï¼ŒæœåŠ¡æœ¬èº«æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œç›´æ¥è°ƒç”¨ä¹Ÿå¯ä»¥è®¿é—®ï¼Œè€Œé€šè¿‡ç½‘å…³ä¸€è½¬å‘ï¼Œä¸ºä»€ä¹ˆå°± 404 äº†å‘¢ï¼Ÿåœ¨ç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹åˆï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°æœ‰äººé‡åˆ°è¿‡ç±»ä¼¼çš„é—®é¢˜ã€‚ã€‚ã€‚ğŸ˜±\né—®é¢˜çš„å…³é”®åœ¨æˆ‘å…³é—­æœåŠ¡åå†æ¬¡è¯·æ±‚ http://localhost:8088/test æ—¶ç»ˆäºæ‰¾åˆ°äº†ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå…³é—­äº†æœåŠ¡åï¼Œåº”è¯¥æ²¡æœ‰è¿”å›çš„ responseï¼Œä½†å‘å‡ºè¯·æ±‚è¿‡åä»ç„¶æ˜¯ 404\n\n![](/asset/spring_ipv6/5.jpg)\n\né‚£ä¹ˆï¼Œå°±å¾ˆæ˜æ˜¾äº†ï¼Œæœ‰å¦ä¸€ä¸ªè¿›ç¨‹ä¹Ÿåœ¨ç›‘å¬ 8088 ç«¯å£ ï¼ï¼ï¼\nä½†è¿˜æ˜¯å¾ˆå¥‡æ€ªï¼Œé‚£ä¸ºä»€ä¹ˆæœåŠ¡å¯åŠ¨çš„æ—¶å€™æ²¡æœ‰æŠ¥ç«¯å£è¢«å ç”¨çš„é”™è¯¯å‘¢ï¼Ÿï¼Ÿï¼Ÿ\né‡æ–°å¯åŠ¨æœåŠ¡ï¼Œä½¿ç”¨ lsof -i tcp:8088 ï¼ˆMac OSï¼‰æŸ¥çœ‹ç«¯å£å ç”¨æƒ…å†µ\n\n![](/asset/spring_ipv6/6.jpg)\n\næœç„¶æœ‰ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶åœ¨ç›‘å¬ï¼Œè€Œä¸€ä¸ªæ˜¯ IPv4ï¼Œä¸€ä¸ªæ˜¯ IPv6çš„ã€‚\né¦–å…ˆï¼Œæ ¹æ®è¿™ç¯‡æ–‡ç«  https://blog.csdn.net/jiyiqinlovexx/article/details/50959351 çš„è§£é‡Šï¼Œå¤šä¸ªè¿›ç¨‹æ˜¯å®Œå…¨å¯ä»¥åŒæ—¶ç›‘å¬åŒä¸€ä¸ªç«¯å£çš„ã€‚\nè€Œä» Java 7 å¼€å§‹ï¼Œé»˜è®¤ä½¿ç”¨ IPv6 è€Œä¸æ˜¯ IPv4 ï¼ˆhttps://stackoverflow.com/questions/35470838/localhost-vs-127-0-0-1-in-spring-frameworkï¼‰ï¼Œæ‰€ä»¥å¯¹äº Spring çš„ localhost æ¥è¯´ï¼Œå…¶å®çœŸæ­£ä½¿ç”¨çš„ IP åœ°å€æ˜¯ ::1ï¼Œè€Œä¸æ˜¯ 127.0.0.1 ã€‚ä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥å‘ç° http://[::1]:8088/test å¾—åˆ°æ­£å¸¸ç»“æœï¼Œè€Œ http://127.0.0.1:8088/test åˆ™ä¸º 404 ã€‚è¿™å°±å®Œç¾åœ°è§£é‡Šäº†å¼€å¯æœåŠ¡ä¸åœæ­¢æœåŠ¡ï¼Œè¿”å›ç»“æœä¸åŒçš„é—®é¢˜ï¼ŒSpring æœåŠ¡æ‰€å¯¹åº”çš„æ­£æ˜¯é‚£ä¸ª IPv6 çš„è¿›ç¨‹ã€‚\né‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆç½‘å…³è½¬å‘å°±åˆ°äº† IPv4 å‘¢ï¼Ÿæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æœåŠ¡æ³¨å†Œä¸­å¿ƒé‡Œçš„ä¿¡æ¯\n\n![](/asset/spring_ipv6/7.jpg)\n\nå¯ä»¥çœ‹åˆ°å…¶å® Eureka ä¿å­˜çš„æ˜¯æ¯ä¸ªæœåŠ¡çš„ IP åœ°å€æ˜¯æœ¬æœºçš„ IPv4 çš„å†…ç½‘åœ°å€ï¼Œè€Œä¸æ˜¯ä¿å­˜åŸŸåï¼Œè¿™å°±æ˜¯é—®é¢˜çš„å…³é”®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Postman å‘é€è¯·æ±‚  http://localhost:8080/metadata-service/test åï¼Œä½¿ç”¨å‘½ä»¤ lsof -i tcp:8088 è¿›è¡ŒéªŒè¯ã€‚\n\n![](/asset/spring_ipv6/8.jpg)\n\nå¯ä»¥çœ‹åˆ°çš„ç¡®æ˜¯å‘å†…ç½‘ IP åœ°å€ï¼Œè€Œä¸æ˜¯å‘ localhost è½¬å‘è¯·æ±‚ã€‚\n## è§£å†³æ–¹æ¡ˆ\nè‡³æ­¤ï¼Œé—®é¢˜çš„åŸå› å·²ç»å®Œå…¨æ¸…æ¥šäº†ï¼Œæœç„¶ç¨‹åºéƒ½æ˜¯ debug de å‡ºæ¥çš„ã€‚\næœ€ç®€å•çš„æ–¹æ³•ä¹Ÿå¾ˆæ¸…æ¥šäº†ï¼Œæ¢ä¸ªç«¯å£å·å°± OK äº†ã€‚\n\nå¦‚æœæœ¬æ–‡æœ‰é”™è¯¯æˆ–è€…ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ï¼ï¼ï¼ğŸ˜†\n\né‚£ä¹ˆï¼Œå äº† 8088 ç«¯å£çš„ IPv4 è¿›ç¨‹æ˜¯å“ªä¸ªç¨‹åºå‘¢ï¼ŸğŸ¤¨\n\n\n\n\n\n\n\nã€‚ã€‚ã€‚ã€‚Hadoop å‡ºæ¥æŒ¨æ‰“ï¼ï¼ï¼ğŸ˜­ğŸ˜­ğŸ˜­","slug":"Spring IPv6","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"cl5i8k7y000031rpf1zgid45a","content":"<h2 id=\"åœºæ™¯\"><a href=\"#åœºæ™¯\" class=\"headerlink\" title=\"åœºæ™¯\"></a>åœºæ™¯</h2><p>ä½¿ç”¨ Spring Cloud Eureka æ­å»ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œä½¿ç”¨ Zuul æ­å»ºæœåŠ¡ç½‘å…³ï¼Œä¸€å¥—æ¯”è¾ƒä¼ ç»Ÿçš„å¾®æœåŠ¡æ¶æ„ã€‚<br>æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„åœ°å€ä¸º <a href=\"http://localhost:8888ï¼ŒZuul\">http://localhost:8888ï¼ŒZuul</a> ç½‘å…³åœ°å€ä¸º <a href=\"http://localhost:8080ï¼Œ\">http://localhost:8080ï¼Œ</a> å¦å¤–æ­å»ºä¸€ä¸ªæœåŠ¡åä¸º metadata-service çš„æœåŠ¡ï¼Œåœ°å€ä¸º <a href=\"http://localhost:8088ã€‚\">http://localhost:8088ã€‚</a></p>\n<h2 id=\"é—®é¢˜\"><a href=\"#é—®é¢˜\" class=\"headerlink\" title=\"é—®é¢˜\"></a>é—®é¢˜</h2><p>åœ¨ metadata-service ä¸­æä¾›ä¸€ä¸ªæµ‹è¯•çš„æ¥å£</p>\n<pre><code class=\"Java\">@RestController\npublic class MetadataController &#123;\nâ€‹\n    @GetMapping(value = &quot;/test&quot;)\n    public int getTest() &#123;\n        return 1;\n    &#125;\n&#125;\n</code></pre>\n<p>ä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå‘ç°ç›´æ¥è¯·æ±‚ <a href=\"http://localhost:8088/test\">http://localhost:8088/test</a> å³ metadata-service çš„åœ°å€ï¼Œå¯ä»¥æ­£å¸¸å¾—åˆ°ç»“æœ</p>\n<p><img src=\"/asset/spring_ipv6/1.jpg\"></p>\n<p>è€Œé€šè¿‡ç½‘å…³ï¼Œä½¿ç”¨ Zuul é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œè°ƒç”¨æœåŠ¡ï¼Œä¼šå‡ºç° 404 çš„é”™è¯¯</p>\n<p><img src=\"/asset/spring_ipv6/2.jpg\"></p>\n<h2 id=\"åˆ†æ\"><a href=\"#åˆ†æ\" class=\"headerlink\" title=\"åˆ†æ\"></a>åˆ†æ</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ <a href=\"http://localhost:8888/\">http://localhost:8888</a> æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ³¨å†Œåˆ°äº†æœåŠ¡æ³¨å†Œä¸­å¿ƒ</p>\n<p><img src=\"/asset/spring_ipv6/3.jpg\"></p>\n<p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚<br>é‚£ä¹ˆï¼Œæˆ‘ä»¬å†æ£€æŸ¥ç½‘å…³æœ‰æ²¡æœ‰è·å–åˆ° metadata-service çš„è·¯ç”±ã€‚å¯ä»¥é€šè¿‡ <a href=\"http://localhost:8080/actuator/routes\">http://localhost:8080/actuator/routes</a> æŸ¥çœ‹ï¼ˆactuatoré»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡é…ç½® management.endpoints.web.exposure.include=* å¼€å¯ï¼‰ã€‚</p>\n<p><img src=\"/asset/spring_ipv6/4.jpg\"></p>\n<p>åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚<br>é‚£ä¹ˆï¼Œå°±å¾ˆå¥‡æ€ªäº†ğŸ¤¨ï¼ŒæœåŠ¡æœ¬èº«æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œç›´æ¥è°ƒç”¨ä¹Ÿå¯ä»¥è®¿é—®ï¼Œè€Œé€šè¿‡ç½‘å…³ä¸€è½¬å‘ï¼Œä¸ºä»€ä¹ˆå°± 404 äº†å‘¢ï¼Ÿåœ¨ç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹åˆï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°æœ‰äººé‡åˆ°è¿‡ç±»ä¼¼çš„é—®é¢˜ã€‚ã€‚ã€‚ğŸ˜±<br>é—®é¢˜çš„å…³é”®åœ¨æˆ‘å…³é—­æœåŠ¡åå†æ¬¡è¯·æ±‚ <a href=\"http://localhost:8088/test\">http://localhost:8088/test</a> æ—¶ç»ˆäºæ‰¾åˆ°äº†ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå…³é—­äº†æœåŠ¡åï¼Œåº”è¯¥æ²¡æœ‰è¿”å›çš„ responseï¼Œä½†å‘å‡ºè¯·æ±‚è¿‡åä»ç„¶æ˜¯ 404</p>\n<p><img src=\"/asset/spring_ipv6/5.jpg\"></p>\n<p>é‚£ä¹ˆï¼Œå°±å¾ˆæ˜æ˜¾äº†ï¼Œæœ‰å¦ä¸€ä¸ªè¿›ç¨‹ä¹Ÿåœ¨ç›‘å¬ 8088 ç«¯å£ ï¼ï¼ï¼<br>ä½†è¿˜æ˜¯å¾ˆå¥‡æ€ªï¼Œé‚£ä¸ºä»€ä¹ˆæœåŠ¡å¯åŠ¨çš„æ—¶å€™æ²¡æœ‰æŠ¥ç«¯å£è¢«å ç”¨çš„é”™è¯¯å‘¢ï¼Ÿï¼Ÿï¼Ÿ<br>é‡æ–°å¯åŠ¨æœåŠ¡ï¼Œä½¿ç”¨ lsof -i tcp:8088 ï¼ˆMac OSï¼‰æŸ¥çœ‹ç«¯å£å ç”¨æƒ…å†µ</p>\n<p><img src=\"/asset/spring_ipv6/6.jpg\"></p>\n<p>æœç„¶æœ‰ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶åœ¨ç›‘å¬ï¼Œè€Œä¸€ä¸ªæ˜¯ IPv4ï¼Œä¸€ä¸ªæ˜¯ IPv6çš„ã€‚<br>é¦–å…ˆï¼Œæ ¹æ®è¿™ç¯‡æ–‡ç«  <a href=\"https://blog.csdn.net/jiyiqinlovexx/article/details/50959351\">https://blog.csdn.net/jiyiqinlovexx/article/details/50959351</a> çš„è§£é‡Šï¼Œå¤šä¸ªè¿›ç¨‹æ˜¯å®Œå…¨å¯ä»¥åŒæ—¶ç›‘å¬åŒä¸€ä¸ªç«¯å£çš„ã€‚<br>è€Œä» Java 7 å¼€å§‹ï¼Œé»˜è®¤ä½¿ç”¨ IPv6 è€Œä¸æ˜¯ IPv4 ï¼ˆ<a href=\"https://stackoverflow.com/questions/35470838/localhost-vs-127-0-0-1-in-spring-framework%EF%BC%89%EF%BC%8C%E6%89%80%E4%BB%A5%E5%AF%B9%E4%BA%8E\">https://stackoverflow.com/questions/35470838/localhost-vs-127-0-0-1-in-spring-frameworkï¼‰ï¼Œæ‰€ä»¥å¯¹äº</a> Spring çš„ localhost æ¥è¯´ï¼Œå…¶å®çœŸæ­£ä½¿ç”¨çš„ IP åœ°å€æ˜¯ ::1ï¼Œè€Œä¸æ˜¯ 127.0.0.1 ã€‚ä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥å‘ç° http://[::1]:8088/test å¾—åˆ°æ­£å¸¸ç»“æœï¼Œè€Œ <a href=\"http://127.0.0.1:8088/test\">http://127.0.0.1:8088/test</a> åˆ™ä¸º 404 ã€‚è¿™å°±å®Œç¾åœ°è§£é‡Šäº†å¼€å¯æœåŠ¡ä¸åœæ­¢æœåŠ¡ï¼Œè¿”å›ç»“æœä¸åŒçš„é—®é¢˜ï¼ŒSpring æœåŠ¡æ‰€å¯¹åº”çš„æ­£æ˜¯é‚£ä¸ª IPv6 çš„è¿›ç¨‹ã€‚<br>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆç½‘å…³è½¬å‘å°±åˆ°äº† IPv4 å‘¢ï¼Ÿæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æœåŠ¡æ³¨å†Œä¸­å¿ƒé‡Œçš„ä¿¡æ¯</p>\n<p><img src=\"/asset/spring_ipv6/7.jpg\"></p>\n<p>å¯ä»¥çœ‹åˆ°å…¶å® Eureka ä¿å­˜çš„æ˜¯æ¯ä¸ªæœåŠ¡çš„ IP åœ°å€æ˜¯æœ¬æœºçš„ IPv4 çš„å†…ç½‘åœ°å€ï¼Œè€Œä¸æ˜¯ä¿å­˜åŸŸåï¼Œè¿™å°±æ˜¯é—®é¢˜çš„å…³é”®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Postman å‘é€è¯·æ±‚  <a href=\"http://localhost:8080/metadata-service/test\">http://localhost:8080/metadata-service/test</a> åï¼Œä½¿ç”¨å‘½ä»¤ lsof -i tcp:8088 è¿›è¡ŒéªŒè¯ã€‚</p>\n<p><img src=\"/asset/spring_ipv6/8.jpg\"></p>\n<p>å¯ä»¥çœ‹åˆ°çš„ç¡®æ˜¯å‘å†…ç½‘ IP åœ°å€ï¼Œè€Œä¸æ˜¯å‘ localhost è½¬å‘è¯·æ±‚ã€‚</p>\n<h2 id=\"è§£å†³æ–¹æ¡ˆ\"><a href=\"#è§£å†³æ–¹æ¡ˆ\" class=\"headerlink\" title=\"è§£å†³æ–¹æ¡ˆ\"></a>è§£å†³æ–¹æ¡ˆ</h2><p>è‡³æ­¤ï¼Œé—®é¢˜çš„åŸå› å·²ç»å®Œå…¨æ¸…æ¥šäº†ï¼Œæœç„¶ç¨‹åºéƒ½æ˜¯ debug de å‡ºæ¥çš„ã€‚<br>æœ€ç®€å•çš„æ–¹æ³•ä¹Ÿå¾ˆæ¸…æ¥šäº†ï¼Œæ¢ä¸ªç«¯å£å·å°± OK äº†ã€‚</p>\n<p>å¦‚æœæœ¬æ–‡æœ‰é”™è¯¯æˆ–è€…ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ï¼ï¼ï¼ğŸ˜†</p>\n<p>é‚£ä¹ˆï¼Œå äº† 8088 ç«¯å£çš„ IPv4 è¿›ç¨‹æ˜¯å“ªä¸ªç¨‹åºå‘¢ï¼ŸğŸ¤¨</p>\n<p>ã€‚ã€‚ã€‚ã€‚Hadoop å‡ºæ¥æŒ¨æ‰“ï¼ï¼ï¼ğŸ˜­ğŸ˜­ğŸ˜­</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"åœºæ™¯\"><a href=\"#åœºæ™¯\" class=\"headerlink\" title=\"åœºæ™¯\"></a>åœºæ™¯</h2><p>ä½¿ç”¨ Spring Cloud Eureka æ­å»ºæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œä½¿ç”¨ Zuul æ­å»ºæœåŠ¡ç½‘å…³ï¼Œä¸€å¥—æ¯”è¾ƒä¼ ç»Ÿçš„å¾®æœåŠ¡æ¶æ„ã€‚<br>æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„åœ°å€ä¸º <a href=\"http://localhost:8888ï¼ŒZuul\">http://localhost:8888ï¼ŒZuul</a> ç½‘å…³åœ°å€ä¸º <a href=\"http://localhost:8080ï¼Œ\">http://localhost:8080ï¼Œ</a> å¦å¤–æ­å»ºä¸€ä¸ªæœåŠ¡åä¸º metadata-service çš„æœåŠ¡ï¼Œåœ°å€ä¸º <a href=\"http://localhost:8088ã€‚\">http://localhost:8088ã€‚</a></p>\n<h2 id=\"é—®é¢˜\"><a href=\"#é—®é¢˜\" class=\"headerlink\" title=\"é—®é¢˜\"></a>é—®é¢˜</h2><p>åœ¨ metadata-service ä¸­æä¾›ä¸€ä¸ªæµ‹è¯•çš„æ¥å£</p>\n<pre><code class=\"Java\">@RestController\npublic class MetadataController &#123;\nâ€‹\n    @GetMapping(value = &quot;/test&quot;)\n    public int getTest() &#123;\n        return 1;\n    &#125;\n&#125;\n</code></pre>\n<p>ä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå‘ç°ç›´æ¥è¯·æ±‚ <a href=\"http://localhost:8088/test\">http://localhost:8088/test</a> å³ metadata-service çš„åœ°å€ï¼Œå¯ä»¥æ­£å¸¸å¾—åˆ°ç»“æœ</p>\n<p><img src=\"/asset/spring_ipv6/1.jpg\"></p>\n<p>è€Œé€šè¿‡ç½‘å…³ï¼Œä½¿ç”¨ Zuul é»˜è®¤è·¯ç”±è§„åˆ™ï¼Œè°ƒç”¨æœåŠ¡ï¼Œä¼šå‡ºç° 404 çš„é”™è¯¯</p>\n<p><img src=\"/asset/spring_ipv6/2.jpg\"></p>\n<h2 id=\"åˆ†æ\"><a href=\"#åˆ†æ\" class=\"headerlink\" title=\"åˆ†æ\"></a>åˆ†æ</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ <a href=\"http://localhost:8888/\">http://localhost:8888</a> æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ³¨å†Œåˆ°äº†æœåŠ¡æ³¨å†Œä¸­å¿ƒ</p>\n<p><img src=\"/asset/spring_ipv6/3.jpg\"></p>\n<p>å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚<br>é‚£ä¹ˆï¼Œæˆ‘ä»¬å†æ£€æŸ¥ç½‘å…³æœ‰æ²¡æœ‰è·å–åˆ° metadata-service çš„è·¯ç”±ã€‚å¯ä»¥é€šè¿‡ <a href=\"http://localhost:8080/actuator/routes\">http://localhost:8080/actuator/routes</a> æŸ¥çœ‹ï¼ˆactuatoré»˜è®¤æ˜¯å…³é—­çš„ï¼Œå¯ä»¥é€šè¿‡é…ç½® management.endpoints.web.exposure.include=* å¼€å¯ï¼‰ã€‚</p>\n<p><img src=\"/asset/spring_ipv6/4.jpg\"></p>\n<p>åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚<br>é‚£ä¹ˆï¼Œå°±å¾ˆå¥‡æ€ªäº†ğŸ¤¨ï¼ŒæœåŠ¡æœ¬èº«æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œç›´æ¥è°ƒç”¨ä¹Ÿå¯ä»¥è®¿é—®ï¼Œè€Œé€šè¿‡ç½‘å…³ä¸€è½¬å‘ï¼Œä¸ºä»€ä¹ˆå°± 404 äº†å‘¢ï¼Ÿåœ¨ç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹åˆï¼Œä¹Ÿæ²¡æœ‰æ‰¾åˆ°æœ‰äººé‡åˆ°è¿‡ç±»ä¼¼çš„é—®é¢˜ã€‚ã€‚ã€‚ğŸ˜±<br>é—®é¢˜çš„å…³é”®åœ¨æˆ‘å…³é—­æœåŠ¡åå†æ¬¡è¯·æ±‚ <a href=\"http://localhost:8088/test\">http://localhost:8088/test</a> æ—¶ç»ˆäºæ‰¾åˆ°äº†ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå…³é—­äº†æœåŠ¡åï¼Œåº”è¯¥æ²¡æœ‰è¿”å›çš„ responseï¼Œä½†å‘å‡ºè¯·æ±‚è¿‡åä»ç„¶æ˜¯ 404</p>\n<p><img src=\"/asset/spring_ipv6/5.jpg\"></p>\n<p>é‚£ä¹ˆï¼Œå°±å¾ˆæ˜æ˜¾äº†ï¼Œæœ‰å¦ä¸€ä¸ªè¿›ç¨‹ä¹Ÿåœ¨ç›‘å¬ 8088 ç«¯å£ ï¼ï¼ï¼<br>ä½†è¿˜æ˜¯å¾ˆå¥‡æ€ªï¼Œé‚£ä¸ºä»€ä¹ˆæœåŠ¡å¯åŠ¨çš„æ—¶å€™æ²¡æœ‰æŠ¥ç«¯å£è¢«å ç”¨çš„é”™è¯¯å‘¢ï¼Ÿï¼Ÿï¼Ÿ<br>é‡æ–°å¯åŠ¨æœåŠ¡ï¼Œä½¿ç”¨ lsof -i tcp:8088 ï¼ˆMac OSï¼‰æŸ¥çœ‹ç«¯å£å ç”¨æƒ…å†µ</p>\n<p><img src=\"/asset/spring_ipv6/6.jpg\"></p>\n<p>æœç„¶æœ‰ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶åœ¨ç›‘å¬ï¼Œè€Œä¸€ä¸ªæ˜¯ IPv4ï¼Œä¸€ä¸ªæ˜¯ IPv6çš„ã€‚<br>é¦–å…ˆï¼Œæ ¹æ®è¿™ç¯‡æ–‡ç«  <a href=\"https://blog.csdn.net/jiyiqinlovexx/article/details/50959351\">https://blog.csdn.net/jiyiqinlovexx/article/details/50959351</a> çš„è§£é‡Šï¼Œå¤šä¸ªè¿›ç¨‹æ˜¯å®Œå…¨å¯ä»¥åŒæ—¶ç›‘å¬åŒä¸€ä¸ªç«¯å£çš„ã€‚<br>è€Œä» Java 7 å¼€å§‹ï¼Œé»˜è®¤ä½¿ç”¨ IPv6 è€Œä¸æ˜¯ IPv4 ï¼ˆ<a href=\"https://stackoverflow.com/questions/35470838/localhost-vs-127-0-0-1-in-spring-framework%EF%BC%89%EF%BC%8C%E6%89%80%E4%BB%A5%E5%AF%B9%E4%BA%8E\">https://stackoverflow.com/questions/35470838/localhost-vs-127-0-0-1-in-spring-frameworkï¼‰ï¼Œæ‰€ä»¥å¯¹äº</a> Spring çš„ localhost æ¥è¯´ï¼Œå…¶å®çœŸæ­£ä½¿ç”¨çš„ IP åœ°å€æ˜¯ ::1ï¼Œè€Œä¸æ˜¯ 127.0.0.1 ã€‚ä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥å‘ç° http://[::1]:8088/test å¾—åˆ°æ­£å¸¸ç»“æœï¼Œè€Œ <a href=\"http://127.0.0.1:8088/test\">http://127.0.0.1:8088/test</a> åˆ™ä¸º 404 ã€‚è¿™å°±å®Œç¾åœ°è§£é‡Šäº†å¼€å¯æœåŠ¡ä¸åœæ­¢æœåŠ¡ï¼Œè¿”å›ç»“æœä¸åŒçš„é—®é¢˜ï¼ŒSpring æœåŠ¡æ‰€å¯¹åº”çš„æ­£æ˜¯é‚£ä¸ª IPv6 çš„è¿›ç¨‹ã€‚<br>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆç½‘å…³è½¬å‘å°±åˆ°äº† IPv4 å‘¢ï¼Ÿæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æœåŠ¡æ³¨å†Œä¸­å¿ƒé‡Œçš„ä¿¡æ¯</p>\n<p><img src=\"/asset/spring_ipv6/7.jpg\"></p>\n<p>å¯ä»¥çœ‹åˆ°å…¶å® Eureka ä¿å­˜çš„æ˜¯æ¯ä¸ªæœåŠ¡çš„ IP åœ°å€æ˜¯æœ¬æœºçš„ IPv4 çš„å†…ç½‘åœ°å€ï¼Œè€Œä¸æ˜¯ä¿å­˜åŸŸåï¼Œè¿™å°±æ˜¯é—®é¢˜çš„å…³é”®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Postman å‘é€è¯·æ±‚  <a href=\"http://localhost:8080/metadata-service/test\">http://localhost:8080/metadata-service/test</a> åï¼Œä½¿ç”¨å‘½ä»¤ lsof -i tcp:8088 è¿›è¡ŒéªŒè¯ã€‚</p>\n<p><img src=\"/asset/spring_ipv6/8.jpg\"></p>\n<p>å¯ä»¥çœ‹åˆ°çš„ç¡®æ˜¯å‘å†…ç½‘ IP åœ°å€ï¼Œè€Œä¸æ˜¯å‘ localhost è½¬å‘è¯·æ±‚ã€‚</p>\n<h2 id=\"è§£å†³æ–¹æ¡ˆ\"><a href=\"#è§£å†³æ–¹æ¡ˆ\" class=\"headerlink\" title=\"è§£å†³æ–¹æ¡ˆ\"></a>è§£å†³æ–¹æ¡ˆ</h2><p>è‡³æ­¤ï¼Œé—®é¢˜çš„åŸå› å·²ç»å®Œå…¨æ¸…æ¥šäº†ï¼Œæœç„¶ç¨‹åºéƒ½æ˜¯ debug de å‡ºæ¥çš„ã€‚<br>æœ€ç®€å•çš„æ–¹æ³•ä¹Ÿå¾ˆæ¸…æ¥šäº†ï¼Œæ¢ä¸ªç«¯å£å·å°± OK äº†ã€‚</p>\n<p>å¦‚æœæœ¬æ–‡æœ‰é”™è¯¯æˆ–è€…ç†è§£ä¸å¯¹çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ï¼ï¼ï¼ğŸ˜†</p>\n<p>é‚£ä¹ˆï¼Œå äº† 8088 ç«¯å£çš„ IPv4 è¿›ç¨‹æ˜¯å“ªä¸ªç¨‹åºå‘¢ï¼ŸğŸ¤¨</p>\n<p>ã€‚ã€‚ã€‚ã€‚Hadoop å‡ºæ¥æŒ¨æ‰“ï¼ï¼ï¼ğŸ˜­ğŸ˜­ğŸ˜­</p>\n"},{"title":"[Introduction] Casbin is All You Need â€”â€” è®¿é—®æ§åˆ¶æ¡†æ¶ Casbin Ramp Up","date":"2022-06-22T01:05:51.000Z","updated":"2022-06-22T01:05:51.000Z","_content":"\n## TL;DR\n\n- è®¿é—®æ§åˆ¶æ¡†æ¶ Casbin çš„åŸç†ä»¥åŠå…¶å†…éƒ¨ç»„ä»¶çš„ç»“æ„\n- ä»¥ä¸€ä¸ª RBAC çš„ç®€å•ä¾‹å­ä»‹ç» Casbin çš„ç”¨æ³•\n\n## Casbinæ˜¯ä»€ä¹ˆï¼Ÿ\n### è®¿é—®æ§åˆ¶\n\n![](/asset/casbin-ramp-up/2022-06-23-17-50-00-image.png)\n\nè®¿é—®æ§åˆ¶ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯æŒ‡åˆ¤æ–­ä¸€æ¡è¯·æ±‚æ˜¯å¦å¯ä»¥è®¿é—®å—ä¿æŠ¤çš„èµ„æºçš„æŠ€æœ¯ã€‚åœ¨ä¸Šå›¾çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„åå°ä¸­æœ‰ä¸¤ä¸ªèµ„æºï¼ŒResource1å’ŒResource2ã€‚å®ƒä»¬å¯ä»¥æ˜¯æœåŠ¡å™¨ã€è´¦å·ã€å›¾ç‰‡ã€è§†é¢‘ç­‰ç­‰ç­‰ç­‰ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬çš„ç›¸åŒç‰¹æ€§æ˜¯ä¸èƒ½è¢«æ‰€æœ‰ç”¨æˆ·éƒ½è®¿é—®ã€‚æ¯”å¦‚ Resource1 å±äºç”¨æˆ· Aliceï¼Œé‚£ä¹ˆåªæœ‰ Alice èƒ½å¤Ÿè®¿é—®å®ƒï¼ŒBob åˆ™ä¸èƒ½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹è®¿é—®è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œåˆ¤æ–­å…¶æ˜¯å¦è¢«å…è®¸åˆ°è¾¾ç›®æ ‡èµ„æºã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒAlice å‘èµ·äº†ä¸¤ä¸ªè®¿é—®è¯·æ±‚ï¼Œåˆ†åˆ«æƒ³è¦è®¿é—® Resource1 å’Œ Resource2ã€‚è®¿é—®æ§åˆ¶å±‚éœ€è¦åšçš„å·¥ä½œå°±æ˜¯å…è®¸è®¿é—® Resource1 çš„è¯·æ±‚é€šè¿‡ï¼Œè€Œé˜»æ‹¦æƒ³è¦è®¿é—® Resource2 çš„è¯·æ±‚ï¼Œå› ä¸º Resource2 å±äº Bobï¼ŒAlice æ˜¯æ— æ³•è®¿é—®çš„ã€‚\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè®¿é—®æ§åˆ¶é—®é¢˜å¾€å¾€ä¼šéšç€ä¸šåŠ¡è€Œå˜å¾—éå¸¸å¤æ‚ã€‚è€Œ Casbin [<sup>1</sup>](#casbin) å°±æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ã€é«˜æ•ˆçš„å¼€æºè®¿é—®æ§åˆ¶æ¡†æ¶ã€‚Casbin åœ¨ Github ä¸Šå·²è·å¾—è¶…è¿‡ 10k+ starï¼Œå¹¶ä¸”æœ‰ç€éå¸¸å®Œæ•´çš„ç”Ÿæ€ã€‚åŸºäº Casbin å¯ä»¥è½»æ¾çš„å®ç°ä¸€ç³»åˆ—è®¿é—®æ§åˆ¶æ¨¡å‹ï¼Œå¦‚ RBACï¼ŒABACç­‰ç­‰ã€‚\n\n### åŸç†â€”â€”PML\n\nCasbin çš„åº•å±‚åŸç†åŸºäºå…¶åˆ›å»ºè€…ç½—æ¨åšå£«æ‰€å‘è¡¨çš„ä¸€ç¯‡è®ºæ–‡ã€ŠPML: An Interpreter-Based Access Control Policy Language for Web Servicesã€‹[<sup>2</sup>](#pml)\n\n#### è®¾è®¡ç›®æ ‡\n\nè¿™ç¯‡è®ºæ–‡ä¸»è¦å…³æ³¨äºå¦‚ä½•è§£å†³ç°å®ä¸­äº‘æœåŠ¡å‚å•†æœ‰å…³æƒé™æ ¡éªŒæ‰€é‡åˆ°çš„ä¸¤ä¸ªé—®é¢˜ï¼š\n\n1. æ¯ä¸ªäº‘æœåŠ¡å‚å•†éƒ½æœ‰ç€è‡ªå·±çš„ä¸€å¥—æƒé™æ£€éªŒè§„åˆ™ã€‚è¿™å¯¹äºåœ¨å¤šä¸ªäº‘ç¯å¢ƒéƒ½è¿›è¡Œéƒ¨ç½²çš„ç”¨æˆ·æ¥è¯´ï¼Œé€ æˆäº†å¾ˆå¤§çš„è¿ç§»å’Œç»´æŠ¤æˆæœ¬ã€‚\n2. åŒæ ·çš„ï¼Œç»´æŠ¤è‡ªå·±çš„ä¸€å¥—æƒé™æ ¡éªŒè§„åˆ™å¯¹äºäº‘æœåŠ¡å‚å•†æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚å¦‚æœäº‘æœåŠ¡å‚å•†ç¼ºä¹åœ¨è¿™æ–¹é¢çš„ç›¸å…³ç»éªŒï¼Œå°±å¾ˆæœ‰å¯èƒ½é€ æˆå®‰å…¨æ¼æ´ã€‚\n\næ—¢ç„¶æ–‡ç« çš„ç›®æ ‡æœ¬è´¨ä¸Šæ˜¯é€šè¿‡é€šç”¨æ€§æ¥è§£å†³é—®é¢˜ï¼Œä½œè€…ä¹Ÿè€ƒè™‘äº†å¦‚ä½•å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæå‡ºäº†ä¸¤ä¸ª independent çš„è®¾è®¡è¦æ±‚ï¼š\n\n1. Access Control Model Independentï¼šPML æ—¢éœ€è¦æ”¯æŒç”¨æˆ·å¯ä»¥åœ¨å¤šä¸ªäº‘æœåŠ¡å‚å•†ä¸­ä½¿ç”¨åŒä¸€ä¸ªæ¨¡å‹ï¼Œä¹Ÿéœ€è¦æ”¯æŒç”¨æˆ·åœ¨ä¸æ”¹å˜æ ¡éªŒä»£ç çš„åŒæ—¶ï¼Œå¯ä»¥åˆ‡æ¢ä¸åŒçš„æ¨¡å‹ã€‚\n2. Implementation Language Independent: PML çš„è®¾è®¡ä¸åº”è¯¥ä¾èµ–äºæŸç§ç¼–ç¨‹è¯­è¨€çš„ç‰¹æ€§ã€‚\n   å› æ­¤ï¼Œæ–‡ä¸­æå‡ºäº†ä¸€ç§æ–°çš„æƒé™æ ¡éªŒè¯­è¨€â€”â€”PML (PERM Modeling Language)ï¼Œå¸Œæœ›é€šè¿‡ä¸€ç§æ”¯æŒå¤šç§æƒé™æ ¡éªŒæ¨¡å‹çš„é…ç½®è¯­è¨€æ¥å¼¥è¡¥è¿™ä¸ª gapã€‚\n\n#### è®¾è®¡å®ç°\n\nåœ¨ä»‹ç» PML çš„è®¾è®¡ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå¤§è‡´äº†è§£ä¸€ä¸‹è®¿é—®æ§åˆ¶é—®é¢˜ä¸­ï¼Œæ‰€æ¶‰åŠåˆ°çš„ä¸€äº›æ¦‚å¿µã€‚\n\n![1c2dea1652f67c0b7920b0471a4113afd8d9325a.png](/asset/casbin-ramp-up/overview.png)\n\nä¸€èˆ¬æ¥è¯´ï¼Œè®¿é—®æ§åˆ¶ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªéƒ¨åˆ†ï¼š\n\n1. **Model è®¿é—®æ§åˆ¶æ¨¡å‹**ã€‚å¸¸è§çš„æ¨¡å‹æœ‰ ACLï¼ˆAccess Control List è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰ï¼ŒRBACï¼ˆRole-Based Access Control åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰ï¼ŒABACï¼ˆAttribute-Based Access Control åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰ã€‚å¯¹äºä¸€ä¸ªåº”ç”¨æ¥è¯´ï¼ŒModel çš„é€‰æ‹©æ˜¯ä¸åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘æ˜¯å¯†åˆ‡ç›¸å…³çš„ï¼Œå› æ­¤ä¹Ÿæ˜¯ç›¸å¯¹é™æ€çš„ã€‚ä¸€æ—¦ä»£ç ç¼–è¯‘å®Œæˆï¼Œè¿™éƒ¨åˆ†æ˜¯ä¸ä¼šéšç€åº”ç”¨çš„è¿è¡Œè€Œäº§ç”Ÿå˜åŒ–çš„ã€‚\n2. **Policy è®¿é—®æ§åˆ¶è§„åˆ™**ã€‚Policy æ˜¯å’Œ Model ç›¸å¯¹åº”çš„ï¼Œæ¯ç§ä¸åŒçš„ Modelï¼Œéƒ½ä¼šæœ‰ä¸åŒæ ¼å¼çš„ Policyã€‚è€Œä¸ Model å®Œå…¨ç›¸åçš„æ˜¯ï¼ŒPolicy æ˜¯ç›¸å¯¹åŠ¨æ€çš„ã€‚åœ¨ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å»å®šä¹‰ Policy çš„æ ¼å¼ï¼Œè€Œ Policy çš„å…·ä½“å†…å®¹éƒ½æ˜¯åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­æ·»åŠ æˆ–ä¿®æ”¹çš„ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªæ–°ç”¨æˆ·æ³¨å†Œäº†æˆ‘ä»¬çš„åº”ç”¨ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±éœ€è¦åŠ¨æ€çš„ä¸ºå…¶æ·»åŠ ä¸€æ¡ Policyã€‚\n\næˆ‘ä»¬å¯ä»¥å°†è¿™ä¸¤éƒ¨åˆ†ç†è§£ä¸ºä¼ ç»Ÿåº”ç”¨ä¸­çš„ä»£ç å’Œæ•°æ®ã€‚æœ‰äº†è¿™ä¸¤éƒ¨åˆ†åï¼Œå†åŠ ä¸Šç”¨æˆ·ç‰¹å®šçš„æ ¡éªŒé€»è¾‘ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œæˆè®¿é—®æ§åˆ¶ä»»åŠ¡ã€‚\n\n##### PERM æ¨¡å‹\n\nå½“ç„¶ï¼Œå¯¹äºç°å®ç¯å¢ƒä¸­å¤æ‚çš„æƒ…å†µï¼Œç®€å•åœ°å°†é—®é¢˜å»ºæ¨¡ä¸ºè¿™ä¸¤éƒ¨åˆ†è‚¯å®šæ˜¯ä¸å¤Ÿçš„ï¼Œå› æ­¤ï¼Œè®ºæ–‡æå‡ºäº†ä¸€ä¸ªæ–°çš„å…ƒæ¨¡å‹ PERMï¼ˆPolicy-Effect-Request-Matcherï¼‰ã€‚\n\n![6d8fa0a037c3ea185cfadb8d817c41cce0d66d78.png](/asset/casbin-ramp-up/pml.png)\n\nPERM æ¨¡å‹ä¸»è¦åŒ…å«äº† 6 ä¸ªä¸»è¦çš„æ¦‚å¿µï¼š\n\n1. **Request**ï¼šè®¿é—®è¯·æ±‚å®šä¹‰ã€‚ç”¨æˆ·çœŸå®çš„è®¿é—®è¯·æ±‚ï¼Œé€šå¸¸ä¼šåŒ…å« subï¼ˆè®¿é—®è€…ï¼‰ï¼Œobjï¼ˆè¢«è®¿é—®çš„èµ„æºï¼‰ï¼Œ actï¼ˆè®¿é—®æ—¶æ‰€è¿›è¡Œçš„æ“ä½œï¼‰æˆ–å…¶ä»–ç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ã€‚\n2. **Policy**ï¼šè®¿é—®æ§åˆ¶è§„åˆ™å®šä¹‰ã€‚å®šä¹‰äº†éœ€è¦å¯¹è®¿é—®è¯·æ±‚çš„å“ªäº›å±æ€§è¿›è¡Œæ ¡éªŒã€‚\n3. **Policy Rule**ï¼šè®¿é—®æ§åˆ¶è§„åˆ™å®ä¾‹ã€‚\n4. **Matcher**ï¼šå¦‚ä½•ä¸ºä¸€æ¡ Request åŒ¹é…åˆ°å…¶å¯¹åº”çš„ Policy Ruleã€‚\n5. **Effect**ï¼šå½“ä¸€æ¡ Request åŒ¹é…åˆ°äº†ä¸€æ¡æˆ–å¤šæ¡ Policy Ruleï¼Œå¦‚ä½•åˆ¤æ–­å…¶æ˜¯å¦åº”è¯¥è¢«å…è®¸ã€‚\n6. **Stub Function**ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼ŒRequest å®ä¾‹ å’Œ Policy Rule çš„åŒ¹é…å¾€å¾€æ— æ³•é€šè¿‡ç®€å•çš„ == ç­‰äºæ¥è§£å†³ï¼Œä¾‹å¦‚é€šé…ç¬¦ç­‰ç­‰ã€‚æ‰€ä»¥ Stub Function å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ä¸€äº›å¤æ‚çš„åŒ¹é…æ–¹æ³•ã€‚\n\nè¿™å…­ä¸ªæ›´åŠ è¯¦ç»†çš„å»ºæ¨¡äº†è®¿é—®æ§åˆ¶çš„é—®é¢˜ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶ç®€å•çš„åˆ†ä¸€ä¸‹ç±»ï¼ŒRequestï¼ŒPolicyï¼ŒMatcherï¼ŒEffect å’Œ Stub Function éƒ½æ˜¯é™æ€çš„ï¼Œå±äº Model çš„ä¸€éƒ¨åˆ†ã€‚é€šè¿‡è¿™ä¸ªäº”é¡¹çš„ç»„åˆï¼ŒACLç­‰å¸¸è§çš„æ¨¡å‹ä»¥åŠä¸€äº›ç”¨æˆ·è‡ªå®šä¹‰çš„è§„åˆ™ï¼Œéƒ½å¯ä»¥å¾ˆè½»æ˜“çš„è¡¨ç¤ºå‡ºæ¥ã€‚åœ¨æœ€åä¸€éƒ¨åˆ†ä¸­ï¼Œä¼šä»¥ RBAC ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•é€šè¿‡ PML å®ç°è¿™æ ·ä¸€ä¸ªæ¨¡å‹ã€‚\n\nè€Œ Policy Rule å°±å±äºåŠ¨æ€å˜åŒ–çš„å†…å®¹ã€‚åœ¨å®é™…å®ç°ä¸­ï¼Œå¾€å¾€ä¹Ÿæ˜¯åƒæ•°æ®ä¸€æ ·ï¼Œå­˜å‚¨åœ¨æ•°æ®åº“å½“ä¸­çš„ã€‚\n\n## ç»“æ„\n\nä¸è®ºæ–‡ä¸­çš„å®ç°ç›¸æ¯”ï¼Œç›®å‰ Casbin çš„å®ç°æ›´åŠ å¼ºå¤§ï¼Œæ”¯æŒäº†æ›´å¤šåŠŸèƒ½ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œä»¥ Casbin ä¸»åº“ï¼ˆGo ç‰ˆæœ¬ï¼‰ï¼Œä»‹ç» Casbin æ˜¯å¦‚ä½•è¿›è¡Œå·¥ä½œçš„ã€‚\n\n![6dbf7fb95022569c5ad99becdcd9090df8a99250.png](/asset/casbin-ramp-up/detail.png)\n\n1. åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼ŒCasbin ä¼šè¯»å–ç”¨æˆ·å·²ç»å®šä¹‰å¥½çš„ Modelï¼Œå…¶ä¸­ä¼šåŒ…å« Request, Policy, Matcher å’Œ Effector å››ä¸ªéƒ¨åˆ†çš„å®šä¹‰ã€‚åŒæ—¶ï¼ŒCasbin ä¼šåˆ©ç”¨ Adapterï¼Œä»æ•°æ®æºå¤„è¯»å– Policy å®ä¾‹ï¼ˆä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„ Policy Ruleï¼‰ã€‚åæ–‡å°±å°† Policy å®ä¾‹ç®€ç§°ä¸º Policyã€‚\n\n2. å¯¹äº Policy çš„å­˜å‚¨å’Œè¯»å–ï¼ŒCasbin å°†å…¶è§£è€¦åˆ°äº†ç‹¬ç«‹çš„ Adapter æ¨¡å—ã€‚é€šè¿‡ä½¿ç”¨ä¸åŒçš„ Adapterï¼ˆFile, MySQLç­‰ç­‰ï¼‰ï¼Œå¯ä»¥ä»ä¸åŒçš„æ•°æ®æºä¸­è¯»å– Policyã€‚å¯¹äº Policy æ¯”è¾ƒå¤šçš„åœºæ™¯ï¼Œå°†æ‰€æœ‰çš„ Policy åŒæ—¶åŠ è½½è¿›å†…å­˜ï¼Œç¡®å®ä¼šå¯¼è‡´ä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚æ‰€ä»¥ï¼Œåœ¨åŠ è½½æ—¶ï¼Œéƒ¨åˆ† Adapter ä¹Ÿæä¾› `LoadFilteredPolicy` çš„æ¥å£ï¼Œé€šè¿‡åªåŠ è½½ Policy çš„ä¸€éƒ¨åˆ†å­é›†ï¼Œå‡å°‘è¿™éƒ¨åˆ†å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆã€‚\n\n3. åœ¨ä¸€æ¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œè¯¥è¯·æ±‚é¦–å…ˆä¼šæŒ‰ç…§ Model ä¸­çš„å®šä¹‰è¿›è¡Œæ‹†åˆ†ã€‚æ¥ä¸‹æ¥ï¼ŒMatcher ä¼šæ ¹æ® Model ä¸­å®šä¹‰çš„è§„åˆ™ï¼Œä¸ Policy è¿›è¡ŒåŒ¹é…ã€‚é™¤äº†æ”¯æŒ == å¼ºåŒ¹é…å¤–ï¼ŒMatcher è¿˜æ”¯æŒé€šè¿‡ Function å’Œ Role Manager è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚Function åƒç”¨æˆ·æä¾›äº†è‡ªå®šä¹‰åŒ¹é…è§„åˆ™çš„æ¥å£ã€‚é€šè¿‡å‘ Matcher ä¼ å…¥è‡ªå®šä¹‰å‡½æ•°ï¼ŒMatcher å¯ä»¥å¯¹ Request ä¸ Policy ä¹‹é—´è¿›è¡Œä¸€äº›å¤æ‚çš„åŒ¹é…ã€‚\n   \n   å¯¹äº RBAC ç­‰è®¿é—®æ§åˆ¶æ¨¡å‹ï¼Œé™¤äº†å•çº¯çš„ç”¨æˆ·ä¸æƒé™ä¹‹é—´å­˜åœ¨å…³ç³»ä¹‹å¤–ï¼Œç”¨æˆ·ä¸è§’è‰²ï¼ˆRoleï¼‰ä¹‹é—´è¿˜å­˜åœ¨ç€ç»§æ‰¿å…³ç³»ã€‚Casbin ä¸­é‡‡ç”¨äº† Role Manager æ¥ä¸ºä¸€æ¡ Request çš„ç”¨æˆ·ä»¥åŠå…¶å¯¹åº”è§’è‰²ï¼ˆåŒ…å«ç»§æ‰¿è§’è‰²ï¼‰å¯»æ‰¾ä¸å…¶ç›¸å…³çš„ Policyã€‚åŒæ—¶ï¼ŒRole Manager ä¹Ÿæ”¯æŒæ·»åŠ è‡ªå®šä¹‰çš„ Functionï¼Œæ¥å¯¹ç”¨æˆ·ä¸è§’è‰²ä¹‹é—´è¿›è¡Œå¤æ‚çš„åŒ¹é…ã€‚\n\n4. åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸€æ¡ Request å¯èƒ½ä¼šåŒ¹é…åˆ°å¤šæ¡ Policyã€‚å¾—åˆ°æ‰€æœ‰çš„ Policy åï¼Œéœ€è¦è¿›ä¸€æ­¥å°†å¤šæ¡ Policy çš„ç»“æœè¿›è¡Œèšåˆï¼Œå¾—åˆ°æœ€ç»ˆæ˜¯å¦å…è®¸ Requestã€‚Effector æ ¹æ® Model ä¸­é…ç½®çš„è§„åˆ™ï¼Œå¯¹æ‰€æœ‰ Matched Policy çš„ effect é¡¹è¿›è¡Œè¿›ä¸€æ­¥çš„ evalã€‚\n\n5. åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œè®¿é—®æ§åˆ¶æœåŠ¡ä¼šæœ‰å¤šä¸ªå®ä¾‹ã€‚Casbin æ”¯æŒå¯¹ Policy è¿›è¡Œå¢é‡æ›´æ–°ï¼Œé‚£ä¹ˆï¼Œå°±éœ€è¦ Dispatcher ç»´æŠ¤å¤šä¸ª Casbin å®ä¾‹çš„ Policy ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚Dispatcher ä¸»è¦æä¾›ä¸¤éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä¸€éƒ¨åˆ†æ˜¯ Casbin çš„ APIï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ Dispatcher è‡ªèº«çš„ APIï¼Œç”¨æ¥å®ç°æˆå‘˜ç®¡ç†ç­‰ä¸€è‡´æ€§é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ Raft ç­‰å…±è¯†ç®—æ³•å®ç°ã€‚\n\n## Usage\n\nåœ¨äº†è§£äº† Casbin çš„åŸç†å’Œç»“æ„åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹åˆ©ç”¨ Casbin æ¥è¿›è¡Œä¸€äº›å®è·µã€‚æœ¬ç« ä»¥ RBAC æ¨¡å‹ä¸ºä¾‹ï¼Œæ„å»ºä¸€ä¸ªç®€å•çš„è®¿é—®æ§åˆ¶ç¤ºä¾‹ã€‚RBAC (Role-Based Access Control) æ¨¡å‹æ˜¯åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶æ¨¡å‹ã€‚åœ¨ RBAC çš„æ¨¡å‹ä¸­ï¼Œç”¨æˆ·å’Œèµ„æºä¹‹é—´å­˜åœ¨ç€è§’è‰²ï¼ˆRoleï¼‰ï¼Œç”¨æˆ·å¯ä»¥å±äºä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²ï¼Œè§’è‰²æ‹¥æœ‰æƒé™å»è®¿é—®èµ„æºã€‚\n\nç»è¿‡å‰ä¸¤ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥å°†è®¿é—®æ§åˆ¶åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šStaticï¼ŒDynamic å’Œ User-specific Logicã€‚åœ¨ä½¿ç”¨ Casbin æ—¶ï¼Œä¹Ÿå¯ä»¥è¿™æ ·è¿›è¡Œåˆ’åˆ†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸ªé™æ€çš„ RBAC Modelï¼ˆmodel.confï¼‰ã€‚\n\n```c#\n[request_definition]\nr = sub, obj, act\n\n[policy_definition]\np = sub, obj, act\n\n[role_definition]\ng = _, _\n\n[policy_effect]\ne = some(where (p.eft == allow))\n\n[matchers]\nm = g(r.sub, p.sub) && r.obj == p.obj && r.act == p.act\n```\n\nåœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œåˆ†åˆ«å®šä¹‰äº†äº”éƒ¨åˆ†å†…å®¹ã€‚\n\n1. **request_definition**ï¼Œå®šä¹‰äº† Request çš„ç»“æ„ã€‚è¿™ä»½ç¤ºä¾‹ä¸­åŒ…å«äº†è®¿é—®è€…ï¼ˆsubï¼‰ï¼Œè¢«è®¿é—®è€…ï¼ˆobjï¼‰å’Œæ“ä½œï¼ˆactï¼‰ã€‚\n2. **policy_definition**ï¼Œå®šä¹‰äº† Policy çš„ç»“æ„ã€‚é€šå¸¸ï¼Œç”±äº Policy å’Œ Request ä¹‹é—´è¦è¿›è¡ŒåŒ¹é…ï¼Œæ‰€ä»¥ä¸¤è€…çš„ç»“æ„æœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§ã€‚\n3. **role_definition**ï¼Œå®šä¹‰äº† Role Managerã€‚`g` å®šä¹‰äº†ä¸€å¥— RBAC ç³»ç»Ÿï¼Œæ¢å¥è¯è¯´æ˜¯ä¸€ç»„ç”¨æˆ·è§’è‰²ç»§æ‰¿å…³ç³»çš„é›†åˆã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ›´ç±»ä¼¼äºä¸€ä¸ªå‡½æ•°ï¼Œåˆ¤æ–­è¾“å…¥çš„å‚æ•°æ˜¯å¦åœ¨è¿™ä¸ªé›†åˆä¸­å­˜åœ¨ç»§æ‰¿å…³ç³»ã€‚\n4. **policy_effect**ï¼Œå®šä¹‰äº†å¦‚ä½•å¯¹å¤šä¸ªåŒ¹é…åˆ°çš„ Policy åšåˆå¹¶ã€‚ç›®å‰ï¼ŒCasbin æ”¯æŒå‡ ä¸ªå›ºå®šè¯­æ³•çš„åˆå¹¶æ¨¡å¼ï¼Œåœ¨å®˜ç½‘ [<sup>3</sup>](#policy) ä¸Šæœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚è¿™äº›æ¨¡å¼çš„å«ä¹‰ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæ¨¡å¼çš„è¯­æ³•ä¸è‡ªç„¶è¯­è¨€æˆ–è€… SQL éå¸¸ç›¸è¿‘ã€‚ä¾‹å¦‚ï¼Œ`some(where (p.eft == allow))` è¡¨ç¤ºçš„æ˜¯å½“ä»»æ„ä¸€ä¸ª Policy çš„ effect æ˜¯ allowï¼Œé‚£ä¹ˆåˆå¹¶çš„ç»“æœå³ä¸º allowã€‚\n5. **matchers**ï¼Œå®šä¹‰äº†å¦‚ä½•åŒ¹é… Policy å’Œ Requestã€‚ å®šä¹‰å…¬å¼çš„è¯­æ³•ä¸å¸¸è§è¯­è¨€ä¸­çš„å¸ƒå°”è¡¨è¾¾å¼ç›¸ä¼¼ï¼Œé€šè¿‡ `==` å¯ä»¥å°† Policy å’Œ Request ä¸­çš„å„é¡¹è¿›è¡Œå¯¹æ¯”ã€‚\n\n#### Policy\n\n```\np, alice, data1, read\np, bob, data2, write\np, data2_admin, data2, read\np, data2_admin, data2, write\ng, alice, data2_admin\n```\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ Model ä¸­å®šä¹‰çš„ Policy ç»“æ„æ¥ç¼–å†™ Policy å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€é¡¹ `p, alice, data1, read` ä¸ `p = sub, obj, act` ç›¸å¯¹åº”ï¼Œ`alice`ï¼Œ`data1`ï¼Œ`read` ä¸ `sub`ï¼Œ`obj`ï¼Œ`act` ç›¸å¯¹åº”ã€‚å¦å¤–ä¸€æ¡æ¯”è¾ƒç‰¹æ®Šçš„å®ä¾‹æ˜¯æœ€åä¸€é¡¹ï¼Œ`g, alice, data2_admin`ï¼Œå®šä¹‰äº†ç”¨æˆ· `alice` ç»§æ‰¿äº† `data2_admin` è¿™ä¸€è§’è‰²ã€‚\n\næˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„ Policy ä¿å­˜åœ¨æ–‡ä»¶ policy.csv ä¸­ã€‚ä½†ä¸€èˆ¬æ¥è¯´ï¼ŒPolicy å‚¨å­˜åœ¨æ•°æ®åº“ç­‰ç­‰ä¸€äº›æ›´åŠ  organized çš„å¤–éƒ¨å­˜å‚¨ä¸­ã€‚\n\n#### User Logic\n\nCasbin å‡ ä¹æ”¯æŒæ‰€æœ‰çš„å¸¸è§çš„ç¼–ç¨‹è¯­è¨€ï¼Œç”¨æˆ·ä½¿ç”¨çš„é€»è¾‘ä¹ŸåŸºæœ¬ç›¸ä¼¼ï¼Œä¸»è¦é€šè¿‡ Enforcer ç±»æ¥è¿›è¡Œæ“ä½œã€‚\n\n```go\ne, err := casbin.NewEnforcer(\"model.conf\", \"policy.csv\")\nresult1, _ := e.Enforce(\"alice\", \"data1\", \"read\")\nfmt.Println(result1)\nresult2, _ := e.Enforce(\"alice\", \"data1\", \"write\")\nfmt.Println(result2)\nresult3, _ := e.Enforce(\"alice\", \"data2\", \"read\")\nfmt.Println(result3)\n```\n\né€šè¿‡ Enforce æ–¹æ³•ï¼Œå¼€å‘è€…è¾“å…¥ Requestï¼Œå°±å¯ä»¥å¾—åˆ°è¿™æ¡è¯·æ±‚æ˜¯å¦å¯ä»¥é€šè¿‡ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­æœ‰ 3 ä¸ª test caseï¼Œåˆ†åˆ«éªŒè¯äº†åˆæ³•è¯·æ±‚åŒ¹é…ï¼Œéæ³•è¯·æ±‚åŒ¹é…ï¼Œé›†æˆè§’è‰²è¯·æ±‚åŒ¹é…ã€‚ç¬¬ä¸€ä¸ª test case å¯¹åº”äº† policy.csv ä¸­çš„ç¬¬ä¸€æ¡ Policyï¼Œç¬¬äºŒä¸ª test case åˆ™æ²¡æœ‰ test caseã€‚ç¬¬ä¸‰ä¸ª test case é€šè¿‡ `g, alice, data2_admin` å°† alice ä¸ data2_admin çš„ Policy å…³è”èµ·æ¥ï¼Œç„¶åé€šè¿‡ç¬¬ä¸‰æ¡ Policy p, data2_admin, data2, read éªŒè¯å…¶ä¸ºåˆæ³•è¯·æ±‚ã€‚\n\n## Reference\n<div id=\"ref1\"/>\n- [1] https://github.com/casbin/casbin\n<div id=\"ref2\"/>\n- [2] https://arxiv.org/pdf/1903.09756.pdf\n<div id=\"ref3\"/>\n- [3] https://casbin.org/docs/en/syntax-for-models#policy-effect\n","source":"_posts/casbin-ramp-up.md","raw":"---\ntitle: \"[Introduction] Casbin is All You Need â€”â€” è®¿é—®æ§åˆ¶æ¡†æ¶ Casbin Ramp Up\"\ndate: 2022-06-22 01:05:51\nupdated: 2022-06-22 01:05:51\n---\n\n## TL;DR\n\n- è®¿é—®æ§åˆ¶æ¡†æ¶ Casbin çš„åŸç†ä»¥åŠå…¶å†…éƒ¨ç»„ä»¶çš„ç»“æ„\n- ä»¥ä¸€ä¸ª RBAC çš„ç®€å•ä¾‹å­ä»‹ç» Casbin çš„ç”¨æ³•\n\n## Casbinæ˜¯ä»€ä¹ˆï¼Ÿ\n### è®¿é—®æ§åˆ¶\n\n![](/asset/casbin-ramp-up/2022-06-23-17-50-00-image.png)\n\nè®¿é—®æ§åˆ¶ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯æŒ‡åˆ¤æ–­ä¸€æ¡è¯·æ±‚æ˜¯å¦å¯ä»¥è®¿é—®å—ä¿æŠ¤çš„èµ„æºçš„æŠ€æœ¯ã€‚åœ¨ä¸Šå›¾çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„åå°ä¸­æœ‰ä¸¤ä¸ªèµ„æºï¼ŒResource1å’ŒResource2ã€‚å®ƒä»¬å¯ä»¥æ˜¯æœåŠ¡å™¨ã€è´¦å·ã€å›¾ç‰‡ã€è§†é¢‘ç­‰ç­‰ç­‰ç­‰ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬çš„ç›¸åŒç‰¹æ€§æ˜¯ä¸èƒ½è¢«æ‰€æœ‰ç”¨æˆ·éƒ½è®¿é—®ã€‚æ¯”å¦‚ Resource1 å±äºç”¨æˆ· Aliceï¼Œé‚£ä¹ˆåªæœ‰ Alice èƒ½å¤Ÿè®¿é—®å®ƒï¼ŒBob åˆ™ä¸èƒ½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹è®¿é—®è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œåˆ¤æ–­å…¶æ˜¯å¦è¢«å…è®¸åˆ°è¾¾ç›®æ ‡èµ„æºã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒAlice å‘èµ·äº†ä¸¤ä¸ªè®¿é—®è¯·æ±‚ï¼Œåˆ†åˆ«æƒ³è¦è®¿é—® Resource1 å’Œ Resource2ã€‚è®¿é—®æ§åˆ¶å±‚éœ€è¦åšçš„å·¥ä½œå°±æ˜¯å…è®¸è®¿é—® Resource1 çš„è¯·æ±‚é€šè¿‡ï¼Œè€Œé˜»æ‹¦æƒ³è¦è®¿é—® Resource2 çš„è¯·æ±‚ï¼Œå› ä¸º Resource2 å±äº Bobï¼ŒAlice æ˜¯æ— æ³•è®¿é—®çš„ã€‚\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè®¿é—®æ§åˆ¶é—®é¢˜å¾€å¾€ä¼šéšç€ä¸šåŠ¡è€Œå˜å¾—éå¸¸å¤æ‚ã€‚è€Œ Casbin [<sup>1</sup>](#casbin) å°±æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ã€é«˜æ•ˆçš„å¼€æºè®¿é—®æ§åˆ¶æ¡†æ¶ã€‚Casbin åœ¨ Github ä¸Šå·²è·å¾—è¶…è¿‡ 10k+ starï¼Œå¹¶ä¸”æœ‰ç€éå¸¸å®Œæ•´çš„ç”Ÿæ€ã€‚åŸºäº Casbin å¯ä»¥è½»æ¾çš„å®ç°ä¸€ç³»åˆ—è®¿é—®æ§åˆ¶æ¨¡å‹ï¼Œå¦‚ RBACï¼ŒABACç­‰ç­‰ã€‚\n\n### åŸç†â€”â€”PML\n\nCasbin çš„åº•å±‚åŸç†åŸºäºå…¶åˆ›å»ºè€…ç½—æ¨åšå£«æ‰€å‘è¡¨çš„ä¸€ç¯‡è®ºæ–‡ã€ŠPML: An Interpreter-Based Access Control Policy Language for Web Servicesã€‹[<sup>2</sup>](#pml)\n\n#### è®¾è®¡ç›®æ ‡\n\nè¿™ç¯‡è®ºæ–‡ä¸»è¦å…³æ³¨äºå¦‚ä½•è§£å†³ç°å®ä¸­äº‘æœåŠ¡å‚å•†æœ‰å…³æƒé™æ ¡éªŒæ‰€é‡åˆ°çš„ä¸¤ä¸ªé—®é¢˜ï¼š\n\n1. æ¯ä¸ªäº‘æœåŠ¡å‚å•†éƒ½æœ‰ç€è‡ªå·±çš„ä¸€å¥—æƒé™æ£€éªŒè§„åˆ™ã€‚è¿™å¯¹äºåœ¨å¤šä¸ªäº‘ç¯å¢ƒéƒ½è¿›è¡Œéƒ¨ç½²çš„ç”¨æˆ·æ¥è¯´ï¼Œé€ æˆäº†å¾ˆå¤§çš„è¿ç§»å’Œç»´æŠ¤æˆæœ¬ã€‚\n2. åŒæ ·çš„ï¼Œç»´æŠ¤è‡ªå·±çš„ä¸€å¥—æƒé™æ ¡éªŒè§„åˆ™å¯¹äºäº‘æœåŠ¡å‚å•†æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚å¦‚æœäº‘æœåŠ¡å‚å•†ç¼ºä¹åœ¨è¿™æ–¹é¢çš„ç›¸å…³ç»éªŒï¼Œå°±å¾ˆæœ‰å¯èƒ½é€ æˆå®‰å…¨æ¼æ´ã€‚\n\næ—¢ç„¶æ–‡ç« çš„ç›®æ ‡æœ¬è´¨ä¸Šæ˜¯é€šè¿‡é€šç”¨æ€§æ¥è§£å†³é—®é¢˜ï¼Œä½œè€…ä¹Ÿè€ƒè™‘äº†å¦‚ä½•å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæå‡ºäº†ä¸¤ä¸ª independent çš„è®¾è®¡è¦æ±‚ï¼š\n\n1. Access Control Model Independentï¼šPML æ—¢éœ€è¦æ”¯æŒç”¨æˆ·å¯ä»¥åœ¨å¤šä¸ªäº‘æœåŠ¡å‚å•†ä¸­ä½¿ç”¨åŒä¸€ä¸ªæ¨¡å‹ï¼Œä¹Ÿéœ€è¦æ”¯æŒç”¨æˆ·åœ¨ä¸æ”¹å˜æ ¡éªŒä»£ç çš„åŒæ—¶ï¼Œå¯ä»¥åˆ‡æ¢ä¸åŒçš„æ¨¡å‹ã€‚\n2. Implementation Language Independent: PML çš„è®¾è®¡ä¸åº”è¯¥ä¾èµ–äºæŸç§ç¼–ç¨‹è¯­è¨€çš„ç‰¹æ€§ã€‚\n   å› æ­¤ï¼Œæ–‡ä¸­æå‡ºäº†ä¸€ç§æ–°çš„æƒé™æ ¡éªŒè¯­è¨€â€”â€”PML (PERM Modeling Language)ï¼Œå¸Œæœ›é€šè¿‡ä¸€ç§æ”¯æŒå¤šç§æƒé™æ ¡éªŒæ¨¡å‹çš„é…ç½®è¯­è¨€æ¥å¼¥è¡¥è¿™ä¸ª gapã€‚\n\n#### è®¾è®¡å®ç°\n\nåœ¨ä»‹ç» PML çš„è®¾è®¡ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå¤§è‡´äº†è§£ä¸€ä¸‹è®¿é—®æ§åˆ¶é—®é¢˜ä¸­ï¼Œæ‰€æ¶‰åŠåˆ°çš„ä¸€äº›æ¦‚å¿µã€‚\n\n![1c2dea1652f67c0b7920b0471a4113afd8d9325a.png](/asset/casbin-ramp-up/overview.png)\n\nä¸€èˆ¬æ¥è¯´ï¼Œè®¿é—®æ§åˆ¶ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªéƒ¨åˆ†ï¼š\n\n1. **Model è®¿é—®æ§åˆ¶æ¨¡å‹**ã€‚å¸¸è§çš„æ¨¡å‹æœ‰ ACLï¼ˆAccess Control List è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰ï¼ŒRBACï¼ˆRole-Based Access Control åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰ï¼ŒABACï¼ˆAttribute-Based Access Control åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰ã€‚å¯¹äºä¸€ä¸ªåº”ç”¨æ¥è¯´ï¼ŒModel çš„é€‰æ‹©æ˜¯ä¸åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘æ˜¯å¯†åˆ‡ç›¸å…³çš„ï¼Œå› æ­¤ä¹Ÿæ˜¯ç›¸å¯¹é™æ€çš„ã€‚ä¸€æ—¦ä»£ç ç¼–è¯‘å®Œæˆï¼Œè¿™éƒ¨åˆ†æ˜¯ä¸ä¼šéšç€åº”ç”¨çš„è¿è¡Œè€Œäº§ç”Ÿå˜åŒ–çš„ã€‚\n2. **Policy è®¿é—®æ§åˆ¶è§„åˆ™**ã€‚Policy æ˜¯å’Œ Model ç›¸å¯¹åº”çš„ï¼Œæ¯ç§ä¸åŒçš„ Modelï¼Œéƒ½ä¼šæœ‰ä¸åŒæ ¼å¼çš„ Policyã€‚è€Œä¸ Model å®Œå…¨ç›¸åçš„æ˜¯ï¼ŒPolicy æ˜¯ç›¸å¯¹åŠ¨æ€çš„ã€‚åœ¨ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å»å®šä¹‰ Policy çš„æ ¼å¼ï¼Œè€Œ Policy çš„å…·ä½“å†…å®¹éƒ½æ˜¯åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­æ·»åŠ æˆ–ä¿®æ”¹çš„ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªæ–°ç”¨æˆ·æ³¨å†Œäº†æˆ‘ä»¬çš„åº”ç”¨ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±éœ€è¦åŠ¨æ€çš„ä¸ºå…¶æ·»åŠ ä¸€æ¡ Policyã€‚\n\næˆ‘ä»¬å¯ä»¥å°†è¿™ä¸¤éƒ¨åˆ†ç†è§£ä¸ºä¼ ç»Ÿåº”ç”¨ä¸­çš„ä»£ç å’Œæ•°æ®ã€‚æœ‰äº†è¿™ä¸¤éƒ¨åˆ†åï¼Œå†åŠ ä¸Šç”¨æˆ·ç‰¹å®šçš„æ ¡éªŒé€»è¾‘ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œæˆè®¿é—®æ§åˆ¶ä»»åŠ¡ã€‚\n\n##### PERM æ¨¡å‹\n\nå½“ç„¶ï¼Œå¯¹äºç°å®ç¯å¢ƒä¸­å¤æ‚çš„æƒ…å†µï¼Œç®€å•åœ°å°†é—®é¢˜å»ºæ¨¡ä¸ºè¿™ä¸¤éƒ¨åˆ†è‚¯å®šæ˜¯ä¸å¤Ÿçš„ï¼Œå› æ­¤ï¼Œè®ºæ–‡æå‡ºäº†ä¸€ä¸ªæ–°çš„å…ƒæ¨¡å‹ PERMï¼ˆPolicy-Effect-Request-Matcherï¼‰ã€‚\n\n![6d8fa0a037c3ea185cfadb8d817c41cce0d66d78.png](/asset/casbin-ramp-up/pml.png)\n\nPERM æ¨¡å‹ä¸»è¦åŒ…å«äº† 6 ä¸ªä¸»è¦çš„æ¦‚å¿µï¼š\n\n1. **Request**ï¼šè®¿é—®è¯·æ±‚å®šä¹‰ã€‚ç”¨æˆ·çœŸå®çš„è®¿é—®è¯·æ±‚ï¼Œé€šå¸¸ä¼šåŒ…å« subï¼ˆè®¿é—®è€…ï¼‰ï¼Œobjï¼ˆè¢«è®¿é—®çš„èµ„æºï¼‰ï¼Œ actï¼ˆè®¿é—®æ—¶æ‰€è¿›è¡Œçš„æ“ä½œï¼‰æˆ–å…¶ä»–ç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ã€‚\n2. **Policy**ï¼šè®¿é—®æ§åˆ¶è§„åˆ™å®šä¹‰ã€‚å®šä¹‰äº†éœ€è¦å¯¹è®¿é—®è¯·æ±‚çš„å“ªäº›å±æ€§è¿›è¡Œæ ¡éªŒã€‚\n3. **Policy Rule**ï¼šè®¿é—®æ§åˆ¶è§„åˆ™å®ä¾‹ã€‚\n4. **Matcher**ï¼šå¦‚ä½•ä¸ºä¸€æ¡ Request åŒ¹é…åˆ°å…¶å¯¹åº”çš„ Policy Ruleã€‚\n5. **Effect**ï¼šå½“ä¸€æ¡ Request åŒ¹é…åˆ°äº†ä¸€æ¡æˆ–å¤šæ¡ Policy Ruleï¼Œå¦‚ä½•åˆ¤æ–­å…¶æ˜¯å¦åº”è¯¥è¢«å…è®¸ã€‚\n6. **Stub Function**ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼ŒRequest å®ä¾‹ å’Œ Policy Rule çš„åŒ¹é…å¾€å¾€æ— æ³•é€šè¿‡ç®€å•çš„ == ç­‰äºæ¥è§£å†³ï¼Œä¾‹å¦‚é€šé…ç¬¦ç­‰ç­‰ã€‚æ‰€ä»¥ Stub Function å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ä¸€äº›å¤æ‚çš„åŒ¹é…æ–¹æ³•ã€‚\n\nè¿™å…­ä¸ªæ›´åŠ è¯¦ç»†çš„å»ºæ¨¡äº†è®¿é—®æ§åˆ¶çš„é—®é¢˜ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶ç®€å•çš„åˆ†ä¸€ä¸‹ç±»ï¼ŒRequestï¼ŒPolicyï¼ŒMatcherï¼ŒEffect å’Œ Stub Function éƒ½æ˜¯é™æ€çš„ï¼Œå±äº Model çš„ä¸€éƒ¨åˆ†ã€‚é€šè¿‡è¿™ä¸ªäº”é¡¹çš„ç»„åˆï¼ŒACLç­‰å¸¸è§çš„æ¨¡å‹ä»¥åŠä¸€äº›ç”¨æˆ·è‡ªå®šä¹‰çš„è§„åˆ™ï¼Œéƒ½å¯ä»¥å¾ˆè½»æ˜“çš„è¡¨ç¤ºå‡ºæ¥ã€‚åœ¨æœ€åä¸€éƒ¨åˆ†ä¸­ï¼Œä¼šä»¥ RBAC ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•é€šè¿‡ PML å®ç°è¿™æ ·ä¸€ä¸ªæ¨¡å‹ã€‚\n\nè€Œ Policy Rule å°±å±äºåŠ¨æ€å˜åŒ–çš„å†…å®¹ã€‚åœ¨å®é™…å®ç°ä¸­ï¼Œå¾€å¾€ä¹Ÿæ˜¯åƒæ•°æ®ä¸€æ ·ï¼Œå­˜å‚¨åœ¨æ•°æ®åº“å½“ä¸­çš„ã€‚\n\n## ç»“æ„\n\nä¸è®ºæ–‡ä¸­çš„å®ç°ç›¸æ¯”ï¼Œç›®å‰ Casbin çš„å®ç°æ›´åŠ å¼ºå¤§ï¼Œæ”¯æŒäº†æ›´å¤šåŠŸèƒ½ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œä»¥ Casbin ä¸»åº“ï¼ˆGo ç‰ˆæœ¬ï¼‰ï¼Œä»‹ç» Casbin æ˜¯å¦‚ä½•è¿›è¡Œå·¥ä½œçš„ã€‚\n\n![6dbf7fb95022569c5ad99becdcd9090df8a99250.png](/asset/casbin-ramp-up/detail.png)\n\n1. åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼ŒCasbin ä¼šè¯»å–ç”¨æˆ·å·²ç»å®šä¹‰å¥½çš„ Modelï¼Œå…¶ä¸­ä¼šåŒ…å« Request, Policy, Matcher å’Œ Effector å››ä¸ªéƒ¨åˆ†çš„å®šä¹‰ã€‚åŒæ—¶ï¼ŒCasbin ä¼šåˆ©ç”¨ Adapterï¼Œä»æ•°æ®æºå¤„è¯»å– Policy å®ä¾‹ï¼ˆä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„ Policy Ruleï¼‰ã€‚åæ–‡å°±å°† Policy å®ä¾‹ç®€ç§°ä¸º Policyã€‚\n\n2. å¯¹äº Policy çš„å­˜å‚¨å’Œè¯»å–ï¼ŒCasbin å°†å…¶è§£è€¦åˆ°äº†ç‹¬ç«‹çš„ Adapter æ¨¡å—ã€‚é€šè¿‡ä½¿ç”¨ä¸åŒçš„ Adapterï¼ˆFile, MySQLç­‰ç­‰ï¼‰ï¼Œå¯ä»¥ä»ä¸åŒçš„æ•°æ®æºä¸­è¯»å– Policyã€‚å¯¹äº Policy æ¯”è¾ƒå¤šçš„åœºæ™¯ï¼Œå°†æ‰€æœ‰çš„ Policy åŒæ—¶åŠ è½½è¿›å†…å­˜ï¼Œç¡®å®ä¼šå¯¼è‡´ä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚æ‰€ä»¥ï¼Œåœ¨åŠ è½½æ—¶ï¼Œéƒ¨åˆ† Adapter ä¹Ÿæä¾› `LoadFilteredPolicy` çš„æ¥å£ï¼Œé€šè¿‡åªåŠ è½½ Policy çš„ä¸€éƒ¨åˆ†å­é›†ï¼Œå‡å°‘è¿™éƒ¨åˆ†å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆã€‚\n\n3. åœ¨ä¸€æ¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œè¯¥è¯·æ±‚é¦–å…ˆä¼šæŒ‰ç…§ Model ä¸­çš„å®šä¹‰è¿›è¡Œæ‹†åˆ†ã€‚æ¥ä¸‹æ¥ï¼ŒMatcher ä¼šæ ¹æ® Model ä¸­å®šä¹‰çš„è§„åˆ™ï¼Œä¸ Policy è¿›è¡ŒåŒ¹é…ã€‚é™¤äº†æ”¯æŒ == å¼ºåŒ¹é…å¤–ï¼ŒMatcher è¿˜æ”¯æŒé€šè¿‡ Function å’Œ Role Manager è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚Function åƒç”¨æˆ·æä¾›äº†è‡ªå®šä¹‰åŒ¹é…è§„åˆ™çš„æ¥å£ã€‚é€šè¿‡å‘ Matcher ä¼ å…¥è‡ªå®šä¹‰å‡½æ•°ï¼ŒMatcher å¯ä»¥å¯¹ Request ä¸ Policy ä¹‹é—´è¿›è¡Œä¸€äº›å¤æ‚çš„åŒ¹é…ã€‚\n   \n   å¯¹äº RBAC ç­‰è®¿é—®æ§åˆ¶æ¨¡å‹ï¼Œé™¤äº†å•çº¯çš„ç”¨æˆ·ä¸æƒé™ä¹‹é—´å­˜åœ¨å…³ç³»ä¹‹å¤–ï¼Œç”¨æˆ·ä¸è§’è‰²ï¼ˆRoleï¼‰ä¹‹é—´è¿˜å­˜åœ¨ç€ç»§æ‰¿å…³ç³»ã€‚Casbin ä¸­é‡‡ç”¨äº† Role Manager æ¥ä¸ºä¸€æ¡ Request çš„ç”¨æˆ·ä»¥åŠå…¶å¯¹åº”è§’è‰²ï¼ˆåŒ…å«ç»§æ‰¿è§’è‰²ï¼‰å¯»æ‰¾ä¸å…¶ç›¸å…³çš„ Policyã€‚åŒæ—¶ï¼ŒRole Manager ä¹Ÿæ”¯æŒæ·»åŠ è‡ªå®šä¹‰çš„ Functionï¼Œæ¥å¯¹ç”¨æˆ·ä¸è§’è‰²ä¹‹é—´è¿›è¡Œå¤æ‚çš„åŒ¹é…ã€‚\n\n4. åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸€æ¡ Request å¯èƒ½ä¼šåŒ¹é…åˆ°å¤šæ¡ Policyã€‚å¾—åˆ°æ‰€æœ‰çš„ Policy åï¼Œéœ€è¦è¿›ä¸€æ­¥å°†å¤šæ¡ Policy çš„ç»“æœè¿›è¡Œèšåˆï¼Œå¾—åˆ°æœ€ç»ˆæ˜¯å¦å…è®¸ Requestã€‚Effector æ ¹æ® Model ä¸­é…ç½®çš„è§„åˆ™ï¼Œå¯¹æ‰€æœ‰ Matched Policy çš„ effect é¡¹è¿›è¡Œè¿›ä¸€æ­¥çš„ evalã€‚\n\n5. åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œè®¿é—®æ§åˆ¶æœåŠ¡ä¼šæœ‰å¤šä¸ªå®ä¾‹ã€‚Casbin æ”¯æŒå¯¹ Policy è¿›è¡Œå¢é‡æ›´æ–°ï¼Œé‚£ä¹ˆï¼Œå°±éœ€è¦ Dispatcher ç»´æŠ¤å¤šä¸ª Casbin å®ä¾‹çš„ Policy ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚Dispatcher ä¸»è¦æä¾›ä¸¤éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä¸€éƒ¨åˆ†æ˜¯ Casbin çš„ APIï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ Dispatcher è‡ªèº«çš„ APIï¼Œç”¨æ¥å®ç°æˆå‘˜ç®¡ç†ç­‰ä¸€è‡´æ€§é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ Raft ç­‰å…±è¯†ç®—æ³•å®ç°ã€‚\n\n## Usage\n\nåœ¨äº†è§£äº† Casbin çš„åŸç†å’Œç»“æ„åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹åˆ©ç”¨ Casbin æ¥è¿›è¡Œä¸€äº›å®è·µã€‚æœ¬ç« ä»¥ RBAC æ¨¡å‹ä¸ºä¾‹ï¼Œæ„å»ºä¸€ä¸ªç®€å•çš„è®¿é—®æ§åˆ¶ç¤ºä¾‹ã€‚RBAC (Role-Based Access Control) æ¨¡å‹æ˜¯åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶æ¨¡å‹ã€‚åœ¨ RBAC çš„æ¨¡å‹ä¸­ï¼Œç”¨æˆ·å’Œèµ„æºä¹‹é—´å­˜åœ¨ç€è§’è‰²ï¼ˆRoleï¼‰ï¼Œç”¨æˆ·å¯ä»¥å±äºä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²ï¼Œè§’è‰²æ‹¥æœ‰æƒé™å»è®¿é—®èµ„æºã€‚\n\nç»è¿‡å‰ä¸¤ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥å°†è®¿é—®æ§åˆ¶åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šStaticï¼ŒDynamic å’Œ User-specific Logicã€‚åœ¨ä½¿ç”¨ Casbin æ—¶ï¼Œä¹Ÿå¯ä»¥è¿™æ ·è¿›è¡Œåˆ’åˆ†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸ªé™æ€çš„ RBAC Modelï¼ˆmodel.confï¼‰ã€‚\n\n```c#\n[request_definition]\nr = sub, obj, act\n\n[policy_definition]\np = sub, obj, act\n\n[role_definition]\ng = _, _\n\n[policy_effect]\ne = some(where (p.eft == allow))\n\n[matchers]\nm = g(r.sub, p.sub) && r.obj == p.obj && r.act == p.act\n```\n\nåœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œåˆ†åˆ«å®šä¹‰äº†äº”éƒ¨åˆ†å†…å®¹ã€‚\n\n1. **request_definition**ï¼Œå®šä¹‰äº† Request çš„ç»“æ„ã€‚è¿™ä»½ç¤ºä¾‹ä¸­åŒ…å«äº†è®¿é—®è€…ï¼ˆsubï¼‰ï¼Œè¢«è®¿é—®è€…ï¼ˆobjï¼‰å’Œæ“ä½œï¼ˆactï¼‰ã€‚\n2. **policy_definition**ï¼Œå®šä¹‰äº† Policy çš„ç»“æ„ã€‚é€šå¸¸ï¼Œç”±äº Policy å’Œ Request ä¹‹é—´è¦è¿›è¡ŒåŒ¹é…ï¼Œæ‰€ä»¥ä¸¤è€…çš„ç»“æ„æœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§ã€‚\n3. **role_definition**ï¼Œå®šä¹‰äº† Role Managerã€‚`g` å®šä¹‰äº†ä¸€å¥— RBAC ç³»ç»Ÿï¼Œæ¢å¥è¯è¯´æ˜¯ä¸€ç»„ç”¨æˆ·è§’è‰²ç»§æ‰¿å…³ç³»çš„é›†åˆã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ›´ç±»ä¼¼äºä¸€ä¸ªå‡½æ•°ï¼Œåˆ¤æ–­è¾“å…¥çš„å‚æ•°æ˜¯å¦åœ¨è¿™ä¸ªé›†åˆä¸­å­˜åœ¨ç»§æ‰¿å…³ç³»ã€‚\n4. **policy_effect**ï¼Œå®šä¹‰äº†å¦‚ä½•å¯¹å¤šä¸ªåŒ¹é…åˆ°çš„ Policy åšåˆå¹¶ã€‚ç›®å‰ï¼ŒCasbin æ”¯æŒå‡ ä¸ªå›ºå®šè¯­æ³•çš„åˆå¹¶æ¨¡å¼ï¼Œåœ¨å®˜ç½‘ [<sup>3</sup>](#policy) ä¸Šæœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚è¿™äº›æ¨¡å¼çš„å«ä¹‰ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæ¨¡å¼çš„è¯­æ³•ä¸è‡ªç„¶è¯­è¨€æˆ–è€… SQL éå¸¸ç›¸è¿‘ã€‚ä¾‹å¦‚ï¼Œ`some(where (p.eft == allow))` è¡¨ç¤ºçš„æ˜¯å½“ä»»æ„ä¸€ä¸ª Policy çš„ effect æ˜¯ allowï¼Œé‚£ä¹ˆåˆå¹¶çš„ç»“æœå³ä¸º allowã€‚\n5. **matchers**ï¼Œå®šä¹‰äº†å¦‚ä½•åŒ¹é… Policy å’Œ Requestã€‚ å®šä¹‰å…¬å¼çš„è¯­æ³•ä¸å¸¸è§è¯­è¨€ä¸­çš„å¸ƒå°”è¡¨è¾¾å¼ç›¸ä¼¼ï¼Œé€šè¿‡ `==` å¯ä»¥å°† Policy å’Œ Request ä¸­çš„å„é¡¹è¿›è¡Œå¯¹æ¯”ã€‚\n\n#### Policy\n\n```\np, alice, data1, read\np, bob, data2, write\np, data2_admin, data2, read\np, data2_admin, data2, write\ng, alice, data2_admin\n```\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ Model ä¸­å®šä¹‰çš„ Policy ç»“æ„æ¥ç¼–å†™ Policy å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€é¡¹ `p, alice, data1, read` ä¸ `p = sub, obj, act` ç›¸å¯¹åº”ï¼Œ`alice`ï¼Œ`data1`ï¼Œ`read` ä¸ `sub`ï¼Œ`obj`ï¼Œ`act` ç›¸å¯¹åº”ã€‚å¦å¤–ä¸€æ¡æ¯”è¾ƒç‰¹æ®Šçš„å®ä¾‹æ˜¯æœ€åä¸€é¡¹ï¼Œ`g, alice, data2_admin`ï¼Œå®šä¹‰äº†ç”¨æˆ· `alice` ç»§æ‰¿äº† `data2_admin` è¿™ä¸€è§’è‰²ã€‚\n\næˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„ Policy ä¿å­˜åœ¨æ–‡ä»¶ policy.csv ä¸­ã€‚ä½†ä¸€èˆ¬æ¥è¯´ï¼ŒPolicy å‚¨å­˜åœ¨æ•°æ®åº“ç­‰ç­‰ä¸€äº›æ›´åŠ  organized çš„å¤–éƒ¨å­˜å‚¨ä¸­ã€‚\n\n#### User Logic\n\nCasbin å‡ ä¹æ”¯æŒæ‰€æœ‰çš„å¸¸è§çš„ç¼–ç¨‹è¯­è¨€ï¼Œç”¨æˆ·ä½¿ç”¨çš„é€»è¾‘ä¹ŸåŸºæœ¬ç›¸ä¼¼ï¼Œä¸»è¦é€šè¿‡ Enforcer ç±»æ¥è¿›è¡Œæ“ä½œã€‚\n\n```go\ne, err := casbin.NewEnforcer(\"model.conf\", \"policy.csv\")\nresult1, _ := e.Enforce(\"alice\", \"data1\", \"read\")\nfmt.Println(result1)\nresult2, _ := e.Enforce(\"alice\", \"data1\", \"write\")\nfmt.Println(result2)\nresult3, _ := e.Enforce(\"alice\", \"data2\", \"read\")\nfmt.Println(result3)\n```\n\né€šè¿‡ Enforce æ–¹æ³•ï¼Œå¼€å‘è€…è¾“å…¥ Requestï¼Œå°±å¯ä»¥å¾—åˆ°è¿™æ¡è¯·æ±‚æ˜¯å¦å¯ä»¥é€šè¿‡ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­æœ‰ 3 ä¸ª test caseï¼Œåˆ†åˆ«éªŒè¯äº†åˆæ³•è¯·æ±‚åŒ¹é…ï¼Œéæ³•è¯·æ±‚åŒ¹é…ï¼Œé›†æˆè§’è‰²è¯·æ±‚åŒ¹é…ã€‚ç¬¬ä¸€ä¸ª test case å¯¹åº”äº† policy.csv ä¸­çš„ç¬¬ä¸€æ¡ Policyï¼Œç¬¬äºŒä¸ª test case åˆ™æ²¡æœ‰ test caseã€‚ç¬¬ä¸‰ä¸ª test case é€šè¿‡ `g, alice, data2_admin` å°† alice ä¸ data2_admin çš„ Policy å…³è”èµ·æ¥ï¼Œç„¶åé€šè¿‡ç¬¬ä¸‰æ¡ Policy p, data2_admin, data2, read éªŒè¯å…¶ä¸ºåˆæ³•è¯·æ±‚ã€‚\n\n## Reference\n<div id=\"ref1\"/>\n- [1] https://github.com/casbin/casbin\n<div id=\"ref2\"/>\n- [2] https://arxiv.org/pdf/1903.09756.pdf\n<div id=\"ref3\"/>\n- [3] https://casbin.org/docs/en/syntax-for-models#policy-effect\n","slug":"casbin-ramp-up","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"cl5i8k7y100041rpfczvk31af","content":"<h2 id=\"TL-DR\"><a href=\"#TL-DR\" class=\"headerlink\" title=\"TL;DR\"></a>TL;DR</h2><ul>\n<li>è®¿é—®æ§åˆ¶æ¡†æ¶ Casbin çš„åŸç†ä»¥åŠå…¶å†…éƒ¨ç»„ä»¶çš„ç»“æ„</li>\n<li>ä»¥ä¸€ä¸ª RBAC çš„ç®€å•ä¾‹å­ä»‹ç» Casbin çš„ç”¨æ³•</li>\n</ul>\n<h2 id=\"Casbinæ˜¯ä»€ä¹ˆï¼Ÿ\"><a href=\"#Casbinæ˜¯ä»€ä¹ˆï¼Ÿ\" class=\"headerlink\" title=\"Casbinæ˜¯ä»€ä¹ˆï¼Ÿ\"></a>Casbinæ˜¯ä»€ä¹ˆï¼Ÿ</h2><h3 id=\"è®¿é—®æ§åˆ¶\"><a href=\"#è®¿é—®æ§åˆ¶\" class=\"headerlink\" title=\"è®¿é—®æ§åˆ¶\"></a>è®¿é—®æ§åˆ¶</h3><p><img src=\"/asset/casbin-ramp-up/2022-06-23-17-50-00-image.png\"></p>\n<p>è®¿é—®æ§åˆ¶ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯æŒ‡åˆ¤æ–­ä¸€æ¡è¯·æ±‚æ˜¯å¦å¯ä»¥è®¿é—®å—ä¿æŠ¤çš„èµ„æºçš„æŠ€æœ¯ã€‚åœ¨ä¸Šå›¾çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„åå°ä¸­æœ‰ä¸¤ä¸ªèµ„æºï¼ŒResource1å’ŒResource2ã€‚å®ƒä»¬å¯ä»¥æ˜¯æœåŠ¡å™¨ã€è´¦å·ã€å›¾ç‰‡ã€è§†é¢‘ç­‰ç­‰ç­‰ç­‰ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬çš„ç›¸åŒç‰¹æ€§æ˜¯ä¸èƒ½è¢«æ‰€æœ‰ç”¨æˆ·éƒ½è®¿é—®ã€‚æ¯”å¦‚ Resource1 å±äºç”¨æˆ· Aliceï¼Œé‚£ä¹ˆåªæœ‰ Alice èƒ½å¤Ÿè®¿é—®å®ƒï¼ŒBob åˆ™ä¸èƒ½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹è®¿é—®è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œåˆ¤æ–­å…¶æ˜¯å¦è¢«å…è®¸åˆ°è¾¾ç›®æ ‡èµ„æºã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒAlice å‘èµ·äº†ä¸¤ä¸ªè®¿é—®è¯·æ±‚ï¼Œåˆ†åˆ«æƒ³è¦è®¿é—® Resource1 å’Œ Resource2ã€‚è®¿é—®æ§åˆ¶å±‚éœ€è¦åšçš„å·¥ä½œå°±æ˜¯å…è®¸è®¿é—® Resource1 çš„è¯·æ±‚é€šè¿‡ï¼Œè€Œé˜»æ‹¦æƒ³è¦è®¿é—® Resource2 çš„è¯·æ±‚ï¼Œå› ä¸º Resource2 å±äº Bobï¼ŒAlice æ˜¯æ— æ³•è®¿é—®çš„ã€‚</p>\n<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè®¿é—®æ§åˆ¶é—®é¢˜å¾€å¾€ä¼šéšç€ä¸šåŠ¡è€Œå˜å¾—éå¸¸å¤æ‚ã€‚è€Œ Casbin <a href=\"#casbin\"><sup>1</sup></a> å°±æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ã€é«˜æ•ˆçš„å¼€æºè®¿é—®æ§åˆ¶æ¡†æ¶ã€‚Casbin åœ¨ Github ä¸Šå·²è·å¾—è¶…è¿‡ 10k+ starï¼Œå¹¶ä¸”æœ‰ç€éå¸¸å®Œæ•´çš„ç”Ÿæ€ã€‚åŸºäº Casbin å¯ä»¥è½»æ¾çš„å®ç°ä¸€ç³»åˆ—è®¿é—®æ§åˆ¶æ¨¡å‹ï¼Œå¦‚ RBACï¼ŒABACç­‰ç­‰ã€‚</p>\n<h3 id=\"åŸç†â€”â€”PML\"><a href=\"#åŸç†â€”â€”PML\" class=\"headerlink\" title=\"åŸç†â€”â€”PML\"></a>åŸç†â€”â€”PML</h3><p>Casbin çš„åº•å±‚åŸç†åŸºäºå…¶åˆ›å»ºè€…ç½—æ¨åšå£«æ‰€å‘è¡¨çš„ä¸€ç¯‡è®ºæ–‡ã€ŠPML: An Interpreter-Based Access Control Policy Language for Web Servicesã€‹<a href=\"#pml\"><sup>2</sup></a></p>\n<h4 id=\"è®¾è®¡ç›®æ ‡\"><a href=\"#è®¾è®¡ç›®æ ‡\" class=\"headerlink\" title=\"è®¾è®¡ç›®æ ‡\"></a>è®¾è®¡ç›®æ ‡</h4><p>è¿™ç¯‡è®ºæ–‡ä¸»è¦å…³æ³¨äºå¦‚ä½•è§£å†³ç°å®ä¸­äº‘æœåŠ¡å‚å•†æœ‰å…³æƒé™æ ¡éªŒæ‰€é‡åˆ°çš„ä¸¤ä¸ªé—®é¢˜ï¼š</p>\n<ol>\n<li>æ¯ä¸ªäº‘æœåŠ¡å‚å•†éƒ½æœ‰ç€è‡ªå·±çš„ä¸€å¥—æƒé™æ£€éªŒè§„åˆ™ã€‚è¿™å¯¹äºåœ¨å¤šä¸ªäº‘ç¯å¢ƒéƒ½è¿›è¡Œéƒ¨ç½²çš„ç”¨æˆ·æ¥è¯´ï¼Œé€ æˆäº†å¾ˆå¤§çš„è¿ç§»å’Œç»´æŠ¤æˆæœ¬ã€‚</li>\n<li>åŒæ ·çš„ï¼Œç»´æŠ¤è‡ªå·±çš„ä¸€å¥—æƒé™æ ¡éªŒè§„åˆ™å¯¹äºäº‘æœåŠ¡å‚å•†æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚å¦‚æœäº‘æœåŠ¡å‚å•†ç¼ºä¹åœ¨è¿™æ–¹é¢çš„ç›¸å…³ç»éªŒï¼Œå°±å¾ˆæœ‰å¯èƒ½é€ æˆå®‰å…¨æ¼æ´ã€‚</li>\n</ol>\n<p>æ—¢ç„¶æ–‡ç« çš„ç›®æ ‡æœ¬è´¨ä¸Šæ˜¯é€šè¿‡é€šç”¨æ€§æ¥è§£å†³é—®é¢˜ï¼Œä½œè€…ä¹Ÿè€ƒè™‘äº†å¦‚ä½•å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæå‡ºäº†ä¸¤ä¸ª independent çš„è®¾è®¡è¦æ±‚ï¼š</p>\n<ol>\n<li>Access Control Model Independentï¼šPML æ—¢éœ€è¦æ”¯æŒç”¨æˆ·å¯ä»¥åœ¨å¤šä¸ªäº‘æœåŠ¡å‚å•†ä¸­ä½¿ç”¨åŒä¸€ä¸ªæ¨¡å‹ï¼Œä¹Ÿéœ€è¦æ”¯æŒç”¨æˆ·åœ¨ä¸æ”¹å˜æ ¡éªŒä»£ç çš„åŒæ—¶ï¼Œå¯ä»¥åˆ‡æ¢ä¸åŒçš„æ¨¡å‹ã€‚</li>\n<li>Implementation Language Independent: PML çš„è®¾è®¡ä¸åº”è¯¥ä¾èµ–äºæŸç§ç¼–ç¨‹è¯­è¨€çš„ç‰¹æ€§ã€‚<br>å› æ­¤ï¼Œæ–‡ä¸­æå‡ºäº†ä¸€ç§æ–°çš„æƒé™æ ¡éªŒè¯­è¨€â€”â€”PML (PERM Modeling Language)ï¼Œå¸Œæœ›é€šè¿‡ä¸€ç§æ”¯æŒå¤šç§æƒé™æ ¡éªŒæ¨¡å‹çš„é…ç½®è¯­è¨€æ¥å¼¥è¡¥è¿™ä¸ª gapã€‚</li>\n</ol>\n<h4 id=\"è®¾è®¡å®ç°\"><a href=\"#è®¾è®¡å®ç°\" class=\"headerlink\" title=\"è®¾è®¡å®ç°\"></a>è®¾è®¡å®ç°</h4><p>åœ¨ä»‹ç» PML çš„è®¾è®¡ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå¤§è‡´äº†è§£ä¸€ä¸‹è®¿é—®æ§åˆ¶é—®é¢˜ä¸­ï¼Œæ‰€æ¶‰åŠåˆ°çš„ä¸€äº›æ¦‚å¿µã€‚</p>\n<p><img src=\"/asset/casbin-ramp-up/overview.png\" alt=\"1c2dea1652f67c0b7920b0471a4113afd8d9325a.png\"></p>\n<p>ä¸€èˆ¬æ¥è¯´ï¼Œè®¿é—®æ§åˆ¶ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>\n<ol>\n<li><strong>Model è®¿é—®æ§åˆ¶æ¨¡å‹</strong>ã€‚å¸¸è§çš„æ¨¡å‹æœ‰ ACLï¼ˆAccess Control List è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰ï¼ŒRBACï¼ˆRole-Based Access Control åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰ï¼ŒABACï¼ˆAttribute-Based Access Control åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰ã€‚å¯¹äºä¸€ä¸ªåº”ç”¨æ¥è¯´ï¼ŒModel çš„é€‰æ‹©æ˜¯ä¸åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘æ˜¯å¯†åˆ‡ç›¸å…³çš„ï¼Œå› æ­¤ä¹Ÿæ˜¯ç›¸å¯¹é™æ€çš„ã€‚ä¸€æ—¦ä»£ç ç¼–è¯‘å®Œæˆï¼Œè¿™éƒ¨åˆ†æ˜¯ä¸ä¼šéšç€åº”ç”¨çš„è¿è¡Œè€Œäº§ç”Ÿå˜åŒ–çš„ã€‚</li>\n<li><strong>Policy è®¿é—®æ§åˆ¶è§„åˆ™</strong>ã€‚Policy æ˜¯å’Œ Model ç›¸å¯¹åº”çš„ï¼Œæ¯ç§ä¸åŒçš„ Modelï¼Œéƒ½ä¼šæœ‰ä¸åŒæ ¼å¼çš„ Policyã€‚è€Œä¸ Model å®Œå…¨ç›¸åçš„æ˜¯ï¼ŒPolicy æ˜¯ç›¸å¯¹åŠ¨æ€çš„ã€‚åœ¨ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å»å®šä¹‰ Policy çš„æ ¼å¼ï¼Œè€Œ Policy çš„å…·ä½“å†…å®¹éƒ½æ˜¯åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­æ·»åŠ æˆ–ä¿®æ”¹çš„ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªæ–°ç”¨æˆ·æ³¨å†Œäº†æˆ‘ä»¬çš„åº”ç”¨ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±éœ€è¦åŠ¨æ€çš„ä¸ºå…¶æ·»åŠ ä¸€æ¡ Policyã€‚</li>\n</ol>\n<p>æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸¤éƒ¨åˆ†ç†è§£ä¸ºä¼ ç»Ÿåº”ç”¨ä¸­çš„ä»£ç å’Œæ•°æ®ã€‚æœ‰äº†è¿™ä¸¤éƒ¨åˆ†åï¼Œå†åŠ ä¸Šç”¨æˆ·ç‰¹å®šçš„æ ¡éªŒé€»è¾‘ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œæˆè®¿é—®æ§åˆ¶ä»»åŠ¡ã€‚</p>\n<h5 id=\"PERM-æ¨¡å‹\"><a href=\"#PERM-æ¨¡å‹\" class=\"headerlink\" title=\"PERM æ¨¡å‹\"></a>PERM æ¨¡å‹</h5><p>å½“ç„¶ï¼Œå¯¹äºç°å®ç¯å¢ƒä¸­å¤æ‚çš„æƒ…å†µï¼Œç®€å•åœ°å°†é—®é¢˜å»ºæ¨¡ä¸ºè¿™ä¸¤éƒ¨åˆ†è‚¯å®šæ˜¯ä¸å¤Ÿçš„ï¼Œå› æ­¤ï¼Œè®ºæ–‡æå‡ºäº†ä¸€ä¸ªæ–°çš„å…ƒæ¨¡å‹ PERMï¼ˆPolicy-Effect-Request-Matcherï¼‰ã€‚</p>\n<p><img src=\"/asset/casbin-ramp-up/pml.png\" alt=\"6d8fa0a037c3ea185cfadb8d817c41cce0d66d78.png\"></p>\n<p>PERM æ¨¡å‹ä¸»è¦åŒ…å«äº† 6 ä¸ªä¸»è¦çš„æ¦‚å¿µï¼š</p>\n<ol>\n<li><strong>Request</strong>ï¼šè®¿é—®è¯·æ±‚å®šä¹‰ã€‚ç”¨æˆ·çœŸå®çš„è®¿é—®è¯·æ±‚ï¼Œé€šå¸¸ä¼šåŒ…å« subï¼ˆè®¿é—®è€…ï¼‰ï¼Œobjï¼ˆè¢«è®¿é—®çš„èµ„æºï¼‰ï¼Œ actï¼ˆè®¿é—®æ—¶æ‰€è¿›è¡Œçš„æ“ä½œï¼‰æˆ–å…¶ä»–ç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ã€‚</li>\n<li><strong>Policy</strong>ï¼šè®¿é—®æ§åˆ¶è§„åˆ™å®šä¹‰ã€‚å®šä¹‰äº†éœ€è¦å¯¹è®¿é—®è¯·æ±‚çš„å“ªäº›å±æ€§è¿›è¡Œæ ¡éªŒã€‚</li>\n<li><strong>Policy Rule</strong>ï¼šè®¿é—®æ§åˆ¶è§„åˆ™å®ä¾‹ã€‚</li>\n<li><strong>Matcher</strong>ï¼šå¦‚ä½•ä¸ºä¸€æ¡ Request åŒ¹é…åˆ°å…¶å¯¹åº”çš„ Policy Ruleã€‚</li>\n<li><strong>Effect</strong>ï¼šå½“ä¸€æ¡ Request åŒ¹é…åˆ°äº†ä¸€æ¡æˆ–å¤šæ¡ Policy Ruleï¼Œå¦‚ä½•åˆ¤æ–­å…¶æ˜¯å¦åº”è¯¥è¢«å…è®¸ã€‚</li>\n<li><strong>Stub Function</strong>ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼ŒRequest å®ä¾‹ å’Œ Policy Rule çš„åŒ¹é…å¾€å¾€æ— æ³•é€šè¿‡ç®€å•çš„ == ç­‰äºæ¥è§£å†³ï¼Œä¾‹å¦‚é€šé…ç¬¦ç­‰ç­‰ã€‚æ‰€ä»¥ Stub Function å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ä¸€äº›å¤æ‚çš„åŒ¹é…æ–¹æ³•ã€‚</li>\n</ol>\n<p>è¿™å…­ä¸ªæ›´åŠ è¯¦ç»†çš„å»ºæ¨¡äº†è®¿é—®æ§åˆ¶çš„é—®é¢˜ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶ç®€å•çš„åˆ†ä¸€ä¸‹ç±»ï¼ŒRequestï¼ŒPolicyï¼ŒMatcherï¼ŒEffect å’Œ Stub Function éƒ½æ˜¯é™æ€çš„ï¼Œå±äº Model çš„ä¸€éƒ¨åˆ†ã€‚é€šè¿‡è¿™ä¸ªäº”é¡¹çš„ç»„åˆï¼ŒACLç­‰å¸¸è§çš„æ¨¡å‹ä»¥åŠä¸€äº›ç”¨æˆ·è‡ªå®šä¹‰çš„è§„åˆ™ï¼Œéƒ½å¯ä»¥å¾ˆè½»æ˜“çš„è¡¨ç¤ºå‡ºæ¥ã€‚åœ¨æœ€åä¸€éƒ¨åˆ†ä¸­ï¼Œä¼šä»¥ RBAC ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•é€šè¿‡ PML å®ç°è¿™æ ·ä¸€ä¸ªæ¨¡å‹ã€‚</p>\n<p>è€Œ Policy Rule å°±å±äºåŠ¨æ€å˜åŒ–çš„å†…å®¹ã€‚åœ¨å®é™…å®ç°ä¸­ï¼Œå¾€å¾€ä¹Ÿæ˜¯åƒæ•°æ®ä¸€æ ·ï¼Œå­˜å‚¨åœ¨æ•°æ®åº“å½“ä¸­çš„ã€‚</p>\n<h2 id=\"ç»“æ„\"><a href=\"#ç»“æ„\" class=\"headerlink\" title=\"ç»“æ„\"></a>ç»“æ„</h2><p>ä¸è®ºæ–‡ä¸­çš„å®ç°ç›¸æ¯”ï¼Œç›®å‰ Casbin çš„å®ç°æ›´åŠ å¼ºå¤§ï¼Œæ”¯æŒäº†æ›´å¤šåŠŸèƒ½ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œä»¥ Casbin ä¸»åº“ï¼ˆGo ç‰ˆæœ¬ï¼‰ï¼Œä»‹ç» Casbin æ˜¯å¦‚ä½•è¿›è¡Œå·¥ä½œçš„ã€‚</p>\n<p><img src=\"/asset/casbin-ramp-up/detail.png\" alt=\"6dbf7fb95022569c5ad99becdcd9090df8a99250.png\"></p>\n<ol>\n<li><p>åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼ŒCasbin ä¼šè¯»å–ç”¨æˆ·å·²ç»å®šä¹‰å¥½çš„ Modelï¼Œå…¶ä¸­ä¼šåŒ…å« Request, Policy, Matcher å’Œ Effector å››ä¸ªéƒ¨åˆ†çš„å®šä¹‰ã€‚åŒæ—¶ï¼ŒCasbin ä¼šåˆ©ç”¨ Adapterï¼Œä»æ•°æ®æºå¤„è¯»å– Policy å®ä¾‹ï¼ˆä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„ Policy Ruleï¼‰ã€‚åæ–‡å°±å°† Policy å®ä¾‹ç®€ç§°ä¸º Policyã€‚</p>\n</li>\n<li><p>å¯¹äº Policy çš„å­˜å‚¨å’Œè¯»å–ï¼ŒCasbin å°†å…¶è§£è€¦åˆ°äº†ç‹¬ç«‹çš„ Adapter æ¨¡å—ã€‚é€šè¿‡ä½¿ç”¨ä¸åŒçš„ Adapterï¼ˆFile, MySQLç­‰ç­‰ï¼‰ï¼Œå¯ä»¥ä»ä¸åŒçš„æ•°æ®æºä¸­è¯»å– Policyã€‚å¯¹äº Policy æ¯”è¾ƒå¤šçš„åœºæ™¯ï¼Œå°†æ‰€æœ‰çš„ Policy åŒæ—¶åŠ è½½è¿›å†…å­˜ï¼Œç¡®å®ä¼šå¯¼è‡´ä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚æ‰€ä»¥ï¼Œåœ¨åŠ è½½æ—¶ï¼Œéƒ¨åˆ† Adapter ä¹Ÿæä¾› <code>LoadFilteredPolicy</code> çš„æ¥å£ï¼Œé€šè¿‡åªåŠ è½½ Policy çš„ä¸€éƒ¨åˆ†å­é›†ï¼Œå‡å°‘è¿™éƒ¨åˆ†å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆã€‚</p>\n</li>\n<li><p>åœ¨ä¸€æ¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œè¯¥è¯·æ±‚é¦–å…ˆä¼šæŒ‰ç…§ Model ä¸­çš„å®šä¹‰è¿›è¡Œæ‹†åˆ†ã€‚æ¥ä¸‹æ¥ï¼ŒMatcher ä¼šæ ¹æ® Model ä¸­å®šä¹‰çš„è§„åˆ™ï¼Œä¸ Policy è¿›è¡ŒåŒ¹é…ã€‚é™¤äº†æ”¯æŒ == å¼ºåŒ¹é…å¤–ï¼ŒMatcher è¿˜æ”¯æŒé€šè¿‡ Function å’Œ Role Manager è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚Function åƒç”¨æˆ·æä¾›äº†è‡ªå®šä¹‰åŒ¹é…è§„åˆ™çš„æ¥å£ã€‚é€šè¿‡å‘ Matcher ä¼ å…¥è‡ªå®šä¹‰å‡½æ•°ï¼ŒMatcher å¯ä»¥å¯¹ Request ä¸ Policy ä¹‹é—´è¿›è¡Œä¸€äº›å¤æ‚çš„åŒ¹é…ã€‚</p>\n<p>å¯¹äº RBAC ç­‰è®¿é—®æ§åˆ¶æ¨¡å‹ï¼Œé™¤äº†å•çº¯çš„ç”¨æˆ·ä¸æƒé™ä¹‹é—´å­˜åœ¨å…³ç³»ä¹‹å¤–ï¼Œç”¨æˆ·ä¸è§’è‰²ï¼ˆRoleï¼‰ä¹‹é—´è¿˜å­˜åœ¨ç€ç»§æ‰¿å…³ç³»ã€‚Casbin ä¸­é‡‡ç”¨äº† Role Manager æ¥ä¸ºä¸€æ¡ Request çš„ç”¨æˆ·ä»¥åŠå…¶å¯¹åº”è§’è‰²ï¼ˆåŒ…å«ç»§æ‰¿è§’è‰²ï¼‰å¯»æ‰¾ä¸å…¶ç›¸å…³çš„ Policyã€‚åŒæ—¶ï¼ŒRole Manager ä¹Ÿæ”¯æŒæ·»åŠ è‡ªå®šä¹‰çš„ Functionï¼Œæ¥å¯¹ç”¨æˆ·ä¸è§’è‰²ä¹‹é—´è¿›è¡Œå¤æ‚çš„åŒ¹é…ã€‚</p>\n</li>\n<li><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸€æ¡ Request å¯èƒ½ä¼šåŒ¹é…åˆ°å¤šæ¡ Policyã€‚å¾—åˆ°æ‰€æœ‰çš„ Policy åï¼Œéœ€è¦è¿›ä¸€æ­¥å°†å¤šæ¡ Policy çš„ç»“æœè¿›è¡Œèšåˆï¼Œå¾—åˆ°æœ€ç»ˆæ˜¯å¦å…è®¸ Requestã€‚Effector æ ¹æ® Model ä¸­é…ç½®çš„è§„åˆ™ï¼Œå¯¹æ‰€æœ‰ Matched Policy çš„ effect é¡¹è¿›è¡Œè¿›ä¸€æ­¥çš„ evalã€‚</p>\n</li>\n<li><p>åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œè®¿é—®æ§åˆ¶æœåŠ¡ä¼šæœ‰å¤šä¸ªå®ä¾‹ã€‚Casbin æ”¯æŒå¯¹ Policy è¿›è¡Œå¢é‡æ›´æ–°ï¼Œé‚£ä¹ˆï¼Œå°±éœ€è¦ Dispatcher ç»´æŠ¤å¤šä¸ª Casbin å®ä¾‹çš„ Policy ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚Dispatcher ä¸»è¦æä¾›ä¸¤éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä¸€éƒ¨åˆ†æ˜¯ Casbin çš„ APIï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ Dispatcher è‡ªèº«çš„ APIï¼Œç”¨æ¥å®ç°æˆå‘˜ç®¡ç†ç­‰ä¸€è‡´æ€§é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ Raft ç­‰å…±è¯†ç®—æ³•å®ç°ã€‚</p>\n</li>\n</ol>\n<h2 id=\"Usage\"><a href=\"#Usage\" class=\"headerlink\" title=\"Usage\"></a>Usage</h2><p>åœ¨äº†è§£äº† Casbin çš„åŸç†å’Œç»“æ„åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹åˆ©ç”¨ Casbin æ¥è¿›è¡Œä¸€äº›å®è·µã€‚æœ¬ç« ä»¥ RBAC æ¨¡å‹ä¸ºä¾‹ï¼Œæ„å»ºä¸€ä¸ªç®€å•çš„è®¿é—®æ§åˆ¶ç¤ºä¾‹ã€‚RBAC (Role-Based Access Control) æ¨¡å‹æ˜¯åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶æ¨¡å‹ã€‚åœ¨ RBAC çš„æ¨¡å‹ä¸­ï¼Œç”¨æˆ·å’Œèµ„æºä¹‹é—´å­˜åœ¨ç€è§’è‰²ï¼ˆRoleï¼‰ï¼Œç”¨æˆ·å¯ä»¥å±äºä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²ï¼Œè§’è‰²æ‹¥æœ‰æƒé™å»è®¿é—®èµ„æºã€‚</p>\n<p>ç»è¿‡å‰ä¸¤ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥å°†è®¿é—®æ§åˆ¶åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šStaticï¼ŒDynamic å’Œ User-specific Logicã€‚åœ¨ä½¿ç”¨ Casbin æ—¶ï¼Œä¹Ÿå¯ä»¥è¿™æ ·è¿›è¡Œåˆ’åˆ†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸ªé™æ€çš„ RBAC Modelï¼ˆmodel.confï¼‰ã€‚</p>\n<pre><code class=\"c#\">[request_definition]\nr = sub, obj, act\n\n[policy_definition]\np = sub, obj, act\n\n[role_definition]\ng = _, _\n\n[policy_effect]\ne = some(where (p.eft == allow))\n\n[matchers]\nm = g(r.sub, p.sub) &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act\n</code></pre>\n<p>åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œåˆ†åˆ«å®šä¹‰äº†äº”éƒ¨åˆ†å†…å®¹ã€‚</p>\n<ol>\n<li><strong>request_definition</strong>ï¼Œå®šä¹‰äº† Request çš„ç»“æ„ã€‚è¿™ä»½ç¤ºä¾‹ä¸­åŒ…å«äº†è®¿é—®è€…ï¼ˆsubï¼‰ï¼Œè¢«è®¿é—®è€…ï¼ˆobjï¼‰å’Œæ“ä½œï¼ˆactï¼‰ã€‚</li>\n<li><strong>policy_definition</strong>ï¼Œå®šä¹‰äº† Policy çš„ç»“æ„ã€‚é€šå¸¸ï¼Œç”±äº Policy å’Œ Request ä¹‹é—´è¦è¿›è¡ŒåŒ¹é…ï¼Œæ‰€ä»¥ä¸¤è€…çš„ç»“æ„æœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§ã€‚</li>\n<li><strong>role_definition</strong>ï¼Œå®šä¹‰äº† Role Managerã€‚<code>g</code> å®šä¹‰äº†ä¸€å¥— RBAC ç³»ç»Ÿï¼Œæ¢å¥è¯è¯´æ˜¯ä¸€ç»„ç”¨æˆ·è§’è‰²ç»§æ‰¿å…³ç³»çš„é›†åˆã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ›´ç±»ä¼¼äºä¸€ä¸ªå‡½æ•°ï¼Œåˆ¤æ–­è¾“å…¥çš„å‚æ•°æ˜¯å¦åœ¨è¿™ä¸ªé›†åˆä¸­å­˜åœ¨ç»§æ‰¿å…³ç³»ã€‚</li>\n<li><strong>policy_effect</strong>ï¼Œå®šä¹‰äº†å¦‚ä½•å¯¹å¤šä¸ªåŒ¹é…åˆ°çš„ Policy åšåˆå¹¶ã€‚ç›®å‰ï¼ŒCasbin æ”¯æŒå‡ ä¸ªå›ºå®šè¯­æ³•çš„åˆå¹¶æ¨¡å¼ï¼Œåœ¨å®˜ç½‘ <a href=\"#policy\"><sup>3</sup></a> ä¸Šæœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚è¿™äº›æ¨¡å¼çš„å«ä¹‰ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæ¨¡å¼çš„è¯­æ³•ä¸è‡ªç„¶è¯­è¨€æˆ–è€… SQL éå¸¸ç›¸è¿‘ã€‚ä¾‹å¦‚ï¼Œ<code>some(where (p.eft == allow))</code> è¡¨ç¤ºçš„æ˜¯å½“ä»»æ„ä¸€ä¸ª Policy çš„ effect æ˜¯ allowï¼Œé‚£ä¹ˆåˆå¹¶çš„ç»“æœå³ä¸º allowã€‚</li>\n<li><strong>matchers</strong>ï¼Œå®šä¹‰äº†å¦‚ä½•åŒ¹é… Policy å’Œ Requestã€‚ å®šä¹‰å…¬å¼çš„è¯­æ³•ä¸å¸¸è§è¯­è¨€ä¸­çš„å¸ƒå°”è¡¨è¾¾å¼ç›¸ä¼¼ï¼Œé€šè¿‡ <code>==</code> å¯ä»¥å°† Policy å’Œ Request ä¸­çš„å„é¡¹è¿›è¡Œå¯¹æ¯”ã€‚</li>\n</ol>\n<h4 id=\"Policy\"><a href=\"#Policy\" class=\"headerlink\" title=\"Policy\"></a>Policy</h4><pre><code>p, alice, data1, read\np, bob, data2, write\np, data2_admin, data2, read\np, data2_admin, data2, write\ng, alice, data2_admin\n</code></pre>\n<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ Model ä¸­å®šä¹‰çš„ Policy ç»“æ„æ¥ç¼–å†™ Policy å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€é¡¹ <code>p, alice, data1, read</code> ä¸ <code>p = sub, obj, act</code> ç›¸å¯¹åº”ï¼Œ<code>alice</code>ï¼Œ<code>data1</code>ï¼Œ<code>read</code> ä¸ <code>sub</code>ï¼Œ<code>obj</code>ï¼Œ<code>act</code> ç›¸å¯¹åº”ã€‚å¦å¤–ä¸€æ¡æ¯”è¾ƒç‰¹æ®Šçš„å®ä¾‹æ˜¯æœ€åä¸€é¡¹ï¼Œ<code>g, alice, data2_admin</code>ï¼Œå®šä¹‰äº†ç”¨æˆ· <code>alice</code> ç»§æ‰¿äº† <code>data2_admin</code> è¿™ä¸€è§’è‰²ã€‚</p>\n<p>æˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„ Policy ä¿å­˜åœ¨æ–‡ä»¶ policy.csv ä¸­ã€‚ä½†ä¸€èˆ¬æ¥è¯´ï¼ŒPolicy å‚¨å­˜åœ¨æ•°æ®åº“ç­‰ç­‰ä¸€äº›æ›´åŠ  organized çš„å¤–éƒ¨å­˜å‚¨ä¸­ã€‚</p>\n<h4 id=\"User-Logic\"><a href=\"#User-Logic\" class=\"headerlink\" title=\"User Logic\"></a>User Logic</h4><p>Casbin å‡ ä¹æ”¯æŒæ‰€æœ‰çš„å¸¸è§çš„ç¼–ç¨‹è¯­è¨€ï¼Œç”¨æˆ·ä½¿ç”¨çš„é€»è¾‘ä¹ŸåŸºæœ¬ç›¸ä¼¼ï¼Œä¸»è¦é€šè¿‡ Enforcer ç±»æ¥è¿›è¡Œæ“ä½œã€‚</p>\n<pre><code class=\"go\">e, err := casbin.NewEnforcer(&quot;model.conf&quot;, &quot;policy.csv&quot;)\nresult1, _ := e.Enforce(&quot;alice&quot;, &quot;data1&quot;, &quot;read&quot;)\nfmt.Println(result1)\nresult2, _ := e.Enforce(&quot;alice&quot;, &quot;data1&quot;, &quot;write&quot;)\nfmt.Println(result2)\nresult3, _ := e.Enforce(&quot;alice&quot;, &quot;data2&quot;, &quot;read&quot;)\nfmt.Println(result3)\n</code></pre>\n<p>é€šè¿‡ Enforce æ–¹æ³•ï¼Œå¼€å‘è€…è¾“å…¥ Requestï¼Œå°±å¯ä»¥å¾—åˆ°è¿™æ¡è¯·æ±‚æ˜¯å¦å¯ä»¥é€šè¿‡ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­æœ‰ 3 ä¸ª test caseï¼Œåˆ†åˆ«éªŒè¯äº†åˆæ³•è¯·æ±‚åŒ¹é…ï¼Œéæ³•è¯·æ±‚åŒ¹é…ï¼Œé›†æˆè§’è‰²è¯·æ±‚åŒ¹é…ã€‚ç¬¬ä¸€ä¸ª test case å¯¹åº”äº† policy.csv ä¸­çš„ç¬¬ä¸€æ¡ Policyï¼Œç¬¬äºŒä¸ª test case åˆ™æ²¡æœ‰ test caseã€‚ç¬¬ä¸‰ä¸ª test case é€šè¿‡ <code>g, alice, data2_admin</code> å°† alice ä¸ data2_admin çš„ Policy å…³è”èµ·æ¥ï¼Œç„¶åé€šè¿‡ç¬¬ä¸‰æ¡ Policy p, data2_admin, data2, read éªŒè¯å…¶ä¸ºåˆæ³•è¯·æ±‚ã€‚</p>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><div id=\"ref1\"/>\n- [1] https://github.com/casbin/casbin\n<div id=\"ref2\"/>\n- [2] https://arxiv.org/pdf/1903.09756.pdf\n<div id=\"ref3\"/>\n- [3] https://casbin.org/docs/en/syntax-for-models#policy-effect\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"TL-DR\"><a href=\"#TL-DR\" class=\"headerlink\" title=\"TL;DR\"></a>TL;DR</h2><ul>\n<li>è®¿é—®æ§åˆ¶æ¡†æ¶ Casbin çš„åŸç†ä»¥åŠå…¶å†…éƒ¨ç»„ä»¶çš„ç»“æ„</li>\n<li>ä»¥ä¸€ä¸ª RBAC çš„ç®€å•ä¾‹å­ä»‹ç» Casbin çš„ç”¨æ³•</li>\n</ul>\n<h2 id=\"Casbinæ˜¯ä»€ä¹ˆï¼Ÿ\"><a href=\"#Casbinæ˜¯ä»€ä¹ˆï¼Ÿ\" class=\"headerlink\" title=\"Casbinæ˜¯ä»€ä¹ˆï¼Ÿ\"></a>Casbinæ˜¯ä»€ä¹ˆï¼Ÿ</h2><h3 id=\"è®¿é—®æ§åˆ¶\"><a href=\"#è®¿é—®æ§åˆ¶\" class=\"headerlink\" title=\"è®¿é—®æ§åˆ¶\"></a>è®¿é—®æ§åˆ¶</h3><p><img src=\"/asset/casbin-ramp-up/2022-06-23-17-50-00-image.png\"></p>\n<p>è®¿é—®æ§åˆ¶ï¼Œé¡¾åæ€ä¹‰ï¼Œæ˜¯æŒ‡åˆ¤æ–­ä¸€æ¡è¯·æ±‚æ˜¯å¦å¯ä»¥è®¿é—®å—ä¿æŠ¤çš„èµ„æºçš„æŠ€æœ¯ã€‚åœ¨ä¸Šå›¾çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„åå°ä¸­æœ‰ä¸¤ä¸ªèµ„æºï¼ŒResource1å’ŒResource2ã€‚å®ƒä»¬å¯ä»¥æ˜¯æœåŠ¡å™¨ã€è´¦å·ã€å›¾ç‰‡ã€è§†é¢‘ç­‰ç­‰ç­‰ç­‰ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬çš„ç›¸åŒç‰¹æ€§æ˜¯ä¸èƒ½è¢«æ‰€æœ‰ç”¨æˆ·éƒ½è®¿é—®ã€‚æ¯”å¦‚ Resource1 å±äºç”¨æˆ· Aliceï¼Œé‚£ä¹ˆåªæœ‰ Alice èƒ½å¤Ÿè®¿é—®å®ƒï¼ŒBob åˆ™ä¸èƒ½ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹è®¿é—®è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œåˆ¤æ–­å…¶æ˜¯å¦è¢«å…è®¸åˆ°è¾¾ç›®æ ‡èµ„æºã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒAlice å‘èµ·äº†ä¸¤ä¸ªè®¿é—®è¯·æ±‚ï¼Œåˆ†åˆ«æƒ³è¦è®¿é—® Resource1 å’Œ Resource2ã€‚è®¿é—®æ§åˆ¶å±‚éœ€è¦åšçš„å·¥ä½œå°±æ˜¯å…è®¸è®¿é—® Resource1 çš„è¯·æ±‚é€šè¿‡ï¼Œè€Œé˜»æ‹¦æƒ³è¦è®¿é—® Resource2 çš„è¯·æ±‚ï¼Œå› ä¸º Resource2 å±äº Bobï¼ŒAlice æ˜¯æ— æ³•è®¿é—®çš„ã€‚</p>\n<p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè®¿é—®æ§åˆ¶é—®é¢˜å¾€å¾€ä¼šéšç€ä¸šåŠ¡è€Œå˜å¾—éå¸¸å¤æ‚ã€‚è€Œ Casbin <a href=\"#casbin\"><sup>1</sup></a> å°±æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ã€é«˜æ•ˆçš„å¼€æºè®¿é—®æ§åˆ¶æ¡†æ¶ã€‚Casbin åœ¨ Github ä¸Šå·²è·å¾—è¶…è¿‡ 10k+ starï¼Œå¹¶ä¸”æœ‰ç€éå¸¸å®Œæ•´çš„ç”Ÿæ€ã€‚åŸºäº Casbin å¯ä»¥è½»æ¾çš„å®ç°ä¸€ç³»åˆ—è®¿é—®æ§åˆ¶æ¨¡å‹ï¼Œå¦‚ RBACï¼ŒABACç­‰ç­‰ã€‚</p>\n<h3 id=\"åŸç†â€”â€”PML\"><a href=\"#åŸç†â€”â€”PML\" class=\"headerlink\" title=\"åŸç†â€”â€”PML\"></a>åŸç†â€”â€”PML</h3><p>Casbin çš„åº•å±‚åŸç†åŸºäºå…¶åˆ›å»ºè€…ç½—æ¨åšå£«æ‰€å‘è¡¨çš„ä¸€ç¯‡è®ºæ–‡ã€ŠPML: An Interpreter-Based Access Control Policy Language for Web Servicesã€‹<a href=\"#pml\"><sup>2</sup></a></p>\n<h4 id=\"è®¾è®¡ç›®æ ‡\"><a href=\"#è®¾è®¡ç›®æ ‡\" class=\"headerlink\" title=\"è®¾è®¡ç›®æ ‡\"></a>è®¾è®¡ç›®æ ‡</h4><p>è¿™ç¯‡è®ºæ–‡ä¸»è¦å…³æ³¨äºå¦‚ä½•è§£å†³ç°å®ä¸­äº‘æœåŠ¡å‚å•†æœ‰å…³æƒé™æ ¡éªŒæ‰€é‡åˆ°çš„ä¸¤ä¸ªé—®é¢˜ï¼š</p>\n<ol>\n<li>æ¯ä¸ªäº‘æœåŠ¡å‚å•†éƒ½æœ‰ç€è‡ªå·±çš„ä¸€å¥—æƒé™æ£€éªŒè§„åˆ™ã€‚è¿™å¯¹äºåœ¨å¤šä¸ªäº‘ç¯å¢ƒéƒ½è¿›è¡Œéƒ¨ç½²çš„ç”¨æˆ·æ¥è¯´ï¼Œé€ æˆäº†å¾ˆå¤§çš„è¿ç§»å’Œç»´æŠ¤æˆæœ¬ã€‚</li>\n<li>åŒæ ·çš„ï¼Œç»´æŠ¤è‡ªå·±çš„ä¸€å¥—æƒé™æ ¡éªŒè§„åˆ™å¯¹äºäº‘æœåŠ¡å‚å•†æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæŒ‘æˆ˜ã€‚å¦‚æœäº‘æœåŠ¡å‚å•†ç¼ºä¹åœ¨è¿™æ–¹é¢çš„ç›¸å…³ç»éªŒï¼Œå°±å¾ˆæœ‰å¯èƒ½é€ æˆå®‰å…¨æ¼æ´ã€‚</li>\n</ol>\n<p>æ—¢ç„¶æ–‡ç« çš„ç›®æ ‡æœ¬è´¨ä¸Šæ˜¯é€šè¿‡é€šç”¨æ€§æ¥è§£å†³é—®é¢˜ï¼Œä½œè€…ä¹Ÿè€ƒè™‘äº†å¦‚ä½•å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæå‡ºäº†ä¸¤ä¸ª independent çš„è®¾è®¡è¦æ±‚ï¼š</p>\n<ol>\n<li>Access Control Model Independentï¼šPML æ—¢éœ€è¦æ”¯æŒç”¨æˆ·å¯ä»¥åœ¨å¤šä¸ªäº‘æœåŠ¡å‚å•†ä¸­ä½¿ç”¨åŒä¸€ä¸ªæ¨¡å‹ï¼Œä¹Ÿéœ€è¦æ”¯æŒç”¨æˆ·åœ¨ä¸æ”¹å˜æ ¡éªŒä»£ç çš„åŒæ—¶ï¼Œå¯ä»¥åˆ‡æ¢ä¸åŒçš„æ¨¡å‹ã€‚</li>\n<li>Implementation Language Independent: PML çš„è®¾è®¡ä¸åº”è¯¥ä¾èµ–äºæŸç§ç¼–ç¨‹è¯­è¨€çš„ç‰¹æ€§ã€‚<br>å› æ­¤ï¼Œæ–‡ä¸­æå‡ºäº†ä¸€ç§æ–°çš„æƒé™æ ¡éªŒè¯­è¨€â€”â€”PML (PERM Modeling Language)ï¼Œå¸Œæœ›é€šè¿‡ä¸€ç§æ”¯æŒå¤šç§æƒé™æ ¡éªŒæ¨¡å‹çš„é…ç½®è¯­è¨€æ¥å¼¥è¡¥è¿™ä¸ª gapã€‚</li>\n</ol>\n<h4 id=\"è®¾è®¡å®ç°\"><a href=\"#è®¾è®¡å®ç°\" class=\"headerlink\" title=\"è®¾è®¡å®ç°\"></a>è®¾è®¡å®ç°</h4><p>åœ¨ä»‹ç» PML çš„è®¾è®¡ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå¤§è‡´äº†è§£ä¸€ä¸‹è®¿é—®æ§åˆ¶é—®é¢˜ä¸­ï¼Œæ‰€æ¶‰åŠåˆ°çš„ä¸€äº›æ¦‚å¿µã€‚</p>\n<p><img src=\"/asset/casbin-ramp-up/overview.png\" alt=\"1c2dea1652f67c0b7920b0471a4113afd8d9325a.png\"></p>\n<p>ä¸€èˆ¬æ¥è¯´ï¼Œè®¿é—®æ§åˆ¶ä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>\n<ol>\n<li><strong>Model è®¿é—®æ§åˆ¶æ¨¡å‹</strong>ã€‚å¸¸è§çš„æ¨¡å‹æœ‰ ACLï¼ˆAccess Control List è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰ï¼ŒRBACï¼ˆRole-Based Access Control åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰ï¼ŒABACï¼ˆAttribute-Based Access Control åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰ã€‚å¯¹äºä¸€ä¸ªåº”ç”¨æ¥è¯´ï¼ŒModel çš„é€‰æ‹©æ˜¯ä¸åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘æ˜¯å¯†åˆ‡ç›¸å…³çš„ï¼Œå› æ­¤ä¹Ÿæ˜¯ç›¸å¯¹é™æ€çš„ã€‚ä¸€æ—¦ä»£ç ç¼–è¯‘å®Œæˆï¼Œè¿™éƒ¨åˆ†æ˜¯ä¸ä¼šéšç€åº”ç”¨çš„è¿è¡Œè€Œäº§ç”Ÿå˜åŒ–çš„ã€‚</li>\n<li><strong>Policy è®¿é—®æ§åˆ¶è§„åˆ™</strong>ã€‚Policy æ˜¯å’Œ Model ç›¸å¯¹åº”çš„ï¼Œæ¯ç§ä¸åŒçš„ Modelï¼Œéƒ½ä¼šæœ‰ä¸åŒæ ¼å¼çš„ Policyã€‚è€Œä¸ Model å®Œå…¨ç›¸åçš„æ˜¯ï¼ŒPolicy æ˜¯ç›¸å¯¹åŠ¨æ€çš„ã€‚åœ¨ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªèƒ½å»å®šä¹‰ Policy çš„æ ¼å¼ï¼Œè€Œ Policy çš„å…·ä½“å†…å®¹éƒ½æ˜¯åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­æ·»åŠ æˆ–ä¿®æ”¹çš„ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªæ–°ç”¨æˆ·æ³¨å†Œäº†æˆ‘ä»¬çš„åº”ç”¨ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±éœ€è¦åŠ¨æ€çš„ä¸ºå…¶æ·»åŠ ä¸€æ¡ Policyã€‚</li>\n</ol>\n<p>æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸¤éƒ¨åˆ†ç†è§£ä¸ºä¼ ç»Ÿåº”ç”¨ä¸­çš„ä»£ç å’Œæ•°æ®ã€‚æœ‰äº†è¿™ä¸¤éƒ¨åˆ†åï¼Œå†åŠ ä¸Šç”¨æˆ·ç‰¹å®šçš„æ ¡éªŒé€»è¾‘ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œæˆè®¿é—®æ§åˆ¶ä»»åŠ¡ã€‚</p>\n<h5 id=\"PERM-æ¨¡å‹\"><a href=\"#PERM-æ¨¡å‹\" class=\"headerlink\" title=\"PERM æ¨¡å‹\"></a>PERM æ¨¡å‹</h5><p>å½“ç„¶ï¼Œå¯¹äºç°å®ç¯å¢ƒä¸­å¤æ‚çš„æƒ…å†µï¼Œç®€å•åœ°å°†é—®é¢˜å»ºæ¨¡ä¸ºè¿™ä¸¤éƒ¨åˆ†è‚¯å®šæ˜¯ä¸å¤Ÿçš„ï¼Œå› æ­¤ï¼Œè®ºæ–‡æå‡ºäº†ä¸€ä¸ªæ–°çš„å…ƒæ¨¡å‹ PERMï¼ˆPolicy-Effect-Request-Matcherï¼‰ã€‚</p>\n<p><img src=\"/asset/casbin-ramp-up/pml.png\" alt=\"6d8fa0a037c3ea185cfadb8d817c41cce0d66d78.png\"></p>\n<p>PERM æ¨¡å‹ä¸»è¦åŒ…å«äº† 6 ä¸ªä¸»è¦çš„æ¦‚å¿µï¼š</p>\n<ol>\n<li><strong>Request</strong>ï¼šè®¿é—®è¯·æ±‚å®šä¹‰ã€‚ç”¨æˆ·çœŸå®çš„è®¿é—®è¯·æ±‚ï¼Œé€šå¸¸ä¼šåŒ…å« subï¼ˆè®¿é—®è€…ï¼‰ï¼Œobjï¼ˆè¢«è®¿é—®çš„èµ„æºï¼‰ï¼Œ actï¼ˆè®¿é—®æ—¶æ‰€è¿›è¡Œçš„æ“ä½œï¼‰æˆ–å…¶ä»–ç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ã€‚</li>\n<li><strong>Policy</strong>ï¼šè®¿é—®æ§åˆ¶è§„åˆ™å®šä¹‰ã€‚å®šä¹‰äº†éœ€è¦å¯¹è®¿é—®è¯·æ±‚çš„å“ªäº›å±æ€§è¿›è¡Œæ ¡éªŒã€‚</li>\n<li><strong>Policy Rule</strong>ï¼šè®¿é—®æ§åˆ¶è§„åˆ™å®ä¾‹ã€‚</li>\n<li><strong>Matcher</strong>ï¼šå¦‚ä½•ä¸ºä¸€æ¡ Request åŒ¹é…åˆ°å…¶å¯¹åº”çš„ Policy Ruleã€‚</li>\n<li><strong>Effect</strong>ï¼šå½“ä¸€æ¡ Request åŒ¹é…åˆ°äº†ä¸€æ¡æˆ–å¤šæ¡ Policy Ruleï¼Œå¦‚ä½•åˆ¤æ–­å…¶æ˜¯å¦åº”è¯¥è¢«å…è®¸ã€‚</li>\n<li><strong>Stub Function</strong>ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼ŒRequest å®ä¾‹ å’Œ Policy Rule çš„åŒ¹é…å¾€å¾€æ— æ³•é€šè¿‡ç®€å•çš„ == ç­‰äºæ¥è§£å†³ï¼Œä¾‹å¦‚é€šé…ç¬¦ç­‰ç­‰ã€‚æ‰€ä»¥ Stub Function å…è®¸ç”¨æˆ·è‡ªå®šä¹‰ä¸€äº›å¤æ‚çš„åŒ¹é…æ–¹æ³•ã€‚</li>\n</ol>\n<p>è¿™å…­ä¸ªæ›´åŠ è¯¦ç»†çš„å»ºæ¨¡äº†è®¿é—®æ§åˆ¶çš„é—®é¢˜ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶ç®€å•çš„åˆ†ä¸€ä¸‹ç±»ï¼ŒRequestï¼ŒPolicyï¼ŒMatcherï¼ŒEffect å’Œ Stub Function éƒ½æ˜¯é™æ€çš„ï¼Œå±äº Model çš„ä¸€éƒ¨åˆ†ã€‚é€šè¿‡è¿™ä¸ªäº”é¡¹çš„ç»„åˆï¼ŒACLç­‰å¸¸è§çš„æ¨¡å‹ä»¥åŠä¸€äº›ç”¨æˆ·è‡ªå®šä¹‰çš„è§„åˆ™ï¼Œéƒ½å¯ä»¥å¾ˆè½»æ˜“çš„è¡¨ç¤ºå‡ºæ¥ã€‚åœ¨æœ€åä¸€éƒ¨åˆ†ä¸­ï¼Œä¼šä»¥ RBAC ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•é€šè¿‡ PML å®ç°è¿™æ ·ä¸€ä¸ªæ¨¡å‹ã€‚</p>\n<p>è€Œ Policy Rule å°±å±äºåŠ¨æ€å˜åŒ–çš„å†…å®¹ã€‚åœ¨å®é™…å®ç°ä¸­ï¼Œå¾€å¾€ä¹Ÿæ˜¯åƒæ•°æ®ä¸€æ ·ï¼Œå­˜å‚¨åœ¨æ•°æ®åº“å½“ä¸­çš„ã€‚</p>\n<h2 id=\"ç»“æ„\"><a href=\"#ç»“æ„\" class=\"headerlink\" title=\"ç»“æ„\"></a>ç»“æ„</h2><p>ä¸è®ºæ–‡ä¸­çš„å®ç°ç›¸æ¯”ï¼Œç›®å‰ Casbin çš„å®ç°æ›´åŠ å¼ºå¤§ï¼Œæ”¯æŒäº†æ›´å¤šåŠŸèƒ½ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œä»¥ Casbin ä¸»åº“ï¼ˆGo ç‰ˆæœ¬ï¼‰ï¼Œä»‹ç» Casbin æ˜¯å¦‚ä½•è¿›è¡Œå·¥ä½œçš„ã€‚</p>\n<p><img src=\"/asset/casbin-ramp-up/detail.png\" alt=\"6dbf7fb95022569c5ad99becdcd9090df8a99250.png\"></p>\n<ol>\n<li><p>åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼ŒCasbin ä¼šè¯»å–ç”¨æˆ·å·²ç»å®šä¹‰å¥½çš„ Modelï¼Œå…¶ä¸­ä¼šåŒ…å« Request, Policy, Matcher å’Œ Effector å››ä¸ªéƒ¨åˆ†çš„å®šä¹‰ã€‚åŒæ—¶ï¼ŒCasbin ä¼šåˆ©ç”¨ Adapterï¼Œä»æ•°æ®æºå¤„è¯»å– Policy å®ä¾‹ï¼ˆä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„ Policy Ruleï¼‰ã€‚åæ–‡å°±å°† Policy å®ä¾‹ç®€ç§°ä¸º Policyã€‚</p>\n</li>\n<li><p>å¯¹äº Policy çš„å­˜å‚¨å’Œè¯»å–ï¼ŒCasbin å°†å…¶è§£è€¦åˆ°äº†ç‹¬ç«‹çš„ Adapter æ¨¡å—ã€‚é€šè¿‡ä½¿ç”¨ä¸åŒçš„ Adapterï¼ˆFile, MySQLç­‰ç­‰ï¼‰ï¼Œå¯ä»¥ä»ä¸åŒçš„æ•°æ®æºä¸­è¯»å– Policyã€‚å¯¹äº Policy æ¯”è¾ƒå¤šçš„åœºæ™¯ï¼Œå°†æ‰€æœ‰çš„ Policy åŒæ—¶åŠ è½½è¿›å†…å­˜ï¼Œç¡®å®ä¼šå¯¼è‡´ä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚æ‰€ä»¥ï¼Œåœ¨åŠ è½½æ—¶ï¼Œéƒ¨åˆ† Adapter ä¹Ÿæä¾› <code>LoadFilteredPolicy</code> çš„æ¥å£ï¼Œé€šè¿‡åªåŠ è½½ Policy çš„ä¸€éƒ¨åˆ†å­é›†ï¼Œå‡å°‘è¿™éƒ¨åˆ†å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆã€‚</p>\n</li>\n<li><p>åœ¨ä¸€æ¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œè¯¥è¯·æ±‚é¦–å…ˆä¼šæŒ‰ç…§ Model ä¸­çš„å®šä¹‰è¿›è¡Œæ‹†åˆ†ã€‚æ¥ä¸‹æ¥ï¼ŒMatcher ä¼šæ ¹æ® Model ä¸­å®šä¹‰çš„è§„åˆ™ï¼Œä¸ Policy è¿›è¡ŒåŒ¹é…ã€‚é™¤äº†æ”¯æŒ == å¼ºåŒ¹é…å¤–ï¼ŒMatcher è¿˜æ”¯æŒé€šè¿‡ Function å’Œ Role Manager è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚Function åƒç”¨æˆ·æä¾›äº†è‡ªå®šä¹‰åŒ¹é…è§„åˆ™çš„æ¥å£ã€‚é€šè¿‡å‘ Matcher ä¼ å…¥è‡ªå®šä¹‰å‡½æ•°ï¼ŒMatcher å¯ä»¥å¯¹ Request ä¸ Policy ä¹‹é—´è¿›è¡Œä¸€äº›å¤æ‚çš„åŒ¹é…ã€‚</p>\n<p>å¯¹äº RBAC ç­‰è®¿é—®æ§åˆ¶æ¨¡å‹ï¼Œé™¤äº†å•çº¯çš„ç”¨æˆ·ä¸æƒé™ä¹‹é—´å­˜åœ¨å…³ç³»ä¹‹å¤–ï¼Œç”¨æˆ·ä¸è§’è‰²ï¼ˆRoleï¼‰ä¹‹é—´è¿˜å­˜åœ¨ç€ç»§æ‰¿å…³ç³»ã€‚Casbin ä¸­é‡‡ç”¨äº† Role Manager æ¥ä¸ºä¸€æ¡ Request çš„ç”¨æˆ·ä»¥åŠå…¶å¯¹åº”è§’è‰²ï¼ˆåŒ…å«ç»§æ‰¿è§’è‰²ï¼‰å¯»æ‰¾ä¸å…¶ç›¸å…³çš„ Policyã€‚åŒæ—¶ï¼ŒRole Manager ä¹Ÿæ”¯æŒæ·»åŠ è‡ªå®šä¹‰çš„ Functionï¼Œæ¥å¯¹ç”¨æˆ·ä¸è§’è‰²ä¹‹é—´è¿›è¡Œå¤æ‚çš„åŒ¹é…ã€‚</p>\n</li>\n<li><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸€æ¡ Request å¯èƒ½ä¼šåŒ¹é…åˆ°å¤šæ¡ Policyã€‚å¾—åˆ°æ‰€æœ‰çš„ Policy åï¼Œéœ€è¦è¿›ä¸€æ­¥å°†å¤šæ¡ Policy çš„ç»“æœè¿›è¡Œèšåˆï¼Œå¾—åˆ°æœ€ç»ˆæ˜¯å¦å…è®¸ Requestã€‚Effector æ ¹æ® Model ä¸­é…ç½®çš„è§„åˆ™ï¼Œå¯¹æ‰€æœ‰ Matched Policy çš„ effect é¡¹è¿›è¡Œè¿›ä¸€æ­¥çš„ evalã€‚</p>\n</li>\n<li><p>åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œè®¿é—®æ§åˆ¶æœåŠ¡ä¼šæœ‰å¤šä¸ªå®ä¾‹ã€‚Casbin æ”¯æŒå¯¹ Policy è¿›è¡Œå¢é‡æ›´æ–°ï¼Œé‚£ä¹ˆï¼Œå°±éœ€è¦ Dispatcher ç»´æŠ¤å¤šä¸ª Casbin å®ä¾‹çš„ Policy ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚Dispatcher ä¸»è¦æä¾›ä¸¤éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä¸€éƒ¨åˆ†æ˜¯ Casbin çš„ APIï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ Dispatcher è‡ªèº«çš„ APIï¼Œç”¨æ¥å®ç°æˆå‘˜ç®¡ç†ç­‰ä¸€è‡´æ€§é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ Raft ç­‰å…±è¯†ç®—æ³•å®ç°ã€‚</p>\n</li>\n</ol>\n<h2 id=\"Usage\"><a href=\"#Usage\" class=\"headerlink\" title=\"Usage\"></a>Usage</h2><p>åœ¨äº†è§£äº† Casbin çš„åŸç†å’Œç»“æ„åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹åˆ©ç”¨ Casbin æ¥è¿›è¡Œä¸€äº›å®è·µã€‚æœ¬ç« ä»¥ RBAC æ¨¡å‹ä¸ºä¾‹ï¼Œæ„å»ºä¸€ä¸ªç®€å•çš„è®¿é—®æ§åˆ¶ç¤ºä¾‹ã€‚RBAC (Role-Based Access Control) æ¨¡å‹æ˜¯åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶æ¨¡å‹ã€‚åœ¨ RBAC çš„æ¨¡å‹ä¸­ï¼Œç”¨æˆ·å’Œèµ„æºä¹‹é—´å­˜åœ¨ç€è§’è‰²ï¼ˆRoleï¼‰ï¼Œç”¨æˆ·å¯ä»¥å±äºä¸€ä¸ªæˆ–å¤šä¸ªè§’è‰²ï¼Œè§’è‰²æ‹¥æœ‰æƒé™å»è®¿é—®èµ„æºã€‚</p>\n<p>ç»è¿‡å‰ä¸¤ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥å°†è®¿é—®æ§åˆ¶åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šStaticï¼ŒDynamic å’Œ User-specific Logicã€‚åœ¨ä½¿ç”¨ Casbin æ—¶ï¼Œä¹Ÿå¯ä»¥è¿™æ ·è¿›è¡Œåˆ’åˆ†ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸ªé™æ€çš„ RBAC Modelï¼ˆmodel.confï¼‰ã€‚</p>\n<pre><code class=\"c#\">[request_definition]\nr = sub, obj, act\n\n[policy_definition]\np = sub, obj, act\n\n[role_definition]\ng = _, _\n\n[policy_effect]\ne = some(where (p.eft == allow))\n\n[matchers]\nm = g(r.sub, p.sub) &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act\n</code></pre>\n<p>åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œåˆ†åˆ«å®šä¹‰äº†äº”éƒ¨åˆ†å†…å®¹ã€‚</p>\n<ol>\n<li><strong>request_definition</strong>ï¼Œå®šä¹‰äº† Request çš„ç»“æ„ã€‚è¿™ä»½ç¤ºä¾‹ä¸­åŒ…å«äº†è®¿é—®è€…ï¼ˆsubï¼‰ï¼Œè¢«è®¿é—®è€…ï¼ˆobjï¼‰å’Œæ“ä½œï¼ˆactï¼‰ã€‚</li>\n<li><strong>policy_definition</strong>ï¼Œå®šä¹‰äº† Policy çš„ç»“æ„ã€‚é€šå¸¸ï¼Œç”±äº Policy å’Œ Request ä¹‹é—´è¦è¿›è¡ŒåŒ¹é…ï¼Œæ‰€ä»¥ä¸¤è€…çš„ç»“æ„æœ‰ä¸€å®šçš„ç›¸ä¼¼æ€§ã€‚</li>\n<li><strong>role_definition</strong>ï¼Œå®šä¹‰äº† Role Managerã€‚<code>g</code> å®šä¹‰äº†ä¸€å¥— RBAC ç³»ç»Ÿï¼Œæ¢å¥è¯è¯´æ˜¯ä¸€ç»„ç”¨æˆ·è§’è‰²ç»§æ‰¿å…³ç³»çš„é›†åˆã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ›´ç±»ä¼¼äºä¸€ä¸ªå‡½æ•°ï¼Œåˆ¤æ–­è¾“å…¥çš„å‚æ•°æ˜¯å¦åœ¨è¿™ä¸ªé›†åˆä¸­å­˜åœ¨ç»§æ‰¿å…³ç³»ã€‚</li>\n<li><strong>policy_effect</strong>ï¼Œå®šä¹‰äº†å¦‚ä½•å¯¹å¤šä¸ªåŒ¹é…åˆ°çš„ Policy åšåˆå¹¶ã€‚ç›®å‰ï¼ŒCasbin æ”¯æŒå‡ ä¸ªå›ºå®šè¯­æ³•çš„åˆå¹¶æ¨¡å¼ï¼Œåœ¨å®˜ç½‘ <a href=\"#policy\"><sup>3</sup></a> ä¸Šæœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚è¿™äº›æ¨¡å¼çš„å«ä¹‰ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæ¨¡å¼çš„è¯­æ³•ä¸è‡ªç„¶è¯­è¨€æˆ–è€… SQL éå¸¸ç›¸è¿‘ã€‚ä¾‹å¦‚ï¼Œ<code>some(where (p.eft == allow))</code> è¡¨ç¤ºçš„æ˜¯å½“ä»»æ„ä¸€ä¸ª Policy çš„ effect æ˜¯ allowï¼Œé‚£ä¹ˆåˆå¹¶çš„ç»“æœå³ä¸º allowã€‚</li>\n<li><strong>matchers</strong>ï¼Œå®šä¹‰äº†å¦‚ä½•åŒ¹é… Policy å’Œ Requestã€‚ å®šä¹‰å…¬å¼çš„è¯­æ³•ä¸å¸¸è§è¯­è¨€ä¸­çš„å¸ƒå°”è¡¨è¾¾å¼ç›¸ä¼¼ï¼Œé€šè¿‡ <code>==</code> å¯ä»¥å°† Policy å’Œ Request ä¸­çš„å„é¡¹è¿›è¡Œå¯¹æ¯”ã€‚</li>\n</ol>\n<h4 id=\"Policy\"><a href=\"#Policy\" class=\"headerlink\" title=\"Policy\"></a>Policy</h4><pre><code>p, alice, data1, read\np, bob, data2, write\np, data2_admin, data2, read\np, data2_admin, data2, write\ng, alice, data2_admin\n</code></pre>\n<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ Model ä¸­å®šä¹‰çš„ Policy ç»“æ„æ¥ç¼–å†™ Policy å®ä¾‹ã€‚ä¾‹å¦‚ï¼Œç¬¬ä¸€é¡¹ <code>p, alice, data1, read</code> ä¸ <code>p = sub, obj, act</code> ç›¸å¯¹åº”ï¼Œ<code>alice</code>ï¼Œ<code>data1</code>ï¼Œ<code>read</code> ä¸ <code>sub</code>ï¼Œ<code>obj</code>ï¼Œ<code>act</code> ç›¸å¯¹åº”ã€‚å¦å¤–ä¸€æ¡æ¯”è¾ƒç‰¹æ®Šçš„å®ä¾‹æ˜¯æœ€åä¸€é¡¹ï¼Œ<code>g, alice, data2_admin</code>ï¼Œå®šä¹‰äº†ç”¨æˆ· <code>alice</code> ç»§æ‰¿äº† <code>data2_admin</code> è¿™ä¸€è§’è‰²ã€‚</p>\n<p>æˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„ Policy ä¿å­˜åœ¨æ–‡ä»¶ policy.csv ä¸­ã€‚ä½†ä¸€èˆ¬æ¥è¯´ï¼ŒPolicy å‚¨å­˜åœ¨æ•°æ®åº“ç­‰ç­‰ä¸€äº›æ›´åŠ  organized çš„å¤–éƒ¨å­˜å‚¨ä¸­ã€‚</p>\n<h4 id=\"User-Logic\"><a href=\"#User-Logic\" class=\"headerlink\" title=\"User Logic\"></a>User Logic</h4><p>Casbin å‡ ä¹æ”¯æŒæ‰€æœ‰çš„å¸¸è§çš„ç¼–ç¨‹è¯­è¨€ï¼Œç”¨æˆ·ä½¿ç”¨çš„é€»è¾‘ä¹ŸåŸºæœ¬ç›¸ä¼¼ï¼Œä¸»è¦é€šè¿‡ Enforcer ç±»æ¥è¿›è¡Œæ“ä½œã€‚</p>\n<pre><code class=\"go\">e, err := casbin.NewEnforcer(&quot;model.conf&quot;, &quot;policy.csv&quot;)\nresult1, _ := e.Enforce(&quot;alice&quot;, &quot;data1&quot;, &quot;read&quot;)\nfmt.Println(result1)\nresult2, _ := e.Enforce(&quot;alice&quot;, &quot;data1&quot;, &quot;write&quot;)\nfmt.Println(result2)\nresult3, _ := e.Enforce(&quot;alice&quot;, &quot;data2&quot;, &quot;read&quot;)\nfmt.Println(result3)\n</code></pre>\n<p>é€šè¿‡ Enforce æ–¹æ³•ï¼Œå¼€å‘è€…è¾“å…¥ Requestï¼Œå°±å¯ä»¥å¾—åˆ°è¿™æ¡è¯·æ±‚æ˜¯å¦å¯ä»¥é€šè¿‡ã€‚åœ¨ä¸Šè¿°ä¾‹å­ä¸­æœ‰ 3 ä¸ª test caseï¼Œåˆ†åˆ«éªŒè¯äº†åˆæ³•è¯·æ±‚åŒ¹é…ï¼Œéæ³•è¯·æ±‚åŒ¹é…ï¼Œé›†æˆè§’è‰²è¯·æ±‚åŒ¹é…ã€‚ç¬¬ä¸€ä¸ª test case å¯¹åº”äº† policy.csv ä¸­çš„ç¬¬ä¸€æ¡ Policyï¼Œç¬¬äºŒä¸ª test case åˆ™æ²¡æœ‰ test caseã€‚ç¬¬ä¸‰ä¸ª test case é€šè¿‡ <code>g, alice, data2_admin</code> å°† alice ä¸ data2_admin çš„ Policy å…³è”èµ·æ¥ï¼Œç„¶åé€šè¿‡ç¬¬ä¸‰æ¡ Policy p, data2_admin, data2, read éªŒè¯å…¶ä¸ºåˆæ³•è¯·æ±‚ã€‚</p>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><div id=\"ref1\"/>\n- [1] https://github.com/casbin/casbin\n<div id=\"ref2\"/>\n- [2] https://arxiv.org/pdf/1903.09756.pdf\n<div id=\"ref3\"/>\n- [3] https://casbin.org/docs/en/syntax-for-models#policy-effect\n"},{"title":"[BugFix] Kubernetes Ingress Nginx DNS æŠ¥é”™æ—¥å¿— Bug Fix","date":"2021-03-13T12:27:49.000Z","updated":"2021-03-13T12:27:49.000Z","_content":"## é—®é¢˜\nç›®å‰ï¼Œå½“æŒ‡å®šè®¿é—®é›†ç¾¤å¤–éƒ¨åœ°å€ä¸º IP æ—¶ï¼Œingress-nginx controller çš„æ—¥å¿—ä¸­å­˜åœ¨å¤§é‡çš„ DNS æŠ¥é”™çš„åƒåœ¾æ—¥å¿—ã€‚è™½ç„¶ä¸å½±å“æ­£å¸¸è¿è¡Œï¼ˆçŒœæµ‹å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½æ³¢åŠ¨ï¼Œå¯¹æ¯”è§æœ€åï¼‰ï¼Œä½†æ˜¯æŸ¥çœ‹ Nginx æ—¥å¿— debug æ—¶æ•ˆç‡ä¸¥é‡é™ä½ã€‚\n\n![](/asset/ingress-nginx-bug-fix/error.png)\n\n## åŸå› \nè¯¦ç»†çš„è®¨è®ºè§ï¼š\n[https://github.com/coredns/coredns/issues/2324](https://github.com/coredns/coredns/issues/2324)\n\nç®€ç•¥æ€»ç»“ä¸‹ï¼Œå¯¼è‡´è®¿é—®å¤–éƒ¨ IPï¼ŒNginx æŠ¥ DNS è§£æé”™è¯¯çš„åŸå› åœ¨äº Kubernetes è‡ªèº«çš„bugï¼Œç¼ºå°‘äº†ä¸€ä¸ªéªŒè¯ã€‚\n\nå‡ºç°é—®é¢˜çš„æƒ…å†µæ˜¯é€šè¿‡ ExternalName ç±»å‹çš„ Service è®¿é—®å¤–éƒ¨æœåŠ¡çš„ã€‚å®šä¹‰çš„ yaml ç±»ä¼¼äºä¸‹é¢è¿™ç§ï¼š\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name: demo2\n  namespace: default\nspec:\n  type: ExternalName\n  externalName: xxx.xxx.xxx.xxx\n```\nå¯¹äº Kubernetes çš„è®¾è®¡æ¥è¯´ï¼ŒExternalName å°±æ˜¯ä¸€ä¸ªåŸŸåã€‚K8s å®˜æ–¹æ˜¯è¿™æ ·ä»‹ç»çš„ \n\n> ExternalName: Maps the service to the contents of the externalName field (e.g. foo.bar.example.com), by returning aCNAMErecord with its value. No proxying of any kind is set up.\n\n> Note:ExternalName accepts an IPv4 address string, but as a DNS names comprised of digits, not as an IP address. ExternalNames that resemble IPv4 addresses are not resolved by CoreDNS or ingress-nginx because ExternalName is intended to specify a canonical DNS name.\n\nä»å®ç°ä¸Šæ¥çœ‹ï¼ŒExternalName ç±»å‹çš„ Service å…¶å®å°±æ˜¯åœ¨ CoreDNS é‡Œçš„ä¸€æ¡ CNAME è®°å½•ã€‚ CNAME æ˜¯ä¸€æ¡åŸŸåæŒ‡å‘å¦ä¸€ä¸ªåŸŸåçš„è®°å½•ï¼Œåœ¨ K8s ä¸­ï¼Œè¿™æ¡ record è®°è½½çš„å°±æ˜¯ Service åå­—æŒ‡å‘ ExtenalName çš„ä¸€ä¸ªæ˜ å°„ã€‚\n\nä½†æ˜¯ï¼Œå½“ ExternalName ç±»å‹çš„ Service ä¸­è®¾å®šçš„æ˜¯ IP æ—¶ï¼ŒK8s å¹¶æ²¡æœ‰å¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼Œä»ç„¶å…è®¸å…¶æ­£å¸¸åˆ›å»ºã€‚\n\nåŒæ—¶ï¼ŒNginx æœ¬èº«å­˜åœ¨ç€ä¸€ä¸ªè½®è¯¢æœºåˆ¶ï¼Œä¼šä¸æ–­çš„å‘ DNS æœåŠ¡æ‹‰å–è®°å½•è¿›è¡Œç¼“å­˜ã€‚\n[https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util/dns.lua](https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util/dns.lua)\n\nåœ¨æ¯æ¬¡æ‹‰å–ç¼“å­˜æ—¶ä¼šå‘ç”Ÿä»¥ä¸‹çš„è¿‡ç¨‹ï¼š\n1. Nginx ä» CoreDNS æ‹‰å–åˆ°äº†ä¸€ä¸ª CNAME è®°å½•ï¼Œä¾‹å¦‚ï¼šdemo2 -> xxx.xxx.xxx.xxx\n2. æ¥ç€ï¼ŒNginx å°è¯•è§£æ xxx.xxx.xxx.xxx è¿™ä¸ªåŸŸåï¼ŒCoreDNS è‡ªç„¶æ˜¯å¯¹è¿™ä¸ªé•¿æˆ IP æ ·å­çš„åŸŸåè§£æä¸å‡ºæ¥çš„ï¼Œäºæ˜¯è§£æå¤±è´¥ï¼Œå¯¼è‡´æŠ¥é”™\n\n------\n\nè‡³äºä¸ºä»€ä¹ˆ DNS è§£æå¤±è´¥ä¹‹åï¼ŒNginx ä»ç„¶èƒ½å¤ŸæˆåŠŸè½¬å‘è¯·æ±‚ï¼ŒåŸå› æ˜¯ ingress-nginx controller åœ¨å®ç°ä¸Šå¹¶æ²¡æœ‰å¯¹è¿™ä¸ªè¿›è¡ŒåŒºåˆ†ã€‚\n\né¦–å…ˆï¼Œå…ˆç®€å•ä»‹ç»ä¸‹ controller çš„åŸç†ã€‚Ingress-nginx controller ä¸€ç›´ç›‘å¬ç€ k8s ç³»ç»Ÿä¸­çš„ ingress èµ„æºã€‚å½“æœ‰æ–°çš„ ingress åˆ›å»ºæ—¶ï¼Œcontroller ä¼šå¼€å§‹æ›´æ–° Nginx çš„é…ç½®æ–‡ä»¶ï¼Œå‘å…¶ä¸­æ·»åŠ è½¬å‘è§„åˆ™ï¼Œå¹¶é‡å¯ Nginxã€‚\n\nä¸‹é¢æ˜¯ controller è§£ææŒ‡å‘ ExternalName çš„ ingressï¼Œç„¶ååˆ›å»º upstream çš„é€»è¾‘\n[https://github.com/kubernetes/ingress-nginx/blob/5f1a37a624ca38e8cccc87cb7a36d7dbcbe70b01/internal/ingress/controller/endpoints.go#L52](https://github.com/kubernetes/ingress-nginx/blob/5f1a37a624ca38e8cccc87cb7a36d7dbcbe70b01/internal/ingress/controller/endpoints.go#L52)\n\n![](/asset/ingress-nginx-bug-fix/nginx-code.png)\n\nå¯ä»¥çœ‹åˆ°ï¼Œcontroller æ˜¯æ²¡æœ‰å¼ºåˆ¶è§£æ ExternalName æˆåŸŸåçš„ï¼Œæ‰€ä»¥å†™è¿› nginx.conf çš„ upstream ä¹Ÿæ˜¯ ip å½¢å¼ï¼Œè¿™æ · nginx ä¼šè‡ªç„¶åœ°å°† ExternalName è§£ææˆ IPï¼Œä»è€Œå¯ä»¥æ­£å¸¸å·¥ä½œã€‚\n\n## è§£å†³æ–¹æ³•\nåœ¨ä¸Šé¢æåˆ°çš„ Github Issue çš„è®¨è®ºä¸­ï¼Œæœ‰å¤§ä½¬å·²ç»ç»™å‡ºäº†è§£å†³æ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡ Service without selectors çš„æ–¹å¼ã€‚\nhttps://kubernetes.io/docs/concepts/services-networking/service/#services-without-selectors\n\nå¸¸è§çš„ K8s Service éƒ½æ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼Œé€‰æ‹©ä¸€ç³»åˆ— Pod ä½œä¸ºåç«¯ï¼ŒK8s endpoint controller ä¼šè‡ªåŠ¨æ ¹æ® Service çš„å£°æ˜å»ä¸º Service çš„æ¯ä¸ªç«¯å£åˆ›å»ºä¸€ä¸ª endpointã€‚Endpoint æ˜¯ K8s ä¸­å®é™…è¿›è¡ŒæœåŠ¡è·¯ç”±çš„èµ„æºã€‚\n\nè€Œåˆ›å»º Service without selectorsï¼Œå°±éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»åˆ›å»ºä¸€ä¸ªä¸ Service åŒåçš„ endpointã€‚è¿™æ ·å°±ä¸éœ€è¦æŒ‡å®š Service ä¸º ExternalName çš„ç±»å‹ï¼ŒCoreDNS ä¸­å°±ä¼šå°†å…¶è§†ä½œä¸€æ¡ A è®°å½•ï¼Œè€Œä¸æ˜¯ä¸€æ¡ CNAME è®°å½•ã€‚Nginx æ‹‰å– DNS ç¼“å­˜æ—¶ä¹Ÿä¸ä¼šæŠŠ IP å½“åšåŸŸåäº†ã€‚\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: demo2\n  namespace: default\nspec:\n  clusterIP: None\n  ports:\n  - name: grpc\n    port: 32443\n    protocol: TCP\n---\nkind: Endpoints\napiVersion: v1\nmetadata:\n  name: demo2\n  namespace: default\nsubsets:\n  - addresses:\n      - ip: xxx.xxx.xxx.xxx\n    ports:\n      - port: 32443\n        name: grpc\n        protocol: TCP\n```\n\n## å¯¹æ¯”\nåœ¨ä¸¤ä¸ªå¯¹ç­‰çš„é›†ç¾¤å‘ç”Ÿé€šä¿¡æ—¶ï¼Œdemo1 ä¿®å¤ï¼Œdemo2ä¸ä¿®å¤ï¼Œå¯¹æ¯”ä¸¤ä¾§çš„ CPU ä½¿ç”¨æƒ…å†µ\n\ndemo1ï¼š\n![](/asset/ingress-nginx-bug-fix/demo1.png)\n\ndemo2ï¼š\n![](/asset/ingress-nginx-bug-fix/demo2.png)\n\ndemo2 å¤§çº¦æ¯” demo1 æ¶ˆè€— CPU å¤š 0.020 ä¸ªæ ¸ã€‚è™½ç„¶è¿™ä¸ªæŠ¥é”™ä¼šç¨å¾®å¢åŠ ä¸€ç‚¹ CPU çš„ä½¿ç”¨é‡ï¼Œä½†å¹¶ä¸å¤šã€‚\n","source":"_posts/ingress-nginx-bug-fix.md","raw":"---\ntitle: \"[BugFix] Kubernetes Ingress Nginx DNS æŠ¥é”™æ—¥å¿— Bug Fix\"\ndate: 2021-03-13 12:27:49\nupdated: 2021-03-13 12:27:49\n---\n## é—®é¢˜\nç›®å‰ï¼Œå½“æŒ‡å®šè®¿é—®é›†ç¾¤å¤–éƒ¨åœ°å€ä¸º IP æ—¶ï¼Œingress-nginx controller çš„æ—¥å¿—ä¸­å­˜åœ¨å¤§é‡çš„ DNS æŠ¥é”™çš„åƒåœ¾æ—¥å¿—ã€‚è™½ç„¶ä¸å½±å“æ­£å¸¸è¿è¡Œï¼ˆçŒœæµ‹å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½æ³¢åŠ¨ï¼Œå¯¹æ¯”è§æœ€åï¼‰ï¼Œä½†æ˜¯æŸ¥çœ‹ Nginx æ—¥å¿— debug æ—¶æ•ˆç‡ä¸¥é‡é™ä½ã€‚\n\n![](/asset/ingress-nginx-bug-fix/error.png)\n\n## åŸå› \nè¯¦ç»†çš„è®¨è®ºè§ï¼š\n[https://github.com/coredns/coredns/issues/2324](https://github.com/coredns/coredns/issues/2324)\n\nç®€ç•¥æ€»ç»“ä¸‹ï¼Œå¯¼è‡´è®¿é—®å¤–éƒ¨ IPï¼ŒNginx æŠ¥ DNS è§£æé”™è¯¯çš„åŸå› åœ¨äº Kubernetes è‡ªèº«çš„bugï¼Œç¼ºå°‘äº†ä¸€ä¸ªéªŒè¯ã€‚\n\nå‡ºç°é—®é¢˜çš„æƒ…å†µæ˜¯é€šè¿‡ ExternalName ç±»å‹çš„ Service è®¿é—®å¤–éƒ¨æœåŠ¡çš„ã€‚å®šä¹‰çš„ yaml ç±»ä¼¼äºä¸‹é¢è¿™ç§ï¼š\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name: demo2\n  namespace: default\nspec:\n  type: ExternalName\n  externalName: xxx.xxx.xxx.xxx\n```\nå¯¹äº Kubernetes çš„è®¾è®¡æ¥è¯´ï¼ŒExternalName å°±æ˜¯ä¸€ä¸ªåŸŸåã€‚K8s å®˜æ–¹æ˜¯è¿™æ ·ä»‹ç»çš„ \n\n> ExternalName: Maps the service to the contents of the externalName field (e.g. foo.bar.example.com), by returning aCNAMErecord with its value. No proxying of any kind is set up.\n\n> Note:ExternalName accepts an IPv4 address string, but as a DNS names comprised of digits, not as an IP address. ExternalNames that resemble IPv4 addresses are not resolved by CoreDNS or ingress-nginx because ExternalName is intended to specify a canonical DNS name.\n\nä»å®ç°ä¸Šæ¥çœ‹ï¼ŒExternalName ç±»å‹çš„ Service å…¶å®å°±æ˜¯åœ¨ CoreDNS é‡Œçš„ä¸€æ¡ CNAME è®°å½•ã€‚ CNAME æ˜¯ä¸€æ¡åŸŸåæŒ‡å‘å¦ä¸€ä¸ªåŸŸåçš„è®°å½•ï¼Œåœ¨ K8s ä¸­ï¼Œè¿™æ¡ record è®°è½½çš„å°±æ˜¯ Service åå­—æŒ‡å‘ ExtenalName çš„ä¸€ä¸ªæ˜ å°„ã€‚\n\nä½†æ˜¯ï¼Œå½“ ExternalName ç±»å‹çš„ Service ä¸­è®¾å®šçš„æ˜¯ IP æ—¶ï¼ŒK8s å¹¶æ²¡æœ‰å¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼Œä»ç„¶å…è®¸å…¶æ­£å¸¸åˆ›å»ºã€‚\n\nåŒæ—¶ï¼ŒNginx æœ¬èº«å­˜åœ¨ç€ä¸€ä¸ªè½®è¯¢æœºåˆ¶ï¼Œä¼šä¸æ–­çš„å‘ DNS æœåŠ¡æ‹‰å–è®°å½•è¿›è¡Œç¼“å­˜ã€‚\n[https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util/dns.lua](https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util/dns.lua)\n\nåœ¨æ¯æ¬¡æ‹‰å–ç¼“å­˜æ—¶ä¼šå‘ç”Ÿä»¥ä¸‹çš„è¿‡ç¨‹ï¼š\n1. Nginx ä» CoreDNS æ‹‰å–åˆ°äº†ä¸€ä¸ª CNAME è®°å½•ï¼Œä¾‹å¦‚ï¼šdemo2 -> xxx.xxx.xxx.xxx\n2. æ¥ç€ï¼ŒNginx å°è¯•è§£æ xxx.xxx.xxx.xxx è¿™ä¸ªåŸŸåï¼ŒCoreDNS è‡ªç„¶æ˜¯å¯¹è¿™ä¸ªé•¿æˆ IP æ ·å­çš„åŸŸåè§£æä¸å‡ºæ¥çš„ï¼Œäºæ˜¯è§£æå¤±è´¥ï¼Œå¯¼è‡´æŠ¥é”™\n\n------\n\nè‡³äºä¸ºä»€ä¹ˆ DNS è§£æå¤±è´¥ä¹‹åï¼ŒNginx ä»ç„¶èƒ½å¤ŸæˆåŠŸè½¬å‘è¯·æ±‚ï¼ŒåŸå› æ˜¯ ingress-nginx controller åœ¨å®ç°ä¸Šå¹¶æ²¡æœ‰å¯¹è¿™ä¸ªè¿›è¡ŒåŒºåˆ†ã€‚\n\né¦–å…ˆï¼Œå…ˆç®€å•ä»‹ç»ä¸‹ controller çš„åŸç†ã€‚Ingress-nginx controller ä¸€ç›´ç›‘å¬ç€ k8s ç³»ç»Ÿä¸­çš„ ingress èµ„æºã€‚å½“æœ‰æ–°çš„ ingress åˆ›å»ºæ—¶ï¼Œcontroller ä¼šå¼€å§‹æ›´æ–° Nginx çš„é…ç½®æ–‡ä»¶ï¼Œå‘å…¶ä¸­æ·»åŠ è½¬å‘è§„åˆ™ï¼Œå¹¶é‡å¯ Nginxã€‚\n\nä¸‹é¢æ˜¯ controller è§£ææŒ‡å‘ ExternalName çš„ ingressï¼Œç„¶ååˆ›å»º upstream çš„é€»è¾‘\n[https://github.com/kubernetes/ingress-nginx/blob/5f1a37a624ca38e8cccc87cb7a36d7dbcbe70b01/internal/ingress/controller/endpoints.go#L52](https://github.com/kubernetes/ingress-nginx/blob/5f1a37a624ca38e8cccc87cb7a36d7dbcbe70b01/internal/ingress/controller/endpoints.go#L52)\n\n![](/asset/ingress-nginx-bug-fix/nginx-code.png)\n\nå¯ä»¥çœ‹åˆ°ï¼Œcontroller æ˜¯æ²¡æœ‰å¼ºåˆ¶è§£æ ExternalName æˆåŸŸåçš„ï¼Œæ‰€ä»¥å†™è¿› nginx.conf çš„ upstream ä¹Ÿæ˜¯ ip å½¢å¼ï¼Œè¿™æ · nginx ä¼šè‡ªç„¶åœ°å°† ExternalName è§£ææˆ IPï¼Œä»è€Œå¯ä»¥æ­£å¸¸å·¥ä½œã€‚\n\n## è§£å†³æ–¹æ³•\nåœ¨ä¸Šé¢æåˆ°çš„ Github Issue çš„è®¨è®ºä¸­ï¼Œæœ‰å¤§ä½¬å·²ç»ç»™å‡ºäº†è§£å†³æ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡ Service without selectors çš„æ–¹å¼ã€‚\nhttps://kubernetes.io/docs/concepts/services-networking/service/#services-without-selectors\n\nå¸¸è§çš„ K8s Service éƒ½æ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼Œé€‰æ‹©ä¸€ç³»åˆ— Pod ä½œä¸ºåç«¯ï¼ŒK8s endpoint controller ä¼šè‡ªåŠ¨æ ¹æ® Service çš„å£°æ˜å»ä¸º Service çš„æ¯ä¸ªç«¯å£åˆ›å»ºä¸€ä¸ª endpointã€‚Endpoint æ˜¯ K8s ä¸­å®é™…è¿›è¡ŒæœåŠ¡è·¯ç”±çš„èµ„æºã€‚\n\nè€Œåˆ›å»º Service without selectorsï¼Œå°±éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»åˆ›å»ºä¸€ä¸ªä¸ Service åŒåçš„ endpointã€‚è¿™æ ·å°±ä¸éœ€è¦æŒ‡å®š Service ä¸º ExternalName çš„ç±»å‹ï¼ŒCoreDNS ä¸­å°±ä¼šå°†å…¶è§†ä½œä¸€æ¡ A è®°å½•ï¼Œè€Œä¸æ˜¯ä¸€æ¡ CNAME è®°å½•ã€‚Nginx æ‹‰å– DNS ç¼“å­˜æ—¶ä¹Ÿä¸ä¼šæŠŠ IP å½“åšåŸŸåäº†ã€‚\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: demo2\n  namespace: default\nspec:\n  clusterIP: None\n  ports:\n  - name: grpc\n    port: 32443\n    protocol: TCP\n---\nkind: Endpoints\napiVersion: v1\nmetadata:\n  name: demo2\n  namespace: default\nsubsets:\n  - addresses:\n      - ip: xxx.xxx.xxx.xxx\n    ports:\n      - port: 32443\n        name: grpc\n        protocol: TCP\n```\n\n## å¯¹æ¯”\nåœ¨ä¸¤ä¸ªå¯¹ç­‰çš„é›†ç¾¤å‘ç”Ÿé€šä¿¡æ—¶ï¼Œdemo1 ä¿®å¤ï¼Œdemo2ä¸ä¿®å¤ï¼Œå¯¹æ¯”ä¸¤ä¾§çš„ CPU ä½¿ç”¨æƒ…å†µ\n\ndemo1ï¼š\n![](/asset/ingress-nginx-bug-fix/demo1.png)\n\ndemo2ï¼š\n![](/asset/ingress-nginx-bug-fix/demo2.png)\n\ndemo2 å¤§çº¦æ¯” demo1 æ¶ˆè€— CPU å¤š 0.020 ä¸ªæ ¸ã€‚è™½ç„¶è¿™ä¸ªæŠ¥é”™ä¼šç¨å¾®å¢åŠ ä¸€ç‚¹ CPU çš„ä½¿ç”¨é‡ï¼Œä½†å¹¶ä¸å¤šã€‚\n","slug":"ingress-nginx-bug-fix","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"cl5i8k7y300051rpf87vag2ku","content":"<h2 id=\"é—®é¢˜\"><a href=\"#é—®é¢˜\" class=\"headerlink\" title=\"é—®é¢˜\"></a>é—®é¢˜</h2><p>ç›®å‰ï¼Œå½“æŒ‡å®šè®¿é—®é›†ç¾¤å¤–éƒ¨åœ°å€ä¸º IP æ—¶ï¼Œingress-nginx controller çš„æ—¥å¿—ä¸­å­˜åœ¨å¤§é‡çš„ DNS æŠ¥é”™çš„åƒåœ¾æ—¥å¿—ã€‚è™½ç„¶ä¸å½±å“æ­£å¸¸è¿è¡Œï¼ˆçŒœæµ‹å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½æ³¢åŠ¨ï¼Œå¯¹æ¯”è§æœ€åï¼‰ï¼Œä½†æ˜¯æŸ¥çœ‹ Nginx æ—¥å¿— debug æ—¶æ•ˆç‡ä¸¥é‡é™ä½ã€‚</p>\n<p><img src=\"/asset/ingress-nginx-bug-fix/error.png\"></p>\n<h2 id=\"åŸå› \"><a href=\"#åŸå› \" class=\"headerlink\" title=\"åŸå› \"></a>åŸå› </h2><p>è¯¦ç»†çš„è®¨è®ºè§ï¼š<br><a href=\"https://github.com/coredns/coredns/issues/2324\">https://github.com/coredns/coredns/issues/2324</a></p>\n<p>ç®€ç•¥æ€»ç»“ä¸‹ï¼Œå¯¼è‡´è®¿é—®å¤–éƒ¨ IPï¼ŒNginx æŠ¥ DNS è§£æé”™è¯¯çš„åŸå› åœ¨äº Kubernetes è‡ªèº«çš„bugï¼Œç¼ºå°‘äº†ä¸€ä¸ªéªŒè¯ã€‚</p>\n<p>å‡ºç°é—®é¢˜çš„æƒ…å†µæ˜¯é€šè¿‡ ExternalName ç±»å‹çš„ Service è®¿é—®å¤–éƒ¨æœåŠ¡çš„ã€‚å®šä¹‰çš„ yaml ç±»ä¼¼äºä¸‹é¢è¿™ç§ï¼š</p>\n<pre><code class=\"yaml\">kind: Service\napiVersion: v1\nmetadata:\n  name: demo2\n  namespace: default\nspec:\n  type: ExternalName\n  externalName: xxx.xxx.xxx.xxx\n</code></pre>\n<p>å¯¹äº Kubernetes çš„è®¾è®¡æ¥è¯´ï¼ŒExternalName å°±æ˜¯ä¸€ä¸ªåŸŸåã€‚K8s å®˜æ–¹æ˜¯è¿™æ ·ä»‹ç»çš„ </p>\n<blockquote>\n<p>ExternalName: Maps the service to the contents of the externalName field (e.g. foo.bar.example.com), by returning aCNAMErecord with its value. No proxying of any kind is set up.</p>\n</blockquote>\n<blockquote>\n<p>Note:ExternalName accepts an IPv4 address string, but as a DNS names comprised of digits, not as an IP address. ExternalNames that resemble IPv4 addresses are not resolved by CoreDNS or ingress-nginx because ExternalName is intended to specify a canonical DNS name.</p>\n</blockquote>\n<p>ä»å®ç°ä¸Šæ¥çœ‹ï¼ŒExternalName ç±»å‹çš„ Service å…¶å®å°±æ˜¯åœ¨ CoreDNS é‡Œçš„ä¸€æ¡ CNAME è®°å½•ã€‚ CNAME æ˜¯ä¸€æ¡åŸŸåæŒ‡å‘å¦ä¸€ä¸ªåŸŸåçš„è®°å½•ï¼Œåœ¨ K8s ä¸­ï¼Œè¿™æ¡ record è®°è½½çš„å°±æ˜¯ Service åå­—æŒ‡å‘ ExtenalName çš„ä¸€ä¸ªæ˜ å°„ã€‚</p>\n<p>ä½†æ˜¯ï¼Œå½“ ExternalName ç±»å‹çš„ Service ä¸­è®¾å®šçš„æ˜¯ IP æ—¶ï¼ŒK8s å¹¶æ²¡æœ‰å¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼Œä»ç„¶å…è®¸å…¶æ­£å¸¸åˆ›å»ºã€‚</p>\n<p>åŒæ—¶ï¼ŒNginx æœ¬èº«å­˜åœ¨ç€ä¸€ä¸ªè½®è¯¢æœºåˆ¶ï¼Œä¼šä¸æ–­çš„å‘ DNS æœåŠ¡æ‹‰å–è®°å½•è¿›è¡Œç¼“å­˜ã€‚<br><a href=\"https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util/dns.lua\">https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util/dns.lua</a></p>\n<p>åœ¨æ¯æ¬¡æ‹‰å–ç¼“å­˜æ—¶ä¼šå‘ç”Ÿä»¥ä¸‹çš„è¿‡ç¨‹ï¼š</p>\n<ol>\n<li>Nginx ä» CoreDNS æ‹‰å–åˆ°äº†ä¸€ä¸ª CNAME è®°å½•ï¼Œä¾‹å¦‚ï¼šdemo2 -&gt; xxx.xxx.xxx.xxx</li>\n<li>æ¥ç€ï¼ŒNginx å°è¯•è§£æ xxx.xxx.xxx.xxx è¿™ä¸ªåŸŸåï¼ŒCoreDNS è‡ªç„¶æ˜¯å¯¹è¿™ä¸ªé•¿æˆ IP æ ·å­çš„åŸŸåè§£æä¸å‡ºæ¥çš„ï¼Œäºæ˜¯è§£æå¤±è´¥ï¼Œå¯¼è‡´æŠ¥é”™</li>\n</ol>\n<hr>\n<p>è‡³äºä¸ºä»€ä¹ˆ DNS è§£æå¤±è´¥ä¹‹åï¼ŒNginx ä»ç„¶èƒ½å¤ŸæˆåŠŸè½¬å‘è¯·æ±‚ï¼ŒåŸå› æ˜¯ ingress-nginx controller åœ¨å®ç°ä¸Šå¹¶æ²¡æœ‰å¯¹è¿™ä¸ªè¿›è¡ŒåŒºåˆ†ã€‚</p>\n<p>é¦–å…ˆï¼Œå…ˆç®€å•ä»‹ç»ä¸‹ controller çš„åŸç†ã€‚Ingress-nginx controller ä¸€ç›´ç›‘å¬ç€ k8s ç³»ç»Ÿä¸­çš„ ingress èµ„æºã€‚å½“æœ‰æ–°çš„ ingress åˆ›å»ºæ—¶ï¼Œcontroller ä¼šå¼€å§‹æ›´æ–° Nginx çš„é…ç½®æ–‡ä»¶ï¼Œå‘å…¶ä¸­æ·»åŠ è½¬å‘è§„åˆ™ï¼Œå¹¶é‡å¯ Nginxã€‚</p>\n<p>ä¸‹é¢æ˜¯ controller è§£ææŒ‡å‘ ExternalName çš„ ingressï¼Œç„¶ååˆ›å»º upstream çš„é€»è¾‘<br><a href=\"https://github.com/kubernetes/ingress-nginx/blob/5f1a37a624ca38e8cccc87cb7a36d7dbcbe70b01/internal/ingress/controller/endpoints.go#L52\">https://github.com/kubernetes/ingress-nginx/blob/5f1a37a624ca38e8cccc87cb7a36d7dbcbe70b01/internal/ingress/controller/endpoints.go#L52</a></p>\n<p><img src=\"/asset/ingress-nginx-bug-fix/nginx-code.png\"></p>\n<p>å¯ä»¥çœ‹åˆ°ï¼Œcontroller æ˜¯æ²¡æœ‰å¼ºåˆ¶è§£æ ExternalName æˆåŸŸåçš„ï¼Œæ‰€ä»¥å†™è¿› nginx.conf çš„ upstream ä¹Ÿæ˜¯ ip å½¢å¼ï¼Œè¿™æ · nginx ä¼šè‡ªç„¶åœ°å°† ExternalName è§£ææˆ IPï¼Œä»è€Œå¯ä»¥æ­£å¸¸å·¥ä½œã€‚</p>\n<h2 id=\"è§£å†³æ–¹æ³•\"><a href=\"#è§£å†³æ–¹æ³•\" class=\"headerlink\" title=\"è§£å†³æ–¹æ³•\"></a>è§£å†³æ–¹æ³•</h2><p>åœ¨ä¸Šé¢æåˆ°çš„ Github Issue çš„è®¨è®ºä¸­ï¼Œæœ‰å¤§ä½¬å·²ç»ç»™å‡ºäº†è§£å†³æ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡ Service without selectors çš„æ–¹å¼ã€‚<br><a href=\"https://kubernetes.io/docs/concepts/services-networking/service/#services-without-selectors\">https://kubernetes.io/docs/concepts/services-networking/service/#services-without-selectors</a></p>\n<p>å¸¸è§çš„ K8s Service éƒ½æ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼Œé€‰æ‹©ä¸€ç³»åˆ— Pod ä½œä¸ºåç«¯ï¼ŒK8s endpoint controller ä¼šè‡ªåŠ¨æ ¹æ® Service çš„å£°æ˜å»ä¸º Service çš„æ¯ä¸ªç«¯å£åˆ›å»ºä¸€ä¸ª endpointã€‚Endpoint æ˜¯ K8s ä¸­å®é™…è¿›è¡ŒæœåŠ¡è·¯ç”±çš„èµ„æºã€‚</p>\n<p>è€Œåˆ›å»º Service without selectorsï¼Œå°±éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»åˆ›å»ºä¸€ä¸ªä¸ Service åŒåçš„ endpointã€‚è¿™æ ·å°±ä¸éœ€è¦æŒ‡å®š Service ä¸º ExternalName çš„ç±»å‹ï¼ŒCoreDNS ä¸­å°±ä¼šå°†å…¶è§†ä½œä¸€æ¡ A è®°å½•ï¼Œè€Œä¸æ˜¯ä¸€æ¡ CNAME è®°å½•ã€‚Nginx æ‹‰å– DNS ç¼“å­˜æ—¶ä¹Ÿä¸ä¼šæŠŠ IP å½“åšåŸŸåäº†ã€‚</p>\n<pre><code class=\"yaml\">apiVersion: v1\nkind: Service\nmetadata:\n  name: demo2\n  namespace: default\nspec:\n  clusterIP: None\n  ports:\n  - name: grpc\n    port: 32443\n    protocol: TCP\n---\nkind: Endpoints\napiVersion: v1\nmetadata:\n  name: demo2\n  namespace: default\nsubsets:\n  - addresses:\n      - ip: xxx.xxx.xxx.xxx\n    ports:\n      - port: 32443\n        name: grpc\n        protocol: TCP\n</code></pre>\n<h2 id=\"å¯¹æ¯”\"><a href=\"#å¯¹æ¯”\" class=\"headerlink\" title=\"å¯¹æ¯”\"></a>å¯¹æ¯”</h2><p>åœ¨ä¸¤ä¸ªå¯¹ç­‰çš„é›†ç¾¤å‘ç”Ÿé€šä¿¡æ—¶ï¼Œdemo1 ä¿®å¤ï¼Œdemo2ä¸ä¿®å¤ï¼Œå¯¹æ¯”ä¸¤ä¾§çš„ CPU ä½¿ç”¨æƒ…å†µ</p>\n<p>demo1ï¼š<br><img src=\"/asset/ingress-nginx-bug-fix/demo1.png\"></p>\n<p>demo2ï¼š<br><img src=\"/asset/ingress-nginx-bug-fix/demo2.png\"></p>\n<p>demo2 å¤§çº¦æ¯” demo1 æ¶ˆè€— CPU å¤š 0.020 ä¸ªæ ¸ã€‚è™½ç„¶è¿™ä¸ªæŠ¥é”™ä¼šç¨å¾®å¢åŠ ä¸€ç‚¹ CPU çš„ä½¿ç”¨é‡ï¼Œä½†å¹¶ä¸å¤šã€‚</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"é—®é¢˜\"><a href=\"#é—®é¢˜\" class=\"headerlink\" title=\"é—®é¢˜\"></a>é—®é¢˜</h2><p>ç›®å‰ï¼Œå½“æŒ‡å®šè®¿é—®é›†ç¾¤å¤–éƒ¨åœ°å€ä¸º IP æ—¶ï¼Œingress-nginx controller çš„æ—¥å¿—ä¸­å­˜åœ¨å¤§é‡çš„ DNS æŠ¥é”™çš„åƒåœ¾æ—¥å¿—ã€‚è™½ç„¶ä¸å½±å“æ­£å¸¸è¿è¡Œï¼ˆçŒœæµ‹å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½æ³¢åŠ¨ï¼Œå¯¹æ¯”è§æœ€åï¼‰ï¼Œä½†æ˜¯æŸ¥çœ‹ Nginx æ—¥å¿— debug æ—¶æ•ˆç‡ä¸¥é‡é™ä½ã€‚</p>\n<p><img src=\"/asset/ingress-nginx-bug-fix/error.png\"></p>\n<h2 id=\"åŸå› \"><a href=\"#åŸå› \" class=\"headerlink\" title=\"åŸå› \"></a>åŸå› </h2><p>è¯¦ç»†çš„è®¨è®ºè§ï¼š<br><a href=\"https://github.com/coredns/coredns/issues/2324\">https://github.com/coredns/coredns/issues/2324</a></p>\n<p>ç®€ç•¥æ€»ç»“ä¸‹ï¼Œå¯¼è‡´è®¿é—®å¤–éƒ¨ IPï¼ŒNginx æŠ¥ DNS è§£æé”™è¯¯çš„åŸå› åœ¨äº Kubernetes è‡ªèº«çš„bugï¼Œç¼ºå°‘äº†ä¸€ä¸ªéªŒè¯ã€‚</p>\n<p>å‡ºç°é—®é¢˜çš„æƒ…å†µæ˜¯é€šè¿‡ ExternalName ç±»å‹çš„ Service è®¿é—®å¤–éƒ¨æœåŠ¡çš„ã€‚å®šä¹‰çš„ yaml ç±»ä¼¼äºä¸‹é¢è¿™ç§ï¼š</p>\n<pre><code class=\"yaml\">kind: Service\napiVersion: v1\nmetadata:\n  name: demo2\n  namespace: default\nspec:\n  type: ExternalName\n  externalName: xxx.xxx.xxx.xxx\n</code></pre>\n<p>å¯¹äº Kubernetes çš„è®¾è®¡æ¥è¯´ï¼ŒExternalName å°±æ˜¯ä¸€ä¸ªåŸŸåã€‚K8s å®˜æ–¹æ˜¯è¿™æ ·ä»‹ç»çš„ </p>\n<blockquote>\n<p>ExternalName: Maps the service to the contents of the externalName field (e.g. foo.bar.example.com), by returning aCNAMErecord with its value. No proxying of any kind is set up.</p>\n</blockquote>\n<blockquote>\n<p>Note:ExternalName accepts an IPv4 address string, but as a DNS names comprised of digits, not as an IP address. ExternalNames that resemble IPv4 addresses are not resolved by CoreDNS or ingress-nginx because ExternalName is intended to specify a canonical DNS name.</p>\n</blockquote>\n<p>ä»å®ç°ä¸Šæ¥çœ‹ï¼ŒExternalName ç±»å‹çš„ Service å…¶å®å°±æ˜¯åœ¨ CoreDNS é‡Œçš„ä¸€æ¡ CNAME è®°å½•ã€‚ CNAME æ˜¯ä¸€æ¡åŸŸåæŒ‡å‘å¦ä¸€ä¸ªåŸŸåçš„è®°å½•ï¼Œåœ¨ K8s ä¸­ï¼Œè¿™æ¡ record è®°è½½çš„å°±æ˜¯ Service åå­—æŒ‡å‘ ExtenalName çš„ä¸€ä¸ªæ˜ å°„ã€‚</p>\n<p>ä½†æ˜¯ï¼Œå½“ ExternalName ç±»å‹çš„ Service ä¸­è®¾å®šçš„æ˜¯ IP æ—¶ï¼ŒK8s å¹¶æ²¡æœ‰å¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼Œä»ç„¶å…è®¸å…¶æ­£å¸¸åˆ›å»ºã€‚</p>\n<p>åŒæ—¶ï¼ŒNginx æœ¬èº«å­˜åœ¨ç€ä¸€ä¸ªè½®è¯¢æœºåˆ¶ï¼Œä¼šä¸æ–­çš„å‘ DNS æœåŠ¡æ‹‰å–è®°å½•è¿›è¡Œç¼“å­˜ã€‚<br><a href=\"https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util/dns.lua\">https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util/dns.lua</a></p>\n<p>åœ¨æ¯æ¬¡æ‹‰å–ç¼“å­˜æ—¶ä¼šå‘ç”Ÿä»¥ä¸‹çš„è¿‡ç¨‹ï¼š</p>\n<ol>\n<li>Nginx ä» CoreDNS æ‹‰å–åˆ°äº†ä¸€ä¸ª CNAME è®°å½•ï¼Œä¾‹å¦‚ï¼šdemo2 -&gt; xxx.xxx.xxx.xxx</li>\n<li>æ¥ç€ï¼ŒNginx å°è¯•è§£æ xxx.xxx.xxx.xxx è¿™ä¸ªåŸŸåï¼ŒCoreDNS è‡ªç„¶æ˜¯å¯¹è¿™ä¸ªé•¿æˆ IP æ ·å­çš„åŸŸåè§£æä¸å‡ºæ¥çš„ï¼Œäºæ˜¯è§£æå¤±è´¥ï¼Œå¯¼è‡´æŠ¥é”™</li>\n</ol>\n<hr>\n<p>è‡³äºä¸ºä»€ä¹ˆ DNS è§£æå¤±è´¥ä¹‹åï¼ŒNginx ä»ç„¶èƒ½å¤ŸæˆåŠŸè½¬å‘è¯·æ±‚ï¼ŒåŸå› æ˜¯ ingress-nginx controller åœ¨å®ç°ä¸Šå¹¶æ²¡æœ‰å¯¹è¿™ä¸ªè¿›è¡ŒåŒºåˆ†ã€‚</p>\n<p>é¦–å…ˆï¼Œå…ˆç®€å•ä»‹ç»ä¸‹ controller çš„åŸç†ã€‚Ingress-nginx controller ä¸€ç›´ç›‘å¬ç€ k8s ç³»ç»Ÿä¸­çš„ ingress èµ„æºã€‚å½“æœ‰æ–°çš„ ingress åˆ›å»ºæ—¶ï¼Œcontroller ä¼šå¼€å§‹æ›´æ–° Nginx çš„é…ç½®æ–‡ä»¶ï¼Œå‘å…¶ä¸­æ·»åŠ è½¬å‘è§„åˆ™ï¼Œå¹¶é‡å¯ Nginxã€‚</p>\n<p>ä¸‹é¢æ˜¯ controller è§£ææŒ‡å‘ ExternalName çš„ ingressï¼Œç„¶ååˆ›å»º upstream çš„é€»è¾‘<br><a href=\"https://github.com/kubernetes/ingress-nginx/blob/5f1a37a624ca38e8cccc87cb7a36d7dbcbe70b01/internal/ingress/controller/endpoints.go#L52\">https://github.com/kubernetes/ingress-nginx/blob/5f1a37a624ca38e8cccc87cb7a36d7dbcbe70b01/internal/ingress/controller/endpoints.go#L52</a></p>\n<p><img src=\"/asset/ingress-nginx-bug-fix/nginx-code.png\"></p>\n<p>å¯ä»¥çœ‹åˆ°ï¼Œcontroller æ˜¯æ²¡æœ‰å¼ºåˆ¶è§£æ ExternalName æˆåŸŸåçš„ï¼Œæ‰€ä»¥å†™è¿› nginx.conf çš„ upstream ä¹Ÿæ˜¯ ip å½¢å¼ï¼Œè¿™æ · nginx ä¼šè‡ªç„¶åœ°å°† ExternalName è§£ææˆ IPï¼Œä»è€Œå¯ä»¥æ­£å¸¸å·¥ä½œã€‚</p>\n<h2 id=\"è§£å†³æ–¹æ³•\"><a href=\"#è§£å†³æ–¹æ³•\" class=\"headerlink\" title=\"è§£å†³æ–¹æ³•\"></a>è§£å†³æ–¹æ³•</h2><p>åœ¨ä¸Šé¢æåˆ°çš„ Github Issue çš„è®¨è®ºä¸­ï¼Œæœ‰å¤§ä½¬å·²ç»ç»™å‡ºäº†è§£å†³æ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡ Service without selectors çš„æ–¹å¼ã€‚<br><a href=\"https://kubernetes.io/docs/concepts/services-networking/service/#services-without-selectors\">https://kubernetes.io/docs/concepts/services-networking/service/#services-without-selectors</a></p>\n<p>å¸¸è§çš„ K8s Service éƒ½æ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨ï¼Œé€‰æ‹©ä¸€ç³»åˆ— Pod ä½œä¸ºåç«¯ï¼ŒK8s endpoint controller ä¼šè‡ªåŠ¨æ ¹æ® Service çš„å£°æ˜å»ä¸º Service çš„æ¯ä¸ªç«¯å£åˆ›å»ºä¸€ä¸ª endpointã€‚Endpoint æ˜¯ K8s ä¸­å®é™…è¿›è¡ŒæœåŠ¡è·¯ç”±çš„èµ„æºã€‚</p>\n<p>è€Œåˆ›å»º Service without selectorsï¼Œå°±éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»åˆ›å»ºä¸€ä¸ªä¸ Service åŒåçš„ endpointã€‚è¿™æ ·å°±ä¸éœ€è¦æŒ‡å®š Service ä¸º ExternalName çš„ç±»å‹ï¼ŒCoreDNS ä¸­å°±ä¼šå°†å…¶è§†ä½œä¸€æ¡ A è®°å½•ï¼Œè€Œä¸æ˜¯ä¸€æ¡ CNAME è®°å½•ã€‚Nginx æ‹‰å– DNS ç¼“å­˜æ—¶ä¹Ÿä¸ä¼šæŠŠ IP å½“åšåŸŸåäº†ã€‚</p>\n<pre><code class=\"yaml\">apiVersion: v1\nkind: Service\nmetadata:\n  name: demo2\n  namespace: default\nspec:\n  clusterIP: None\n  ports:\n  - name: grpc\n    port: 32443\n    protocol: TCP\n---\nkind: Endpoints\napiVersion: v1\nmetadata:\n  name: demo2\n  namespace: default\nsubsets:\n  - addresses:\n      - ip: xxx.xxx.xxx.xxx\n    ports:\n      - port: 32443\n        name: grpc\n        protocol: TCP\n</code></pre>\n<h2 id=\"å¯¹æ¯”\"><a href=\"#å¯¹æ¯”\" class=\"headerlink\" title=\"å¯¹æ¯”\"></a>å¯¹æ¯”</h2><p>åœ¨ä¸¤ä¸ªå¯¹ç­‰çš„é›†ç¾¤å‘ç”Ÿé€šä¿¡æ—¶ï¼Œdemo1 ä¿®å¤ï¼Œdemo2ä¸ä¿®å¤ï¼Œå¯¹æ¯”ä¸¤ä¾§çš„ CPU ä½¿ç”¨æƒ…å†µ</p>\n<p>demo1ï¼š<br><img src=\"/asset/ingress-nginx-bug-fix/demo1.png\"></p>\n<p>demo2ï¼š<br><img src=\"/asset/ingress-nginx-bug-fix/demo2.png\"></p>\n<p>demo2 å¤§çº¦æ¯” demo1 æ¶ˆè€— CPU å¤š 0.020 ä¸ªæ ¸ã€‚è™½ç„¶è¿™ä¸ªæŠ¥é”™ä¼šç¨å¾®å¢åŠ ä¸€ç‚¹ CPU çš„ä½¿ç”¨é‡ï¼Œä½†å¹¶ä¸å¤šã€‚</p>\n"},{"title":"[Introduction] Kubernetes CronJob","date":"2021-03-08T00:06:14.000Z","updated":"2021-03-08T00:06:14.000Z","_content":"æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸‹ K8s çš„ CronJobï¼Œè¿˜æœ‰å…¶ä¸­çš„ä¸€äº›å°å‘ã€‚\n\n## æ¦‚å¿µ\nCronjob æ˜¯ K8s å®šæ—¶é€šè¿‡ cronjob controller å®šæ—¶å»åˆ›å»º Job å®ç°çš„ã€‚\nåˆ›å»º Cronjob çš„ä¸€ä¸ªä¾‹å­ï¼š\n```yaml\napiVersion: batch/v1beta1\nkind: CronJob\nmetadata:\n  name: hello\nspec:\n  schedule: \"*/1 * * * *\"\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          containers:\n          - name: hello\n            image: busybox\n            imagePullPolicy: IfNotPresent\n            args:\n            - /bin/sh\n            - -c\n            - date; echo Hello from the Kubernetes cluster\n          restartPolicy: OnFailure\n```\n\n## Cronjob controller å·¥ä½œåŸç†\nstartingDeadlineSeconds æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„å‚æ•°ï¼Œå…¶é…ç½®äº†ä¸€ä¸ªå‘¨æœŸåˆ›å»ºjobæ—¶ï¼Œå¤šé•¿æ—¶é—´ç®—ä½œå¤±è´¥ã€‚\n1. Controller æ¯10ç§’è½®è¯¢ä¸€æ¬¡ cronjob\n2. å¯¹äºæ¯ä¸ª cronjobï¼Œè®¡ç®—ä»ä¸Šæ¬¡è¢«è°ƒåº¦ lastScheduleTime åˆ°ç°åœ¨é”™è¿‡äº†å¤šå°‘æ¬¡è°ƒåº¦ã€‚å¦‚æœå¤§äº100æ¬¡ï¼Œåˆ™å°†å…¶çŠ¶æ€ç½®ä¸º FailedNeedsStart\n3. å¯¹äºå…¶ä»– cronjob è®¡ç®—å½“å‰æ˜¯å¦è¿˜åœ¨å…¶ lastScheduleTime + startingDeadlineSeconds å†…ï¼Œå¦‚æœåœ¨ï¼Œåˆ™è¿›è¡Œè°ƒåº¦ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™å‘é€ä¸€æ¡ event\n\"Missed starting window for {cronjob name}. Missed scheduled time to start a job {scheduledTime}\"\n\n## Tips\n1. æ—¶é—´\nå› ä¸º Cronjob å®é™…ä¸Šæ˜¯é€šè¿‡ controller å»ç®¡ç†çš„ï¼Œæ‰€ä»¥å…¶æ—¶é—´æ˜¯ kube-controller-manager çš„æ—¶é—´ã€‚\n2. å‘½å\nCronjob çš„å‘½åè¦éµå¾ª DNS subdomain nameï¼Œå¹¶ä¸”ä¸èƒ½è¶…è¿‡ 52 ä¸ªå­—ç¬¦ã€‚å› ä¸º Cronjob Controller ä¼šåœ¨å…¶åˆ›å»ºçš„ Job åå†æ‹¼æ¥ 11 ä¸ªå­—ç¬¦ ï¼ˆ K8s å¯¹ Job å‘½åçš„é™åˆ¶æ˜¯ 63 ä¸ªå­—ç¬¦ï¼‰\n3. å¹‚ç­‰æ€§\næ ¹æ®é…ç½®çš„é‡å¯å’Œå¥åº·è§„åˆ™çš„ä¸åŒï¼ŒK8s å¯åŠ¨ Cronjob æ—¶åªèƒ½ä¿è¯ about ä¸€æ¬¡ï¼Œæœ‰æ—¶å¯èƒ½ä¼šå¯åŠ¨å¤šæ¬¡ï¼Œæœ‰æ—¶å¯èƒ½ä¼šæ²¡æœ‰å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦ cronjob ä¿è¯å¹‚ç­‰æ€§ã€‚\nä»¥ä¸‹æ˜¯ cronjob å¯èƒ½ä¼šå‘ç”Ÿçš„ä¸¤ç§å¼‚å¸¸æƒ…å†µï¼š\n  1. è§¦å‘å¤šæ¬¡\nconcurrencyPolicy é…ç½®ä¸º Allowï¼Œå¹¶ä¸” startingDeadlineSeconds ä¸è®¾ç½®æˆ–è€…è®¾ç½®ä¸ºå¾ˆå¤§ã€‚è¿™æ ·ï¼Œcontroller åœ¨å¤šæ¬¡è½®è¯¢ä¸­å¯èƒ½éƒ½ä¼šæŸ¥çœ‹åˆ° cronjob ç¬¦åˆå†æ¬¡è¿è¡Œçš„æ¡ä»¶ï¼Œä»è€Œåˆ›å»ºå¤šä¸ª jobã€‚\n  2. è§¦å‘0æ¬¡\nconcurrencyPolicy é…ç½®ä¸º Forbidï¼Œè¿™æ · controller å°±ä¼šç­‰åˆ°ä¸Šä¸€æ¬¡cronjobç»“æŸä¹‹åæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡è°ƒåº¦ã€‚\n4. è‡ªå®šä¹‰ Crontroller\nä» kubernetes 1.20 å¼€å§‹æ”¯æŒ\n5. åˆ é™¤è¿è¡ŒæˆåŠŸçš„ Job\né…ç½® https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/\n  successfulJobsHistoryLimit: 0\n  failedJobsHistoryLimit: 0\n\n","source":"_posts/k8s-cronjob.md","raw":"---\ntitle: \"[Introduction] Kubernetes CronJob\"\ndate: 2021-03-08 00:06:14\nupdated: 2021-03-08 00:06:14\n---\næœ¬æ–‡ä¸»è¦ä»‹ç»ä¸‹ K8s çš„ CronJobï¼Œè¿˜æœ‰å…¶ä¸­çš„ä¸€äº›å°å‘ã€‚\n\n## æ¦‚å¿µ\nCronjob æ˜¯ K8s å®šæ—¶é€šè¿‡ cronjob controller å®šæ—¶å»åˆ›å»º Job å®ç°çš„ã€‚\nåˆ›å»º Cronjob çš„ä¸€ä¸ªä¾‹å­ï¼š\n```yaml\napiVersion: batch/v1beta1\nkind: CronJob\nmetadata:\n  name: hello\nspec:\n  schedule: \"*/1 * * * *\"\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          containers:\n          - name: hello\n            image: busybox\n            imagePullPolicy: IfNotPresent\n            args:\n            - /bin/sh\n            - -c\n            - date; echo Hello from the Kubernetes cluster\n          restartPolicy: OnFailure\n```\n\n## Cronjob controller å·¥ä½œåŸç†\nstartingDeadlineSeconds æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„å‚æ•°ï¼Œå…¶é…ç½®äº†ä¸€ä¸ªå‘¨æœŸåˆ›å»ºjobæ—¶ï¼Œå¤šé•¿æ—¶é—´ç®—ä½œå¤±è´¥ã€‚\n1. Controller æ¯10ç§’è½®è¯¢ä¸€æ¬¡ cronjob\n2. å¯¹äºæ¯ä¸ª cronjobï¼Œè®¡ç®—ä»ä¸Šæ¬¡è¢«è°ƒåº¦ lastScheduleTime åˆ°ç°åœ¨é”™è¿‡äº†å¤šå°‘æ¬¡è°ƒåº¦ã€‚å¦‚æœå¤§äº100æ¬¡ï¼Œåˆ™å°†å…¶çŠ¶æ€ç½®ä¸º FailedNeedsStart\n3. å¯¹äºå…¶ä»– cronjob è®¡ç®—å½“å‰æ˜¯å¦è¿˜åœ¨å…¶ lastScheduleTime + startingDeadlineSeconds å†…ï¼Œå¦‚æœåœ¨ï¼Œåˆ™è¿›è¡Œè°ƒåº¦ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™å‘é€ä¸€æ¡ event\n\"Missed starting window for {cronjob name}. Missed scheduled time to start a job {scheduledTime}\"\n\n## Tips\n1. æ—¶é—´\nå› ä¸º Cronjob å®é™…ä¸Šæ˜¯é€šè¿‡ controller å»ç®¡ç†çš„ï¼Œæ‰€ä»¥å…¶æ—¶é—´æ˜¯ kube-controller-manager çš„æ—¶é—´ã€‚\n2. å‘½å\nCronjob çš„å‘½åè¦éµå¾ª DNS subdomain nameï¼Œå¹¶ä¸”ä¸èƒ½è¶…è¿‡ 52 ä¸ªå­—ç¬¦ã€‚å› ä¸º Cronjob Controller ä¼šåœ¨å…¶åˆ›å»ºçš„ Job åå†æ‹¼æ¥ 11 ä¸ªå­—ç¬¦ ï¼ˆ K8s å¯¹ Job å‘½åçš„é™åˆ¶æ˜¯ 63 ä¸ªå­—ç¬¦ï¼‰\n3. å¹‚ç­‰æ€§\næ ¹æ®é…ç½®çš„é‡å¯å’Œå¥åº·è§„åˆ™çš„ä¸åŒï¼ŒK8s å¯åŠ¨ Cronjob æ—¶åªèƒ½ä¿è¯ about ä¸€æ¬¡ï¼Œæœ‰æ—¶å¯èƒ½ä¼šå¯åŠ¨å¤šæ¬¡ï¼Œæœ‰æ—¶å¯èƒ½ä¼šæ²¡æœ‰å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦ cronjob ä¿è¯å¹‚ç­‰æ€§ã€‚\nä»¥ä¸‹æ˜¯ cronjob å¯èƒ½ä¼šå‘ç”Ÿçš„ä¸¤ç§å¼‚å¸¸æƒ…å†µï¼š\n  1. è§¦å‘å¤šæ¬¡\nconcurrencyPolicy é…ç½®ä¸º Allowï¼Œå¹¶ä¸” startingDeadlineSeconds ä¸è®¾ç½®æˆ–è€…è®¾ç½®ä¸ºå¾ˆå¤§ã€‚è¿™æ ·ï¼Œcontroller åœ¨å¤šæ¬¡è½®è¯¢ä¸­å¯èƒ½éƒ½ä¼šæŸ¥çœ‹åˆ° cronjob ç¬¦åˆå†æ¬¡è¿è¡Œçš„æ¡ä»¶ï¼Œä»è€Œåˆ›å»ºå¤šä¸ª jobã€‚\n  2. è§¦å‘0æ¬¡\nconcurrencyPolicy é…ç½®ä¸º Forbidï¼Œè¿™æ · controller å°±ä¼šç­‰åˆ°ä¸Šä¸€æ¬¡cronjobç»“æŸä¹‹åæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡è°ƒåº¦ã€‚\n4. è‡ªå®šä¹‰ Crontroller\nä» kubernetes 1.20 å¼€å§‹æ”¯æŒ\n5. åˆ é™¤è¿è¡ŒæˆåŠŸçš„ Job\né…ç½® https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/\n  successfulJobsHistoryLimit: 0\n  failedJobsHistoryLimit: 0\n\n","slug":"k8s-cronjob","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"cl5i8k7y400061rpf8gtl8e4u","content":"<p>æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸‹ K8s çš„ CronJobï¼Œè¿˜æœ‰å…¶ä¸­çš„ä¸€äº›å°å‘ã€‚</p>\n<h2 id=\"æ¦‚å¿µ\"><a href=\"#æ¦‚å¿µ\" class=\"headerlink\" title=\"æ¦‚å¿µ\"></a>æ¦‚å¿µ</h2><p>Cronjob æ˜¯ K8s å®šæ—¶é€šè¿‡ cronjob controller å®šæ—¶å»åˆ›å»º Job å®ç°çš„ã€‚<br>åˆ›å»º Cronjob çš„ä¸€ä¸ªä¾‹å­ï¼š</p>\n<pre><code class=\"yaml\">apiVersion: batch/v1beta1\nkind: CronJob\nmetadata:\n  name: hello\nspec:\n  schedule: &quot;*/1 * * * *&quot;\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          containers:\n          - name: hello\n            image: busybox\n            imagePullPolicy: IfNotPresent\n            args:\n            - /bin/sh\n            - -c\n            - date; echo Hello from the Kubernetes cluster\n          restartPolicy: OnFailure\n</code></pre>\n<h2 id=\"Cronjob-controller-å·¥ä½œåŸç†\"><a href=\"#Cronjob-controller-å·¥ä½œåŸç†\" class=\"headerlink\" title=\"Cronjob controller å·¥ä½œåŸç†\"></a>Cronjob controller å·¥ä½œåŸç†</h2><p>startingDeadlineSeconds æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„å‚æ•°ï¼Œå…¶é…ç½®äº†ä¸€ä¸ªå‘¨æœŸåˆ›å»ºjobæ—¶ï¼Œå¤šé•¿æ—¶é—´ç®—ä½œå¤±è´¥ã€‚</p>\n<ol>\n<li>Controller æ¯10ç§’è½®è¯¢ä¸€æ¬¡ cronjob</li>\n<li>å¯¹äºæ¯ä¸ª cronjobï¼Œè®¡ç®—ä»ä¸Šæ¬¡è¢«è°ƒåº¦ lastScheduleTime åˆ°ç°åœ¨é”™è¿‡äº†å¤šå°‘æ¬¡è°ƒåº¦ã€‚å¦‚æœå¤§äº100æ¬¡ï¼Œåˆ™å°†å…¶çŠ¶æ€ç½®ä¸º FailedNeedsStart</li>\n<li>å¯¹äºå…¶ä»– cronjob è®¡ç®—å½“å‰æ˜¯å¦è¿˜åœ¨å…¶ lastScheduleTime + startingDeadlineSeconds å†…ï¼Œå¦‚æœåœ¨ï¼Œåˆ™è¿›è¡Œè°ƒåº¦ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™å‘é€ä¸€æ¡ event<br>â€œMissed starting window for {cronjob name}. Missed scheduled time to start a job {scheduledTime}â€</li>\n</ol>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><ol>\n<li>æ—¶é—´<br>å› ä¸º Cronjob å®é™…ä¸Šæ˜¯é€šè¿‡ controller å»ç®¡ç†çš„ï¼Œæ‰€ä»¥å…¶æ—¶é—´æ˜¯ kube-controller-manager çš„æ—¶é—´ã€‚</li>\n<li>å‘½å<br>Cronjob çš„å‘½åè¦éµå¾ª DNS subdomain nameï¼Œå¹¶ä¸”ä¸èƒ½è¶…è¿‡ 52 ä¸ªå­—ç¬¦ã€‚å› ä¸º Cronjob Controller ä¼šåœ¨å…¶åˆ›å»ºçš„ Job åå†æ‹¼æ¥ 11 ä¸ªå­—ç¬¦ ï¼ˆ K8s å¯¹ Job å‘½åçš„é™åˆ¶æ˜¯ 63 ä¸ªå­—ç¬¦ï¼‰</li>\n<li>å¹‚ç­‰æ€§<br>æ ¹æ®é…ç½®çš„é‡å¯å’Œå¥åº·è§„åˆ™çš„ä¸åŒï¼ŒK8s å¯åŠ¨ Cronjob æ—¶åªèƒ½ä¿è¯ about ä¸€æ¬¡ï¼Œæœ‰æ—¶å¯èƒ½ä¼šå¯åŠ¨å¤šæ¬¡ï¼Œæœ‰æ—¶å¯èƒ½ä¼šæ²¡æœ‰å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦ cronjob ä¿è¯å¹‚ç­‰æ€§ã€‚<br>ä»¥ä¸‹æ˜¯ cronjob å¯èƒ½ä¼šå‘ç”Ÿçš„ä¸¤ç§å¼‚å¸¸æƒ…å†µï¼š</li>\n<li>è§¦å‘å¤šæ¬¡<br>concurrencyPolicy é…ç½®ä¸º Allowï¼Œå¹¶ä¸” startingDeadlineSeconds ä¸è®¾ç½®æˆ–è€…è®¾ç½®ä¸ºå¾ˆå¤§ã€‚è¿™æ ·ï¼Œcontroller åœ¨å¤šæ¬¡è½®è¯¢ä¸­å¯èƒ½éƒ½ä¼šæŸ¥çœ‹åˆ° cronjob ç¬¦åˆå†æ¬¡è¿è¡Œçš„æ¡ä»¶ï¼Œä»è€Œåˆ›å»ºå¤šä¸ª jobã€‚</li>\n<li>è§¦å‘0æ¬¡<br>concurrencyPolicy é…ç½®ä¸º Forbidï¼Œè¿™æ · controller å°±ä¼šç­‰åˆ°ä¸Šä¸€æ¬¡cronjobç»“æŸä¹‹åæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡è°ƒåº¦ã€‚</li>\n<li>è‡ªå®šä¹‰ Crontroller<br>ä» kubernetes 1.20 å¼€å§‹æ”¯æŒ</li>\n<li>åˆ é™¤è¿è¡ŒæˆåŠŸçš„ Job<br>é…ç½® <a href=\"https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/\">https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/</a><br>successfulJobsHistoryLimit: 0<br>failedJobsHistoryLimit: 0</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸‹ K8s çš„ CronJobï¼Œè¿˜æœ‰å…¶ä¸­çš„ä¸€äº›å°å‘ã€‚</p>\n<h2 id=\"æ¦‚å¿µ\"><a href=\"#æ¦‚å¿µ\" class=\"headerlink\" title=\"æ¦‚å¿µ\"></a>æ¦‚å¿µ</h2><p>Cronjob æ˜¯ K8s å®šæ—¶é€šè¿‡ cronjob controller å®šæ—¶å»åˆ›å»º Job å®ç°çš„ã€‚<br>åˆ›å»º Cronjob çš„ä¸€ä¸ªä¾‹å­ï¼š</p>\n<pre><code class=\"yaml\">apiVersion: batch/v1beta1\nkind: CronJob\nmetadata:\n  name: hello\nspec:\n  schedule: &quot;*/1 * * * *&quot;\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          containers:\n          - name: hello\n            image: busybox\n            imagePullPolicy: IfNotPresent\n            args:\n            - /bin/sh\n            - -c\n            - date; echo Hello from the Kubernetes cluster\n          restartPolicy: OnFailure\n</code></pre>\n<h2 id=\"Cronjob-controller-å·¥ä½œåŸç†\"><a href=\"#Cronjob-controller-å·¥ä½œåŸç†\" class=\"headerlink\" title=\"Cronjob controller å·¥ä½œåŸç†\"></a>Cronjob controller å·¥ä½œåŸç†</h2><p>startingDeadlineSeconds æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„å‚æ•°ï¼Œå…¶é…ç½®äº†ä¸€ä¸ªå‘¨æœŸåˆ›å»ºjobæ—¶ï¼Œå¤šé•¿æ—¶é—´ç®—ä½œå¤±è´¥ã€‚</p>\n<ol>\n<li>Controller æ¯10ç§’è½®è¯¢ä¸€æ¬¡ cronjob</li>\n<li>å¯¹äºæ¯ä¸ª cronjobï¼Œè®¡ç®—ä»ä¸Šæ¬¡è¢«è°ƒåº¦ lastScheduleTime åˆ°ç°åœ¨é”™è¿‡äº†å¤šå°‘æ¬¡è°ƒåº¦ã€‚å¦‚æœå¤§äº100æ¬¡ï¼Œåˆ™å°†å…¶çŠ¶æ€ç½®ä¸º FailedNeedsStart</li>\n<li>å¯¹äºå…¶ä»– cronjob è®¡ç®—å½“å‰æ˜¯å¦è¿˜åœ¨å…¶ lastScheduleTime + startingDeadlineSeconds å†…ï¼Œå¦‚æœåœ¨ï¼Œåˆ™è¿›è¡Œè°ƒåº¦ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™å‘é€ä¸€æ¡ event<br>â€œMissed starting window for {cronjob name}. Missed scheduled time to start a job {scheduledTime}â€</li>\n</ol>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><ol>\n<li>æ—¶é—´<br>å› ä¸º Cronjob å®é™…ä¸Šæ˜¯é€šè¿‡ controller å»ç®¡ç†çš„ï¼Œæ‰€ä»¥å…¶æ—¶é—´æ˜¯ kube-controller-manager çš„æ—¶é—´ã€‚</li>\n<li>å‘½å<br>Cronjob çš„å‘½åè¦éµå¾ª DNS subdomain nameï¼Œå¹¶ä¸”ä¸èƒ½è¶…è¿‡ 52 ä¸ªå­—ç¬¦ã€‚å› ä¸º Cronjob Controller ä¼šåœ¨å…¶åˆ›å»ºçš„ Job åå†æ‹¼æ¥ 11 ä¸ªå­—ç¬¦ ï¼ˆ K8s å¯¹ Job å‘½åçš„é™åˆ¶æ˜¯ 63 ä¸ªå­—ç¬¦ï¼‰</li>\n<li>å¹‚ç­‰æ€§<br>æ ¹æ®é…ç½®çš„é‡å¯å’Œå¥åº·è§„åˆ™çš„ä¸åŒï¼ŒK8s å¯åŠ¨ Cronjob æ—¶åªèƒ½ä¿è¯ about ä¸€æ¬¡ï¼Œæœ‰æ—¶å¯èƒ½ä¼šå¯åŠ¨å¤šæ¬¡ï¼Œæœ‰æ—¶å¯èƒ½ä¼šæ²¡æœ‰å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦ cronjob ä¿è¯å¹‚ç­‰æ€§ã€‚<br>ä»¥ä¸‹æ˜¯ cronjob å¯èƒ½ä¼šå‘ç”Ÿçš„ä¸¤ç§å¼‚å¸¸æƒ…å†µï¼š</li>\n<li>è§¦å‘å¤šæ¬¡<br>concurrencyPolicy é…ç½®ä¸º Allowï¼Œå¹¶ä¸” startingDeadlineSeconds ä¸è®¾ç½®æˆ–è€…è®¾ç½®ä¸ºå¾ˆå¤§ã€‚è¿™æ ·ï¼Œcontroller åœ¨å¤šæ¬¡è½®è¯¢ä¸­å¯èƒ½éƒ½ä¼šæŸ¥çœ‹åˆ° cronjob ç¬¦åˆå†æ¬¡è¿è¡Œçš„æ¡ä»¶ï¼Œä»è€Œåˆ›å»ºå¤šä¸ª jobã€‚</li>\n<li>è§¦å‘0æ¬¡<br>concurrencyPolicy é…ç½®ä¸º Forbidï¼Œè¿™æ · controller å°±ä¼šç­‰åˆ°ä¸Šä¸€æ¬¡cronjobç»“æŸä¹‹åæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡è°ƒåº¦ã€‚</li>\n<li>è‡ªå®šä¹‰ Crontroller<br>ä» kubernetes 1.20 å¼€å§‹æ”¯æŒ</li>\n<li>åˆ é™¤è¿è¡ŒæˆåŠŸçš„ Job<br>é…ç½® <a href=\"https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/\">https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/</a><br>successfulJobsHistoryLimit: 0<br>failedJobsHistoryLimit: 0</li>\n</ol>\n"},{"title":"[Introduction] Kubernetes Ramp Up","date":"2021-03-15T15:39:36.000Z","updated":"2021-03-15T15:39:36.000Z","_content":"## ç›®æ ‡\n- ä»‹ç» K8sï¼ŒDocker æ¦‚å¿µä»¥åŠåŸç†\n- ä» 0 å¼€å§‹éƒ¨ç½²ä¸€ä¸ªç®€å•å®Œæ•´çš„æœåŠ¡\n\n## Dockeræ˜¯ä»€ä¹ˆï¼Ÿ\nDockeræ˜¯ç”±Googleæ¨å‡ºçš„Goè¯­è¨€è¿›è¡Œå¼€å‘å®ç°ï¼ŒåŸºäºLinuxå†…æ ¸çš„ <font color=red>namespace</font>ï¼Œå¯¹<font color=red>è¿›ç¨‹</font>è¿›è¡Œå°è£…<font color=red>éš”ç¦»</font>ï¼Œå±äºæ“ä½œç³»ç»Ÿå±‚é¢çš„å®¹å™¨åŒ–æŠ€æœ¯ã€‚\n\n![](/asset/k8s-ramp-up/1.png)\n\n### ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ\né•œåƒï¼ˆImageï¼‰\n\nå®¹å™¨ï¼ˆContainerï¼‰\n\nä»“åº“ï¼ˆRepositoryï¼‰\n\nä»ä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œé•œåƒå°±åƒä¸€ä¸ªç±»ï¼›å®¹å™¨æ˜¯å¯¹è±¡å®ä¾‹ï¼Œè¿è¡Œæ—¶åœ¨ç³»ç»Ÿä¸­ä¼šæœ‰è®¸å¤šå®¹å™¨ï¼›ä»“åº“ä¸»è¦ç”¨äºå­˜å‚¨å’Œç»´æŠ¤è¿™äº›é•œåƒã€‚\n\n### ä¸ºä»€ä¹ˆä½¿ç”¨ Dockerï¼Ÿ\n- é…ç½®ç¯å¢ƒ\nå¼€å‘è¿‡ç¨‹ä¸­ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯ç¯å¢ƒä¸€è‡´æ€§é—®é¢˜ã€‚ç”±äºå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´ï¼Œå¯¼è‡´æœ‰äº› bug å¹¶æœªåœ¨å¼€å‘è¿‡ç¨‹ä¸­è¢«å‘ç°ã€‚è€Œ Docker çš„é•œåƒæä¾›äº†é™¤å†…æ ¸å¤–å®Œæ•´çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œç¡®ä¿äº†åº”ç”¨è¿è¡Œç¯å¢ƒä¸€è‡´æ€§\n- åº”ç”¨éš”ç¦»\næœºå™¨ä¸Šå¯èƒ½åŒæ—¶è¿è¡Œå¤šä¸ªæœåŠ¡ã€‚å¦‚æœæœåŠ¡ä¹‹é—´æ²¡æœ‰éš”ç¦»ï¼Œä¸€ä¸ªæœåŠ¡å‡ºç°å¼‚å¸¸ï¼Œå¾€å¾€å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœåŠ¡ä¹ŸæŒ‚æ‰ã€‚åŒæ—¶ï¼Œä¸åŒæœåŠ¡æ‰€ä¾èµ–çš„ç¯å¢ƒä¹Ÿå¯èƒ½å‘ç”Ÿå†²çªã€‚\n\n### åŸç†\né¦–å…ˆï¼Œè¦äº†è§£ä¸€ä¸‹è¿›ç¨‹çš„å‘½åç©ºé—´ã€‚Linux ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹æŒ‰ç…§æƒ¯ä¾‹æ˜¯é€šè¿‡PIDæ ‡è¯†çš„ï¼Œè¿™æ„å‘³ç€å†…æ ¸å¿…é¡»ç®¡ç†ä¸€ä¸ªå…¨å±€çš„PIDåˆ—è¡¨ã€‚è€Œä¸”ï¼Œæ‰€æœ‰è°ƒç”¨è€…é€šè¿‡unameç³»ç»Ÿè°ƒç”¨è¿”å›çš„ç³»ç»Ÿç›¸å…³ä¿¡æ¯ï¼ˆåŒ…æ‹¬ç³»ç»Ÿåç§°å’Œæœ‰å…³å†…æ ¸çš„ä¸€äº›ä¿¡æ¯ï¼‰éƒ½æ˜¯ç›¸åŒçš„ã€‚\n\nLinux çš„å‘½åç©ºé—´ä»å†…æ ¸å±‚é¢ä¸Šè¿›è¡Œäº†è™šæ‹ŸåŒ–ï¼Œå¯¹æ‰€æœ‰çš„å…¨å±€èµ„æºè¿›è¡Œä¸€ä¸ªæŠ½è±¡ã€‚æœ¬è´¨ä¸Šï¼Œå»ºç«‹äº†ç³»ç»Ÿçš„ä¸åŒè§†å›¾ã€‚æ¯ä¸€é¡¹å…¨å±€èµ„æºéƒ½å¿…é¡»åŒ…è£…åˆ°å‘½åç©ºé—´çš„æ•°æ®ç»“æ„ä¸­ï¼Œåªæœ‰èµ„æºå’ŒåŒ…å«èµ„æºçš„å‘½åç©ºé—´æ„æˆçš„äºŒå…ƒç»„ä»ç„¶æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚ä¸ä»…ä»…æ˜¯ PIDï¼ŒLinux é€šè¿‡åŒæ ·çš„æ–¹æ³•å¯¹å…¶ä»–èµ„æºä¹Ÿåšäº†è™šæ‹ŸåŒ–å¤„ç†ã€‚å‘½åç©ºé—´å…±æœ‰ä»¥ä¸‹6ç§ï¼š\n\n![](/asset/k8s-ramp-up/2.png)\n\nå€ŸåŠ© Linux çš„å‘½åç©ºé—´ï¼ŒDocker å¯¹è¿›ç¨‹è¿›è¡Œéš”ç¦»ï¼Œå¯ä»¥ä»è¿›ç¨‹æ ‘çš„è§’åº¦ç†è§£ã€‚\n\n![](/asset/k8s-ramp-up/3.png)\n\næ¯æ¬¡åœ¨æ‰§è¡Œ `docker start` æˆ– `docker run` çš„æ—¶å€™ï¼Œå…¶å®æ˜¯ç”± docker çš„ daemon è¿›ç¨‹ docker containerdï¼Œè°ƒç”¨ Linux ç³»ç»Ÿè°ƒç”¨ `clone()` å»åˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚è€Œåˆ›å»ºè¿›ç¨‹çš„è¿‡ç¨‹ä¸­å°±ä¸ºæ–°åˆ›å»ºçš„è¿›ç¨‹åˆ†é…äº†æ–°çš„ Linux å‘½åç©ºé—´ã€‚å¯ä»¥ç®€å•é˜…è¯»ä¸€ä¸‹ docker çš„å¼€æºä»£ç \n\n<pre><code class=\"go\">// https://github.com/moby/moby/blob/49e809fbfe250f3df2deacc0c3e5c403db3b8915/daemon/start.go#L17\n// åˆ›å»ºå®¹å™¨çš„å‡½æ•°ï¼Œå…¶ä¸­åˆè°ƒç”¨äº†è®¾ç½®\nfunc (daemon *Daemon) ContainerStart(name string, hostConfig *containertypes.HostConfig, checkpoint string, checkpointDir string) error\n\n// https://github.com/moby/moby/blob/470ae8422fc6f1845288eb7572253b08f1e6edf8/daemon/oci_linux.go#L212\n// è®¾ç½® Namespace\nfunc setNamespace(s *specs.Spec, ns specs.LinuxNamespace) {\n   for i, n := range s.Linux.Namespaces {\n      if n.Type == ns.Type {\n         s.Linux.Namespaces[i] = ns\n         return\n      }\n   }\n   s.Linux.Namespaces = append(s.Linux.Namespaces, ns)\n}\n\n// https://github.com/moby/moby/blob/49e809fbfe250f3df2deacc0c3e5c403db3b8915/daemon/start.go#L198\n// åˆ›å»ºæ–°çš„è¿›ç¨‹\npid, err := daemon.containerd.Start(context.Background(), \n                                    container.ID, \n                                    checkpointDir,    \n                                    container.StreamConfig.Stdin() != nil | | container.Config.Tty, \n                                    container.InitializeStdio)\n</code></pre>\n\n### å¦‚ä½•å®‰è£…ï¼Ÿ\n[https://docs.docker.com/get-docker/](https://docs.docker.com/get-docker/)\n\n## Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ\nKubernetes æ˜¯ Google äº 2014 å¹´åŸºäºå…¶å†…éƒ¨ Brog ç³»ç»Ÿå¼€æºçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’ç®¡ç†ç³»ç»Ÿï¼Œå¯ä½¿ç”¨å£°æ˜å¼çš„é…ç½®ï¼ˆä»¥ yaml æ–‡ä»¶çš„å½¢å¼ï¼‰è‡ªåŠ¨åœ°æ‰§è¡Œå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†ï¼ŒåŒ…æ‹¬éƒ¨ç½²ã€ä¼¸ç¼©ã€è´Ÿè½½å‡è¡¡ã€å›æ»šç­‰ã€‚\n\nä¸ºä»€ä¹ˆå« K8sï¼Ÿå› ä¸º K<font color=red>ubernete</font>sï¼Œä¸­é—´æ˜¯8ä¸ªå­—æ¯ã€‚\n\nkubernetes æä¾›çš„åŠŸèƒ½ï¼š\n- è‡ªåŠ¨å‘å¸ƒä¸ä¼¸ç¼©ï¼šå¯ä»¥é€šè¿‡å£°æ˜å¼çš„é…ç½®æ–‡ä»¶å®šä¹‰æƒ³è¦éƒ¨ç½²çš„å®¹å™¨\n- æ»šåŠ¨å‡çº§ä¸ç°åº¦å‘å¸ƒï¼šé‡‡ç”¨é€æ­¥æ›¿æ¢çš„ç­–ç•¥å®ç°æ»šåŠ¨å‡çº§\n- æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼šKubernetes é€šè¿‡ DNS åç§°æˆ– IP åœ°å€æš´éœ²å®¹å™¨çš„è®¿é—®æ–¹å¼ï¼Œå¹¶ä¸”å¯åœ¨åŒä¸€å®¹å™¨ç»„å†…å®ç°è´Ÿè½½åˆ†å‘ä¸å‡è¡¡\n- å­˜å‚¨ç¼–æ’ï¼šKubernetes å¯ä»¥è‡ªåŠ¨æŒ‚è½½æŒ‡å®šçš„å­˜å‚¨ç³»ç»Ÿï¼Œå¦‚ local storage/nfs / äº‘å­˜å‚¨ç­‰\n- æ•…éšœæ¢å¤ï¼šKubernetes è‡ªåŠ¨é‡å¯å·²ç»åœæœºçš„å®¹å™¨ï¼Œæ›¿æ¢ä¸æ»¡è¶³å¥åº·æ£€æŸ¥çš„å®¹å™¨\n- å¯†é’¥ä¸é…ç½®ç®¡ç†ï¼šKubernetes å¯ä»¥å­˜å‚¨ä¸ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ Docker Registry çš„ç™»å½•å‡­è¯ï¼Œå¯†ç ï¼Œssh å¯†é’¥ç­‰\n\n### ä¸ºä»€ä¹ˆä½¿ç”¨ K8sï¼Ÿ\nå¤§å‹å•ä½“åº”ç”¨è¢«é€æ¸æ‹†åˆ†æˆå°çš„ã€å¯ç‹¬ç«‹è¿è¡Œçš„ç»„ä»¶ã€‚éšç€éƒ¨ç½²ç»„ä»¶çš„å¢å¤šå’Œæ•°æ®ä¸­å¿ƒçš„å¢é•¿ï¼Œé…ç½®ã€ç®¡ç†å’Œè¿ç»´å˜å¾—å¾ˆå›°éš¾ã€‚(å¾®æœåŠ¡ï¼‰\n\nK8s çš„å®šä¹‰å°±æ˜¯å®¹å™¨ç¼–æ’å’Œç®¡ç†å¼•æ“ï¼Œè§£å†³äº†è¿™äº›é—®é¢˜ã€‚\n\n### å¦‚ä½•å®‰è£…ï¼Ÿ\nç”±éš¾åˆ°æ˜“(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§\n- Kubeadm: https://kubernetes.io/docs/reference/setup-tools/kubeadm/\n- MiniKube: Local kubernetes https://minikube.sigs.k8s.io/docs/start/\n- Kind: Kubernetes in Docker https://github.com/kubernetes-sigs/kind\n- Docker-desktopï¼ˆä»…é™ Macï¼‰: ä¸€é”®å¼€å¯\n![](/asset/k8s-ramp-up/4.png)\n\n\nå…¶ä»–ç‰ˆæœ¬çš„ç±» K8s ç³»ç»Ÿï¼š\n- K3s: https://github.com/k3s-io/k3s\n- K0s: https://github.com/k0sproject/k0s\n\n## Kubernetes æ¶æ„\n\n![](/asset/k8s-ramp-up/5.png)\n\n### master\n\nMaster è´Ÿè´£ç®¡ç†æœåŠ¡æ¥å¯¹æ•´ä¸ªç³»ç»Ÿè¿›è¡Œç®¡ç†ä¸æ§åˆ¶ï¼ŒåŒ…æ‹¬\n- apiserverï¼šä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„å¯¹å¤–æ¥å£ï¼Œæä¾›ä¸€å¥— Restful API ä¾›å®¢æˆ·ç«¯è°ƒç”¨ï¼Œä»»ä½•çš„èµ„æºè¯·æ±‚ / è°ƒç”¨æ“ä½œéƒ½æ˜¯é€šè¿‡ kube-apiserver æä¾›çš„æ¥å£è¿›è¡Œ, å¦‚ kubectlã€kubernetes dashboard ç­‰ç®¡ç†å·¥å…·å°±æ˜¯é€šè¿‡ apiserver æ¥å®ç°å¯¹é›†ç¾¤çš„ç®¡ç†\n- kube-schedulerï¼šèµ„æºè°ƒåº¦å™¨ï¼Œè´Ÿè´£å°†å®¹å™¨ç»„åˆ†é…åˆ°å“ªäº›èŠ‚ç‚¹ä¸Š\n- kube-controller-managerï¼šç®¡ç†æ§åˆ¶å™¨ï¼Œé›†ç¾¤ä¸­å¤„ç†å¸¸è§„ä»»åŠ¡çš„åå°çº¿ç¨‹ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆè´Ÿè´£ç›‘å¬èŠ‚ç‚¹åœæœºçš„äº‹ä»¶å¹¶ä½œå‡ºå¯¹åº”å“åº”ï¼‰ã€endpoint-controllerï¼ˆåˆ·æ–°æœåŠ¡ä¸å®¹å™¨ç»„çš„å…³è”ä¿¡æ¯ï¼‰ã€replication-controllerï¼ˆç»´æŠ¤å®¹å™¨ç»„çš„å‰¯æœ¬æ•°ä¸ºæŒ‡å®šçš„æ•°å€¼ï¼‰ã€Service Account & Token æ§åˆ¶å™¨ï¼ˆè´Ÿè´£ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤çš„ Service Account ä»¥åŠ API Access Tokenï¼‰\n- etcdï¼šæ•°æ®å­˜å‚¨ï¼Œå­˜å‚¨é›†ç¾¤æ‰€æœ‰çš„é…ç½®ä¿¡æ¯\n- corednsï¼šå®ç°é›†ç¾¤å†…éƒ¨é€šè¿‡æœåŠ¡åç§°è¿›è¡Œå®¹å™¨ç»„è®¿é—®çš„åŠŸèƒ½\n\n### worker\n\nWorker è´Ÿè½½æ‰§è¡Œ Master åˆ†é…çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬\n- kubeletï¼šæ˜¯å·¥ä½œèŠ‚ç‚¹ä¸Šæ‰§è¡Œæ“ä½œçš„ä»£ç†ç¨‹åºï¼Œè´Ÿè´£å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå®šæœŸæ‰§è¡Œå®¹å™¨å¥åº·æ£€æŸ¥ï¼Œå¹¶ä¸ŠæŠ¥å®¹å™¨çš„è¿è¡ŒçŠ¶æ€\n- kube-proxyï¼šæ˜¯ä¸€ä¸ªå…·æœ‰è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„ç®€å•çš„ç½‘ç»œè®¿é—®ä»£ç†ï¼Œè´Ÿè´£å°†è®¿é—®æŸä¸ªæœåŠ¡çš„è¯·æ±‚åˆ†é…åˆ°å·¥ä½œèŠ‚ç‚¹çš„å…·ä½“æŸä¸ªå®¹å™¨ä¸Šï¼ˆkube-proxy ä¹Ÿè¿è¡Œäº master node ä¸Šï¼‰\n- Docker Daemonï¼šKubernetes å…¶å®ä¸å±€é™äº Dockerï¼ˆå³å°†å–æ¶ˆï¼‰ï¼Œå®ƒæ”¯æŒä»»ä½•å®ç°äº† Kubernetes å®¹å™¨å¼•æ“æ¥å£çš„å®¹å™¨å¼•æ“ï¼Œå¦‚ containerdã€rktlet\n\n### ç½‘ç»œé€šä¿¡\nç½‘ç»œé€šä¿¡ç»„ä»¶åªéœ€è¦ç¬¦åˆ CNI ï¼ˆContainer Network Interfaceï¼‰æ¥å£è§„èŒƒï¼Œä¸»è¦ä½œç”¨åœ¨äºç»™å„ä¸ªå®¹å™¨åˆ†é…é›†ç¾¤å†… IPï¼Œä½¿å¾—å…¶å†…ç½‘ IP èƒ½å¤Ÿé›†ç¾¤å†…å”¯ä¸€ï¼Œå¹¶ä¸”å¯ä»¥äº’ç›¸è®¿é—®ï¼Œç›®å‰å¸¸ç”¨çš„æœ‰ Flannelï¼ŒCalicoç­‰ç½‘ç»œç»„ä»¶ã€‚\n\nç®€å•ä»‹ç»ä¸‹æ¯”è¾ƒå¸¸ç”¨çš„ Flannel çš„åŸç†ã€‚Flannel è¿è¡Œåœ¨ç¬¬3å±‚ç½‘ç»œå±‚ï¼ŒåŸºäº IPv4ï¼Œåˆ›å»ºä¸€ä¸ªå¤§å‹å†…éƒ¨ç½‘ç»œï¼Œè·¨è¶Šé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹ç»„æˆä¸€ä¸ªå­ç½‘ï¼Œæ¯ä¸ªå®¹å™¨åœ¨å†…ç½‘ä¸­æœ‰å”¯ä¸€çš„IPã€‚\n\né¦–å…ˆï¼ŒFlannel ä¼šä¸ºæ¯å°èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªå­ç½‘æ®µã€‚Flanneld åœ¨ Docker å®¹å™¨å¯åŠ¨æ—¶ä¿®æ”¹å…¶å¯åŠ¨å‚æ•°ï¼Œå°†å…¶ IP é™åˆ¶åœ¨å½“å‰çš„å­ç½‘æ®µå†…ï¼Œå…·ä½“ IP çš„åˆ†é…ä»æ˜¯ç”± docker è¿›è¡Œã€‚Flannelé€šè¿‡EtcdæœåŠ¡ç»´æŠ¤äº†ä¸€å¼ èŠ‚ç‚¹é—´çš„è·¯ç”±è¡¨ï¼Œè¯¦ç»†è®°å½•äº†å„èŠ‚ç‚¹å­ç½‘ç½‘æ®µï¼Œä¿è¯ä¸åŒèŠ‚ç‚¹çš„å­ç½‘ç½‘æ®µä¸ä¼šé‡å¤ã€‚\n\næ•°æ®ä»æºå®¹å™¨ä¸­å‘å‡ºåï¼Œç»ç”±æ‰€åœ¨ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡è½¬å‘åˆ°flannel0è™šæ‹Ÿç½‘å¡ï¼ŒflanneldæœåŠ¡ç›‘å¬åœ¨ç½‘å¡çš„å¦å¤–ä¸€ç«¯ã€‚\n\næºä¸»æœºçš„flanneldæœåŠ¡å°†åŸæœ¬çš„æ•°æ®å†…å®¹UDPå°è£…åæ ¹æ®è‡ªå·±çš„è·¯ç”±è¡¨æŠ•é€’ç»™ç›®çš„èŠ‚ç‚¹çš„flanneldæœåŠ¡ï¼Œæ•°æ®åˆ°è¾¾ä»¥åè¢«è§£åŒ…ï¼Œç„¶åç›´æ¥è¿›å…¥ç›®çš„èŠ‚ç‚¹çš„flannel0è™šæ‹Ÿç½‘å¡ï¼Œç„¶åè¢«è½¬å‘åˆ°ç›®çš„ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡ï¼Œæœ€åå°±åƒæœ¬æœºå®¹å™¨é€šä¿¡ä¸€ä¸‹çš„æœ‰docker0è·¯ç”±åˆ°è¾¾ç›®æ ‡å®¹å™¨ã€‚\n\n![](/asset/k8s-ramp-up/6.png)\n\n## å¿«é€Ÿä¸Šæ‰‹ K8s æ¦‚å¿µ\n\nä¸€äº›æ¨èçš„ K8s æ¦‚å¿µä»‹ç»ï¼š\n- å¾®è½¯çš„ 50å¤© K8s æ•™ç¨‹ä¸­ï¼ˆhttps://azure.microsoft.com/en-us/resources/kubernetes-learning-path/ï¼‰é€šè¿‡åŠ¨ç‰©å›­çš„å½¢å¼ä»‹ç»äº†ä¸€äº› K8s æ¦‚å¿µ http://aka.ms/k8s/LearnwithPhippy\n- ç»¼è¿°PPTï¼šhttps://www2.slideshare.net/BobKillen/kubernetes-a-comprehensive-overview-updated?from_action=save\n\nK8s ä¸­çš„æ¦‚å¿µæå¤šï¼Œæ¯”è¾ƒé›¶ç¢ï¼Œè¿™é‡Œé€šè¿‡ä¸€ä¸ªç®€å•çš„å°ä¾‹å­ï¼Œå°½å¯èƒ½è¦†ç›–å¤šçš„ K8s æ¦‚å¿µã€‚\n\n## æ¦‚è§ˆ\n\nä¾‹å­ä½¿ç”¨ä¸€ä¸ªå¼€æºçš„ fortune-teller é•œåƒï¼ˆ`quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1`ï¼‰ ï¼Œæ¯æ¬¡è¯·æ±‚å®¹å™¨å†…çš„æœåŠ¡ï¼ŒæœåŠ¡ä¼šè¿”å›ä¸€å¥åè¨€ã€‚å¸Œæœ›åœ¨ MacOS çš„ç¯å¢ƒä¸‹ï¼Œå±•ç¤ºä¸€ä¸ªåº”ç”¨åœ¨ K8s ä¸­è¿è¡Œçš„å…¨æµç¨‹ã€‚\n\nå‡†å¤‡ç¯å¢ƒ\nä¸ºäº†ä¸å½±å“å¤§å®¶æœ¬åœ°çš„ç¯å¢ƒï¼Œè¿™é‡Œä½¿ç”¨ Kind åˆ›å»ºå‡ºä¸€ä¸ªç‹¬ç«‹çš„ K8s é›†ç¾¤ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç‰ˆæœ¬å¹¶ä¸”å¯ä»¥åœ¨å®Œæˆå¿«é€Ÿæ¸…ç†æ‰ã€‚(Docker åŒé‡éš”ç¦»ï¼‰\n\n1. å®‰è£… Kind ä»¥åŠ gRpc æµ‹è¯•å·¥å…·\n```bash\nbrew install kind\nbrew install grpcurl\n```\n\n2. æ‹‰å–é•œåƒ\n```bash\ndocker pull kindest/node:v1.16.15\ndocker pull quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n```\n\n3. åˆ›å»º K8s é›†ç¾¤ï¼Œå› ä¸º Kind æ˜¯åœ¨ Docker å®¹å™¨é‡Œé¢åˆ›å»ºçš„ K8sï¼Œæ‰€ä»¥å®¿ä¸»æœºè®¿é—®ï¼Œéœ€è¦æŠŠç«¯å£æš´éœ²å‡ºæ¥ã€‚Kind ä¼šé»˜è®¤æŠŠ K8s apiserver çš„ç«¯å£æš´éœ²å‡ºæ¥ï¼Œç”¨æ¥ç»™ kubectl å‘½ä»¤ä½¿ç”¨ã€‚ä½†ä¸ºäº†ä¹‹åçš„æµ‹è¯•ï¼Œæˆ‘ä»¬æå‰æŠŠå‡ ä¸ªç«¯å£åœ¨åˆ›å»ºçš„æ—¶å€™å°±æš´éœ²å‡ºæ¥ã€‚\n\nKind åŒæ ·æ”¯æŒé€šè¿‡yaml çš„å½¢å¼åˆ›å»ºé›†ç¾¤\n```yaml\nkind: Cluster\napiVersion: kind.x-k8s.io/v1alpha4\nnodes:\n- role: control-plane\n  extraPortMappings:\n  - containerPort: 32080\n    hostPort: 32080\n  - containerPort: 32443\n    hostPort: 32443\n```\n\n```bash\nkind create cluster --name=fortune-teller --image=kindest/node:v1.16.15 --config kind-config.yaml\n```\n\n### è¿è¡Œ Docker ç‰ˆæœ¬\n1. å¯åŠ¨å®¹å™¨\n```bash\ndocker run -p 50051:50051 quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n```\n\n`-p` å°†å®¹å™¨å†…çš„ 50051 ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„ 50051 ç«¯å£\n\n2. æµ‹è¯•åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œç¬¬ä¸€æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦ç»™ grpcurl å¼€å¯æƒé™\n```bash\ngrpcurl -plaintext 127.0.0.1:50051 build.stack.fortune.FortuneTeller/Predict\n```\n\nåº”ç”¨åœ¨æ”¶åˆ°è¯·æ±‚ä»¥åï¼Œä¼šè¿”å›ä¸€å¥åè¨€\n\n![](/asset/k8s-ramp-up/7.png)\n\n### å°†åº”ç”¨ä» Docker è¿ç§»åˆ° K8s ä¸­\n\nä¸ Docker ä¸­å®¹å™¨æ¦‚å¿µç›¸å¯¹åº”çš„ï¼ŒK8s ä¸­ä¹Ÿæœ‰ç€å®¹å™¨çš„æ¦‚å¿µã€‚å¯¹äºè™šæ‹ŸåŒ–çš„å®¹å™¨æ¥è¯´ï¼Œæœ€ä½³å®è·µæ˜¯ä¸€ä¸ªå®¹å™¨ä¸€ä¸ªåº”ç”¨ï¼Œä½†å½“ä¸€ä¸ªæœåŠ¡éœ€è¦å¤šä¸ªåº”ç”¨ç»„åˆå®Œæˆæ—¶ï¼Œç®€å•çš„å°†å¤šä¸ªåº”ç”¨éƒ¨ç½²åˆ°ä¸€ä¸ªå®¹å™¨å†…ï¼Œå°±ç ´åäº†åº”ç”¨ä¹‹é—´çš„éš”ç¦»æ€§ï¼Œæ‰€ä»¥ K8s å¯¹äºå®¹å™¨è¿›è¡Œäº†ä¸€å±‚å°è£…ï¼Œå½¢æˆäº† Pod çš„æ¦‚å¿µã€‚\n\n#### Pod\n\nPod æ˜¯ Kubernetes åˆ›å»ºæˆ–éƒ¨ç½²çš„æœ€å°åŸºæœ¬å•å…ƒã€‚ä¸€ä¸ª Pod å°è£…ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨å®¹å™¨ã€å­˜å‚¨èµ„æºã€ä¸€ä¸ªç‹¬ç«‹çš„ç½‘ç»œ IP ä»¥åŠç®¡ç†æ§åˆ¶å®¹å™¨è¿è¡Œæ–¹å¼çš„ç­–ç•¥é€‰é¡¹ã€‚Pod ä¸­çš„æ¯ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼ˆåŒ…æ‹¬ IP ä¸ç«¯å£ï¼‰ï¼ŒPod å†…çš„å®¹å™¨å¯ä»¥ä½¿ç”¨ localhost ç›¸äº’é€šä¿¡ã€‚Pod å¯ä»¥æŒ‡å®šä¸€ç»„å…±äº«å­˜å‚¨å· Volumesï¼ŒPod ä¸­æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥è®¿é—®å…±äº«çš„ Volumesã€‚ \n\né€šè¿‡ Podï¼Œç”¨æˆ·å°±å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ§åˆ¶å®¹å™¨ä¹‹é—´çš„éš”ç¦»æ€§ã€‚\n\næœ‰äº† Pod ä½œä¸ºåŸºç¡€ä»¥åï¼ŒK8s å°±è¦å®ç°å®ƒæœ€é‡è¦çš„åŠŸèƒ½ï¼Œå¯¹å®¹å™¨çš„ç¼–æ’ç®¡ç†ã€‚å½“æœåŠ¡éœ€è¦æ‰©å®¹æ—¶ï¼ŒK8s éœ€è¦èƒ½å¤Ÿå¿«é€Ÿå¤åˆ¶ Podï¼Œå½“ Pod æŒ‚æ‰äº†ï¼ŒK8s éœ€è¦èƒ½å¤Ÿè‡ªåŠ¨é‡å¯ã€‚æ‰€ä»¥ K8s ç”±æ­¤è¡ç”Ÿå‡ºäº† ReplicaSet çš„æ¦‚å¿µã€‚\n\n#### ReplicaSet\n\nReplicaSet ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰æŒ‰é…ç½®çš„ Pod å‰¯æœ¬æ•°åœ¨è¿è¡Œï¼Œé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨çš„æ–¹å¼å¯¹ Pod è¿›è¡Œç­›é€‰å’Œç®¡ç†ã€‚åœ¨æ—§çš„ç‰ˆæœ¬ä¸­è¿˜æœ‰ä¸€ä¸ª ReplicaController çš„æ¦‚å¿µï¼ŒRC ä¸ RS ä¸¤è€…åŠŸèƒ½å®Œå…¨ç›¸åŒï¼ŒåŒºåˆ«ä»…ä»…åœ¨äº RS å¯¹äº Pod çš„æ ‡ç­¾é€‰æ‹©å™¨æ›´åŠ å¼ºå¤§ã€‚\n\nå¼€å¤´æåˆ°äº† K8s ä½¿ç”¨å£°æ˜å¼çš„é…ç½®è‡ªåŠ¨å»ç®¡ç†å®¹å™¨ï¼Œè€Œ ReplicaSet çš„å†…å®¹å´å¤ªè¿‡å…·ä½“ï¼Œæ¶‰åŠåˆ°äº† Pod çš„å…·ä½“ç»´æŠ¤ç»†èŠ‚ã€‚æ‰€ä»¥ K8s åœ¨ ReplicaSet ä¹‹ä¸Šåˆè¡ç”Ÿå‡ºå£°æ˜å¼é…ç½®å®¹å™¨çš„æ¦‚å¿µï¼ŒDeploymentã€‚\n\n#### Deployment\n\nDeployment ä¸º Pod ä¸ ReplicaSet æä¾›äº†å£°æ˜å¼çš„å®šä¹‰ï¼Œæè¿°ä½ æƒ³è¦çš„ç›®æ ‡çŠ¶æ€æ˜¯ä»€ä¹ˆï¼ŒDeployment controller å°±ä¼šå¸®ä½ å°† Pod ä¸ ReplicaSet çš„å®é™…çŠ¶æ€æ”¹å˜åˆ°ä½ æƒ³è¦çš„ç›®æ ‡çŠ¶æ€ã€‚\n\nä»¥ fortune-teller ä¸ºä¾‹å­ï¼Œå¯ä»¥ç¼–å†™ä¸€ä»½ä¸‹é¢è¿™æ ·çš„ Deployment é…ç½®æ–‡ä»¶\n```yaml\napiVersion: apps/v1 # k8s apiç‰ˆæœ¬\nkind: Deployment # èµ„æºç±»å‹\nmetadata:\n  name: fortune-teller-app # deployment åå­—\n  namespace: default\nspec:\n  replicas: 1 # Pod å‰¯æœ¬æ•°é‡\n  selector:\n    matchLabels:\n      k8s-app: fortune-teller-app # ç®¡ç†æ ‡ç­¾ä¸­åŒ…å« k8s-app: fortune-teller-app çš„ Pod\n  template: # Pod æ¨¡æ¿\n    metadata:\n      labels:\n        k8s-app: fortune-teller-app # Pod æ ‡ç­¾\n    spec: # Pod é…ç½®\n      containers:\n      - image: quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n        imagePullPolicy: IfNotPresent\n        name: fortune-teller-app\n        ports:\n        - containerPort: 50051\n          name: grpc\n          protocol: TCP\n```\n\nå°†ä¸Šé¢çš„å†…å®¹ä¿å­˜åˆ°ä¸€ä»½ yaml æ–‡ä»¶ä¸­ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè®© K8s æ‰§è¡Œ yaml\n```bash\nkubectl apply -f deployment.yaml\n```\n\né€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°åˆšåˆšåˆ›å»ºçš„ deployment\n```bash\nkubectl get deployement\n```\n\n![](/asset/k8s-ramp-up/8.png)\n\næ­¤æ—¶ï¼ŒK8s å·²ç»è‡ªåŠ¨æ ¹æ® deployment ä¸­é…ç½®çš„ Pod æ¨¡æ¿å’Œé…ç½®ï¼Œåˆ›å»ºäº† Podã€‚é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ° K8s è‡ªåŠ¨åˆ›å»ºçš„ Pod\n```bash\nkubectl get pods\n```\n![](/asset/k8s-ramp-up/9.png)\n\nå› ä¸º K8s é‡‡ç”¨å£°æ˜å¼çš„é…ç½®å»ç®¡ç† Podï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åŠ¨æ€åœ°å»ä¿®æ”¹ deployment çš„é…ç½®ï¼ŒK8s ä¼šè‡ªåŠ¨æ ¹æ®æ–°çš„é…ç½®å»ç®¡ç† Podã€‚\n```bash\nkubectl edit deployment fortune-teller-app\n```\n\næˆ‘ä»¬æŠŠé…ç½®æ–‡ä»¶ä¸­çš„å‰¯æœ¬æ•°é‡ä¿®æ”¹ä¸º 2\n\n![](/asset/k8s-ramp-up/10.png)\n\nä¿å­˜é€€å‡ºåï¼Œæˆ‘ä»¬å†æ¬¡æ‰§è¡Œ kubectl get pods ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ° K8s æ ¹æ®æ–°çš„é…ç½®ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Pod\n\n![](/asset/k8s-ramp-up/11.png)\n\nç°åœ¨æˆ‘ä»¬å°±æœ‰äº†ä¸¤ä¸ª fortune-teller çš„æœåŠ¡ã€‚åœ¨çœŸå®ç¯å¢ƒä¸­ï¼ŒPod çš„è°ƒåº¦ç”± K8s è¿›è¡Œç®¡ç†ï¼ŒæŸä¸ªæ—¶åˆ»æœåŠ¡å¯èƒ½åœ¨ Node1 ä¸Šï¼Œè€Œå¦ä¸€æ—¶åˆ»æœåŠ¡å¯èƒ½å°±è¢«è°ƒåº¦åˆ°äº† Node2 ä¸Šã€‚æ‰€ä»¥ï¼Œè®¿é—®å…·ä½“ Pod æ˜¯ä¸€ç§ä¸ç¨³å®šçš„æœåŠ¡è®¿é—®æ–¹æ³•ï¼Œè€Œä¸”ç›®å‰å¤§å¤šæ•°çš„åç«¯æœåŠ¡éƒ½æ˜¯æ— çŠ¶æ€çš„æœåŠ¡ï¼Œç›´æ¥è®¿é—® Pod ä¹Ÿå¯¼è‡´ä¸èƒ½è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚æ‰€ä»¥ï¼ŒK8s åœ¨æ­¤åŸºç¡€ä¸Šè¡ç”Ÿå‡º Service çš„æ¦‚å¿µã€‚\n\n#### Service\n\nService å¯ä»¥çœ‹åšä¸€ç»„æä¾›ç›¸åŒæœåŠ¡çš„ Pod çš„å¯¹å¤–è®¿é—®æ¥å£ã€‚Kubernetes æä¾›ä¸‰ç§ç±»å‹çš„ Serviceï¼š\n- NodePortï¼š é›†ç¾¤å¤–éƒ¨å¯ä»¥é€šè¿‡ Node IP ä¸ Node Port æ¥è®¿é—®å…·ä½“æŸä¸ª Podï¼Œæ¯å°æœºå™¨ä¸Šéƒ½ä¼šæš´éœ²åŒæ ·çš„ç«¯å£\n- ClusterIPï¼šæŒ‡é€šè¿‡é›†ç¾¤çš„å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼ŒæœåŠ¡åªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨å¯ä»¥è®¿é—®ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤çš„ ServiceType\n- ExternalNameï¼šä¸æŒ‡å‘ Podï¼ŒæŒ‡å‘å¤–éƒ¨æœåŠ¡\nService å’Œ Deployment æ˜¯ä¸€å¯¹æ¯”è¾ƒå®¹æ˜“æ··æ·†çš„æ¦‚å¿µï¼Œä¸¤è€…éƒ½æ˜¯å¯¹ä¸€ç»„ Pod è¿›è¡Œç®¡ç†ï¼Œä½†å®ƒä»¬ä¸¤è€…ä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨ä¸‹é¢è¿™å¼ å›¾æ¥æ¦‚æ‹¬\n\n![](/asset/k8s-ramp-up/12.png)\n\nService æ˜¯é¢å‘æœåŠ¡è°ƒç”¨è€…ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨è®¿é—® K8sã€‚è€Œ Deployment æ˜¯é¢å‘ K8s åº•å±‚å¼•æ“çš„ï¼Œé¢å‘å†…éƒ¨ç®¡ç†è€…ã€‚\n\nService çš„é…ç½®æ–‡ä»¶æ ¼å¼ä¸ Deployment å¾ˆç±»ä¼¼\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: fortune-teller-service\n  namespace: default\nspec:\n  ports:\n  - name: grpc\n    port: 50051\n    protocol: TCP\n    targetPort: 50051\n  selector:\n    k8s-app: fortune-teller-app\n  type: ClusterIP\n```\n\nåŒæ ·çš„ï¼Œæˆ‘ä»¬é€šè¿‡ kubectl apply -f service.yaml å‘½ä»¤ï¼Œå¯ä»¥åˆ›å»º Serviceã€‚é€šè¿‡ kubectl get service å¯ä»¥æŸ¥çœ‹åˆ°åˆšåˆšåˆ›å»ºçš„ Serviceã€‚\n\n![](/asset/k8s-ramp-up/13.png)\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç™»é™†åˆ°ä¸€ä¸ª Pod é‡Œå»æµ‹è¯•ä¸€ä¸‹æ˜¯å¦å¯ä»¥è®¿é—®æœåŠ¡ã€‚\nNetshoot é•œåƒä¸­åŒ…å«äº†ä¸€äº›ç½‘ç»œæµ‹è¯•çš„å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¿›å…¥ä¸€ä¸ª netshoot å®¹å™¨å†…æµ‹è¯•ã€‚é‡‡ç”¨ deployment çš„æ–¹å¼åˆ›å»º Pod\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: netshoot\n  namespace: default\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      k8s-app: netshoot\n  template:\n    metadata:\n      labels:\n        k8s-app: netshoot\n    spec:\n      containers:\n      - args:\n        - 1000d\n        command:\n        - /bin/sleep\n        image: nicolaka/netshoot\n        name: netshoot\n```\n\nä¸ Docker çš„å‘½ä»¤ç±»ä¼¼ï¼Œä½¿ç”¨å‘½ä»¤ `kubectl cp grpcurl_1.6.0_linux_x86_64.tar.gz <pod name>:/` å¤åˆ¶å·¥å…·åˆ°å®¹å™¨å†…ã€‚\n\nå¤åˆ¶æˆåŠŸåï¼Œä½¿ç”¨å‘½ä»¤ kubectl exec -it <pod name> bash å¯ä»¥è¿›å…¥åˆ°å®¹å™¨å†…ã€‚\n\nè§£å‹\n```bash\ncd /\ntar -zxf grpcurl_1.6.0_linux_x86_64.tar.gz\n```\n\nç„¶åæˆ‘ä»¬å¯ä»¥æµ‹è¯•æ˜¯å¦å¯ä»¥ä» K8s é›†ç¾¤å†…è®¿é—® Serviceã€‚å¯¹äº K8s é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ï¼ŒK8s æœ‰è‡ªå·±çš„ DNS ç»„ä»¶ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡æœåŠ¡åè®¿é—®ã€‚\n```bash\n./grpcurl -plaintext fortune-teller-service:50051 build.stack.fortune.FortuneTeller/Predict\n```\n\n![](/asset/k8s-ramp-up/14.png)\n\néªŒè¯æœåŠ¡å¯ä»¥ä»é›†ç¾¤å†…è®¿é—®ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦è§£å†³å¦‚ä½•ä»é›†ç¾¤å¤–è®¿é—®æœåŠ¡çš„é—®é¢˜ï¼Œæ¯•ç«Ÿå¤§å¤šæ•°æœåŠ¡æ˜¯é¢å‘ K8s é›†ç¾¤å¤–çš„ç”¨æˆ·çš„ã€‚å…¶å®ç›®å‰æˆ‘ä»¬å·²ç»äº†è§£äº†ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯ä½¿ç”¨ Nodeport ç±»å‹çš„ Serviceã€‚ä½†é‡‡ç”¨è¿™ç§æ–¹æ³•æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š\n1. æ¯ä¸ªç«¯å£åªèƒ½æ˜¯ä¸€ç§æœåŠ¡\n2. ç«¯å£èŒƒå›´åªèƒ½æ˜¯ 30000-32767\n3. å¦‚æœèŠ‚ç‚¹ çš„ IP åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œè°ƒç”¨æ–¹éœ€è¦èƒ½å¤Ÿå¯Ÿè§‰ã€‚\næ‰€ä»¥ï¼ŒK8s ä¸ºæœåŠ¡çš„å¤–éƒ¨è®¿é—®è·¯ç”±æä¾›äº†æ–°çš„ç±»å‹ Ingressã€‚\n\n#### Ingress\nIngress å…¶å®æ˜¯ä¸€ç§ç±»ä¼¼äºè·¯ç”±è¡¨ä¸€æ ·çš„é…ç½®ï¼Œå®é™…çš„è·¯ç”±å·¥ä½œéœ€è¦ Ingress Controller æ‰§è¡Œã€‚K8s æœ¬èº«å¹¶æ²¡æœ‰æä¾› Ingress Controllerï¼Œç›®å‰å¸¸ç”¨çš„æ˜¯é€šè¿‡ Nginx å®ç°çš„ç‰ˆæœ¬ https://github.com/kubernetes/ingress-nginx ã€‚å¯ä»¥ä½¿ç”¨ä¸Šé¢å‹ç¼©åŒ…ä¸­çš„ ingress-controller.yaml å®‰è£…\n\n![](/asset/k8s-ramp-up/15.png)\n\nIngree nginx controller é€šè¿‡å®¿ä¸»æœºæš´éœ²ç»™å¤–éƒ¨è®¿é—®çš„ç«¯å£æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹ yamlï¼Œæ”¹æˆæˆ‘ä»¬åœ¨ä¸€å¼€å§‹åˆ›å»ºé›†ç¾¤æ—¶æ˜ å°„çš„ç«¯å£ã€‚\n\né€šè¿‡ `kubectl get svc -n ingress-nginx` æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼Œæš´éœ²çš„æ˜¯ä¸¤ä¸ªéšæœºåˆ†é…çš„ç«¯å£\n\n![](/asset/k8s-ramp-up/16.png)\n\næˆ‘ä»¬æ‰‹åŠ¨å°†å…¶æ”¹æˆ 32080 å’Œ 32443ã€‚\n\n![](/asset/k8s-ramp-up/17.png)\n\nIngress nginx controller åŒæ ·æ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨çš„æ–¹å¼ç®¡ç† Ingressã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Ingressï¼Œå°†å‘å¾€ Host fortune.bytedance.com çš„è¯·æ±‚è·¯ç”±åˆ° Service fortune-teller-serviceã€‚\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/backend-protocol: GRPC\n  name: fortune-ingress\n  namespace: default\nspec:\n  rules:\n  - host: fortune.bytedance.com\n    http:\n      paths:\n      - backend:\n          serviceName: fortune-teller-service\n          servicePort: grpc\n```\n\nå®‰è£… Ingress\n```bash\nkubectl apply -f ingress.yaml\nkubectl get ingress\n```\n\n![](/asset/k8s-ramp-up/18.png)\n\nIngress nginx controller å¯¹äº gRpc é»˜è®¤åªæ”¯æŒ SSL çš„å½¢å¼ï¼Œè€ŒFedlearner ä¸­çš„ controller åšäº†ä¸€äº›å®šåˆ¶åŒ–æ“ä½œï¼Œä½¿å¾—é€šè¿‡ 80 ç«¯å£ï¼Œåªä½¿ç”¨ HTTP2 ä¹Ÿå¯ä»¥è½¬å‘ gRpcã€‚è¯¦æƒ…å¯ä»¥å‚è€ƒ https://github.com/bytedance/ingress-nginx/pull/2/files\n\nä½¿ç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ä»å¤–éƒ¨è®¿é—®æœåŠ¡\n```bash\ngrpcurl -insecure -servername 'fortune.bytedance.com' 0.0.0.0:32443 build.stack.fortune.FortuneTeller/Predict\n```\n\n![](/asset/k8s-ramp-up/19.png)\n\nåˆšæ‰ä¹Ÿæåˆ°äº†ï¼ŒgRpc é€šå¸¸æ˜¯ä½¿ç”¨ SSL è¿›è¡ŒåŠ å¯†çš„ï¼ŒSSL çš„å…³é”®åœ¨äºå…¬é’¥ï¼Œç§é’¥ä»¥åŠè¯ä¹¦çš„éªŒè¯ã€‚é€šè¿‡æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼ç¡®å®å¯ä»¥å¤„ç†è¯ä¹¦çš„é—®é¢˜ï¼Œä½† K8s æŠ½è±¡å‡º Secret è¿™ç§èµ„æºï¼Œå¤§å¤§æé«˜äº†å¯¹è¿™ç±»æ–‡ä»¶çš„ç®¡ç†å’Œå¤ç”¨èƒ½åŠ›ã€‚\n\n#### Secret\n\nSecret è§£å†³äº†å¯†ç ã€tokenã€å¯†é’¥ç­‰æ•æ„Ÿæ•°æ®çš„å­˜å‚¨é—®é¢˜ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š\n- Service Account ï¼šç”¨æ¥è®¿é—® Kubernetes APIï¼Œç”± Kubernetes è‡ªåŠ¨åˆ›å»ºï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„ / run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­\n- Opaque ï¼šBase64 ç¼–ç æ ¼å¼çš„ Secretï¼Œç”¨æ¥å­˜å‚¨å¯†ç ã€å¯†é’¥ç­‰\n- kubernetes.io/dockerconfigjson ï¼šç”¨æ¥å­˜å‚¨ docker registry çš„è®¤è¯ä¿¡æ¯\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥åˆ›å»ºä¸€ä¸ª Opaque ç±»å‹çš„ Secretï¼Œä½¿å¾— ingress nginx controller æ”¯æŒæœåŠ¡ç«¯çš„ SSLã€‚\nç”±äºç¯‡å¹…æœ‰é™ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹è¯ä¹¦ç›¸å…³çš„æ¦‚å¿µï¼š\n- CAï¼šè¯ä¹¦æˆæƒä¸­å¿ƒ(certificate authority)ï¼Œç”¨æ¥ç­¾å‘ç§é’¥ï¼Œå¹¶éªŒè¯å…¬é’¥ï¼Œç§é’¥çš„åˆæ³•æ€§\n- ç§é’¥ï¼Œå…¬é’¥ï¼šç§é’¥ç”¨äºåŠ å¯†ï¼Œå…¬é’¥ç”¨äºè§£å¯†\n\nSecret æ”¯æŒä¸ç¼–å†™ yamlï¼Œç›´æ¥ä»æ–‡ä»¶ä¸­åˆ›å»º Secret\n```bash\nkubectl create secret generic fortune-teller-ssl-verify \\\n  --from-file=ca.crt=CA.pem \\\n  --from-file=tls.crt=server-public.pem \\\n  --from-file=tls.key=server-private.key\n```\n\nä¿®æ”¹ Ingressï¼Œä½¿å…¶ä½¿ç”¨æ–°åˆ›å»ºçš„ Secret æä¾›æœåŠ¡ä¾§çš„ SSLã€‚\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/backend-protocol: GRPC\n  name: fortune-ingress\n  namespace: default\nspec:\n  rules:\n  - host: fortune.test.com\n    http:\n      paths:\n      - backend:\n          serviceName: fortune-teller-service\n          servicePort: grpc\n  tls:\n  - hosts:\n    - fortune.test.com\n    secretName: fortune-teller-ssl-verify\n```\n\nå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯è‡ªç­¾åçš„è¯ä¹¦ï¼Œä¸è¢«å…¬å…±çš„ CA æ‰€ä¿¡ä»»ï¼Œæ‰€ä»¥åœ¨å‘é€è¯·æ±‚æ˜¯éœ€è¦æ‰‹åŠ¨æŒ‡å®šè‡ªå·±æ‰€ä¿¡ä»»çš„ CAã€‚\n\n```bash\ngrpcurl -cacert CA.pem \\\n  -servername 'fortune.test.com' \\\n  127.0.0.1:32443 \\\n  build.stack.fortune.FortuneTeller/Predict\n```\n\n![](/asset/k8s-ramp-up/20.png)\n\n## å‚è€ƒ\n- https://draveness.me/docker/\n- https://www.yuque.com/kshare/2020/fe3b6f86-3b9b-48da-9770-897d838cbf41?language=zh-cn#Namespace\n- https://network.51cto.com/art/201907/598970.htm\n- https://blog.csdn.net/gatieme/article/details/51383322\n\n","source":"_posts/k8s-ramp-up.md","raw":"---\ntitle: \"[Introduction] Kubernetes Ramp Up\"\ndate: 2021-03-15 15:39:36\nupdated: 2021-03-15 15:39:36\n---\n## ç›®æ ‡\n- ä»‹ç» K8sï¼ŒDocker æ¦‚å¿µä»¥åŠåŸç†\n- ä» 0 å¼€å§‹éƒ¨ç½²ä¸€ä¸ªç®€å•å®Œæ•´çš„æœåŠ¡\n\n## Dockeræ˜¯ä»€ä¹ˆï¼Ÿ\nDockeræ˜¯ç”±Googleæ¨å‡ºçš„Goè¯­è¨€è¿›è¡Œå¼€å‘å®ç°ï¼ŒåŸºäºLinuxå†…æ ¸çš„ <font color=red>namespace</font>ï¼Œå¯¹<font color=red>è¿›ç¨‹</font>è¿›è¡Œå°è£…<font color=red>éš”ç¦»</font>ï¼Œå±äºæ“ä½œç³»ç»Ÿå±‚é¢çš„å®¹å™¨åŒ–æŠ€æœ¯ã€‚\n\n![](/asset/k8s-ramp-up/1.png)\n\n### ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ\né•œåƒï¼ˆImageï¼‰\n\nå®¹å™¨ï¼ˆContainerï¼‰\n\nä»“åº“ï¼ˆRepositoryï¼‰\n\nä»ä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œé•œåƒå°±åƒä¸€ä¸ªç±»ï¼›å®¹å™¨æ˜¯å¯¹è±¡å®ä¾‹ï¼Œè¿è¡Œæ—¶åœ¨ç³»ç»Ÿä¸­ä¼šæœ‰è®¸å¤šå®¹å™¨ï¼›ä»“åº“ä¸»è¦ç”¨äºå­˜å‚¨å’Œç»´æŠ¤è¿™äº›é•œåƒã€‚\n\n### ä¸ºä»€ä¹ˆä½¿ç”¨ Dockerï¼Ÿ\n- é…ç½®ç¯å¢ƒ\nå¼€å‘è¿‡ç¨‹ä¸­ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯ç¯å¢ƒä¸€è‡´æ€§é—®é¢˜ã€‚ç”±äºå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´ï¼Œå¯¼è‡´æœ‰äº› bug å¹¶æœªåœ¨å¼€å‘è¿‡ç¨‹ä¸­è¢«å‘ç°ã€‚è€Œ Docker çš„é•œåƒæä¾›äº†é™¤å†…æ ¸å¤–å®Œæ•´çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œç¡®ä¿äº†åº”ç”¨è¿è¡Œç¯å¢ƒä¸€è‡´æ€§\n- åº”ç”¨éš”ç¦»\næœºå™¨ä¸Šå¯èƒ½åŒæ—¶è¿è¡Œå¤šä¸ªæœåŠ¡ã€‚å¦‚æœæœåŠ¡ä¹‹é—´æ²¡æœ‰éš”ç¦»ï¼Œä¸€ä¸ªæœåŠ¡å‡ºç°å¼‚å¸¸ï¼Œå¾€å¾€å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœåŠ¡ä¹ŸæŒ‚æ‰ã€‚åŒæ—¶ï¼Œä¸åŒæœåŠ¡æ‰€ä¾èµ–çš„ç¯å¢ƒä¹Ÿå¯èƒ½å‘ç”Ÿå†²çªã€‚\n\n### åŸç†\né¦–å…ˆï¼Œè¦äº†è§£ä¸€ä¸‹è¿›ç¨‹çš„å‘½åç©ºé—´ã€‚Linux ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹æŒ‰ç…§æƒ¯ä¾‹æ˜¯é€šè¿‡PIDæ ‡è¯†çš„ï¼Œè¿™æ„å‘³ç€å†…æ ¸å¿…é¡»ç®¡ç†ä¸€ä¸ªå…¨å±€çš„PIDåˆ—è¡¨ã€‚è€Œä¸”ï¼Œæ‰€æœ‰è°ƒç”¨è€…é€šè¿‡unameç³»ç»Ÿè°ƒç”¨è¿”å›çš„ç³»ç»Ÿç›¸å…³ä¿¡æ¯ï¼ˆåŒ…æ‹¬ç³»ç»Ÿåç§°å’Œæœ‰å…³å†…æ ¸çš„ä¸€äº›ä¿¡æ¯ï¼‰éƒ½æ˜¯ç›¸åŒçš„ã€‚\n\nLinux çš„å‘½åç©ºé—´ä»å†…æ ¸å±‚é¢ä¸Šè¿›è¡Œäº†è™šæ‹ŸåŒ–ï¼Œå¯¹æ‰€æœ‰çš„å…¨å±€èµ„æºè¿›è¡Œä¸€ä¸ªæŠ½è±¡ã€‚æœ¬è´¨ä¸Šï¼Œå»ºç«‹äº†ç³»ç»Ÿçš„ä¸åŒè§†å›¾ã€‚æ¯ä¸€é¡¹å…¨å±€èµ„æºéƒ½å¿…é¡»åŒ…è£…åˆ°å‘½åç©ºé—´çš„æ•°æ®ç»“æ„ä¸­ï¼Œåªæœ‰èµ„æºå’ŒåŒ…å«èµ„æºçš„å‘½åç©ºé—´æ„æˆçš„äºŒå…ƒç»„ä»ç„¶æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚ä¸ä»…ä»…æ˜¯ PIDï¼ŒLinux é€šè¿‡åŒæ ·çš„æ–¹æ³•å¯¹å…¶ä»–èµ„æºä¹Ÿåšäº†è™šæ‹ŸåŒ–å¤„ç†ã€‚å‘½åç©ºé—´å…±æœ‰ä»¥ä¸‹6ç§ï¼š\n\n![](/asset/k8s-ramp-up/2.png)\n\nå€ŸåŠ© Linux çš„å‘½åç©ºé—´ï¼ŒDocker å¯¹è¿›ç¨‹è¿›è¡Œéš”ç¦»ï¼Œå¯ä»¥ä»è¿›ç¨‹æ ‘çš„è§’åº¦ç†è§£ã€‚\n\n![](/asset/k8s-ramp-up/3.png)\n\næ¯æ¬¡åœ¨æ‰§è¡Œ `docker start` æˆ– `docker run` çš„æ—¶å€™ï¼Œå…¶å®æ˜¯ç”± docker çš„ daemon è¿›ç¨‹ docker containerdï¼Œè°ƒç”¨ Linux ç³»ç»Ÿè°ƒç”¨ `clone()` å»åˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚è€Œåˆ›å»ºè¿›ç¨‹çš„è¿‡ç¨‹ä¸­å°±ä¸ºæ–°åˆ›å»ºçš„è¿›ç¨‹åˆ†é…äº†æ–°çš„ Linux å‘½åç©ºé—´ã€‚å¯ä»¥ç®€å•é˜…è¯»ä¸€ä¸‹ docker çš„å¼€æºä»£ç \n\n<pre><code class=\"go\">// https://github.com/moby/moby/blob/49e809fbfe250f3df2deacc0c3e5c403db3b8915/daemon/start.go#L17\n// åˆ›å»ºå®¹å™¨çš„å‡½æ•°ï¼Œå…¶ä¸­åˆè°ƒç”¨äº†è®¾ç½®\nfunc (daemon *Daemon) ContainerStart(name string, hostConfig *containertypes.HostConfig, checkpoint string, checkpointDir string) error\n\n// https://github.com/moby/moby/blob/470ae8422fc6f1845288eb7572253b08f1e6edf8/daemon/oci_linux.go#L212\n// è®¾ç½® Namespace\nfunc setNamespace(s *specs.Spec, ns specs.LinuxNamespace) {\n   for i, n := range s.Linux.Namespaces {\n      if n.Type == ns.Type {\n         s.Linux.Namespaces[i] = ns\n         return\n      }\n   }\n   s.Linux.Namespaces = append(s.Linux.Namespaces, ns)\n}\n\n// https://github.com/moby/moby/blob/49e809fbfe250f3df2deacc0c3e5c403db3b8915/daemon/start.go#L198\n// åˆ›å»ºæ–°çš„è¿›ç¨‹\npid, err := daemon.containerd.Start(context.Background(), \n                                    container.ID, \n                                    checkpointDir,    \n                                    container.StreamConfig.Stdin() != nil | | container.Config.Tty, \n                                    container.InitializeStdio)\n</code></pre>\n\n### å¦‚ä½•å®‰è£…ï¼Ÿ\n[https://docs.docker.com/get-docker/](https://docs.docker.com/get-docker/)\n\n## Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ\nKubernetes æ˜¯ Google äº 2014 å¹´åŸºäºå…¶å†…éƒ¨ Brog ç³»ç»Ÿå¼€æºçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’ç®¡ç†ç³»ç»Ÿï¼Œå¯ä½¿ç”¨å£°æ˜å¼çš„é…ç½®ï¼ˆä»¥ yaml æ–‡ä»¶çš„å½¢å¼ï¼‰è‡ªåŠ¨åœ°æ‰§è¡Œå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†ï¼ŒåŒ…æ‹¬éƒ¨ç½²ã€ä¼¸ç¼©ã€è´Ÿè½½å‡è¡¡ã€å›æ»šç­‰ã€‚\n\nä¸ºä»€ä¹ˆå« K8sï¼Ÿå› ä¸º K<font color=red>ubernete</font>sï¼Œä¸­é—´æ˜¯8ä¸ªå­—æ¯ã€‚\n\nkubernetes æä¾›çš„åŠŸèƒ½ï¼š\n- è‡ªåŠ¨å‘å¸ƒä¸ä¼¸ç¼©ï¼šå¯ä»¥é€šè¿‡å£°æ˜å¼çš„é…ç½®æ–‡ä»¶å®šä¹‰æƒ³è¦éƒ¨ç½²çš„å®¹å™¨\n- æ»šåŠ¨å‡çº§ä¸ç°åº¦å‘å¸ƒï¼šé‡‡ç”¨é€æ­¥æ›¿æ¢çš„ç­–ç•¥å®ç°æ»šåŠ¨å‡çº§\n- æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼šKubernetes é€šè¿‡ DNS åç§°æˆ– IP åœ°å€æš´éœ²å®¹å™¨çš„è®¿é—®æ–¹å¼ï¼Œå¹¶ä¸”å¯åœ¨åŒä¸€å®¹å™¨ç»„å†…å®ç°è´Ÿè½½åˆ†å‘ä¸å‡è¡¡\n- å­˜å‚¨ç¼–æ’ï¼šKubernetes å¯ä»¥è‡ªåŠ¨æŒ‚è½½æŒ‡å®šçš„å­˜å‚¨ç³»ç»Ÿï¼Œå¦‚ local storage/nfs / äº‘å­˜å‚¨ç­‰\n- æ•…éšœæ¢å¤ï¼šKubernetes è‡ªåŠ¨é‡å¯å·²ç»åœæœºçš„å®¹å™¨ï¼Œæ›¿æ¢ä¸æ»¡è¶³å¥åº·æ£€æŸ¥çš„å®¹å™¨\n- å¯†é’¥ä¸é…ç½®ç®¡ç†ï¼šKubernetes å¯ä»¥å­˜å‚¨ä¸ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ Docker Registry çš„ç™»å½•å‡­è¯ï¼Œå¯†ç ï¼Œssh å¯†é’¥ç­‰\n\n### ä¸ºä»€ä¹ˆä½¿ç”¨ K8sï¼Ÿ\nå¤§å‹å•ä½“åº”ç”¨è¢«é€æ¸æ‹†åˆ†æˆå°çš„ã€å¯ç‹¬ç«‹è¿è¡Œçš„ç»„ä»¶ã€‚éšç€éƒ¨ç½²ç»„ä»¶çš„å¢å¤šå’Œæ•°æ®ä¸­å¿ƒçš„å¢é•¿ï¼Œé…ç½®ã€ç®¡ç†å’Œè¿ç»´å˜å¾—å¾ˆå›°éš¾ã€‚(å¾®æœåŠ¡ï¼‰\n\nK8s çš„å®šä¹‰å°±æ˜¯å®¹å™¨ç¼–æ’å’Œç®¡ç†å¼•æ“ï¼Œè§£å†³äº†è¿™äº›é—®é¢˜ã€‚\n\n### å¦‚ä½•å®‰è£…ï¼Ÿ\nç”±éš¾åˆ°æ˜“(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§\n- Kubeadm: https://kubernetes.io/docs/reference/setup-tools/kubeadm/\n- MiniKube: Local kubernetes https://minikube.sigs.k8s.io/docs/start/\n- Kind: Kubernetes in Docker https://github.com/kubernetes-sigs/kind\n- Docker-desktopï¼ˆä»…é™ Macï¼‰: ä¸€é”®å¼€å¯\n![](/asset/k8s-ramp-up/4.png)\n\n\nå…¶ä»–ç‰ˆæœ¬çš„ç±» K8s ç³»ç»Ÿï¼š\n- K3s: https://github.com/k3s-io/k3s\n- K0s: https://github.com/k0sproject/k0s\n\n## Kubernetes æ¶æ„\n\n![](/asset/k8s-ramp-up/5.png)\n\n### master\n\nMaster è´Ÿè´£ç®¡ç†æœåŠ¡æ¥å¯¹æ•´ä¸ªç³»ç»Ÿè¿›è¡Œç®¡ç†ä¸æ§åˆ¶ï¼ŒåŒ…æ‹¬\n- apiserverï¼šä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„å¯¹å¤–æ¥å£ï¼Œæä¾›ä¸€å¥— Restful API ä¾›å®¢æˆ·ç«¯è°ƒç”¨ï¼Œä»»ä½•çš„èµ„æºè¯·æ±‚ / è°ƒç”¨æ“ä½œéƒ½æ˜¯é€šè¿‡ kube-apiserver æä¾›çš„æ¥å£è¿›è¡Œ, å¦‚ kubectlã€kubernetes dashboard ç­‰ç®¡ç†å·¥å…·å°±æ˜¯é€šè¿‡ apiserver æ¥å®ç°å¯¹é›†ç¾¤çš„ç®¡ç†\n- kube-schedulerï¼šèµ„æºè°ƒåº¦å™¨ï¼Œè´Ÿè´£å°†å®¹å™¨ç»„åˆ†é…åˆ°å“ªäº›èŠ‚ç‚¹ä¸Š\n- kube-controller-managerï¼šç®¡ç†æ§åˆ¶å™¨ï¼Œé›†ç¾¤ä¸­å¤„ç†å¸¸è§„ä»»åŠ¡çš„åå°çº¿ç¨‹ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆè´Ÿè´£ç›‘å¬èŠ‚ç‚¹åœæœºçš„äº‹ä»¶å¹¶ä½œå‡ºå¯¹åº”å“åº”ï¼‰ã€endpoint-controllerï¼ˆåˆ·æ–°æœåŠ¡ä¸å®¹å™¨ç»„çš„å…³è”ä¿¡æ¯ï¼‰ã€replication-controllerï¼ˆç»´æŠ¤å®¹å™¨ç»„çš„å‰¯æœ¬æ•°ä¸ºæŒ‡å®šçš„æ•°å€¼ï¼‰ã€Service Account & Token æ§åˆ¶å™¨ï¼ˆè´Ÿè´£ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤çš„ Service Account ä»¥åŠ API Access Tokenï¼‰\n- etcdï¼šæ•°æ®å­˜å‚¨ï¼Œå­˜å‚¨é›†ç¾¤æ‰€æœ‰çš„é…ç½®ä¿¡æ¯\n- corednsï¼šå®ç°é›†ç¾¤å†…éƒ¨é€šè¿‡æœåŠ¡åç§°è¿›è¡Œå®¹å™¨ç»„è®¿é—®çš„åŠŸèƒ½\n\n### worker\n\nWorker è´Ÿè½½æ‰§è¡Œ Master åˆ†é…çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬\n- kubeletï¼šæ˜¯å·¥ä½œèŠ‚ç‚¹ä¸Šæ‰§è¡Œæ“ä½œçš„ä»£ç†ç¨‹åºï¼Œè´Ÿè´£å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå®šæœŸæ‰§è¡Œå®¹å™¨å¥åº·æ£€æŸ¥ï¼Œå¹¶ä¸ŠæŠ¥å®¹å™¨çš„è¿è¡ŒçŠ¶æ€\n- kube-proxyï¼šæ˜¯ä¸€ä¸ªå…·æœ‰è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„ç®€å•çš„ç½‘ç»œè®¿é—®ä»£ç†ï¼Œè´Ÿè´£å°†è®¿é—®æŸä¸ªæœåŠ¡çš„è¯·æ±‚åˆ†é…åˆ°å·¥ä½œèŠ‚ç‚¹çš„å…·ä½“æŸä¸ªå®¹å™¨ä¸Šï¼ˆkube-proxy ä¹Ÿè¿è¡Œäº master node ä¸Šï¼‰\n- Docker Daemonï¼šKubernetes å…¶å®ä¸å±€é™äº Dockerï¼ˆå³å°†å–æ¶ˆï¼‰ï¼Œå®ƒæ”¯æŒä»»ä½•å®ç°äº† Kubernetes å®¹å™¨å¼•æ“æ¥å£çš„å®¹å™¨å¼•æ“ï¼Œå¦‚ containerdã€rktlet\n\n### ç½‘ç»œé€šä¿¡\nç½‘ç»œé€šä¿¡ç»„ä»¶åªéœ€è¦ç¬¦åˆ CNI ï¼ˆContainer Network Interfaceï¼‰æ¥å£è§„èŒƒï¼Œä¸»è¦ä½œç”¨åœ¨äºç»™å„ä¸ªå®¹å™¨åˆ†é…é›†ç¾¤å†… IPï¼Œä½¿å¾—å…¶å†…ç½‘ IP èƒ½å¤Ÿé›†ç¾¤å†…å”¯ä¸€ï¼Œå¹¶ä¸”å¯ä»¥äº’ç›¸è®¿é—®ï¼Œç›®å‰å¸¸ç”¨çš„æœ‰ Flannelï¼ŒCalicoç­‰ç½‘ç»œç»„ä»¶ã€‚\n\nç®€å•ä»‹ç»ä¸‹æ¯”è¾ƒå¸¸ç”¨çš„ Flannel çš„åŸç†ã€‚Flannel è¿è¡Œåœ¨ç¬¬3å±‚ç½‘ç»œå±‚ï¼ŒåŸºäº IPv4ï¼Œåˆ›å»ºä¸€ä¸ªå¤§å‹å†…éƒ¨ç½‘ç»œï¼Œè·¨è¶Šé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹ç»„æˆä¸€ä¸ªå­ç½‘ï¼Œæ¯ä¸ªå®¹å™¨åœ¨å†…ç½‘ä¸­æœ‰å”¯ä¸€çš„IPã€‚\n\né¦–å…ˆï¼ŒFlannel ä¼šä¸ºæ¯å°èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªå­ç½‘æ®µã€‚Flanneld åœ¨ Docker å®¹å™¨å¯åŠ¨æ—¶ä¿®æ”¹å…¶å¯åŠ¨å‚æ•°ï¼Œå°†å…¶ IP é™åˆ¶åœ¨å½“å‰çš„å­ç½‘æ®µå†…ï¼Œå…·ä½“ IP çš„åˆ†é…ä»æ˜¯ç”± docker è¿›è¡Œã€‚Flannelé€šè¿‡EtcdæœåŠ¡ç»´æŠ¤äº†ä¸€å¼ èŠ‚ç‚¹é—´çš„è·¯ç”±è¡¨ï¼Œè¯¦ç»†è®°å½•äº†å„èŠ‚ç‚¹å­ç½‘ç½‘æ®µï¼Œä¿è¯ä¸åŒèŠ‚ç‚¹çš„å­ç½‘ç½‘æ®µä¸ä¼šé‡å¤ã€‚\n\næ•°æ®ä»æºå®¹å™¨ä¸­å‘å‡ºåï¼Œç»ç”±æ‰€åœ¨ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡è½¬å‘åˆ°flannel0è™šæ‹Ÿç½‘å¡ï¼ŒflanneldæœåŠ¡ç›‘å¬åœ¨ç½‘å¡çš„å¦å¤–ä¸€ç«¯ã€‚\n\næºä¸»æœºçš„flanneldæœåŠ¡å°†åŸæœ¬çš„æ•°æ®å†…å®¹UDPå°è£…åæ ¹æ®è‡ªå·±çš„è·¯ç”±è¡¨æŠ•é€’ç»™ç›®çš„èŠ‚ç‚¹çš„flanneldæœåŠ¡ï¼Œæ•°æ®åˆ°è¾¾ä»¥åè¢«è§£åŒ…ï¼Œç„¶åç›´æ¥è¿›å…¥ç›®çš„èŠ‚ç‚¹çš„flannel0è™šæ‹Ÿç½‘å¡ï¼Œç„¶åè¢«è½¬å‘åˆ°ç›®çš„ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡ï¼Œæœ€åå°±åƒæœ¬æœºå®¹å™¨é€šä¿¡ä¸€ä¸‹çš„æœ‰docker0è·¯ç”±åˆ°è¾¾ç›®æ ‡å®¹å™¨ã€‚\n\n![](/asset/k8s-ramp-up/6.png)\n\n## å¿«é€Ÿä¸Šæ‰‹ K8s æ¦‚å¿µ\n\nä¸€äº›æ¨èçš„ K8s æ¦‚å¿µä»‹ç»ï¼š\n- å¾®è½¯çš„ 50å¤© K8s æ•™ç¨‹ä¸­ï¼ˆhttps://azure.microsoft.com/en-us/resources/kubernetes-learning-path/ï¼‰é€šè¿‡åŠ¨ç‰©å›­çš„å½¢å¼ä»‹ç»äº†ä¸€äº› K8s æ¦‚å¿µ http://aka.ms/k8s/LearnwithPhippy\n- ç»¼è¿°PPTï¼šhttps://www2.slideshare.net/BobKillen/kubernetes-a-comprehensive-overview-updated?from_action=save\n\nK8s ä¸­çš„æ¦‚å¿µæå¤šï¼Œæ¯”è¾ƒé›¶ç¢ï¼Œè¿™é‡Œé€šè¿‡ä¸€ä¸ªç®€å•çš„å°ä¾‹å­ï¼Œå°½å¯èƒ½è¦†ç›–å¤šçš„ K8s æ¦‚å¿µã€‚\n\n## æ¦‚è§ˆ\n\nä¾‹å­ä½¿ç”¨ä¸€ä¸ªå¼€æºçš„ fortune-teller é•œåƒï¼ˆ`quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1`ï¼‰ ï¼Œæ¯æ¬¡è¯·æ±‚å®¹å™¨å†…çš„æœåŠ¡ï¼ŒæœåŠ¡ä¼šè¿”å›ä¸€å¥åè¨€ã€‚å¸Œæœ›åœ¨ MacOS çš„ç¯å¢ƒä¸‹ï¼Œå±•ç¤ºä¸€ä¸ªåº”ç”¨åœ¨ K8s ä¸­è¿è¡Œçš„å…¨æµç¨‹ã€‚\n\nå‡†å¤‡ç¯å¢ƒ\nä¸ºäº†ä¸å½±å“å¤§å®¶æœ¬åœ°çš„ç¯å¢ƒï¼Œè¿™é‡Œä½¿ç”¨ Kind åˆ›å»ºå‡ºä¸€ä¸ªç‹¬ç«‹çš„ K8s é›†ç¾¤ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç‰ˆæœ¬å¹¶ä¸”å¯ä»¥åœ¨å®Œæˆå¿«é€Ÿæ¸…ç†æ‰ã€‚(Docker åŒé‡éš”ç¦»ï¼‰\n\n1. å®‰è£… Kind ä»¥åŠ gRpc æµ‹è¯•å·¥å…·\n```bash\nbrew install kind\nbrew install grpcurl\n```\n\n2. æ‹‰å–é•œåƒ\n```bash\ndocker pull kindest/node:v1.16.15\ndocker pull quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n```\n\n3. åˆ›å»º K8s é›†ç¾¤ï¼Œå› ä¸º Kind æ˜¯åœ¨ Docker å®¹å™¨é‡Œé¢åˆ›å»ºçš„ K8sï¼Œæ‰€ä»¥å®¿ä¸»æœºè®¿é—®ï¼Œéœ€è¦æŠŠç«¯å£æš´éœ²å‡ºæ¥ã€‚Kind ä¼šé»˜è®¤æŠŠ K8s apiserver çš„ç«¯å£æš´éœ²å‡ºæ¥ï¼Œç”¨æ¥ç»™ kubectl å‘½ä»¤ä½¿ç”¨ã€‚ä½†ä¸ºäº†ä¹‹åçš„æµ‹è¯•ï¼Œæˆ‘ä»¬æå‰æŠŠå‡ ä¸ªç«¯å£åœ¨åˆ›å»ºçš„æ—¶å€™å°±æš´éœ²å‡ºæ¥ã€‚\n\nKind åŒæ ·æ”¯æŒé€šè¿‡yaml çš„å½¢å¼åˆ›å»ºé›†ç¾¤\n```yaml\nkind: Cluster\napiVersion: kind.x-k8s.io/v1alpha4\nnodes:\n- role: control-plane\n  extraPortMappings:\n  - containerPort: 32080\n    hostPort: 32080\n  - containerPort: 32443\n    hostPort: 32443\n```\n\n```bash\nkind create cluster --name=fortune-teller --image=kindest/node:v1.16.15 --config kind-config.yaml\n```\n\n### è¿è¡Œ Docker ç‰ˆæœ¬\n1. å¯åŠ¨å®¹å™¨\n```bash\ndocker run -p 50051:50051 quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n```\n\n`-p` å°†å®¹å™¨å†…çš„ 50051 ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„ 50051 ç«¯å£\n\n2. æµ‹è¯•åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œç¬¬ä¸€æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦ç»™ grpcurl å¼€å¯æƒé™\n```bash\ngrpcurl -plaintext 127.0.0.1:50051 build.stack.fortune.FortuneTeller/Predict\n```\n\nåº”ç”¨åœ¨æ”¶åˆ°è¯·æ±‚ä»¥åï¼Œä¼šè¿”å›ä¸€å¥åè¨€\n\n![](/asset/k8s-ramp-up/7.png)\n\n### å°†åº”ç”¨ä» Docker è¿ç§»åˆ° K8s ä¸­\n\nä¸ Docker ä¸­å®¹å™¨æ¦‚å¿µç›¸å¯¹åº”çš„ï¼ŒK8s ä¸­ä¹Ÿæœ‰ç€å®¹å™¨çš„æ¦‚å¿µã€‚å¯¹äºè™šæ‹ŸåŒ–çš„å®¹å™¨æ¥è¯´ï¼Œæœ€ä½³å®è·µæ˜¯ä¸€ä¸ªå®¹å™¨ä¸€ä¸ªåº”ç”¨ï¼Œä½†å½“ä¸€ä¸ªæœåŠ¡éœ€è¦å¤šä¸ªåº”ç”¨ç»„åˆå®Œæˆæ—¶ï¼Œç®€å•çš„å°†å¤šä¸ªåº”ç”¨éƒ¨ç½²åˆ°ä¸€ä¸ªå®¹å™¨å†…ï¼Œå°±ç ´åäº†åº”ç”¨ä¹‹é—´çš„éš”ç¦»æ€§ï¼Œæ‰€ä»¥ K8s å¯¹äºå®¹å™¨è¿›è¡Œäº†ä¸€å±‚å°è£…ï¼Œå½¢æˆäº† Pod çš„æ¦‚å¿µã€‚\n\n#### Pod\n\nPod æ˜¯ Kubernetes åˆ›å»ºæˆ–éƒ¨ç½²çš„æœ€å°åŸºæœ¬å•å…ƒã€‚ä¸€ä¸ª Pod å°è£…ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨å®¹å™¨ã€å­˜å‚¨èµ„æºã€ä¸€ä¸ªç‹¬ç«‹çš„ç½‘ç»œ IP ä»¥åŠç®¡ç†æ§åˆ¶å®¹å™¨è¿è¡Œæ–¹å¼çš„ç­–ç•¥é€‰é¡¹ã€‚Pod ä¸­çš„æ¯ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼ˆåŒ…æ‹¬ IP ä¸ç«¯å£ï¼‰ï¼ŒPod å†…çš„å®¹å™¨å¯ä»¥ä½¿ç”¨ localhost ç›¸äº’é€šä¿¡ã€‚Pod å¯ä»¥æŒ‡å®šä¸€ç»„å…±äº«å­˜å‚¨å· Volumesï¼ŒPod ä¸­æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥è®¿é—®å…±äº«çš„ Volumesã€‚ \n\né€šè¿‡ Podï¼Œç”¨æˆ·å°±å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ§åˆ¶å®¹å™¨ä¹‹é—´çš„éš”ç¦»æ€§ã€‚\n\næœ‰äº† Pod ä½œä¸ºåŸºç¡€ä»¥åï¼ŒK8s å°±è¦å®ç°å®ƒæœ€é‡è¦çš„åŠŸèƒ½ï¼Œå¯¹å®¹å™¨çš„ç¼–æ’ç®¡ç†ã€‚å½“æœåŠ¡éœ€è¦æ‰©å®¹æ—¶ï¼ŒK8s éœ€è¦èƒ½å¤Ÿå¿«é€Ÿå¤åˆ¶ Podï¼Œå½“ Pod æŒ‚æ‰äº†ï¼ŒK8s éœ€è¦èƒ½å¤Ÿè‡ªåŠ¨é‡å¯ã€‚æ‰€ä»¥ K8s ç”±æ­¤è¡ç”Ÿå‡ºäº† ReplicaSet çš„æ¦‚å¿µã€‚\n\n#### ReplicaSet\n\nReplicaSet ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰æŒ‰é…ç½®çš„ Pod å‰¯æœ¬æ•°åœ¨è¿è¡Œï¼Œé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨çš„æ–¹å¼å¯¹ Pod è¿›è¡Œç­›é€‰å’Œç®¡ç†ã€‚åœ¨æ—§çš„ç‰ˆæœ¬ä¸­è¿˜æœ‰ä¸€ä¸ª ReplicaController çš„æ¦‚å¿µï¼ŒRC ä¸ RS ä¸¤è€…åŠŸèƒ½å®Œå…¨ç›¸åŒï¼ŒåŒºåˆ«ä»…ä»…åœ¨äº RS å¯¹äº Pod çš„æ ‡ç­¾é€‰æ‹©å™¨æ›´åŠ å¼ºå¤§ã€‚\n\nå¼€å¤´æåˆ°äº† K8s ä½¿ç”¨å£°æ˜å¼çš„é…ç½®è‡ªåŠ¨å»ç®¡ç†å®¹å™¨ï¼Œè€Œ ReplicaSet çš„å†…å®¹å´å¤ªè¿‡å…·ä½“ï¼Œæ¶‰åŠåˆ°äº† Pod çš„å…·ä½“ç»´æŠ¤ç»†èŠ‚ã€‚æ‰€ä»¥ K8s åœ¨ ReplicaSet ä¹‹ä¸Šåˆè¡ç”Ÿå‡ºå£°æ˜å¼é…ç½®å®¹å™¨çš„æ¦‚å¿µï¼ŒDeploymentã€‚\n\n#### Deployment\n\nDeployment ä¸º Pod ä¸ ReplicaSet æä¾›äº†å£°æ˜å¼çš„å®šä¹‰ï¼Œæè¿°ä½ æƒ³è¦çš„ç›®æ ‡çŠ¶æ€æ˜¯ä»€ä¹ˆï¼ŒDeployment controller å°±ä¼šå¸®ä½ å°† Pod ä¸ ReplicaSet çš„å®é™…çŠ¶æ€æ”¹å˜åˆ°ä½ æƒ³è¦çš„ç›®æ ‡çŠ¶æ€ã€‚\n\nä»¥ fortune-teller ä¸ºä¾‹å­ï¼Œå¯ä»¥ç¼–å†™ä¸€ä»½ä¸‹é¢è¿™æ ·çš„ Deployment é…ç½®æ–‡ä»¶\n```yaml\napiVersion: apps/v1 # k8s apiç‰ˆæœ¬\nkind: Deployment # èµ„æºç±»å‹\nmetadata:\n  name: fortune-teller-app # deployment åå­—\n  namespace: default\nspec:\n  replicas: 1 # Pod å‰¯æœ¬æ•°é‡\n  selector:\n    matchLabels:\n      k8s-app: fortune-teller-app # ç®¡ç†æ ‡ç­¾ä¸­åŒ…å« k8s-app: fortune-teller-app çš„ Pod\n  template: # Pod æ¨¡æ¿\n    metadata:\n      labels:\n        k8s-app: fortune-teller-app # Pod æ ‡ç­¾\n    spec: # Pod é…ç½®\n      containers:\n      - image: quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n        imagePullPolicy: IfNotPresent\n        name: fortune-teller-app\n        ports:\n        - containerPort: 50051\n          name: grpc\n          protocol: TCP\n```\n\nå°†ä¸Šé¢çš„å†…å®¹ä¿å­˜åˆ°ä¸€ä»½ yaml æ–‡ä»¶ä¸­ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè®© K8s æ‰§è¡Œ yaml\n```bash\nkubectl apply -f deployment.yaml\n```\n\né€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°åˆšåˆšåˆ›å»ºçš„ deployment\n```bash\nkubectl get deployement\n```\n\n![](/asset/k8s-ramp-up/8.png)\n\næ­¤æ—¶ï¼ŒK8s å·²ç»è‡ªåŠ¨æ ¹æ® deployment ä¸­é…ç½®çš„ Pod æ¨¡æ¿å’Œé…ç½®ï¼Œåˆ›å»ºäº† Podã€‚é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ° K8s è‡ªåŠ¨åˆ›å»ºçš„ Pod\n```bash\nkubectl get pods\n```\n![](/asset/k8s-ramp-up/9.png)\n\nå› ä¸º K8s é‡‡ç”¨å£°æ˜å¼çš„é…ç½®å»ç®¡ç† Podï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åŠ¨æ€åœ°å»ä¿®æ”¹ deployment çš„é…ç½®ï¼ŒK8s ä¼šè‡ªåŠ¨æ ¹æ®æ–°çš„é…ç½®å»ç®¡ç† Podã€‚\n```bash\nkubectl edit deployment fortune-teller-app\n```\n\næˆ‘ä»¬æŠŠé…ç½®æ–‡ä»¶ä¸­çš„å‰¯æœ¬æ•°é‡ä¿®æ”¹ä¸º 2\n\n![](/asset/k8s-ramp-up/10.png)\n\nä¿å­˜é€€å‡ºåï¼Œæˆ‘ä»¬å†æ¬¡æ‰§è¡Œ kubectl get pods ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ° K8s æ ¹æ®æ–°çš„é…ç½®ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Pod\n\n![](/asset/k8s-ramp-up/11.png)\n\nç°åœ¨æˆ‘ä»¬å°±æœ‰äº†ä¸¤ä¸ª fortune-teller çš„æœåŠ¡ã€‚åœ¨çœŸå®ç¯å¢ƒä¸­ï¼ŒPod çš„è°ƒåº¦ç”± K8s è¿›è¡Œç®¡ç†ï¼ŒæŸä¸ªæ—¶åˆ»æœåŠ¡å¯èƒ½åœ¨ Node1 ä¸Šï¼Œè€Œå¦ä¸€æ—¶åˆ»æœåŠ¡å¯èƒ½å°±è¢«è°ƒåº¦åˆ°äº† Node2 ä¸Šã€‚æ‰€ä»¥ï¼Œè®¿é—®å…·ä½“ Pod æ˜¯ä¸€ç§ä¸ç¨³å®šçš„æœåŠ¡è®¿é—®æ–¹æ³•ï¼Œè€Œä¸”ç›®å‰å¤§å¤šæ•°çš„åç«¯æœåŠ¡éƒ½æ˜¯æ— çŠ¶æ€çš„æœåŠ¡ï¼Œç›´æ¥è®¿é—® Pod ä¹Ÿå¯¼è‡´ä¸èƒ½è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚æ‰€ä»¥ï¼ŒK8s åœ¨æ­¤åŸºç¡€ä¸Šè¡ç”Ÿå‡º Service çš„æ¦‚å¿µã€‚\n\n#### Service\n\nService å¯ä»¥çœ‹åšä¸€ç»„æä¾›ç›¸åŒæœåŠ¡çš„ Pod çš„å¯¹å¤–è®¿é—®æ¥å£ã€‚Kubernetes æä¾›ä¸‰ç§ç±»å‹çš„ Serviceï¼š\n- NodePortï¼š é›†ç¾¤å¤–éƒ¨å¯ä»¥é€šè¿‡ Node IP ä¸ Node Port æ¥è®¿é—®å…·ä½“æŸä¸ª Podï¼Œæ¯å°æœºå™¨ä¸Šéƒ½ä¼šæš´éœ²åŒæ ·çš„ç«¯å£\n- ClusterIPï¼šæŒ‡é€šè¿‡é›†ç¾¤çš„å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼ŒæœåŠ¡åªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨å¯ä»¥è®¿é—®ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤çš„ ServiceType\n- ExternalNameï¼šä¸æŒ‡å‘ Podï¼ŒæŒ‡å‘å¤–éƒ¨æœåŠ¡\nService å’Œ Deployment æ˜¯ä¸€å¯¹æ¯”è¾ƒå®¹æ˜“æ··æ·†çš„æ¦‚å¿µï¼Œä¸¤è€…éƒ½æ˜¯å¯¹ä¸€ç»„ Pod è¿›è¡Œç®¡ç†ï¼Œä½†å®ƒä»¬ä¸¤è€…ä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨ä¸‹é¢è¿™å¼ å›¾æ¥æ¦‚æ‹¬\n\n![](/asset/k8s-ramp-up/12.png)\n\nService æ˜¯é¢å‘æœåŠ¡è°ƒç”¨è€…ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨è®¿é—® K8sã€‚è€Œ Deployment æ˜¯é¢å‘ K8s åº•å±‚å¼•æ“çš„ï¼Œé¢å‘å†…éƒ¨ç®¡ç†è€…ã€‚\n\nService çš„é…ç½®æ–‡ä»¶æ ¼å¼ä¸ Deployment å¾ˆç±»ä¼¼\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: fortune-teller-service\n  namespace: default\nspec:\n  ports:\n  - name: grpc\n    port: 50051\n    protocol: TCP\n    targetPort: 50051\n  selector:\n    k8s-app: fortune-teller-app\n  type: ClusterIP\n```\n\nåŒæ ·çš„ï¼Œæˆ‘ä»¬é€šè¿‡ kubectl apply -f service.yaml å‘½ä»¤ï¼Œå¯ä»¥åˆ›å»º Serviceã€‚é€šè¿‡ kubectl get service å¯ä»¥æŸ¥çœ‹åˆ°åˆšåˆšåˆ›å»ºçš„ Serviceã€‚\n\n![](/asset/k8s-ramp-up/13.png)\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç™»é™†åˆ°ä¸€ä¸ª Pod é‡Œå»æµ‹è¯•ä¸€ä¸‹æ˜¯å¦å¯ä»¥è®¿é—®æœåŠ¡ã€‚\nNetshoot é•œåƒä¸­åŒ…å«äº†ä¸€äº›ç½‘ç»œæµ‹è¯•çš„å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¿›å…¥ä¸€ä¸ª netshoot å®¹å™¨å†…æµ‹è¯•ã€‚é‡‡ç”¨ deployment çš„æ–¹å¼åˆ›å»º Pod\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: netshoot\n  namespace: default\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      k8s-app: netshoot\n  template:\n    metadata:\n      labels:\n        k8s-app: netshoot\n    spec:\n      containers:\n      - args:\n        - 1000d\n        command:\n        - /bin/sleep\n        image: nicolaka/netshoot\n        name: netshoot\n```\n\nä¸ Docker çš„å‘½ä»¤ç±»ä¼¼ï¼Œä½¿ç”¨å‘½ä»¤ `kubectl cp grpcurl_1.6.0_linux_x86_64.tar.gz <pod name>:/` å¤åˆ¶å·¥å…·åˆ°å®¹å™¨å†…ã€‚\n\nå¤åˆ¶æˆåŠŸåï¼Œä½¿ç”¨å‘½ä»¤ kubectl exec -it <pod name> bash å¯ä»¥è¿›å…¥åˆ°å®¹å™¨å†…ã€‚\n\nè§£å‹\n```bash\ncd /\ntar -zxf grpcurl_1.6.0_linux_x86_64.tar.gz\n```\n\nç„¶åæˆ‘ä»¬å¯ä»¥æµ‹è¯•æ˜¯å¦å¯ä»¥ä» K8s é›†ç¾¤å†…è®¿é—® Serviceã€‚å¯¹äº K8s é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ï¼ŒK8s æœ‰è‡ªå·±çš„ DNS ç»„ä»¶ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡æœåŠ¡åè®¿é—®ã€‚\n```bash\n./grpcurl -plaintext fortune-teller-service:50051 build.stack.fortune.FortuneTeller/Predict\n```\n\n![](/asset/k8s-ramp-up/14.png)\n\néªŒè¯æœåŠ¡å¯ä»¥ä»é›†ç¾¤å†…è®¿é—®ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦è§£å†³å¦‚ä½•ä»é›†ç¾¤å¤–è®¿é—®æœåŠ¡çš„é—®é¢˜ï¼Œæ¯•ç«Ÿå¤§å¤šæ•°æœåŠ¡æ˜¯é¢å‘ K8s é›†ç¾¤å¤–çš„ç”¨æˆ·çš„ã€‚å…¶å®ç›®å‰æˆ‘ä»¬å·²ç»äº†è§£äº†ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯ä½¿ç”¨ Nodeport ç±»å‹çš„ Serviceã€‚ä½†é‡‡ç”¨è¿™ç§æ–¹æ³•æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š\n1. æ¯ä¸ªç«¯å£åªèƒ½æ˜¯ä¸€ç§æœåŠ¡\n2. ç«¯å£èŒƒå›´åªèƒ½æ˜¯ 30000-32767\n3. å¦‚æœèŠ‚ç‚¹ çš„ IP åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œè°ƒç”¨æ–¹éœ€è¦èƒ½å¤Ÿå¯Ÿè§‰ã€‚\næ‰€ä»¥ï¼ŒK8s ä¸ºæœåŠ¡çš„å¤–éƒ¨è®¿é—®è·¯ç”±æä¾›äº†æ–°çš„ç±»å‹ Ingressã€‚\n\n#### Ingress\nIngress å…¶å®æ˜¯ä¸€ç§ç±»ä¼¼äºè·¯ç”±è¡¨ä¸€æ ·çš„é…ç½®ï¼Œå®é™…çš„è·¯ç”±å·¥ä½œéœ€è¦ Ingress Controller æ‰§è¡Œã€‚K8s æœ¬èº«å¹¶æ²¡æœ‰æä¾› Ingress Controllerï¼Œç›®å‰å¸¸ç”¨çš„æ˜¯é€šè¿‡ Nginx å®ç°çš„ç‰ˆæœ¬ https://github.com/kubernetes/ingress-nginx ã€‚å¯ä»¥ä½¿ç”¨ä¸Šé¢å‹ç¼©åŒ…ä¸­çš„ ingress-controller.yaml å®‰è£…\n\n![](/asset/k8s-ramp-up/15.png)\n\nIngree nginx controller é€šè¿‡å®¿ä¸»æœºæš´éœ²ç»™å¤–éƒ¨è®¿é—®çš„ç«¯å£æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹ yamlï¼Œæ”¹æˆæˆ‘ä»¬åœ¨ä¸€å¼€å§‹åˆ›å»ºé›†ç¾¤æ—¶æ˜ å°„çš„ç«¯å£ã€‚\n\né€šè¿‡ `kubectl get svc -n ingress-nginx` æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼Œæš´éœ²çš„æ˜¯ä¸¤ä¸ªéšæœºåˆ†é…çš„ç«¯å£\n\n![](/asset/k8s-ramp-up/16.png)\n\næˆ‘ä»¬æ‰‹åŠ¨å°†å…¶æ”¹æˆ 32080 å’Œ 32443ã€‚\n\n![](/asset/k8s-ramp-up/17.png)\n\nIngress nginx controller åŒæ ·æ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨çš„æ–¹å¼ç®¡ç† Ingressã€‚\n\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Ingressï¼Œå°†å‘å¾€ Host fortune.bytedance.com çš„è¯·æ±‚è·¯ç”±åˆ° Service fortune-teller-serviceã€‚\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/backend-protocol: GRPC\n  name: fortune-ingress\n  namespace: default\nspec:\n  rules:\n  - host: fortune.bytedance.com\n    http:\n      paths:\n      - backend:\n          serviceName: fortune-teller-service\n          servicePort: grpc\n```\n\nå®‰è£… Ingress\n```bash\nkubectl apply -f ingress.yaml\nkubectl get ingress\n```\n\n![](/asset/k8s-ramp-up/18.png)\n\nIngress nginx controller å¯¹äº gRpc é»˜è®¤åªæ”¯æŒ SSL çš„å½¢å¼ï¼Œè€ŒFedlearner ä¸­çš„ controller åšäº†ä¸€äº›å®šåˆ¶åŒ–æ“ä½œï¼Œä½¿å¾—é€šè¿‡ 80 ç«¯å£ï¼Œåªä½¿ç”¨ HTTP2 ä¹Ÿå¯ä»¥è½¬å‘ gRpcã€‚è¯¦æƒ…å¯ä»¥å‚è€ƒ https://github.com/bytedance/ingress-nginx/pull/2/files\n\nä½¿ç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ä»å¤–éƒ¨è®¿é—®æœåŠ¡\n```bash\ngrpcurl -insecure -servername 'fortune.bytedance.com' 0.0.0.0:32443 build.stack.fortune.FortuneTeller/Predict\n```\n\n![](/asset/k8s-ramp-up/19.png)\n\nåˆšæ‰ä¹Ÿæåˆ°äº†ï¼ŒgRpc é€šå¸¸æ˜¯ä½¿ç”¨ SSL è¿›è¡ŒåŠ å¯†çš„ï¼ŒSSL çš„å…³é”®åœ¨äºå…¬é’¥ï¼Œç§é’¥ä»¥åŠè¯ä¹¦çš„éªŒè¯ã€‚é€šè¿‡æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼ç¡®å®å¯ä»¥å¤„ç†è¯ä¹¦çš„é—®é¢˜ï¼Œä½† K8s æŠ½è±¡å‡º Secret è¿™ç§èµ„æºï¼Œå¤§å¤§æé«˜äº†å¯¹è¿™ç±»æ–‡ä»¶çš„ç®¡ç†å’Œå¤ç”¨èƒ½åŠ›ã€‚\n\n#### Secret\n\nSecret è§£å†³äº†å¯†ç ã€tokenã€å¯†é’¥ç­‰æ•æ„Ÿæ•°æ®çš„å­˜å‚¨é—®é¢˜ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š\n- Service Account ï¼šç”¨æ¥è®¿é—® Kubernetes APIï¼Œç”± Kubernetes è‡ªåŠ¨åˆ›å»ºï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„ / run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­\n- Opaque ï¼šBase64 ç¼–ç æ ¼å¼çš„ Secretï¼Œç”¨æ¥å­˜å‚¨å¯†ç ã€å¯†é’¥ç­‰\n- kubernetes.io/dockerconfigjson ï¼šç”¨æ¥å­˜å‚¨ docker registry çš„è®¤è¯ä¿¡æ¯\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥åˆ›å»ºä¸€ä¸ª Opaque ç±»å‹çš„ Secretï¼Œä½¿å¾— ingress nginx controller æ”¯æŒæœåŠ¡ç«¯çš„ SSLã€‚\nç”±äºç¯‡å¹…æœ‰é™ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹è¯ä¹¦ç›¸å…³çš„æ¦‚å¿µï¼š\n- CAï¼šè¯ä¹¦æˆæƒä¸­å¿ƒ(certificate authority)ï¼Œç”¨æ¥ç­¾å‘ç§é’¥ï¼Œå¹¶éªŒè¯å…¬é’¥ï¼Œç§é’¥çš„åˆæ³•æ€§\n- ç§é’¥ï¼Œå…¬é’¥ï¼šç§é’¥ç”¨äºåŠ å¯†ï¼Œå…¬é’¥ç”¨äºè§£å¯†\n\nSecret æ”¯æŒä¸ç¼–å†™ yamlï¼Œç›´æ¥ä»æ–‡ä»¶ä¸­åˆ›å»º Secret\n```bash\nkubectl create secret generic fortune-teller-ssl-verify \\\n  --from-file=ca.crt=CA.pem \\\n  --from-file=tls.crt=server-public.pem \\\n  --from-file=tls.key=server-private.key\n```\n\nä¿®æ”¹ Ingressï¼Œä½¿å…¶ä½¿ç”¨æ–°åˆ›å»ºçš„ Secret æä¾›æœåŠ¡ä¾§çš„ SSLã€‚\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/backend-protocol: GRPC\n  name: fortune-ingress\n  namespace: default\nspec:\n  rules:\n  - host: fortune.test.com\n    http:\n      paths:\n      - backend:\n          serviceName: fortune-teller-service\n          servicePort: grpc\n  tls:\n  - hosts:\n    - fortune.test.com\n    secretName: fortune-teller-ssl-verify\n```\n\nå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯è‡ªç­¾åçš„è¯ä¹¦ï¼Œä¸è¢«å…¬å…±çš„ CA æ‰€ä¿¡ä»»ï¼Œæ‰€ä»¥åœ¨å‘é€è¯·æ±‚æ˜¯éœ€è¦æ‰‹åŠ¨æŒ‡å®šè‡ªå·±æ‰€ä¿¡ä»»çš„ CAã€‚\n\n```bash\ngrpcurl -cacert CA.pem \\\n  -servername 'fortune.test.com' \\\n  127.0.0.1:32443 \\\n  build.stack.fortune.FortuneTeller/Predict\n```\n\n![](/asset/k8s-ramp-up/20.png)\n\n## å‚è€ƒ\n- https://draveness.me/docker/\n- https://www.yuque.com/kshare/2020/fe3b6f86-3b9b-48da-9770-897d838cbf41?language=zh-cn#Namespace\n- https://network.51cto.com/art/201907/598970.htm\n- https://blog.csdn.net/gatieme/article/details/51383322\n\n","slug":"k8s-ramp-up","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"cl5i8k7y500071rpf8od71152","content":"<h2 id=\"ç›®æ ‡\"><a href=\"#ç›®æ ‡\" class=\"headerlink\" title=\"ç›®æ ‡\"></a>ç›®æ ‡</h2><ul>\n<li>ä»‹ç» K8sï¼ŒDocker æ¦‚å¿µä»¥åŠåŸç†</li>\n<li>ä» 0 å¼€å§‹éƒ¨ç½²ä¸€ä¸ªç®€å•å®Œæ•´çš„æœåŠ¡</li>\n</ul>\n<h2 id=\"Dockeræ˜¯ä»€ä¹ˆï¼Ÿ\"><a href=\"#Dockeræ˜¯ä»€ä¹ˆï¼Ÿ\" class=\"headerlink\" title=\"Dockeræ˜¯ä»€ä¹ˆï¼Ÿ\"></a>Dockeræ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>Dockeræ˜¯ç”±Googleæ¨å‡ºçš„Goè¯­è¨€è¿›è¡Œå¼€å‘å®ç°ï¼ŒåŸºäºLinuxå†…æ ¸çš„ <font color=red>namespace</font>ï¼Œå¯¹<font color=red>è¿›ç¨‹</font>è¿›è¡Œå°è£…<font color=red>éš”ç¦»</font>ï¼Œå±äºæ“ä½œç³»ç»Ÿå±‚é¢çš„å®¹å™¨åŒ–æŠ€æœ¯ã€‚</p>\n<p><img src=\"/asset/k8s-ramp-up/1.png\"></p>\n<h3 id=\"ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ\"><a href=\"#ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ\" class=\"headerlink\" title=\"ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ\"></a>ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ</h3><p>é•œåƒï¼ˆImageï¼‰</p>\n<p>å®¹å™¨ï¼ˆContainerï¼‰</p>\n<p>ä»“åº“ï¼ˆRepositoryï¼‰</p>\n<p>ä»ä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œé•œåƒå°±åƒä¸€ä¸ªç±»ï¼›å®¹å™¨æ˜¯å¯¹è±¡å®ä¾‹ï¼Œè¿è¡Œæ—¶åœ¨ç³»ç»Ÿä¸­ä¼šæœ‰è®¸å¤šå®¹å™¨ï¼›ä»“åº“ä¸»è¦ç”¨äºå­˜å‚¨å’Œç»´æŠ¤è¿™äº›é•œåƒã€‚</p>\n<h3 id=\"ä¸ºä»€ä¹ˆä½¿ç”¨-Dockerï¼Ÿ\"><a href=\"#ä¸ºä»€ä¹ˆä½¿ç”¨-Dockerï¼Ÿ\" class=\"headerlink\" title=\"ä¸ºä»€ä¹ˆä½¿ç”¨ Dockerï¼Ÿ\"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ Dockerï¼Ÿ</h3><ul>\n<li>é…ç½®ç¯å¢ƒ<br>å¼€å‘è¿‡ç¨‹ä¸­ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯ç¯å¢ƒä¸€è‡´æ€§é—®é¢˜ã€‚ç”±äºå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´ï¼Œå¯¼è‡´æœ‰äº› bug å¹¶æœªåœ¨å¼€å‘è¿‡ç¨‹ä¸­è¢«å‘ç°ã€‚è€Œ Docker çš„é•œåƒæä¾›äº†é™¤å†…æ ¸å¤–å®Œæ•´çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œç¡®ä¿äº†åº”ç”¨è¿è¡Œç¯å¢ƒä¸€è‡´æ€§</li>\n<li>åº”ç”¨éš”ç¦»<br>æœºå™¨ä¸Šå¯èƒ½åŒæ—¶è¿è¡Œå¤šä¸ªæœåŠ¡ã€‚å¦‚æœæœåŠ¡ä¹‹é—´æ²¡æœ‰éš”ç¦»ï¼Œä¸€ä¸ªæœåŠ¡å‡ºç°å¼‚å¸¸ï¼Œå¾€å¾€å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœåŠ¡ä¹ŸæŒ‚æ‰ã€‚åŒæ—¶ï¼Œä¸åŒæœåŠ¡æ‰€ä¾èµ–çš„ç¯å¢ƒä¹Ÿå¯èƒ½å‘ç”Ÿå†²çªã€‚</li>\n</ul>\n<h3 id=\"åŸç†\"><a href=\"#åŸç†\" class=\"headerlink\" title=\"åŸç†\"></a>åŸç†</h3><p>é¦–å…ˆï¼Œè¦äº†è§£ä¸€ä¸‹è¿›ç¨‹çš„å‘½åç©ºé—´ã€‚Linux ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹æŒ‰ç…§æƒ¯ä¾‹æ˜¯é€šè¿‡PIDæ ‡è¯†çš„ï¼Œè¿™æ„å‘³ç€å†…æ ¸å¿…é¡»ç®¡ç†ä¸€ä¸ªå…¨å±€çš„PIDåˆ—è¡¨ã€‚è€Œä¸”ï¼Œæ‰€æœ‰è°ƒç”¨è€…é€šè¿‡unameç³»ç»Ÿè°ƒç”¨è¿”å›çš„ç³»ç»Ÿç›¸å…³ä¿¡æ¯ï¼ˆåŒ…æ‹¬ç³»ç»Ÿåç§°å’Œæœ‰å…³å†…æ ¸çš„ä¸€äº›ä¿¡æ¯ï¼‰éƒ½æ˜¯ç›¸åŒçš„ã€‚</p>\n<p>Linux çš„å‘½åç©ºé—´ä»å†…æ ¸å±‚é¢ä¸Šè¿›è¡Œäº†è™šæ‹ŸåŒ–ï¼Œå¯¹æ‰€æœ‰çš„å…¨å±€èµ„æºè¿›è¡Œä¸€ä¸ªæŠ½è±¡ã€‚æœ¬è´¨ä¸Šï¼Œå»ºç«‹äº†ç³»ç»Ÿçš„ä¸åŒè§†å›¾ã€‚æ¯ä¸€é¡¹å…¨å±€èµ„æºéƒ½å¿…é¡»åŒ…è£…åˆ°å‘½åç©ºé—´çš„æ•°æ®ç»“æ„ä¸­ï¼Œåªæœ‰èµ„æºå’ŒåŒ…å«èµ„æºçš„å‘½åç©ºé—´æ„æˆçš„äºŒå…ƒç»„ä»ç„¶æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚ä¸ä»…ä»…æ˜¯ PIDï¼ŒLinux é€šè¿‡åŒæ ·çš„æ–¹æ³•å¯¹å…¶ä»–èµ„æºä¹Ÿåšäº†è™šæ‹ŸåŒ–å¤„ç†ã€‚å‘½åç©ºé—´å…±æœ‰ä»¥ä¸‹6ç§ï¼š</p>\n<p><img src=\"/asset/k8s-ramp-up/2.png\"></p>\n<p>å€ŸåŠ© Linux çš„å‘½åç©ºé—´ï¼ŒDocker å¯¹è¿›ç¨‹è¿›è¡Œéš”ç¦»ï¼Œå¯ä»¥ä»è¿›ç¨‹æ ‘çš„è§’åº¦ç†è§£ã€‚</p>\n<p><img src=\"/asset/k8s-ramp-up/3.png\"></p>\n<p>æ¯æ¬¡åœ¨æ‰§è¡Œ <code>docker start</code> æˆ– <code>docker run</code> çš„æ—¶å€™ï¼Œå…¶å®æ˜¯ç”± docker çš„ daemon è¿›ç¨‹ docker containerdï¼Œè°ƒç”¨ Linux ç³»ç»Ÿè°ƒç”¨ <code>clone()</code> å»åˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚è€Œåˆ›å»ºè¿›ç¨‹çš„è¿‡ç¨‹ä¸­å°±ä¸ºæ–°åˆ›å»ºçš„è¿›ç¨‹åˆ†é…äº†æ–°çš„ Linux å‘½åç©ºé—´ã€‚å¯ä»¥ç®€å•é˜…è¯»ä¸€ä¸‹ docker çš„å¼€æºä»£ç </p>\n<pre><code class=\"go\">// https://github.com/moby/moby/blob/49e809fbfe250f3df2deacc0c3e5c403db3b8915/daemon/start.go#L17\n// åˆ›å»ºå®¹å™¨çš„å‡½æ•°ï¼Œå…¶ä¸­åˆè°ƒç”¨äº†è®¾ç½®\nfunc (daemon *Daemon) ContainerStart(name string, hostConfig *containertypes.HostConfig, checkpoint string, checkpointDir string) error\n\n// https://github.com/moby/moby/blob/470ae8422fc6f1845288eb7572253b08f1e6edf8/daemon/oci_linux.go#L212\n// è®¾ç½® Namespace\nfunc setNamespace(s *specs.Spec, ns specs.LinuxNamespace) &#123;\n   for i, n := range s.Linux.Namespaces &#123;\n      if n.Type == ns.Type &#123;\n         s.Linux.Namespaces[i] = ns\n         return\n      &#125;\n   &#125;\n   s.Linux.Namespaces = append(s.Linux.Namespaces, ns)\n&#125;\n\n// https://github.com/moby/moby/blob/49e809fbfe250f3df2deacc0c3e5c403db3b8915/daemon/start.go#L198\n// åˆ›å»ºæ–°çš„è¿›ç¨‹\npid, err := daemon.containerd.Start(context.Background(), \n                                    container.ID, \n                                    checkpointDir,    \n                                    container.StreamConfig.Stdin() != nil | | container.Config.Tty, \n                                    container.InitializeStdio)\n</code></pre>\n\n<h3 id=\"å¦‚ä½•å®‰è£…ï¼Ÿ\"><a href=\"#å¦‚ä½•å®‰è£…ï¼Ÿ\" class=\"headerlink\" title=\"å¦‚ä½•å®‰è£…ï¼Ÿ\"></a>å¦‚ä½•å®‰è£…ï¼Ÿ</h3><p><a href=\"https://docs.docker.com/get-docker/\">https://docs.docker.com/get-docker/</a></p>\n<h2 id=\"Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ\"><a href=\"#Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ\" class=\"headerlink\" title=\"Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ\"></a>Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>Kubernetes æ˜¯ Google äº 2014 å¹´åŸºäºå…¶å†…éƒ¨ Brog ç³»ç»Ÿå¼€æºçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’ç®¡ç†ç³»ç»Ÿï¼Œå¯ä½¿ç”¨å£°æ˜å¼çš„é…ç½®ï¼ˆä»¥ yaml æ–‡ä»¶çš„å½¢å¼ï¼‰è‡ªåŠ¨åœ°æ‰§è¡Œå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†ï¼ŒåŒ…æ‹¬éƒ¨ç½²ã€ä¼¸ç¼©ã€è´Ÿè½½å‡è¡¡ã€å›æ»šç­‰ã€‚</p>\n<p>ä¸ºä»€ä¹ˆå« K8sï¼Ÿå› ä¸º K<font color=red>ubernete</font>sï¼Œä¸­é—´æ˜¯8ä¸ªå­—æ¯ã€‚</p>\n<p>kubernetes æä¾›çš„åŠŸèƒ½ï¼š</p>\n<ul>\n<li>è‡ªåŠ¨å‘å¸ƒä¸ä¼¸ç¼©ï¼šå¯ä»¥é€šè¿‡å£°æ˜å¼çš„é…ç½®æ–‡ä»¶å®šä¹‰æƒ³è¦éƒ¨ç½²çš„å®¹å™¨</li>\n<li>æ»šåŠ¨å‡çº§ä¸ç°åº¦å‘å¸ƒï¼šé‡‡ç”¨é€æ­¥æ›¿æ¢çš„ç­–ç•¥å®ç°æ»šåŠ¨å‡çº§</li>\n<li>æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼šKubernetes é€šè¿‡ DNS åç§°æˆ– IP åœ°å€æš´éœ²å®¹å™¨çš„è®¿é—®æ–¹å¼ï¼Œå¹¶ä¸”å¯åœ¨åŒä¸€å®¹å™¨ç»„å†…å®ç°è´Ÿè½½åˆ†å‘ä¸å‡è¡¡</li>\n<li>å­˜å‚¨ç¼–æ’ï¼šKubernetes å¯ä»¥è‡ªåŠ¨æŒ‚è½½æŒ‡å®šçš„å­˜å‚¨ç³»ç»Ÿï¼Œå¦‚ local storage/nfs / äº‘å­˜å‚¨ç­‰</li>\n<li>æ•…éšœæ¢å¤ï¼šKubernetes è‡ªåŠ¨é‡å¯å·²ç»åœæœºçš„å®¹å™¨ï¼Œæ›¿æ¢ä¸æ»¡è¶³å¥åº·æ£€æŸ¥çš„å®¹å™¨</li>\n<li>å¯†é’¥ä¸é…ç½®ç®¡ç†ï¼šKubernetes å¯ä»¥å­˜å‚¨ä¸ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ Docker Registry çš„ç™»å½•å‡­è¯ï¼Œå¯†ç ï¼Œssh å¯†é’¥ç­‰</li>\n</ul>\n<h3 id=\"ä¸ºä»€ä¹ˆä½¿ç”¨-K8sï¼Ÿ\"><a href=\"#ä¸ºä»€ä¹ˆä½¿ç”¨-K8sï¼Ÿ\" class=\"headerlink\" title=\"ä¸ºä»€ä¹ˆä½¿ç”¨ K8sï¼Ÿ\"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ K8sï¼Ÿ</h3><p>å¤§å‹å•ä½“åº”ç”¨è¢«é€æ¸æ‹†åˆ†æˆå°çš„ã€å¯ç‹¬ç«‹è¿è¡Œçš„ç»„ä»¶ã€‚éšç€éƒ¨ç½²ç»„ä»¶çš„å¢å¤šå’Œæ•°æ®ä¸­å¿ƒçš„å¢é•¿ï¼Œé…ç½®ã€ç®¡ç†å’Œè¿ç»´å˜å¾—å¾ˆå›°éš¾ã€‚(å¾®æœåŠ¡ï¼‰</p>\n<p>K8s çš„å®šä¹‰å°±æ˜¯å®¹å™¨ç¼–æ’å’Œç®¡ç†å¼•æ“ï¼Œè§£å†³äº†è¿™äº›é—®é¢˜ã€‚</p>\n<h3 id=\"å¦‚ä½•å®‰è£…ï¼Ÿ-1\"><a href=\"#å¦‚ä½•å®‰è£…ï¼Ÿ-1\" class=\"headerlink\" title=\"å¦‚ä½•å®‰è£…ï¼Ÿ\"></a>å¦‚ä½•å®‰è£…ï¼Ÿ</h3><p>ç”±éš¾åˆ°æ˜“(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§</p>\n<ul>\n<li>Kubeadm: <a href=\"https://kubernetes.io/docs/reference/setup-tools/kubeadm/\">https://kubernetes.io/docs/reference/setup-tools/kubeadm/</a></li>\n<li>MiniKube: Local kubernetes <a href=\"https://minikube.sigs.k8s.io/docs/start/\">https://minikube.sigs.k8s.io/docs/start/</a></li>\n<li>Kind: Kubernetes in Docker <a href=\"https://github.com/kubernetes-sigs/kind\">https://github.com/kubernetes-sigs/kind</a></li>\n<li>Docker-desktopï¼ˆä»…é™ Macï¼‰: ä¸€é”®å¼€å¯<br><img src=\"/asset/k8s-ramp-up/4.png\"></li>\n</ul>\n<p>å…¶ä»–ç‰ˆæœ¬çš„ç±» K8s ç³»ç»Ÿï¼š</p>\n<ul>\n<li>K3s: <a href=\"https://github.com/k3s-io/k3s\">https://github.com/k3s-io/k3s</a></li>\n<li>K0s: <a href=\"https://github.com/k0sproject/k0s\">https://github.com/k0sproject/k0s</a></li>\n</ul>\n<h2 id=\"Kubernetes-æ¶æ„\"><a href=\"#Kubernetes-æ¶æ„\" class=\"headerlink\" title=\"Kubernetes æ¶æ„\"></a>Kubernetes æ¶æ„</h2><p><img src=\"/asset/k8s-ramp-up/5.png\"></p>\n<h3 id=\"master\"><a href=\"#master\" class=\"headerlink\" title=\"master\"></a>master</h3><p>Master è´Ÿè´£ç®¡ç†æœåŠ¡æ¥å¯¹æ•´ä¸ªç³»ç»Ÿè¿›è¡Œç®¡ç†ä¸æ§åˆ¶ï¼ŒåŒ…æ‹¬</p>\n<ul>\n<li>apiserverï¼šä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„å¯¹å¤–æ¥å£ï¼Œæä¾›ä¸€å¥— Restful API ä¾›å®¢æˆ·ç«¯è°ƒç”¨ï¼Œä»»ä½•çš„èµ„æºè¯·æ±‚ / è°ƒç”¨æ“ä½œéƒ½æ˜¯é€šè¿‡ kube-apiserver æä¾›çš„æ¥å£è¿›è¡Œ, å¦‚ kubectlã€kubernetes dashboard ç­‰ç®¡ç†å·¥å…·å°±æ˜¯é€šè¿‡ apiserver æ¥å®ç°å¯¹é›†ç¾¤çš„ç®¡ç†</li>\n<li>kube-schedulerï¼šèµ„æºè°ƒåº¦å™¨ï¼Œè´Ÿè´£å°†å®¹å™¨ç»„åˆ†é…åˆ°å“ªäº›èŠ‚ç‚¹ä¸Š</li>\n<li>kube-controller-managerï¼šç®¡ç†æ§åˆ¶å™¨ï¼Œé›†ç¾¤ä¸­å¤„ç†å¸¸è§„ä»»åŠ¡çš„åå°çº¿ç¨‹ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆè´Ÿè´£ç›‘å¬èŠ‚ç‚¹åœæœºçš„äº‹ä»¶å¹¶ä½œå‡ºå¯¹åº”å“åº”ï¼‰ã€endpoint-controllerï¼ˆåˆ·æ–°æœåŠ¡ä¸å®¹å™¨ç»„çš„å…³è”ä¿¡æ¯ï¼‰ã€replication-controllerï¼ˆç»´æŠ¤å®¹å™¨ç»„çš„å‰¯æœ¬æ•°ä¸ºæŒ‡å®šçš„æ•°å€¼ï¼‰ã€Service Account &amp; Token æ§åˆ¶å™¨ï¼ˆè´Ÿè´£ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤çš„ Service Account ä»¥åŠ API Access Tokenï¼‰</li>\n<li>etcdï¼šæ•°æ®å­˜å‚¨ï¼Œå­˜å‚¨é›†ç¾¤æ‰€æœ‰çš„é…ç½®ä¿¡æ¯</li>\n<li>corednsï¼šå®ç°é›†ç¾¤å†…éƒ¨é€šè¿‡æœåŠ¡åç§°è¿›è¡Œå®¹å™¨ç»„è®¿é—®çš„åŠŸèƒ½</li>\n</ul>\n<h3 id=\"worker\"><a href=\"#worker\" class=\"headerlink\" title=\"worker\"></a>worker</h3><p>Worker è´Ÿè½½æ‰§è¡Œ Master åˆ†é…çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬</p>\n<ul>\n<li>kubeletï¼šæ˜¯å·¥ä½œèŠ‚ç‚¹ä¸Šæ‰§è¡Œæ“ä½œçš„ä»£ç†ç¨‹åºï¼Œè´Ÿè´£å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå®šæœŸæ‰§è¡Œå®¹å™¨å¥åº·æ£€æŸ¥ï¼Œå¹¶ä¸ŠæŠ¥å®¹å™¨çš„è¿è¡ŒçŠ¶æ€</li>\n<li>kube-proxyï¼šæ˜¯ä¸€ä¸ªå…·æœ‰è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„ç®€å•çš„ç½‘ç»œè®¿é—®ä»£ç†ï¼Œè´Ÿè´£å°†è®¿é—®æŸä¸ªæœåŠ¡çš„è¯·æ±‚åˆ†é…åˆ°å·¥ä½œèŠ‚ç‚¹çš„å…·ä½“æŸä¸ªå®¹å™¨ä¸Šï¼ˆkube-proxy ä¹Ÿè¿è¡Œäº master node ä¸Šï¼‰</li>\n<li>Docker Daemonï¼šKubernetes å…¶å®ä¸å±€é™äº Dockerï¼ˆå³å°†å–æ¶ˆï¼‰ï¼Œå®ƒæ”¯æŒä»»ä½•å®ç°äº† Kubernetes å®¹å™¨å¼•æ“æ¥å£çš„å®¹å™¨å¼•æ“ï¼Œå¦‚ containerdã€rktlet</li>\n</ul>\n<h3 id=\"ç½‘ç»œé€šä¿¡\"><a href=\"#ç½‘ç»œé€šä¿¡\" class=\"headerlink\" title=\"ç½‘ç»œé€šä¿¡\"></a>ç½‘ç»œé€šä¿¡</h3><p>ç½‘ç»œé€šä¿¡ç»„ä»¶åªéœ€è¦ç¬¦åˆ CNI ï¼ˆContainer Network Interfaceï¼‰æ¥å£è§„èŒƒï¼Œä¸»è¦ä½œç”¨åœ¨äºç»™å„ä¸ªå®¹å™¨åˆ†é…é›†ç¾¤å†… IPï¼Œä½¿å¾—å…¶å†…ç½‘ IP èƒ½å¤Ÿé›†ç¾¤å†…å”¯ä¸€ï¼Œå¹¶ä¸”å¯ä»¥äº’ç›¸è®¿é—®ï¼Œç›®å‰å¸¸ç”¨çš„æœ‰ Flannelï¼ŒCalicoç­‰ç½‘ç»œç»„ä»¶ã€‚</p>\n<p>ç®€å•ä»‹ç»ä¸‹æ¯”è¾ƒå¸¸ç”¨çš„ Flannel çš„åŸç†ã€‚Flannel è¿è¡Œåœ¨ç¬¬3å±‚ç½‘ç»œå±‚ï¼ŒåŸºäº IPv4ï¼Œåˆ›å»ºä¸€ä¸ªå¤§å‹å†…éƒ¨ç½‘ç»œï¼Œè·¨è¶Šé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹ç»„æˆä¸€ä¸ªå­ç½‘ï¼Œæ¯ä¸ªå®¹å™¨åœ¨å†…ç½‘ä¸­æœ‰å”¯ä¸€çš„IPã€‚</p>\n<p>é¦–å…ˆï¼ŒFlannel ä¼šä¸ºæ¯å°èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªå­ç½‘æ®µã€‚Flanneld åœ¨ Docker å®¹å™¨å¯åŠ¨æ—¶ä¿®æ”¹å…¶å¯åŠ¨å‚æ•°ï¼Œå°†å…¶ IP é™åˆ¶åœ¨å½“å‰çš„å­ç½‘æ®µå†…ï¼Œå…·ä½“ IP çš„åˆ†é…ä»æ˜¯ç”± docker è¿›è¡Œã€‚Flannelé€šè¿‡EtcdæœåŠ¡ç»´æŠ¤äº†ä¸€å¼ èŠ‚ç‚¹é—´çš„è·¯ç”±è¡¨ï¼Œè¯¦ç»†è®°å½•äº†å„èŠ‚ç‚¹å­ç½‘ç½‘æ®µï¼Œä¿è¯ä¸åŒèŠ‚ç‚¹çš„å­ç½‘ç½‘æ®µä¸ä¼šé‡å¤ã€‚</p>\n<p>æ•°æ®ä»æºå®¹å™¨ä¸­å‘å‡ºåï¼Œç»ç”±æ‰€åœ¨ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡è½¬å‘åˆ°flannel0è™šæ‹Ÿç½‘å¡ï¼ŒflanneldæœåŠ¡ç›‘å¬åœ¨ç½‘å¡çš„å¦å¤–ä¸€ç«¯ã€‚</p>\n<p>æºä¸»æœºçš„flanneldæœåŠ¡å°†åŸæœ¬çš„æ•°æ®å†…å®¹UDPå°è£…åæ ¹æ®è‡ªå·±çš„è·¯ç”±è¡¨æŠ•é€’ç»™ç›®çš„èŠ‚ç‚¹çš„flanneldæœåŠ¡ï¼Œæ•°æ®åˆ°è¾¾ä»¥åè¢«è§£åŒ…ï¼Œç„¶åç›´æ¥è¿›å…¥ç›®çš„èŠ‚ç‚¹çš„flannel0è™šæ‹Ÿç½‘å¡ï¼Œç„¶åè¢«è½¬å‘åˆ°ç›®çš„ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡ï¼Œæœ€åå°±åƒæœ¬æœºå®¹å™¨é€šä¿¡ä¸€ä¸‹çš„æœ‰docker0è·¯ç”±åˆ°è¾¾ç›®æ ‡å®¹å™¨ã€‚</p>\n<p><img src=\"/asset/k8s-ramp-up/6.png\"></p>\n<h2 id=\"å¿«é€Ÿä¸Šæ‰‹-K8s-æ¦‚å¿µ\"><a href=\"#å¿«é€Ÿä¸Šæ‰‹-K8s-æ¦‚å¿µ\" class=\"headerlink\" title=\"å¿«é€Ÿä¸Šæ‰‹ K8s æ¦‚å¿µ\"></a>å¿«é€Ÿä¸Šæ‰‹ K8s æ¦‚å¿µ</h2><p>ä¸€äº›æ¨èçš„ K8s æ¦‚å¿µä»‹ç»ï¼š</p>\n<ul>\n<li>å¾®è½¯çš„ 50å¤© K8s æ•™ç¨‹ä¸­ï¼ˆ<a href=\"https://azure.microsoft.com/en-us/resources/kubernetes-learning-path/%EF%BC%89%E9%80%9A%E8%BF%87%E5%8A%A8%E7%89%A9%E5%9B%AD%E7%9A%84%E5%BD%A2%E5%BC%8F%E4%BB%8B%E7%BB%8D%E4%BA%86%E4%B8%80%E4%BA%9B\">https://azure.microsoft.com/en-us/resources/kubernetes-learning-path/ï¼‰é€šè¿‡åŠ¨ç‰©å›­çš„å½¢å¼ä»‹ç»äº†ä¸€äº›</a> K8s æ¦‚å¿µ <a href=\"http://aka.ms/k8s/LearnwithPhippy\">http://aka.ms/k8s/LearnwithPhippy</a></li>\n<li>ç»¼è¿°PPTï¼š<a href=\"https://www2.slideshare.net/BobKillen/kubernetes-a-comprehensive-overview-updated?from_action=save\">https://www2.slideshare.net/BobKillen/kubernetes-a-comprehensive-overview-updated?from_action=save</a></li>\n</ul>\n<p>K8s ä¸­çš„æ¦‚å¿µæå¤šï¼Œæ¯”è¾ƒé›¶ç¢ï¼Œè¿™é‡Œé€šè¿‡ä¸€ä¸ªç®€å•çš„å°ä¾‹å­ï¼Œå°½å¯èƒ½è¦†ç›–å¤šçš„ K8s æ¦‚å¿µã€‚</p>\n<h2 id=\"æ¦‚è§ˆ\"><a href=\"#æ¦‚è§ˆ\" class=\"headerlink\" title=\"æ¦‚è§ˆ\"></a>æ¦‚è§ˆ</h2><p>ä¾‹å­ä½¿ç”¨ä¸€ä¸ªå¼€æºçš„ fortune-teller é•œåƒï¼ˆ<code>quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1</code>ï¼‰ ï¼Œæ¯æ¬¡è¯·æ±‚å®¹å™¨å†…çš„æœåŠ¡ï¼ŒæœåŠ¡ä¼šè¿”å›ä¸€å¥åè¨€ã€‚å¸Œæœ›åœ¨ MacOS çš„ç¯å¢ƒä¸‹ï¼Œå±•ç¤ºä¸€ä¸ªåº”ç”¨åœ¨ K8s ä¸­è¿è¡Œçš„å…¨æµç¨‹ã€‚</p>\n<p>å‡†å¤‡ç¯å¢ƒ<br>ä¸ºäº†ä¸å½±å“å¤§å®¶æœ¬åœ°çš„ç¯å¢ƒï¼Œè¿™é‡Œä½¿ç”¨ Kind åˆ›å»ºå‡ºä¸€ä¸ªç‹¬ç«‹çš„ K8s é›†ç¾¤ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç‰ˆæœ¬å¹¶ä¸”å¯ä»¥åœ¨å®Œæˆå¿«é€Ÿæ¸…ç†æ‰ã€‚(Docker åŒé‡éš”ç¦»ï¼‰</p>\n<ol>\n<li><p>å®‰è£… Kind ä»¥åŠ gRpc æµ‹è¯•å·¥å…·</p>\n<pre><code class=\"bash\">brew install kind\nbrew install grpcurl\n</code></pre>\n</li>\n<li><p>æ‹‰å–é•œåƒ</p>\n<pre><code class=\"bash\">docker pull kindest/node:v1.16.15\ndocker pull quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n</code></pre>\n</li>\n<li><p>åˆ›å»º K8s é›†ç¾¤ï¼Œå› ä¸º Kind æ˜¯åœ¨ Docker å®¹å™¨é‡Œé¢åˆ›å»ºçš„ K8sï¼Œæ‰€ä»¥å®¿ä¸»æœºè®¿é—®ï¼Œéœ€è¦æŠŠç«¯å£æš´éœ²å‡ºæ¥ã€‚Kind ä¼šé»˜è®¤æŠŠ K8s apiserver çš„ç«¯å£æš´éœ²å‡ºæ¥ï¼Œç”¨æ¥ç»™ kubectl å‘½ä»¤ä½¿ç”¨ã€‚ä½†ä¸ºäº†ä¹‹åçš„æµ‹è¯•ï¼Œæˆ‘ä»¬æå‰æŠŠå‡ ä¸ªç«¯å£åœ¨åˆ›å»ºçš„æ—¶å€™å°±æš´éœ²å‡ºæ¥ã€‚</p>\n</li>\n</ol>\n<p>Kind åŒæ ·æ”¯æŒé€šè¿‡yaml çš„å½¢å¼åˆ›å»ºé›†ç¾¤</p>\n<pre><code class=\"yaml\">kind: Cluster\napiVersion: kind.x-k8s.io/v1alpha4\nnodes:\n- role: control-plane\n  extraPortMappings:\n  - containerPort: 32080\n    hostPort: 32080\n  - containerPort: 32443\n    hostPort: 32443\n</code></pre>\n<pre><code class=\"bash\">kind create cluster --name=fortune-teller --image=kindest/node:v1.16.15 --config kind-config.yaml\n</code></pre>\n<h3 id=\"è¿è¡Œ-Docker-ç‰ˆæœ¬\"><a href=\"#è¿è¡Œ-Docker-ç‰ˆæœ¬\" class=\"headerlink\" title=\"è¿è¡Œ Docker ç‰ˆæœ¬\"></a>è¿è¡Œ Docker ç‰ˆæœ¬</h3><ol>\n<li>å¯åŠ¨å®¹å™¨<pre><code class=\"bash\">docker run -p 50051:50051 quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n</code></pre>\n</li>\n</ol>\n<p><code>-p</code> å°†å®¹å™¨å†…çš„ 50051 ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„ 50051 ç«¯å£</p>\n<ol start=\"2\">\n<li>æµ‹è¯•åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œç¬¬ä¸€æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦ç»™ grpcurl å¼€å¯æƒé™<pre><code class=\"bash\">grpcurl -plaintext 127.0.0.1:50051 build.stack.fortune.FortuneTeller/Predict\n</code></pre>\n</li>\n</ol>\n<p>åº”ç”¨åœ¨æ”¶åˆ°è¯·æ±‚ä»¥åï¼Œä¼šè¿”å›ä¸€å¥åè¨€</p>\n<p><img src=\"/asset/k8s-ramp-up/7.png\"></p>\n<h3 id=\"å°†åº”ç”¨ä»-Docker-è¿ç§»åˆ°-K8s-ä¸­\"><a href=\"#å°†åº”ç”¨ä»-Docker-è¿ç§»åˆ°-K8s-ä¸­\" class=\"headerlink\" title=\"å°†åº”ç”¨ä» Docker è¿ç§»åˆ° K8s ä¸­\"></a>å°†åº”ç”¨ä» Docker è¿ç§»åˆ° K8s ä¸­</h3><p>ä¸ Docker ä¸­å®¹å™¨æ¦‚å¿µç›¸å¯¹åº”çš„ï¼ŒK8s ä¸­ä¹Ÿæœ‰ç€å®¹å™¨çš„æ¦‚å¿µã€‚å¯¹äºè™šæ‹ŸåŒ–çš„å®¹å™¨æ¥è¯´ï¼Œæœ€ä½³å®è·µæ˜¯ä¸€ä¸ªå®¹å™¨ä¸€ä¸ªåº”ç”¨ï¼Œä½†å½“ä¸€ä¸ªæœåŠ¡éœ€è¦å¤šä¸ªåº”ç”¨ç»„åˆå®Œæˆæ—¶ï¼Œç®€å•çš„å°†å¤šä¸ªåº”ç”¨éƒ¨ç½²åˆ°ä¸€ä¸ªå®¹å™¨å†…ï¼Œå°±ç ´åäº†åº”ç”¨ä¹‹é—´çš„éš”ç¦»æ€§ï¼Œæ‰€ä»¥ K8s å¯¹äºå®¹å™¨è¿›è¡Œäº†ä¸€å±‚å°è£…ï¼Œå½¢æˆäº† Pod çš„æ¦‚å¿µã€‚</p>\n<h4 id=\"Pod\"><a href=\"#Pod\" class=\"headerlink\" title=\"Pod\"></a>Pod</h4><p>Pod æ˜¯ Kubernetes åˆ›å»ºæˆ–éƒ¨ç½²çš„æœ€å°åŸºæœ¬å•å…ƒã€‚ä¸€ä¸ª Pod å°è£…ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨å®¹å™¨ã€å­˜å‚¨èµ„æºã€ä¸€ä¸ªç‹¬ç«‹çš„ç½‘ç»œ IP ä»¥åŠç®¡ç†æ§åˆ¶å®¹å™¨è¿è¡Œæ–¹å¼çš„ç­–ç•¥é€‰é¡¹ã€‚Pod ä¸­çš„æ¯ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼ˆåŒ…æ‹¬ IP ä¸ç«¯å£ï¼‰ï¼ŒPod å†…çš„å®¹å™¨å¯ä»¥ä½¿ç”¨ localhost ç›¸äº’é€šä¿¡ã€‚Pod å¯ä»¥æŒ‡å®šä¸€ç»„å…±äº«å­˜å‚¨å· Volumesï¼ŒPod ä¸­æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥è®¿é—®å…±äº«çš„ Volumesã€‚ </p>\n<p>é€šè¿‡ Podï¼Œç”¨æˆ·å°±å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ§åˆ¶å®¹å™¨ä¹‹é—´çš„éš”ç¦»æ€§ã€‚</p>\n<p>æœ‰äº† Pod ä½œä¸ºåŸºç¡€ä»¥åï¼ŒK8s å°±è¦å®ç°å®ƒæœ€é‡è¦çš„åŠŸèƒ½ï¼Œå¯¹å®¹å™¨çš„ç¼–æ’ç®¡ç†ã€‚å½“æœåŠ¡éœ€è¦æ‰©å®¹æ—¶ï¼ŒK8s éœ€è¦èƒ½å¤Ÿå¿«é€Ÿå¤åˆ¶ Podï¼Œå½“ Pod æŒ‚æ‰äº†ï¼ŒK8s éœ€è¦èƒ½å¤Ÿè‡ªåŠ¨é‡å¯ã€‚æ‰€ä»¥ K8s ç”±æ­¤è¡ç”Ÿå‡ºäº† ReplicaSet çš„æ¦‚å¿µã€‚</p>\n<h4 id=\"ReplicaSet\"><a href=\"#ReplicaSet\" class=\"headerlink\" title=\"ReplicaSet\"></a>ReplicaSet</h4><p>ReplicaSet ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰æŒ‰é…ç½®çš„ Pod å‰¯æœ¬æ•°åœ¨è¿è¡Œï¼Œé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨çš„æ–¹å¼å¯¹ Pod è¿›è¡Œç­›é€‰å’Œç®¡ç†ã€‚åœ¨æ—§çš„ç‰ˆæœ¬ä¸­è¿˜æœ‰ä¸€ä¸ª ReplicaController çš„æ¦‚å¿µï¼ŒRC ä¸ RS ä¸¤è€…åŠŸèƒ½å®Œå…¨ç›¸åŒï¼ŒåŒºåˆ«ä»…ä»…åœ¨äº RS å¯¹äº Pod çš„æ ‡ç­¾é€‰æ‹©å™¨æ›´åŠ å¼ºå¤§ã€‚</p>\n<p>å¼€å¤´æåˆ°äº† K8s ä½¿ç”¨å£°æ˜å¼çš„é…ç½®è‡ªåŠ¨å»ç®¡ç†å®¹å™¨ï¼Œè€Œ ReplicaSet çš„å†…å®¹å´å¤ªè¿‡å…·ä½“ï¼Œæ¶‰åŠåˆ°äº† Pod çš„å…·ä½“ç»´æŠ¤ç»†èŠ‚ã€‚æ‰€ä»¥ K8s åœ¨ ReplicaSet ä¹‹ä¸Šåˆè¡ç”Ÿå‡ºå£°æ˜å¼é…ç½®å®¹å™¨çš„æ¦‚å¿µï¼ŒDeploymentã€‚</p>\n<h4 id=\"Deployment\"><a href=\"#Deployment\" class=\"headerlink\" title=\"Deployment\"></a>Deployment</h4><p>Deployment ä¸º Pod ä¸ ReplicaSet æä¾›äº†å£°æ˜å¼çš„å®šä¹‰ï¼Œæè¿°ä½ æƒ³è¦çš„ç›®æ ‡çŠ¶æ€æ˜¯ä»€ä¹ˆï¼ŒDeployment controller å°±ä¼šå¸®ä½ å°† Pod ä¸ ReplicaSet çš„å®é™…çŠ¶æ€æ”¹å˜åˆ°ä½ æƒ³è¦çš„ç›®æ ‡çŠ¶æ€ã€‚</p>\n<p>ä»¥ fortune-teller ä¸ºä¾‹å­ï¼Œå¯ä»¥ç¼–å†™ä¸€ä»½ä¸‹é¢è¿™æ ·çš„ Deployment é…ç½®æ–‡ä»¶</p>\n<pre><code class=\"yaml\">apiVersion: apps/v1 # k8s apiç‰ˆæœ¬\nkind: Deployment # èµ„æºç±»å‹\nmetadata:\n  name: fortune-teller-app # deployment åå­—\n  namespace: default\nspec:\n  replicas: 1 # Pod å‰¯æœ¬æ•°é‡\n  selector:\n    matchLabels:\n      k8s-app: fortune-teller-app # ç®¡ç†æ ‡ç­¾ä¸­åŒ…å« k8s-app: fortune-teller-app çš„ Pod\n  template: # Pod æ¨¡æ¿\n    metadata:\n      labels:\n        k8s-app: fortune-teller-app # Pod æ ‡ç­¾\n    spec: # Pod é…ç½®\n      containers:\n      - image: quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n        imagePullPolicy: IfNotPresent\n        name: fortune-teller-app\n        ports:\n        - containerPort: 50051\n          name: grpc\n          protocol: TCP\n</code></pre>\n<p>å°†ä¸Šé¢çš„å†…å®¹ä¿å­˜åˆ°ä¸€ä»½ yaml æ–‡ä»¶ä¸­ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè®© K8s æ‰§è¡Œ yaml</p>\n<pre><code class=\"bash\">kubectl apply -f deployment.yaml\n</code></pre>\n<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°åˆšåˆšåˆ›å»ºçš„ deployment</p>\n<pre><code class=\"bash\">kubectl get deployement\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/8.png\"></p>\n<p>æ­¤æ—¶ï¼ŒK8s å·²ç»è‡ªåŠ¨æ ¹æ® deployment ä¸­é…ç½®çš„ Pod æ¨¡æ¿å’Œé…ç½®ï¼Œåˆ›å»ºäº† Podã€‚é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ° K8s è‡ªåŠ¨åˆ›å»ºçš„ Pod</p>\n<pre><code class=\"bash\">kubectl get pods\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/9.png\"></p>\n<p>å› ä¸º K8s é‡‡ç”¨å£°æ˜å¼çš„é…ç½®å»ç®¡ç† Podï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åŠ¨æ€åœ°å»ä¿®æ”¹ deployment çš„é…ç½®ï¼ŒK8s ä¼šè‡ªåŠ¨æ ¹æ®æ–°çš„é…ç½®å»ç®¡ç† Podã€‚</p>\n<pre><code class=\"bash\">kubectl edit deployment fortune-teller-app\n</code></pre>\n<p>æˆ‘ä»¬æŠŠé…ç½®æ–‡ä»¶ä¸­çš„å‰¯æœ¬æ•°é‡ä¿®æ”¹ä¸º 2</p>\n<p><img src=\"/asset/k8s-ramp-up/10.png\"></p>\n<p>ä¿å­˜é€€å‡ºåï¼Œæˆ‘ä»¬å†æ¬¡æ‰§è¡Œ kubectl get pods ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ° K8s æ ¹æ®æ–°çš„é…ç½®ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Pod</p>\n<p><img src=\"/asset/k8s-ramp-up/11.png\"></p>\n<p>ç°åœ¨æˆ‘ä»¬å°±æœ‰äº†ä¸¤ä¸ª fortune-teller çš„æœåŠ¡ã€‚åœ¨çœŸå®ç¯å¢ƒä¸­ï¼ŒPod çš„è°ƒåº¦ç”± K8s è¿›è¡Œç®¡ç†ï¼ŒæŸä¸ªæ—¶åˆ»æœåŠ¡å¯èƒ½åœ¨ Node1 ä¸Šï¼Œè€Œå¦ä¸€æ—¶åˆ»æœåŠ¡å¯èƒ½å°±è¢«è°ƒåº¦åˆ°äº† Node2 ä¸Šã€‚æ‰€ä»¥ï¼Œè®¿é—®å…·ä½“ Pod æ˜¯ä¸€ç§ä¸ç¨³å®šçš„æœåŠ¡è®¿é—®æ–¹æ³•ï¼Œè€Œä¸”ç›®å‰å¤§å¤šæ•°çš„åç«¯æœåŠ¡éƒ½æ˜¯æ— çŠ¶æ€çš„æœåŠ¡ï¼Œç›´æ¥è®¿é—® Pod ä¹Ÿå¯¼è‡´ä¸èƒ½è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚æ‰€ä»¥ï¼ŒK8s åœ¨æ­¤åŸºç¡€ä¸Šè¡ç”Ÿå‡º Service çš„æ¦‚å¿µã€‚</p>\n<h4 id=\"Service\"><a href=\"#Service\" class=\"headerlink\" title=\"Service\"></a>Service</h4><p>Service å¯ä»¥çœ‹åšä¸€ç»„æä¾›ç›¸åŒæœåŠ¡çš„ Pod çš„å¯¹å¤–è®¿é—®æ¥å£ã€‚Kubernetes æä¾›ä¸‰ç§ç±»å‹çš„ Serviceï¼š</p>\n<ul>\n<li>NodePortï¼š é›†ç¾¤å¤–éƒ¨å¯ä»¥é€šè¿‡ Node IP ä¸ Node Port æ¥è®¿é—®å…·ä½“æŸä¸ª Podï¼Œæ¯å°æœºå™¨ä¸Šéƒ½ä¼šæš´éœ²åŒæ ·çš„ç«¯å£</li>\n<li>ClusterIPï¼šæŒ‡é€šè¿‡é›†ç¾¤çš„å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼ŒæœåŠ¡åªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨å¯ä»¥è®¿é—®ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤çš„ ServiceType</li>\n<li>ExternalNameï¼šä¸æŒ‡å‘ Podï¼ŒæŒ‡å‘å¤–éƒ¨æœåŠ¡<br>Service å’Œ Deployment æ˜¯ä¸€å¯¹æ¯”è¾ƒå®¹æ˜“æ··æ·†çš„æ¦‚å¿µï¼Œä¸¤è€…éƒ½æ˜¯å¯¹ä¸€ç»„ Pod è¿›è¡Œç®¡ç†ï¼Œä½†å®ƒä»¬ä¸¤è€…ä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨ä¸‹é¢è¿™å¼ å›¾æ¥æ¦‚æ‹¬</li>\n</ul>\n<p><img src=\"/asset/k8s-ramp-up/12.png\"></p>\n<p>Service æ˜¯é¢å‘æœåŠ¡è°ƒç”¨è€…ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨è®¿é—® K8sã€‚è€Œ Deployment æ˜¯é¢å‘ K8s åº•å±‚å¼•æ“çš„ï¼Œé¢å‘å†…éƒ¨ç®¡ç†è€…ã€‚</p>\n<p>Service çš„é…ç½®æ–‡ä»¶æ ¼å¼ä¸ Deployment å¾ˆç±»ä¼¼</p>\n<pre><code class=\"yaml\">apiVersion: v1\nkind: Service\nmetadata:\n  name: fortune-teller-service\n  namespace: default\nspec:\n  ports:\n  - name: grpc\n    port: 50051\n    protocol: TCP\n    targetPort: 50051\n  selector:\n    k8s-app: fortune-teller-app\n  type: ClusterIP\n</code></pre>\n<p>åŒæ ·çš„ï¼Œæˆ‘ä»¬é€šè¿‡ kubectl apply -f service.yaml å‘½ä»¤ï¼Œå¯ä»¥åˆ›å»º Serviceã€‚é€šè¿‡ kubectl get service å¯ä»¥æŸ¥çœ‹åˆ°åˆšåˆšåˆ›å»ºçš„ Serviceã€‚</p>\n<p><img src=\"/asset/k8s-ramp-up/13.png\"></p>\n<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç™»é™†åˆ°ä¸€ä¸ª Pod é‡Œå»æµ‹è¯•ä¸€ä¸‹æ˜¯å¦å¯ä»¥è®¿é—®æœåŠ¡ã€‚<br>Netshoot é•œåƒä¸­åŒ…å«äº†ä¸€äº›ç½‘ç»œæµ‹è¯•çš„å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¿›å…¥ä¸€ä¸ª netshoot å®¹å™¨å†…æµ‹è¯•ã€‚é‡‡ç”¨ deployment çš„æ–¹å¼åˆ›å»º Pod</p>\n<pre><code class=\"yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: netshoot\n  namespace: default\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      k8s-app: netshoot\n  template:\n    metadata:\n      labels:\n        k8s-app: netshoot\n    spec:\n      containers:\n      - args:\n        - 1000d\n        command:\n        - /bin/sleep\n        image: nicolaka/netshoot\n        name: netshoot\n</code></pre>\n<p>ä¸ Docker çš„å‘½ä»¤ç±»ä¼¼ï¼Œä½¿ç”¨å‘½ä»¤ <code>kubectl cp grpcurl_1.6.0_linux_x86_64.tar.gz &lt;pod name&gt;:/</code> å¤åˆ¶å·¥å…·åˆ°å®¹å™¨å†…ã€‚</p>\n<p>å¤åˆ¶æˆåŠŸåï¼Œä½¿ç”¨å‘½ä»¤ kubectl exec -it <pod name> bash å¯ä»¥è¿›å…¥åˆ°å®¹å™¨å†…ã€‚</p>\n<p>è§£å‹</p>\n<pre><code class=\"bash\">cd /\ntar -zxf grpcurl_1.6.0_linux_x86_64.tar.gz\n</code></pre>\n<p>ç„¶åæˆ‘ä»¬å¯ä»¥æµ‹è¯•æ˜¯å¦å¯ä»¥ä» K8s é›†ç¾¤å†…è®¿é—® Serviceã€‚å¯¹äº K8s é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ï¼ŒK8s æœ‰è‡ªå·±çš„ DNS ç»„ä»¶ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡æœåŠ¡åè®¿é—®ã€‚</p>\n<pre><code class=\"bash\">./grpcurl -plaintext fortune-teller-service:50051 build.stack.fortune.FortuneTeller/Predict\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/14.png\"></p>\n<p>éªŒè¯æœåŠ¡å¯ä»¥ä»é›†ç¾¤å†…è®¿é—®ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦è§£å†³å¦‚ä½•ä»é›†ç¾¤å¤–è®¿é—®æœåŠ¡çš„é—®é¢˜ï¼Œæ¯•ç«Ÿå¤§å¤šæ•°æœåŠ¡æ˜¯é¢å‘ K8s é›†ç¾¤å¤–çš„ç”¨æˆ·çš„ã€‚å…¶å®ç›®å‰æˆ‘ä»¬å·²ç»äº†è§£äº†ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯ä½¿ç”¨ Nodeport ç±»å‹çš„ Serviceã€‚ä½†é‡‡ç”¨è¿™ç§æ–¹æ³•æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š</p>\n<ol>\n<li>æ¯ä¸ªç«¯å£åªèƒ½æ˜¯ä¸€ç§æœåŠ¡</li>\n<li>ç«¯å£èŒƒå›´åªèƒ½æ˜¯ 30000-32767</li>\n<li>å¦‚æœèŠ‚ç‚¹ çš„ IP åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œè°ƒç”¨æ–¹éœ€è¦èƒ½å¤Ÿå¯Ÿè§‰ã€‚<br>æ‰€ä»¥ï¼ŒK8s ä¸ºæœåŠ¡çš„å¤–éƒ¨è®¿é—®è·¯ç”±æä¾›äº†æ–°çš„ç±»å‹ Ingressã€‚</li>\n</ol>\n<h4 id=\"Ingress\"><a href=\"#Ingress\" class=\"headerlink\" title=\"Ingress\"></a>Ingress</h4><p>Ingress å…¶å®æ˜¯ä¸€ç§ç±»ä¼¼äºè·¯ç”±è¡¨ä¸€æ ·çš„é…ç½®ï¼Œå®é™…çš„è·¯ç”±å·¥ä½œéœ€è¦ Ingress Controller æ‰§è¡Œã€‚K8s æœ¬èº«å¹¶æ²¡æœ‰æä¾› Ingress Controllerï¼Œç›®å‰å¸¸ç”¨çš„æ˜¯é€šè¿‡ Nginx å®ç°çš„ç‰ˆæœ¬ <a href=\"https://github.com/kubernetes/ingress-nginx\">https://github.com/kubernetes/ingress-nginx</a> ã€‚å¯ä»¥ä½¿ç”¨ä¸Šé¢å‹ç¼©åŒ…ä¸­çš„ ingress-controller.yaml å®‰è£…</p>\n<p><img src=\"/asset/k8s-ramp-up/15.png\"></p>\n<p>Ingree nginx controller é€šè¿‡å®¿ä¸»æœºæš´éœ²ç»™å¤–éƒ¨è®¿é—®çš„ç«¯å£æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹ yamlï¼Œæ”¹æˆæˆ‘ä»¬åœ¨ä¸€å¼€å§‹åˆ›å»ºé›†ç¾¤æ—¶æ˜ å°„çš„ç«¯å£ã€‚</p>\n<p>é€šè¿‡ <code>kubectl get svc -n ingress-nginx</code> æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼Œæš´éœ²çš„æ˜¯ä¸¤ä¸ªéšæœºåˆ†é…çš„ç«¯å£</p>\n<p><img src=\"/asset/k8s-ramp-up/16.png\"></p>\n<p>æˆ‘ä»¬æ‰‹åŠ¨å°†å…¶æ”¹æˆ 32080 å’Œ 32443ã€‚</p>\n<p><img src=\"/asset/k8s-ramp-up/17.png\"></p>\n<p>Ingress nginx controller åŒæ ·æ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨çš„æ–¹å¼ç®¡ç† Ingressã€‚</p>\n<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Ingressï¼Œå°†å‘å¾€ Host fortune.bytedance.com çš„è¯·æ±‚è·¯ç”±åˆ° Service fortune-teller-serviceã€‚</p>\n<pre><code class=\"yaml\">apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/backend-protocol: GRPC\n  name: fortune-ingress\n  namespace: default\nspec:\n  rules:\n  - host: fortune.bytedance.com\n    http:\n      paths:\n      - backend:\n          serviceName: fortune-teller-service\n          servicePort: grpc\n</code></pre>\n<p>å®‰è£… Ingress</p>\n<pre><code class=\"bash\">kubectl apply -f ingress.yaml\nkubectl get ingress\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/18.png\"></p>\n<p>Ingress nginx controller å¯¹äº gRpc é»˜è®¤åªæ”¯æŒ SSL çš„å½¢å¼ï¼Œè€ŒFedlearner ä¸­çš„ controller åšäº†ä¸€äº›å®šåˆ¶åŒ–æ“ä½œï¼Œä½¿å¾—é€šè¿‡ 80 ç«¯å£ï¼Œåªä½¿ç”¨ HTTP2 ä¹Ÿå¯ä»¥è½¬å‘ gRpcã€‚è¯¦æƒ…å¯ä»¥å‚è€ƒ <a href=\"https://github.com/bytedance/ingress-nginx/pull/2/files\">https://github.com/bytedance/ingress-nginx/pull/2/files</a></p>\n<p>ä½¿ç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ä»å¤–éƒ¨è®¿é—®æœåŠ¡</p>\n<pre><code class=\"bash\">grpcurl -insecure -servername &#39;fortune.bytedance.com&#39; 0.0.0.0:32443 build.stack.fortune.FortuneTeller/Predict\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/19.png\"></p>\n<p>åˆšæ‰ä¹Ÿæåˆ°äº†ï¼ŒgRpc é€šå¸¸æ˜¯ä½¿ç”¨ SSL è¿›è¡ŒåŠ å¯†çš„ï¼ŒSSL çš„å…³é”®åœ¨äºå…¬é’¥ï¼Œç§é’¥ä»¥åŠè¯ä¹¦çš„éªŒè¯ã€‚é€šè¿‡æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼ç¡®å®å¯ä»¥å¤„ç†è¯ä¹¦çš„é—®é¢˜ï¼Œä½† K8s æŠ½è±¡å‡º Secret è¿™ç§èµ„æºï¼Œå¤§å¤§æé«˜äº†å¯¹è¿™ç±»æ–‡ä»¶çš„ç®¡ç†å’Œå¤ç”¨èƒ½åŠ›ã€‚</p>\n<h4 id=\"Secret\"><a href=\"#Secret\" class=\"headerlink\" title=\"Secret\"></a>Secret</h4><p>Secret è§£å†³äº†å¯†ç ã€tokenã€å¯†é’¥ç­‰æ•æ„Ÿæ•°æ®çš„å­˜å‚¨é—®é¢˜ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š</p>\n<ul>\n<li>Service Account ï¼šç”¨æ¥è®¿é—® Kubernetes APIï¼Œç”± Kubernetes è‡ªåŠ¨åˆ›å»ºï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„ / run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­</li>\n<li>Opaque ï¼šBase64 ç¼–ç æ ¼å¼çš„ Secretï¼Œç”¨æ¥å­˜å‚¨å¯†ç ã€å¯†é’¥ç­‰</li>\n<li>kubernetes.io/dockerconfigjson ï¼šç”¨æ¥å­˜å‚¨ docker registry çš„è®¤è¯ä¿¡æ¯</li>\n</ul>\n<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥åˆ›å»ºä¸€ä¸ª Opaque ç±»å‹çš„ Secretï¼Œä½¿å¾— ingress nginx controller æ”¯æŒæœåŠ¡ç«¯çš„ SSLã€‚<br>ç”±äºç¯‡å¹…æœ‰é™ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹è¯ä¹¦ç›¸å…³çš„æ¦‚å¿µï¼š</p>\n<ul>\n<li>CAï¼šè¯ä¹¦æˆæƒä¸­å¿ƒ(certificate authority)ï¼Œç”¨æ¥ç­¾å‘ç§é’¥ï¼Œå¹¶éªŒè¯å…¬é’¥ï¼Œç§é’¥çš„åˆæ³•æ€§</li>\n<li>ç§é’¥ï¼Œå…¬é’¥ï¼šç§é’¥ç”¨äºåŠ å¯†ï¼Œå…¬é’¥ç”¨äºè§£å¯†</li>\n</ul>\n<p>Secret æ”¯æŒä¸ç¼–å†™ yamlï¼Œç›´æ¥ä»æ–‡ä»¶ä¸­åˆ›å»º Secret</p>\n<pre><code class=\"bash\">kubectl create secret generic fortune-teller-ssl-verify \\\n  --from-file=ca.crt=CA.pem \\\n  --from-file=tls.crt=server-public.pem \\\n  --from-file=tls.key=server-private.key\n</code></pre>\n<p>ä¿®æ”¹ Ingressï¼Œä½¿å…¶ä½¿ç”¨æ–°åˆ›å»ºçš„ Secret æä¾›æœåŠ¡ä¾§çš„ SSLã€‚</p>\n<pre><code class=\"yaml\">apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/backend-protocol: GRPC\n  name: fortune-ingress\n  namespace: default\nspec:\n  rules:\n  - host: fortune.test.com\n    http:\n      paths:\n      - backend:\n          serviceName: fortune-teller-service\n          servicePort: grpc\n  tls:\n  - hosts:\n    - fortune.test.com\n    secretName: fortune-teller-ssl-verify\n</code></pre>\n<p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯è‡ªç­¾åçš„è¯ä¹¦ï¼Œä¸è¢«å…¬å…±çš„ CA æ‰€ä¿¡ä»»ï¼Œæ‰€ä»¥åœ¨å‘é€è¯·æ±‚æ˜¯éœ€è¦æ‰‹åŠ¨æŒ‡å®šè‡ªå·±æ‰€ä¿¡ä»»çš„ CAã€‚</p>\n<pre><code class=\"bash\">grpcurl -cacert CA.pem \\\n  -servername &#39;fortune.test.com&#39; \\\n  127.0.0.1:32443 \\\n  build.stack.fortune.FortuneTeller/Predict\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/20.png\"></p>\n<h2 id=\"å‚è€ƒ\"><a href=\"#å‚è€ƒ\" class=\"headerlink\" title=\"å‚è€ƒ\"></a>å‚è€ƒ</h2><ul>\n<li><a href=\"https://draveness.me/docker/\">https://draveness.me/docker/</a></li>\n<li><a href=\"https://www.yuque.com/kshare/2020/fe3b6f86-3b9b-48da-9770-897d838cbf41?language=zh-cn#Namespace\">https://www.yuque.com/kshare/2020/fe3b6f86-3b9b-48da-9770-897d838cbf41?language=zh-cn#Namespace</a></li>\n<li><a href=\"https://network.51cto.com/art/201907/598970.htm\">https://network.51cto.com/art/201907/598970.htm</a></li>\n<li><a href=\"https://blog.csdn.net/gatieme/article/details/51383322\">https://blog.csdn.net/gatieme/article/details/51383322</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"ç›®æ ‡\"><a href=\"#ç›®æ ‡\" class=\"headerlink\" title=\"ç›®æ ‡\"></a>ç›®æ ‡</h2><ul>\n<li>ä»‹ç» K8sï¼ŒDocker æ¦‚å¿µä»¥åŠåŸç†</li>\n<li>ä» 0 å¼€å§‹éƒ¨ç½²ä¸€ä¸ªç®€å•å®Œæ•´çš„æœåŠ¡</li>\n</ul>\n<h2 id=\"Dockeræ˜¯ä»€ä¹ˆï¼Ÿ\"><a href=\"#Dockeræ˜¯ä»€ä¹ˆï¼Ÿ\" class=\"headerlink\" title=\"Dockeræ˜¯ä»€ä¹ˆï¼Ÿ\"></a>Dockeræ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>Dockeræ˜¯ç”±Googleæ¨å‡ºçš„Goè¯­è¨€è¿›è¡Œå¼€å‘å®ç°ï¼ŒåŸºäºLinuxå†…æ ¸çš„ <font color=red>namespace</font>ï¼Œå¯¹<font color=red>è¿›ç¨‹</font>è¿›è¡Œå°è£…<font color=red>éš”ç¦»</font>ï¼Œå±äºæ“ä½œç³»ç»Ÿå±‚é¢çš„å®¹å™¨åŒ–æŠ€æœ¯ã€‚</p>\n<p><img src=\"/asset/k8s-ramp-up/1.png\"></p>\n<h3 id=\"ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ\"><a href=\"#ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ\" class=\"headerlink\" title=\"ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ\"></a>ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ</h3><p>é•œåƒï¼ˆImageï¼‰</p>\n<p>å®¹å™¨ï¼ˆContainerï¼‰</p>\n<p>ä»“åº“ï¼ˆRepositoryï¼‰</p>\n<p>ä»ä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œé•œåƒå°±åƒä¸€ä¸ªç±»ï¼›å®¹å™¨æ˜¯å¯¹è±¡å®ä¾‹ï¼Œè¿è¡Œæ—¶åœ¨ç³»ç»Ÿä¸­ä¼šæœ‰è®¸å¤šå®¹å™¨ï¼›ä»“åº“ä¸»è¦ç”¨äºå­˜å‚¨å’Œç»´æŠ¤è¿™äº›é•œåƒã€‚</p>\n<h3 id=\"ä¸ºä»€ä¹ˆä½¿ç”¨-Dockerï¼Ÿ\"><a href=\"#ä¸ºä»€ä¹ˆä½¿ç”¨-Dockerï¼Ÿ\" class=\"headerlink\" title=\"ä¸ºä»€ä¹ˆä½¿ç”¨ Dockerï¼Ÿ\"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ Dockerï¼Ÿ</h3><ul>\n<li>é…ç½®ç¯å¢ƒ<br>å¼€å‘è¿‡ç¨‹ä¸­ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯ç¯å¢ƒä¸€è‡´æ€§é—®é¢˜ã€‚ç”±äºå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´ï¼Œå¯¼è‡´æœ‰äº› bug å¹¶æœªåœ¨å¼€å‘è¿‡ç¨‹ä¸­è¢«å‘ç°ã€‚è€Œ Docker çš„é•œåƒæä¾›äº†é™¤å†…æ ¸å¤–å®Œæ•´çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œç¡®ä¿äº†åº”ç”¨è¿è¡Œç¯å¢ƒä¸€è‡´æ€§</li>\n<li>åº”ç”¨éš”ç¦»<br>æœºå™¨ä¸Šå¯èƒ½åŒæ—¶è¿è¡Œå¤šä¸ªæœåŠ¡ã€‚å¦‚æœæœåŠ¡ä¹‹é—´æ²¡æœ‰éš”ç¦»ï¼Œä¸€ä¸ªæœåŠ¡å‡ºç°å¼‚å¸¸ï¼Œå¾€å¾€å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–æœåŠ¡ä¹ŸæŒ‚æ‰ã€‚åŒæ—¶ï¼Œä¸åŒæœåŠ¡æ‰€ä¾èµ–çš„ç¯å¢ƒä¹Ÿå¯èƒ½å‘ç”Ÿå†²çªã€‚</li>\n</ul>\n<h3 id=\"åŸç†\"><a href=\"#åŸç†\" class=\"headerlink\" title=\"åŸç†\"></a>åŸç†</h3><p>é¦–å…ˆï¼Œè¦äº†è§£ä¸€ä¸‹è¿›ç¨‹çš„å‘½åç©ºé—´ã€‚Linux ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹æŒ‰ç…§æƒ¯ä¾‹æ˜¯é€šè¿‡PIDæ ‡è¯†çš„ï¼Œè¿™æ„å‘³ç€å†…æ ¸å¿…é¡»ç®¡ç†ä¸€ä¸ªå…¨å±€çš„PIDåˆ—è¡¨ã€‚è€Œä¸”ï¼Œæ‰€æœ‰è°ƒç”¨è€…é€šè¿‡unameç³»ç»Ÿè°ƒç”¨è¿”å›çš„ç³»ç»Ÿç›¸å…³ä¿¡æ¯ï¼ˆåŒ…æ‹¬ç³»ç»Ÿåç§°å’Œæœ‰å…³å†…æ ¸çš„ä¸€äº›ä¿¡æ¯ï¼‰éƒ½æ˜¯ç›¸åŒçš„ã€‚</p>\n<p>Linux çš„å‘½åç©ºé—´ä»å†…æ ¸å±‚é¢ä¸Šè¿›è¡Œäº†è™šæ‹ŸåŒ–ï¼Œå¯¹æ‰€æœ‰çš„å…¨å±€èµ„æºè¿›è¡Œä¸€ä¸ªæŠ½è±¡ã€‚æœ¬è´¨ä¸Šï¼Œå»ºç«‹äº†ç³»ç»Ÿçš„ä¸åŒè§†å›¾ã€‚æ¯ä¸€é¡¹å…¨å±€èµ„æºéƒ½å¿…é¡»åŒ…è£…åˆ°å‘½åç©ºé—´çš„æ•°æ®ç»“æ„ä¸­ï¼Œåªæœ‰èµ„æºå’ŒåŒ…å«èµ„æºçš„å‘½åç©ºé—´æ„æˆçš„äºŒå…ƒç»„ä»ç„¶æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚ä¸ä»…ä»…æ˜¯ PIDï¼ŒLinux é€šè¿‡åŒæ ·çš„æ–¹æ³•å¯¹å…¶ä»–èµ„æºä¹Ÿåšäº†è™šæ‹ŸåŒ–å¤„ç†ã€‚å‘½åç©ºé—´å…±æœ‰ä»¥ä¸‹6ç§ï¼š</p>\n<p><img src=\"/asset/k8s-ramp-up/2.png\"></p>\n<p>å€ŸåŠ© Linux çš„å‘½åç©ºé—´ï¼ŒDocker å¯¹è¿›ç¨‹è¿›è¡Œéš”ç¦»ï¼Œå¯ä»¥ä»è¿›ç¨‹æ ‘çš„è§’åº¦ç†è§£ã€‚</p>\n<p><img src=\"/asset/k8s-ramp-up/3.png\"></p>\n<p>æ¯æ¬¡åœ¨æ‰§è¡Œ <code>docker start</code> æˆ– <code>docker run</code> çš„æ—¶å€™ï¼Œå…¶å®æ˜¯ç”± docker çš„ daemon è¿›ç¨‹ docker containerdï¼Œè°ƒç”¨ Linux ç³»ç»Ÿè°ƒç”¨ <code>clone()</code> å»åˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚è€Œåˆ›å»ºè¿›ç¨‹çš„è¿‡ç¨‹ä¸­å°±ä¸ºæ–°åˆ›å»ºçš„è¿›ç¨‹åˆ†é…äº†æ–°çš„ Linux å‘½åç©ºé—´ã€‚å¯ä»¥ç®€å•é˜…è¯»ä¸€ä¸‹ docker çš„å¼€æºä»£ç </p>\n<pre><code class=\"go\">// https://github.com/moby/moby/blob/49e809fbfe250f3df2deacc0c3e5c403db3b8915/daemon/start.go#L17\n// åˆ›å»ºå®¹å™¨çš„å‡½æ•°ï¼Œå…¶ä¸­åˆè°ƒç”¨äº†è®¾ç½®\nfunc (daemon *Daemon) ContainerStart(name string, hostConfig *containertypes.HostConfig, checkpoint string, checkpointDir string) error\n\n// https://github.com/moby/moby/blob/470ae8422fc6f1845288eb7572253b08f1e6edf8/daemon/oci_linux.go#L212\n// è®¾ç½® Namespace\nfunc setNamespace(s *specs.Spec, ns specs.LinuxNamespace) &#123;\n   for i, n := range s.Linux.Namespaces &#123;\n      if n.Type == ns.Type &#123;\n         s.Linux.Namespaces[i] = ns\n         return\n      &#125;\n   &#125;\n   s.Linux.Namespaces = append(s.Linux.Namespaces, ns)\n&#125;\n\n// https://github.com/moby/moby/blob/49e809fbfe250f3df2deacc0c3e5c403db3b8915/daemon/start.go#L198\n// åˆ›å»ºæ–°çš„è¿›ç¨‹\npid, err := daemon.containerd.Start(context.Background(), \n                                    container.ID, \n                                    checkpointDir,    \n                                    container.StreamConfig.Stdin() != nil | | container.Config.Tty, \n                                    container.InitializeStdio)\n</code></pre>\n\n<h3 id=\"å¦‚ä½•å®‰è£…ï¼Ÿ\"><a href=\"#å¦‚ä½•å®‰è£…ï¼Ÿ\" class=\"headerlink\" title=\"å¦‚ä½•å®‰è£…ï¼Ÿ\"></a>å¦‚ä½•å®‰è£…ï¼Ÿ</h3><p><a href=\"https://docs.docker.com/get-docker/\">https://docs.docker.com/get-docker/</a></p>\n<h2 id=\"Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ\"><a href=\"#Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ\" class=\"headerlink\" title=\"Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ\"></a>Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>Kubernetes æ˜¯ Google äº 2014 å¹´åŸºäºå…¶å†…éƒ¨ Brog ç³»ç»Ÿå¼€æºçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’ç®¡ç†ç³»ç»Ÿï¼Œå¯ä½¿ç”¨å£°æ˜å¼çš„é…ç½®ï¼ˆä»¥ yaml æ–‡ä»¶çš„å½¢å¼ï¼‰è‡ªåŠ¨åœ°æ‰§è¡Œå®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„ç®¡ç†ï¼ŒåŒ…æ‹¬éƒ¨ç½²ã€ä¼¸ç¼©ã€è´Ÿè½½å‡è¡¡ã€å›æ»šç­‰ã€‚</p>\n<p>ä¸ºä»€ä¹ˆå« K8sï¼Ÿå› ä¸º K<font color=red>ubernete</font>sï¼Œä¸­é—´æ˜¯8ä¸ªå­—æ¯ã€‚</p>\n<p>kubernetes æä¾›çš„åŠŸèƒ½ï¼š</p>\n<ul>\n<li>è‡ªåŠ¨å‘å¸ƒä¸ä¼¸ç¼©ï¼šå¯ä»¥é€šè¿‡å£°æ˜å¼çš„é…ç½®æ–‡ä»¶å®šä¹‰æƒ³è¦éƒ¨ç½²çš„å®¹å™¨</li>\n<li>æ»šåŠ¨å‡çº§ä¸ç°åº¦å‘å¸ƒï¼šé‡‡ç”¨é€æ­¥æ›¿æ¢çš„ç­–ç•¥å®ç°æ»šåŠ¨å‡çº§</li>\n<li>æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼šKubernetes é€šè¿‡ DNS åç§°æˆ– IP åœ°å€æš´éœ²å®¹å™¨çš„è®¿é—®æ–¹å¼ï¼Œå¹¶ä¸”å¯åœ¨åŒä¸€å®¹å™¨ç»„å†…å®ç°è´Ÿè½½åˆ†å‘ä¸å‡è¡¡</li>\n<li>å­˜å‚¨ç¼–æ’ï¼šKubernetes å¯ä»¥è‡ªåŠ¨æŒ‚è½½æŒ‡å®šçš„å­˜å‚¨ç³»ç»Ÿï¼Œå¦‚ local storage/nfs / äº‘å­˜å‚¨ç­‰</li>\n<li>æ•…éšœæ¢å¤ï¼šKubernetes è‡ªåŠ¨é‡å¯å·²ç»åœæœºçš„å®¹å™¨ï¼Œæ›¿æ¢ä¸æ»¡è¶³å¥åº·æ£€æŸ¥çš„å®¹å™¨</li>\n<li>å¯†é’¥ä¸é…ç½®ç®¡ç†ï¼šKubernetes å¯ä»¥å­˜å‚¨ä¸ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ Docker Registry çš„ç™»å½•å‡­è¯ï¼Œå¯†ç ï¼Œssh å¯†é’¥ç­‰</li>\n</ul>\n<h3 id=\"ä¸ºä»€ä¹ˆä½¿ç”¨-K8sï¼Ÿ\"><a href=\"#ä¸ºä»€ä¹ˆä½¿ç”¨-K8sï¼Ÿ\" class=\"headerlink\" title=\"ä¸ºä»€ä¹ˆä½¿ç”¨ K8sï¼Ÿ\"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ K8sï¼Ÿ</h3><p>å¤§å‹å•ä½“åº”ç”¨è¢«é€æ¸æ‹†åˆ†æˆå°çš„ã€å¯ç‹¬ç«‹è¿è¡Œçš„ç»„ä»¶ã€‚éšç€éƒ¨ç½²ç»„ä»¶çš„å¢å¤šå’Œæ•°æ®ä¸­å¿ƒçš„å¢é•¿ï¼Œé…ç½®ã€ç®¡ç†å’Œè¿ç»´å˜å¾—å¾ˆå›°éš¾ã€‚(å¾®æœåŠ¡ï¼‰</p>\n<p>K8s çš„å®šä¹‰å°±æ˜¯å®¹å™¨ç¼–æ’å’Œç®¡ç†å¼•æ“ï¼Œè§£å†³äº†è¿™äº›é—®é¢˜ã€‚</p>\n<h3 id=\"å¦‚ä½•å®‰è£…ï¼Ÿ-1\"><a href=\"#å¦‚ä½•å®‰è£…ï¼Ÿ-1\" class=\"headerlink\" title=\"å¦‚ä½•å®‰è£…ï¼Ÿ\"></a>å¦‚ä½•å®‰è£…ï¼Ÿ</h3><p>ç”±éš¾åˆ°æ˜“(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§</p>\n<ul>\n<li>Kubeadm: <a href=\"https://kubernetes.io/docs/reference/setup-tools/kubeadm/\">https://kubernetes.io/docs/reference/setup-tools/kubeadm/</a></li>\n<li>MiniKube: Local kubernetes <a href=\"https://minikube.sigs.k8s.io/docs/start/\">https://minikube.sigs.k8s.io/docs/start/</a></li>\n<li>Kind: Kubernetes in Docker <a href=\"https://github.com/kubernetes-sigs/kind\">https://github.com/kubernetes-sigs/kind</a></li>\n<li>Docker-desktopï¼ˆä»…é™ Macï¼‰: ä¸€é”®å¼€å¯<br><img src=\"/asset/k8s-ramp-up/4.png\"></li>\n</ul>\n<p>å…¶ä»–ç‰ˆæœ¬çš„ç±» K8s ç³»ç»Ÿï¼š</p>\n<ul>\n<li>K3s: <a href=\"https://github.com/k3s-io/k3s\">https://github.com/k3s-io/k3s</a></li>\n<li>K0s: <a href=\"https://github.com/k0sproject/k0s\">https://github.com/k0sproject/k0s</a></li>\n</ul>\n<h2 id=\"Kubernetes-æ¶æ„\"><a href=\"#Kubernetes-æ¶æ„\" class=\"headerlink\" title=\"Kubernetes æ¶æ„\"></a>Kubernetes æ¶æ„</h2><p><img src=\"/asset/k8s-ramp-up/5.png\"></p>\n<h3 id=\"master\"><a href=\"#master\" class=\"headerlink\" title=\"master\"></a>master</h3><p>Master è´Ÿè´£ç®¡ç†æœåŠ¡æ¥å¯¹æ•´ä¸ªç³»ç»Ÿè¿›è¡Œç®¡ç†ä¸æ§åˆ¶ï¼ŒåŒ…æ‹¬</p>\n<ul>\n<li>apiserverï¼šä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„å¯¹å¤–æ¥å£ï¼Œæä¾›ä¸€å¥— Restful API ä¾›å®¢æˆ·ç«¯è°ƒç”¨ï¼Œä»»ä½•çš„èµ„æºè¯·æ±‚ / è°ƒç”¨æ“ä½œéƒ½æ˜¯é€šè¿‡ kube-apiserver æä¾›çš„æ¥å£è¿›è¡Œ, å¦‚ kubectlã€kubernetes dashboard ç­‰ç®¡ç†å·¥å…·å°±æ˜¯é€šè¿‡ apiserver æ¥å®ç°å¯¹é›†ç¾¤çš„ç®¡ç†</li>\n<li>kube-schedulerï¼šèµ„æºè°ƒåº¦å™¨ï¼Œè´Ÿè´£å°†å®¹å™¨ç»„åˆ†é…åˆ°å“ªäº›èŠ‚ç‚¹ä¸Š</li>\n<li>kube-controller-managerï¼šç®¡ç†æ§åˆ¶å™¨ï¼Œé›†ç¾¤ä¸­å¤„ç†å¸¸è§„ä»»åŠ¡çš„åå°çº¿ç¨‹ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆè´Ÿè´£ç›‘å¬èŠ‚ç‚¹åœæœºçš„äº‹ä»¶å¹¶ä½œå‡ºå¯¹åº”å“åº”ï¼‰ã€endpoint-controllerï¼ˆåˆ·æ–°æœåŠ¡ä¸å®¹å™¨ç»„çš„å…³è”ä¿¡æ¯ï¼‰ã€replication-controllerï¼ˆç»´æŠ¤å®¹å™¨ç»„çš„å‰¯æœ¬æ•°ä¸ºæŒ‡å®šçš„æ•°å€¼ï¼‰ã€Service Account &amp; Token æ§åˆ¶å™¨ï¼ˆè´Ÿè´£ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤çš„ Service Account ä»¥åŠ API Access Tokenï¼‰</li>\n<li>etcdï¼šæ•°æ®å­˜å‚¨ï¼Œå­˜å‚¨é›†ç¾¤æ‰€æœ‰çš„é…ç½®ä¿¡æ¯</li>\n<li>corednsï¼šå®ç°é›†ç¾¤å†…éƒ¨é€šè¿‡æœåŠ¡åç§°è¿›è¡Œå®¹å™¨ç»„è®¿é—®çš„åŠŸèƒ½</li>\n</ul>\n<h3 id=\"worker\"><a href=\"#worker\" class=\"headerlink\" title=\"worker\"></a>worker</h3><p>Worker è´Ÿè½½æ‰§è¡Œ Master åˆ†é…çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬</p>\n<ul>\n<li>kubeletï¼šæ˜¯å·¥ä½œèŠ‚ç‚¹ä¸Šæ‰§è¡Œæ“ä½œçš„ä»£ç†ç¨‹åºï¼Œè´Ÿè´£å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå®šæœŸæ‰§è¡Œå®¹å™¨å¥åº·æ£€æŸ¥ï¼Œå¹¶ä¸ŠæŠ¥å®¹å™¨çš„è¿è¡ŒçŠ¶æ€</li>\n<li>kube-proxyï¼šæ˜¯ä¸€ä¸ªå…·æœ‰è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„ç®€å•çš„ç½‘ç»œè®¿é—®ä»£ç†ï¼Œè´Ÿè´£å°†è®¿é—®æŸä¸ªæœåŠ¡çš„è¯·æ±‚åˆ†é…åˆ°å·¥ä½œèŠ‚ç‚¹çš„å…·ä½“æŸä¸ªå®¹å™¨ä¸Šï¼ˆkube-proxy ä¹Ÿè¿è¡Œäº master node ä¸Šï¼‰</li>\n<li>Docker Daemonï¼šKubernetes å…¶å®ä¸å±€é™äº Dockerï¼ˆå³å°†å–æ¶ˆï¼‰ï¼Œå®ƒæ”¯æŒä»»ä½•å®ç°äº† Kubernetes å®¹å™¨å¼•æ“æ¥å£çš„å®¹å™¨å¼•æ“ï¼Œå¦‚ containerdã€rktlet</li>\n</ul>\n<h3 id=\"ç½‘ç»œé€šä¿¡\"><a href=\"#ç½‘ç»œé€šä¿¡\" class=\"headerlink\" title=\"ç½‘ç»œé€šä¿¡\"></a>ç½‘ç»œé€šä¿¡</h3><p>ç½‘ç»œé€šä¿¡ç»„ä»¶åªéœ€è¦ç¬¦åˆ CNI ï¼ˆContainer Network Interfaceï¼‰æ¥å£è§„èŒƒï¼Œä¸»è¦ä½œç”¨åœ¨äºç»™å„ä¸ªå®¹å™¨åˆ†é…é›†ç¾¤å†… IPï¼Œä½¿å¾—å…¶å†…ç½‘ IP èƒ½å¤Ÿé›†ç¾¤å†…å”¯ä¸€ï¼Œå¹¶ä¸”å¯ä»¥äº’ç›¸è®¿é—®ï¼Œç›®å‰å¸¸ç”¨çš„æœ‰ Flannelï¼ŒCalicoç­‰ç½‘ç»œç»„ä»¶ã€‚</p>\n<p>ç®€å•ä»‹ç»ä¸‹æ¯”è¾ƒå¸¸ç”¨çš„ Flannel çš„åŸç†ã€‚Flannel è¿è¡Œåœ¨ç¬¬3å±‚ç½‘ç»œå±‚ï¼ŒåŸºäº IPv4ï¼Œåˆ›å»ºä¸€ä¸ªå¤§å‹å†…éƒ¨ç½‘ç»œï¼Œè·¨è¶Šé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹ç»„æˆä¸€ä¸ªå­ç½‘ï¼Œæ¯ä¸ªå®¹å™¨åœ¨å†…ç½‘ä¸­æœ‰å”¯ä¸€çš„IPã€‚</p>\n<p>é¦–å…ˆï¼ŒFlannel ä¼šä¸ºæ¯å°èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªå­ç½‘æ®µã€‚Flanneld åœ¨ Docker å®¹å™¨å¯åŠ¨æ—¶ä¿®æ”¹å…¶å¯åŠ¨å‚æ•°ï¼Œå°†å…¶ IP é™åˆ¶åœ¨å½“å‰çš„å­ç½‘æ®µå†…ï¼Œå…·ä½“ IP çš„åˆ†é…ä»æ˜¯ç”± docker è¿›è¡Œã€‚Flannelé€šè¿‡EtcdæœåŠ¡ç»´æŠ¤äº†ä¸€å¼ èŠ‚ç‚¹é—´çš„è·¯ç”±è¡¨ï¼Œè¯¦ç»†è®°å½•äº†å„èŠ‚ç‚¹å­ç½‘ç½‘æ®µï¼Œä¿è¯ä¸åŒèŠ‚ç‚¹çš„å­ç½‘ç½‘æ®µä¸ä¼šé‡å¤ã€‚</p>\n<p>æ•°æ®ä»æºå®¹å™¨ä¸­å‘å‡ºåï¼Œç»ç”±æ‰€åœ¨ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡è½¬å‘åˆ°flannel0è™šæ‹Ÿç½‘å¡ï¼ŒflanneldæœåŠ¡ç›‘å¬åœ¨ç½‘å¡çš„å¦å¤–ä¸€ç«¯ã€‚</p>\n<p>æºä¸»æœºçš„flanneldæœåŠ¡å°†åŸæœ¬çš„æ•°æ®å†…å®¹UDPå°è£…åæ ¹æ®è‡ªå·±çš„è·¯ç”±è¡¨æŠ•é€’ç»™ç›®çš„èŠ‚ç‚¹çš„flanneldæœåŠ¡ï¼Œæ•°æ®åˆ°è¾¾ä»¥åè¢«è§£åŒ…ï¼Œç„¶åç›´æ¥è¿›å…¥ç›®çš„èŠ‚ç‚¹çš„flannel0è™šæ‹Ÿç½‘å¡ï¼Œç„¶åè¢«è½¬å‘åˆ°ç›®çš„ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡ï¼Œæœ€åå°±åƒæœ¬æœºå®¹å™¨é€šä¿¡ä¸€ä¸‹çš„æœ‰docker0è·¯ç”±åˆ°è¾¾ç›®æ ‡å®¹å™¨ã€‚</p>\n<p><img src=\"/asset/k8s-ramp-up/6.png\"></p>\n<h2 id=\"å¿«é€Ÿä¸Šæ‰‹-K8s-æ¦‚å¿µ\"><a href=\"#å¿«é€Ÿä¸Šæ‰‹-K8s-æ¦‚å¿µ\" class=\"headerlink\" title=\"å¿«é€Ÿä¸Šæ‰‹ K8s æ¦‚å¿µ\"></a>å¿«é€Ÿä¸Šæ‰‹ K8s æ¦‚å¿µ</h2><p>ä¸€äº›æ¨èçš„ K8s æ¦‚å¿µä»‹ç»ï¼š</p>\n<ul>\n<li>å¾®è½¯çš„ 50å¤© K8s æ•™ç¨‹ä¸­ï¼ˆ<a href=\"https://azure.microsoft.com/en-us/resources/kubernetes-learning-path/%EF%BC%89%E9%80%9A%E8%BF%87%E5%8A%A8%E7%89%A9%E5%9B%AD%E7%9A%84%E5%BD%A2%E5%BC%8F%E4%BB%8B%E7%BB%8D%E4%BA%86%E4%B8%80%E4%BA%9B\">https://azure.microsoft.com/en-us/resources/kubernetes-learning-path/ï¼‰é€šè¿‡åŠ¨ç‰©å›­çš„å½¢å¼ä»‹ç»äº†ä¸€äº›</a> K8s æ¦‚å¿µ <a href=\"http://aka.ms/k8s/LearnwithPhippy\">http://aka.ms/k8s/LearnwithPhippy</a></li>\n<li>ç»¼è¿°PPTï¼š<a href=\"https://www2.slideshare.net/BobKillen/kubernetes-a-comprehensive-overview-updated?from_action=save\">https://www2.slideshare.net/BobKillen/kubernetes-a-comprehensive-overview-updated?from_action=save</a></li>\n</ul>\n<p>K8s ä¸­çš„æ¦‚å¿µæå¤šï¼Œæ¯”è¾ƒé›¶ç¢ï¼Œè¿™é‡Œé€šè¿‡ä¸€ä¸ªç®€å•çš„å°ä¾‹å­ï¼Œå°½å¯èƒ½è¦†ç›–å¤šçš„ K8s æ¦‚å¿µã€‚</p>\n<h2 id=\"æ¦‚è§ˆ\"><a href=\"#æ¦‚è§ˆ\" class=\"headerlink\" title=\"æ¦‚è§ˆ\"></a>æ¦‚è§ˆ</h2><p>ä¾‹å­ä½¿ç”¨ä¸€ä¸ªå¼€æºçš„ fortune-teller é•œåƒï¼ˆ<code>quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1</code>ï¼‰ ï¼Œæ¯æ¬¡è¯·æ±‚å®¹å™¨å†…çš„æœåŠ¡ï¼ŒæœåŠ¡ä¼šè¿”å›ä¸€å¥åè¨€ã€‚å¸Œæœ›åœ¨ MacOS çš„ç¯å¢ƒä¸‹ï¼Œå±•ç¤ºä¸€ä¸ªåº”ç”¨åœ¨ K8s ä¸­è¿è¡Œçš„å…¨æµç¨‹ã€‚</p>\n<p>å‡†å¤‡ç¯å¢ƒ<br>ä¸ºäº†ä¸å½±å“å¤§å®¶æœ¬åœ°çš„ç¯å¢ƒï¼Œè¿™é‡Œä½¿ç”¨ Kind åˆ›å»ºå‡ºä¸€ä¸ªç‹¬ç«‹çš„ K8s é›†ç¾¤ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç‰ˆæœ¬å¹¶ä¸”å¯ä»¥åœ¨å®Œæˆå¿«é€Ÿæ¸…ç†æ‰ã€‚(Docker åŒé‡éš”ç¦»ï¼‰</p>\n<ol>\n<li><p>å®‰è£… Kind ä»¥åŠ gRpc æµ‹è¯•å·¥å…·</p>\n<pre><code class=\"bash\">brew install kind\nbrew install grpcurl\n</code></pre>\n</li>\n<li><p>æ‹‰å–é•œåƒ</p>\n<pre><code class=\"bash\">docker pull kindest/node:v1.16.15\ndocker pull quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n</code></pre>\n</li>\n<li><p>åˆ›å»º K8s é›†ç¾¤ï¼Œå› ä¸º Kind æ˜¯åœ¨ Docker å®¹å™¨é‡Œé¢åˆ›å»ºçš„ K8sï¼Œæ‰€ä»¥å®¿ä¸»æœºè®¿é—®ï¼Œéœ€è¦æŠŠç«¯å£æš´éœ²å‡ºæ¥ã€‚Kind ä¼šé»˜è®¤æŠŠ K8s apiserver çš„ç«¯å£æš´éœ²å‡ºæ¥ï¼Œç”¨æ¥ç»™ kubectl å‘½ä»¤ä½¿ç”¨ã€‚ä½†ä¸ºäº†ä¹‹åçš„æµ‹è¯•ï¼Œæˆ‘ä»¬æå‰æŠŠå‡ ä¸ªç«¯å£åœ¨åˆ›å»ºçš„æ—¶å€™å°±æš´éœ²å‡ºæ¥ã€‚</p>\n</li>\n</ol>\n<p>Kind åŒæ ·æ”¯æŒé€šè¿‡yaml çš„å½¢å¼åˆ›å»ºé›†ç¾¤</p>\n<pre><code class=\"yaml\">kind: Cluster\napiVersion: kind.x-k8s.io/v1alpha4\nnodes:\n- role: control-plane\n  extraPortMappings:\n  - containerPort: 32080\n    hostPort: 32080\n  - containerPort: 32443\n    hostPort: 32443\n</code></pre>\n<pre><code class=\"bash\">kind create cluster --name=fortune-teller --image=kindest/node:v1.16.15 --config kind-config.yaml\n</code></pre>\n<h3 id=\"è¿è¡Œ-Docker-ç‰ˆæœ¬\"><a href=\"#è¿è¡Œ-Docker-ç‰ˆæœ¬\" class=\"headerlink\" title=\"è¿è¡Œ Docker ç‰ˆæœ¬\"></a>è¿è¡Œ Docker ç‰ˆæœ¬</h3><ol>\n<li>å¯åŠ¨å®¹å™¨<pre><code class=\"bash\">docker run -p 50051:50051 quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n</code></pre>\n</li>\n</ol>\n<p><code>-p</code> å°†å®¹å™¨å†…çš„ 50051 ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„ 50051 ç«¯å£</p>\n<ol start=\"2\">\n<li>æµ‹è¯•åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œç¬¬ä¸€æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦ç»™ grpcurl å¼€å¯æƒé™<pre><code class=\"bash\">grpcurl -plaintext 127.0.0.1:50051 build.stack.fortune.FortuneTeller/Predict\n</code></pre>\n</li>\n</ol>\n<p>åº”ç”¨åœ¨æ”¶åˆ°è¯·æ±‚ä»¥åï¼Œä¼šè¿”å›ä¸€å¥åè¨€</p>\n<p><img src=\"/asset/k8s-ramp-up/7.png\"></p>\n<h3 id=\"å°†åº”ç”¨ä»-Docker-è¿ç§»åˆ°-K8s-ä¸­\"><a href=\"#å°†åº”ç”¨ä»-Docker-è¿ç§»åˆ°-K8s-ä¸­\" class=\"headerlink\" title=\"å°†åº”ç”¨ä» Docker è¿ç§»åˆ° K8s ä¸­\"></a>å°†åº”ç”¨ä» Docker è¿ç§»åˆ° K8s ä¸­</h3><p>ä¸ Docker ä¸­å®¹å™¨æ¦‚å¿µç›¸å¯¹åº”çš„ï¼ŒK8s ä¸­ä¹Ÿæœ‰ç€å®¹å™¨çš„æ¦‚å¿µã€‚å¯¹äºè™šæ‹ŸåŒ–çš„å®¹å™¨æ¥è¯´ï¼Œæœ€ä½³å®è·µæ˜¯ä¸€ä¸ªå®¹å™¨ä¸€ä¸ªåº”ç”¨ï¼Œä½†å½“ä¸€ä¸ªæœåŠ¡éœ€è¦å¤šä¸ªåº”ç”¨ç»„åˆå®Œæˆæ—¶ï¼Œç®€å•çš„å°†å¤šä¸ªåº”ç”¨éƒ¨ç½²åˆ°ä¸€ä¸ªå®¹å™¨å†…ï¼Œå°±ç ´åäº†åº”ç”¨ä¹‹é—´çš„éš”ç¦»æ€§ï¼Œæ‰€ä»¥ K8s å¯¹äºå®¹å™¨è¿›è¡Œäº†ä¸€å±‚å°è£…ï¼Œå½¢æˆäº† Pod çš„æ¦‚å¿µã€‚</p>\n<h4 id=\"Pod\"><a href=\"#Pod\" class=\"headerlink\" title=\"Pod\"></a>Pod</h4><p>Pod æ˜¯ Kubernetes åˆ›å»ºæˆ–éƒ¨ç½²çš„æœ€å°åŸºæœ¬å•å…ƒã€‚ä¸€ä¸ª Pod å°è£…ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨å®¹å™¨ã€å­˜å‚¨èµ„æºã€ä¸€ä¸ªç‹¬ç«‹çš„ç½‘ç»œ IP ä»¥åŠç®¡ç†æ§åˆ¶å®¹å™¨è¿è¡Œæ–¹å¼çš„ç­–ç•¥é€‰é¡¹ã€‚Pod ä¸­çš„æ¯ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼ˆåŒ…æ‹¬ IP ä¸ç«¯å£ï¼‰ï¼ŒPod å†…çš„å®¹å™¨å¯ä»¥ä½¿ç”¨ localhost ç›¸äº’é€šä¿¡ã€‚Pod å¯ä»¥æŒ‡å®šä¸€ç»„å…±äº«å­˜å‚¨å· Volumesï¼ŒPod ä¸­æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥è®¿é—®å…±äº«çš„ Volumesã€‚ </p>\n<p>é€šè¿‡ Podï¼Œç”¨æˆ·å°±å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ§åˆ¶å®¹å™¨ä¹‹é—´çš„éš”ç¦»æ€§ã€‚</p>\n<p>æœ‰äº† Pod ä½œä¸ºåŸºç¡€ä»¥åï¼ŒK8s å°±è¦å®ç°å®ƒæœ€é‡è¦çš„åŠŸèƒ½ï¼Œå¯¹å®¹å™¨çš„ç¼–æ’ç®¡ç†ã€‚å½“æœåŠ¡éœ€è¦æ‰©å®¹æ—¶ï¼ŒK8s éœ€è¦èƒ½å¤Ÿå¿«é€Ÿå¤åˆ¶ Podï¼Œå½“ Pod æŒ‚æ‰äº†ï¼ŒK8s éœ€è¦èƒ½å¤Ÿè‡ªåŠ¨é‡å¯ã€‚æ‰€ä»¥ K8s ç”±æ­¤è¡ç”Ÿå‡ºäº† ReplicaSet çš„æ¦‚å¿µã€‚</p>\n<h4 id=\"ReplicaSet\"><a href=\"#ReplicaSet\" class=\"headerlink\" title=\"ReplicaSet\"></a>ReplicaSet</h4><p>ReplicaSet ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰æŒ‰é…ç½®çš„ Pod å‰¯æœ¬æ•°åœ¨è¿è¡Œï¼Œé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨çš„æ–¹å¼å¯¹ Pod è¿›è¡Œç­›é€‰å’Œç®¡ç†ã€‚åœ¨æ—§çš„ç‰ˆæœ¬ä¸­è¿˜æœ‰ä¸€ä¸ª ReplicaController çš„æ¦‚å¿µï¼ŒRC ä¸ RS ä¸¤è€…åŠŸèƒ½å®Œå…¨ç›¸åŒï¼ŒåŒºåˆ«ä»…ä»…åœ¨äº RS å¯¹äº Pod çš„æ ‡ç­¾é€‰æ‹©å™¨æ›´åŠ å¼ºå¤§ã€‚</p>\n<p>å¼€å¤´æåˆ°äº† K8s ä½¿ç”¨å£°æ˜å¼çš„é…ç½®è‡ªåŠ¨å»ç®¡ç†å®¹å™¨ï¼Œè€Œ ReplicaSet çš„å†…å®¹å´å¤ªè¿‡å…·ä½“ï¼Œæ¶‰åŠåˆ°äº† Pod çš„å…·ä½“ç»´æŠ¤ç»†èŠ‚ã€‚æ‰€ä»¥ K8s åœ¨ ReplicaSet ä¹‹ä¸Šåˆè¡ç”Ÿå‡ºå£°æ˜å¼é…ç½®å®¹å™¨çš„æ¦‚å¿µï¼ŒDeploymentã€‚</p>\n<h4 id=\"Deployment\"><a href=\"#Deployment\" class=\"headerlink\" title=\"Deployment\"></a>Deployment</h4><p>Deployment ä¸º Pod ä¸ ReplicaSet æä¾›äº†å£°æ˜å¼çš„å®šä¹‰ï¼Œæè¿°ä½ æƒ³è¦çš„ç›®æ ‡çŠ¶æ€æ˜¯ä»€ä¹ˆï¼ŒDeployment controller å°±ä¼šå¸®ä½ å°† Pod ä¸ ReplicaSet çš„å®é™…çŠ¶æ€æ”¹å˜åˆ°ä½ æƒ³è¦çš„ç›®æ ‡çŠ¶æ€ã€‚</p>\n<p>ä»¥ fortune-teller ä¸ºä¾‹å­ï¼Œå¯ä»¥ç¼–å†™ä¸€ä»½ä¸‹é¢è¿™æ ·çš„ Deployment é…ç½®æ–‡ä»¶</p>\n<pre><code class=\"yaml\">apiVersion: apps/v1 # k8s apiç‰ˆæœ¬\nkind: Deployment # èµ„æºç±»å‹\nmetadata:\n  name: fortune-teller-app # deployment åå­—\n  namespace: default\nspec:\n  replicas: 1 # Pod å‰¯æœ¬æ•°é‡\n  selector:\n    matchLabels:\n      k8s-app: fortune-teller-app # ç®¡ç†æ ‡ç­¾ä¸­åŒ…å« k8s-app: fortune-teller-app çš„ Pod\n  template: # Pod æ¨¡æ¿\n    metadata:\n      labels:\n        k8s-app: fortune-teller-app # Pod æ ‡ç­¾\n    spec: # Pod é…ç½®\n      containers:\n      - image: quay.io/kubernetes-ingress-controller/grpc-fortune-teller:0.1\n        imagePullPolicy: IfNotPresent\n        name: fortune-teller-app\n        ports:\n        - containerPort: 50051\n          name: grpc\n          protocol: TCP\n</code></pre>\n<p>å°†ä¸Šé¢çš„å†…å®¹ä¿å­˜åˆ°ä¸€ä»½ yaml æ–‡ä»¶ä¸­ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè®© K8s æ‰§è¡Œ yaml</p>\n<pre><code class=\"bash\">kubectl apply -f deployment.yaml\n</code></pre>\n<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°åˆšåˆšåˆ›å»ºçš„ deployment</p>\n<pre><code class=\"bash\">kubectl get deployement\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/8.png\"></p>\n<p>æ­¤æ—¶ï¼ŒK8s å·²ç»è‡ªåŠ¨æ ¹æ® deployment ä¸­é…ç½®çš„ Pod æ¨¡æ¿å’Œé…ç½®ï¼Œåˆ›å»ºäº† Podã€‚é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ° K8s è‡ªåŠ¨åˆ›å»ºçš„ Pod</p>\n<pre><code class=\"bash\">kubectl get pods\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/9.png\"></p>\n<p>å› ä¸º K8s é‡‡ç”¨å£°æ˜å¼çš„é…ç½®å»ç®¡ç† Podï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åŠ¨æ€åœ°å»ä¿®æ”¹ deployment çš„é…ç½®ï¼ŒK8s ä¼šè‡ªåŠ¨æ ¹æ®æ–°çš„é…ç½®å»ç®¡ç† Podã€‚</p>\n<pre><code class=\"bash\">kubectl edit deployment fortune-teller-app\n</code></pre>\n<p>æˆ‘ä»¬æŠŠé…ç½®æ–‡ä»¶ä¸­çš„å‰¯æœ¬æ•°é‡ä¿®æ”¹ä¸º 2</p>\n<p><img src=\"/asset/k8s-ramp-up/10.png\"></p>\n<p>ä¿å­˜é€€å‡ºåï¼Œæˆ‘ä»¬å†æ¬¡æ‰§è¡Œ kubectl get pods ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ° K8s æ ¹æ®æ–°çš„é…ç½®ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Pod</p>\n<p><img src=\"/asset/k8s-ramp-up/11.png\"></p>\n<p>ç°åœ¨æˆ‘ä»¬å°±æœ‰äº†ä¸¤ä¸ª fortune-teller çš„æœåŠ¡ã€‚åœ¨çœŸå®ç¯å¢ƒä¸­ï¼ŒPod çš„è°ƒåº¦ç”± K8s è¿›è¡Œç®¡ç†ï¼ŒæŸä¸ªæ—¶åˆ»æœåŠ¡å¯èƒ½åœ¨ Node1 ä¸Šï¼Œè€Œå¦ä¸€æ—¶åˆ»æœåŠ¡å¯èƒ½å°±è¢«è°ƒåº¦åˆ°äº† Node2 ä¸Šã€‚æ‰€ä»¥ï¼Œè®¿é—®å…·ä½“ Pod æ˜¯ä¸€ç§ä¸ç¨³å®šçš„æœåŠ¡è®¿é—®æ–¹æ³•ï¼Œè€Œä¸”ç›®å‰å¤§å¤šæ•°çš„åç«¯æœåŠ¡éƒ½æ˜¯æ— çŠ¶æ€çš„æœåŠ¡ï¼Œç›´æ¥è®¿é—® Pod ä¹Ÿå¯¼è‡´ä¸èƒ½è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚æ‰€ä»¥ï¼ŒK8s åœ¨æ­¤åŸºç¡€ä¸Šè¡ç”Ÿå‡º Service çš„æ¦‚å¿µã€‚</p>\n<h4 id=\"Service\"><a href=\"#Service\" class=\"headerlink\" title=\"Service\"></a>Service</h4><p>Service å¯ä»¥çœ‹åšä¸€ç»„æä¾›ç›¸åŒæœåŠ¡çš„ Pod çš„å¯¹å¤–è®¿é—®æ¥å£ã€‚Kubernetes æä¾›ä¸‰ç§ç±»å‹çš„ Serviceï¼š</p>\n<ul>\n<li>NodePortï¼š é›†ç¾¤å¤–éƒ¨å¯ä»¥é€šè¿‡ Node IP ä¸ Node Port æ¥è®¿é—®å…·ä½“æŸä¸ª Podï¼Œæ¯å°æœºå™¨ä¸Šéƒ½ä¼šæš´éœ²åŒæ ·çš„ç«¯å£</li>\n<li>ClusterIPï¼šæŒ‡é€šè¿‡é›†ç¾¤çš„å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼ŒæœåŠ¡åªèƒ½å¤Ÿåœ¨é›†ç¾¤å†…éƒ¨å¯ä»¥è®¿é—®ï¼Œè¿™ä¹Ÿæ˜¯é»˜è®¤çš„ ServiceType</li>\n<li>ExternalNameï¼šä¸æŒ‡å‘ Podï¼ŒæŒ‡å‘å¤–éƒ¨æœåŠ¡<br>Service å’Œ Deployment æ˜¯ä¸€å¯¹æ¯”è¾ƒå®¹æ˜“æ··æ·†çš„æ¦‚å¿µï¼Œä¸¤è€…éƒ½æ˜¯å¯¹ä¸€ç»„ Pod è¿›è¡Œç®¡ç†ï¼Œä½†å®ƒä»¬ä¸¤è€…ä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨ä¸‹é¢è¿™å¼ å›¾æ¥æ¦‚æ‹¬</li>\n</ul>\n<p><img src=\"/asset/k8s-ramp-up/12.png\"></p>\n<p>Service æ˜¯é¢å‘æœåŠ¡è°ƒç”¨è€…ï¼Œä¹Ÿå°±æ˜¯å¤–éƒ¨è®¿é—® K8sã€‚è€Œ Deployment æ˜¯é¢å‘ K8s åº•å±‚å¼•æ“çš„ï¼Œé¢å‘å†…éƒ¨ç®¡ç†è€…ã€‚</p>\n<p>Service çš„é…ç½®æ–‡ä»¶æ ¼å¼ä¸ Deployment å¾ˆç±»ä¼¼</p>\n<pre><code class=\"yaml\">apiVersion: v1\nkind: Service\nmetadata:\n  name: fortune-teller-service\n  namespace: default\nspec:\n  ports:\n  - name: grpc\n    port: 50051\n    protocol: TCP\n    targetPort: 50051\n  selector:\n    k8s-app: fortune-teller-app\n  type: ClusterIP\n</code></pre>\n<p>åŒæ ·çš„ï¼Œæˆ‘ä»¬é€šè¿‡ kubectl apply -f service.yaml å‘½ä»¤ï¼Œå¯ä»¥åˆ›å»º Serviceã€‚é€šè¿‡ kubectl get service å¯ä»¥æŸ¥çœ‹åˆ°åˆšåˆšåˆ›å»ºçš„ Serviceã€‚</p>\n<p><img src=\"/asset/k8s-ramp-up/13.png\"></p>\n<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç™»é™†åˆ°ä¸€ä¸ª Pod é‡Œå»æµ‹è¯•ä¸€ä¸‹æ˜¯å¦å¯ä»¥è®¿é—®æœåŠ¡ã€‚<br>Netshoot é•œåƒä¸­åŒ…å«äº†ä¸€äº›ç½‘ç»œæµ‹è¯•çš„å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¿›å…¥ä¸€ä¸ª netshoot å®¹å™¨å†…æµ‹è¯•ã€‚é‡‡ç”¨ deployment çš„æ–¹å¼åˆ›å»º Pod</p>\n<pre><code class=\"yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: netshoot\n  namespace: default\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      k8s-app: netshoot\n  template:\n    metadata:\n      labels:\n        k8s-app: netshoot\n    spec:\n      containers:\n      - args:\n        - 1000d\n        command:\n        - /bin/sleep\n        image: nicolaka/netshoot\n        name: netshoot\n</code></pre>\n<p>ä¸ Docker çš„å‘½ä»¤ç±»ä¼¼ï¼Œä½¿ç”¨å‘½ä»¤ <code>kubectl cp grpcurl_1.6.0_linux_x86_64.tar.gz &lt;pod name&gt;:/</code> å¤åˆ¶å·¥å…·åˆ°å®¹å™¨å†…ã€‚</p>\n<p>å¤åˆ¶æˆåŠŸåï¼Œä½¿ç”¨å‘½ä»¤ kubectl exec -it <pod name> bash å¯ä»¥è¿›å…¥åˆ°å®¹å™¨å†…ã€‚</p>\n<p>è§£å‹</p>\n<pre><code class=\"bash\">cd /\ntar -zxf grpcurl_1.6.0_linux_x86_64.tar.gz\n</code></pre>\n<p>ç„¶åæˆ‘ä»¬å¯ä»¥æµ‹è¯•æ˜¯å¦å¯ä»¥ä» K8s é›†ç¾¤å†…è®¿é—® Serviceã€‚å¯¹äº K8s é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ï¼ŒK8s æœ‰è‡ªå·±çš„ DNS ç»„ä»¶ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡æœåŠ¡åè®¿é—®ã€‚</p>\n<pre><code class=\"bash\">./grpcurl -plaintext fortune-teller-service:50051 build.stack.fortune.FortuneTeller/Predict\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/14.png\"></p>\n<p>éªŒè¯æœåŠ¡å¯ä»¥ä»é›†ç¾¤å†…è®¿é—®ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦è§£å†³å¦‚ä½•ä»é›†ç¾¤å¤–è®¿é—®æœåŠ¡çš„é—®é¢˜ï¼Œæ¯•ç«Ÿå¤§å¤šæ•°æœåŠ¡æ˜¯é¢å‘ K8s é›†ç¾¤å¤–çš„ç”¨æˆ·çš„ã€‚å…¶å®ç›®å‰æˆ‘ä»¬å·²ç»äº†è§£äº†ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå°±æ˜¯ä½¿ç”¨ Nodeport ç±»å‹çš„ Serviceã€‚ä½†é‡‡ç”¨è¿™ç§æ–¹æ³•æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š</p>\n<ol>\n<li>æ¯ä¸ªç«¯å£åªèƒ½æ˜¯ä¸€ç§æœåŠ¡</li>\n<li>ç«¯å£èŒƒå›´åªèƒ½æ˜¯ 30000-32767</li>\n<li>å¦‚æœèŠ‚ç‚¹ çš„ IP åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œè°ƒç”¨æ–¹éœ€è¦èƒ½å¤Ÿå¯Ÿè§‰ã€‚<br>æ‰€ä»¥ï¼ŒK8s ä¸ºæœåŠ¡çš„å¤–éƒ¨è®¿é—®è·¯ç”±æä¾›äº†æ–°çš„ç±»å‹ Ingressã€‚</li>\n</ol>\n<h4 id=\"Ingress\"><a href=\"#Ingress\" class=\"headerlink\" title=\"Ingress\"></a>Ingress</h4><p>Ingress å…¶å®æ˜¯ä¸€ç§ç±»ä¼¼äºè·¯ç”±è¡¨ä¸€æ ·çš„é…ç½®ï¼Œå®é™…çš„è·¯ç”±å·¥ä½œéœ€è¦ Ingress Controller æ‰§è¡Œã€‚K8s æœ¬èº«å¹¶æ²¡æœ‰æä¾› Ingress Controllerï¼Œç›®å‰å¸¸ç”¨çš„æ˜¯é€šè¿‡ Nginx å®ç°çš„ç‰ˆæœ¬ <a href=\"https://github.com/kubernetes/ingress-nginx\">https://github.com/kubernetes/ingress-nginx</a> ã€‚å¯ä»¥ä½¿ç”¨ä¸Šé¢å‹ç¼©åŒ…ä¸­çš„ ingress-controller.yaml å®‰è£…</p>\n<p><img src=\"/asset/k8s-ramp-up/15.png\"></p>\n<p>Ingree nginx controller é€šè¿‡å®¿ä¸»æœºæš´éœ²ç»™å¤–éƒ¨è®¿é—®çš„ç«¯å£æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹ yamlï¼Œæ”¹æˆæˆ‘ä»¬åœ¨ä¸€å¼€å§‹åˆ›å»ºé›†ç¾¤æ—¶æ˜ å°„çš„ç«¯å£ã€‚</p>\n<p>é€šè¿‡ <code>kubectl get svc -n ingress-nginx</code> æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼Œæš´éœ²çš„æ˜¯ä¸¤ä¸ªéšæœºåˆ†é…çš„ç«¯å£</p>\n<p><img src=\"/asset/k8s-ramp-up/16.png\"></p>\n<p>æˆ‘ä»¬æ‰‹åŠ¨å°†å…¶æ”¹æˆ 32080 å’Œ 32443ã€‚</p>\n<p><img src=\"/asset/k8s-ramp-up/17.png\"></p>\n<p>Ingress nginx controller åŒæ ·æ˜¯é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨çš„æ–¹å¼ç®¡ç† Ingressã€‚</p>\n<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ Ingressï¼Œå°†å‘å¾€ Host fortune.bytedance.com çš„è¯·æ±‚è·¯ç”±åˆ° Service fortune-teller-serviceã€‚</p>\n<pre><code class=\"yaml\">apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/backend-protocol: GRPC\n  name: fortune-ingress\n  namespace: default\nspec:\n  rules:\n  - host: fortune.bytedance.com\n    http:\n      paths:\n      - backend:\n          serviceName: fortune-teller-service\n          servicePort: grpc\n</code></pre>\n<p>å®‰è£… Ingress</p>\n<pre><code class=\"bash\">kubectl apply -f ingress.yaml\nkubectl get ingress\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/18.png\"></p>\n<p>Ingress nginx controller å¯¹äº gRpc é»˜è®¤åªæ”¯æŒ SSL çš„å½¢å¼ï¼Œè€ŒFedlearner ä¸­çš„ controller åšäº†ä¸€äº›å®šåˆ¶åŒ–æ“ä½œï¼Œä½¿å¾—é€šè¿‡ 80 ç«¯å£ï¼Œåªä½¿ç”¨ HTTP2 ä¹Ÿå¯ä»¥è½¬å‘ gRpcã€‚è¯¦æƒ…å¯ä»¥å‚è€ƒ <a href=\"https://github.com/bytedance/ingress-nginx/pull/2/files\">https://github.com/bytedance/ingress-nginx/pull/2/files</a></p>\n<p>ä½¿ç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ä»å¤–éƒ¨è®¿é—®æœåŠ¡</p>\n<pre><code class=\"bash\">grpcurl -insecure -servername &#39;fortune.bytedance.com&#39; 0.0.0.0:32443 build.stack.fortune.FortuneTeller/Predict\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/19.png\"></p>\n<p>åˆšæ‰ä¹Ÿæåˆ°äº†ï¼ŒgRpc é€šå¸¸æ˜¯ä½¿ç”¨ SSL è¿›è¡ŒåŠ å¯†çš„ï¼ŒSSL çš„å…³é”®åœ¨äºå…¬é’¥ï¼Œç§é’¥ä»¥åŠè¯ä¹¦çš„éªŒè¯ã€‚é€šè¿‡æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼ç¡®å®å¯ä»¥å¤„ç†è¯ä¹¦çš„é—®é¢˜ï¼Œä½† K8s æŠ½è±¡å‡º Secret è¿™ç§èµ„æºï¼Œå¤§å¤§æé«˜äº†å¯¹è¿™ç±»æ–‡ä»¶çš„ç®¡ç†å’Œå¤ç”¨èƒ½åŠ›ã€‚</p>\n<h4 id=\"Secret\"><a href=\"#Secret\" class=\"headerlink\" title=\"Secret\"></a>Secret</h4><p>Secret è§£å†³äº†å¯†ç ã€tokenã€å¯†é’¥ç­‰æ•æ„Ÿæ•°æ®çš„å­˜å‚¨é—®é¢˜ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š</p>\n<ul>\n<li>Service Account ï¼šç”¨æ¥è®¿é—® Kubernetes APIï¼Œç”± Kubernetes è‡ªåŠ¨åˆ›å»ºï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨æŒ‚è½½åˆ° Pod çš„ / run/secrets/kubernetes.io/serviceaccount ç›®å½•ä¸­</li>\n<li>Opaque ï¼šBase64 ç¼–ç æ ¼å¼çš„ Secretï¼Œç”¨æ¥å­˜å‚¨å¯†ç ã€å¯†é’¥ç­‰</li>\n<li>kubernetes.io/dockerconfigjson ï¼šç”¨æ¥å­˜å‚¨ docker registry çš„è®¤è¯ä¿¡æ¯</li>\n</ul>\n<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥åˆ›å»ºä¸€ä¸ª Opaque ç±»å‹çš„ Secretï¼Œä½¿å¾— ingress nginx controller æ”¯æŒæœåŠ¡ç«¯çš„ SSLã€‚<br>ç”±äºç¯‡å¹…æœ‰é™ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹è¯ä¹¦ç›¸å…³çš„æ¦‚å¿µï¼š</p>\n<ul>\n<li>CAï¼šè¯ä¹¦æˆæƒä¸­å¿ƒ(certificate authority)ï¼Œç”¨æ¥ç­¾å‘ç§é’¥ï¼Œå¹¶éªŒè¯å…¬é’¥ï¼Œç§é’¥çš„åˆæ³•æ€§</li>\n<li>ç§é’¥ï¼Œå…¬é’¥ï¼šç§é’¥ç”¨äºåŠ å¯†ï¼Œå…¬é’¥ç”¨äºè§£å¯†</li>\n</ul>\n<p>Secret æ”¯æŒä¸ç¼–å†™ yamlï¼Œç›´æ¥ä»æ–‡ä»¶ä¸­åˆ›å»º Secret</p>\n<pre><code class=\"bash\">kubectl create secret generic fortune-teller-ssl-verify \\\n  --from-file=ca.crt=CA.pem \\\n  --from-file=tls.crt=server-public.pem \\\n  --from-file=tls.key=server-private.key\n</code></pre>\n<p>ä¿®æ”¹ Ingressï¼Œä½¿å…¶ä½¿ç”¨æ–°åˆ›å»ºçš„ Secret æä¾›æœåŠ¡ä¾§çš„ SSLã€‚</p>\n<pre><code class=\"yaml\">apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/backend-protocol: GRPC\n  name: fortune-ingress\n  namespace: default\nspec:\n  rules:\n  - host: fortune.test.com\n    http:\n      paths:\n      - backend:\n          serviceName: fortune-teller-service\n          servicePort: grpc\n  tls:\n  - hosts:\n    - fortune.test.com\n    secretName: fortune-teller-ssl-verify\n</code></pre>\n<p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯è‡ªç­¾åçš„è¯ä¹¦ï¼Œä¸è¢«å…¬å…±çš„ CA æ‰€ä¿¡ä»»ï¼Œæ‰€ä»¥åœ¨å‘é€è¯·æ±‚æ˜¯éœ€è¦æ‰‹åŠ¨æŒ‡å®šè‡ªå·±æ‰€ä¿¡ä»»çš„ CAã€‚</p>\n<pre><code class=\"bash\">grpcurl -cacert CA.pem \\\n  -servername &#39;fortune.test.com&#39; \\\n  127.0.0.1:32443 \\\n  build.stack.fortune.FortuneTeller/Predict\n</code></pre>\n<p><img src=\"/asset/k8s-ramp-up/20.png\"></p>\n<h2 id=\"å‚è€ƒ\"><a href=\"#å‚è€ƒ\" class=\"headerlink\" title=\"å‚è€ƒ\"></a>å‚è€ƒ</h2><ul>\n<li><a href=\"https://draveness.me/docker/\">https://draveness.me/docker/</a></li>\n<li><a href=\"https://www.yuque.com/kshare/2020/fe3b6f86-3b9b-48da-9770-897d838cbf41?language=zh-cn#Namespace\">https://www.yuque.com/kshare/2020/fe3b6f86-3b9b-48da-9770-897d838cbf41?language=zh-cn#Namespace</a></li>\n<li><a href=\"https://network.51cto.com/art/201907/598970.htm\">https://network.51cto.com/art/201907/598970.htm</a></li>\n<li><a href=\"https://blog.csdn.net/gatieme/article/details/51383322\">https://blog.csdn.net/gatieme/article/details/51383322</a></li>\n</ul>\n"},{"title":"[CodeRead] TiDB Lightning","date":"2021-03-19T18:48:44.000Z","updated":"2021-03-19T18:48:44.000Z","_content":"\nTiDB Lightning æ˜¯ä¸€ä¸ªå°†æ•°æ®å¯¼å…¥åˆ° TiDB ä¸­çš„å·¥å…·ï¼Œä½¿ç”¨ Go ç¼–å†™ã€‚æ”¯æŒ `Local`, `Importer`, `TiDB` ä¸‰ç§å¯¼å…¥æ¨¡å¼ã€‚åœ¨ TiDB çš„å®˜ç½‘ä¸­ï¼Œå¯¹å…¶[åŸç†]()æœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚\n\næœ¬æ–‡ä»ä»£ç çš„è§’åº¦ï¼Œå¸¦é¢†å¤§å®¶èµ°è¿‡ä¸€ä¸ªæ•°æ®å¯¼å…¥çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥åªå…³æ³¨ä¸€äº›é€»è¾‘ä¸Šé‡è¦çš„æ­¥éª¤ï¼Œè€Œä¸€äº›å…¶ä»–çš„ç»†èŠ‚å¯èƒ½ä¸ä¼šæ¶‰åŠåˆ°ã€‚\n<!-- more -->\n\n![](/asset/tidb-lightning/1.png)\né¦–å…ˆï¼Œè¿›å…¥ main å‡½æ•°ï¼Œç¨‹åºè°ƒç”¨äº†ä¸¤ä¸ªä¸»è¦çš„å¯åŠ¨å‡½æ•°ï¼š`GoServer` å’Œ `RunServer`ã€‚\n\n## GoServer\n\n[https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L96](https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L96)\n\nGoServer å¯åŠ¨äº†ä¸€ä¸ª Api Serverï¼Œæœ‰ç€ä»¥ä¸‹è¿™äº› endpoint\n- /web\n- /metrics\n- /debug\n- /tasks\n- /progress\n- /pause\n- /resume\n- /loglevel\n\nApi Server ä¸ºæ•´ä¸ª lightning æä¾›äº†æ§åˆ¶ï¼Œç›‘æ§å’ŒæŸ¥çœ‹è¿›åº¦ç­‰åŠŸèƒ½ã€‚æ˜¯ç”¨æˆ·ä¸ lightning äº¤äº’çš„å…¥å£ã€‚è€Œå½“ç”¨æˆ·é€šè¿‡ `POST /tasks` æäº¤äº†ä¸€ä¸ªæ•°æ®å¯¼å…¥ä»»åŠ¡æ—¶ï¼ŒApi Server å°±ä¼šå‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œè€ŒåŒæ ·åœ¨ç›‘å¬ç€é˜Ÿåˆ—çš„ RunServer å°±ä¼šå¼€å§‹æ‰§è¡Œã€‚\n\n## RunServer\n\n[https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L194](https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L194)\n\nRunServer æ˜¯çœŸæ­£æ‰§è¡Œå¯¼å…¥çš„åœ°æ–¹ã€‚ä¸€ä¸ª for å¾ªç¯ä¸€ç›´ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡é…ç½®ã€‚åœ¨è·å–åˆ°ä¸€ä¸ªä»»åŠ¡çš„é…ç½®åï¼Œå¼€å§‹æ­£å¼æ‰§è¡Œå¯¼å…¥ä»»åŠ¡ã€‚\n\n### RegisterMySQL\n\nè¿™ä¸ªå‡½æ•°çš„å‘½åæœ‰ç‚¹è¿·æƒ‘ï¼Œä½†æ‰€å¹¸æœ‰æ³¨é‡Šã€‚RegisterMySQL åŒæ—¶åŒ…å«äº†å‘ gomysql driver é…ç½® TLS å’Œè§£é™¤é…ç½®çš„ä¸¤ä¸ªä½œç”¨ã€‚åœ¨è¿è¡Œçš„ä¸€å¼€å§‹ï¼Œæ³¨å†Œ TiDB çš„ TLS é…ç½®ï¼Œè¿™æ ·ç›´æ¥å¯ä»¥ä½¿ç”¨ `sql.open()` è¿æ¥ TiDBã€‚åœ¨æ‰§è¡Œå¯¼å…¥ä»»åŠ¡ç»“æŸåï¼Œé€šè¿‡å°† `CAPath` ç½®ä¸ºç©ºï¼Œåˆ é™¤ TLS é…ç½®ã€‚\n\n### Glue\n\nGlue å°†æ•°æ®å’Œå¯¼å…¥ç²˜åˆåœ¨ä¸€èµ·ã€‚è¿™é‡Œåœ¨åˆ›å»º Glue æ—¶ï¼Œå°±å°† TiDB è®¾ä¸ºäº†å¯¼å…¥æ¨¡å¼ã€‚\n\n### MyDumper\n\nç¡®å®šå¥½ç›®æ ‡æ•°æ®åº“ä¹Ÿå°±æ˜¯ backend åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹æ•°æ®å¯¼å…¥çš„ frontend äº†ã€‚`MyDumper` æ˜¯ä¸€æ¬¾ç”± PingCAP åŸºäºç¤¾åŒºç‰ˆï¼Œä¸º TiDB å®šåˆ¶åŒ–å¼€å‘çš„æ•°æ®å¯¼å‡ºå·¥å…·ã€‚ä½†æ˜¯ç›®å‰ä¼¼ä¹å·²ç»ä¸æ¨èä½¿ç”¨äº†ï¼Œæ¨èæ”¹ç”¨ `dumpling` äº†ã€‚\n\nåœ¨è¿™é‡Œåˆ›å»º MyDumper æ—¶ï¼Œå°±ä¼šåœ¨ `setup` ä¸­ä» SQL æ–‡ä»¶ä¸­ã€‚ è¿™é‡Œä¼šå¯¹è¡¨æŒ‰ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œè®©å°è¡¨ä¹‹åå…ˆè¿›è¡Œå¯¼å…¥ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤§è¡¨å¯¼å…¥æ—¶é˜»å¡å°è¡¨é‡Šæ”¾ index workerã€‚\n\n```go\ntype mdLoaderSetup struct {\n\tloader        *MDLoader\n\tdbSchemas     []FileInfo\n\ttableSchemas  []FileInfo\n\tviewSchemas   []FileInfo\n\ttableDatas    []FileInfo\n\tdbIndexMap    map[string]int\n\ttableIndexMap map[filter.Table]int\n}\n```\n\n### Check\n\nåˆå§‹åŒ–å¹¶é…ç½®å¥½ MyDumper åï¼Œåœ¨æ­£å¼å¼€è·‘å‰ï¼Œç¨‹åºè¿˜éœ€è¦è¿›è¡Œæ£€æŸ¥ã€‚è¿™é‡Œæ£€æŸ¥äº†ä¸¤é¡¹ï¼š1. `CheckSystemRequirement` ç³»ç»Ÿè¦æ±‚æ˜¯å¦æ»¡è¶³ï¼Œlightning å¯¹äºå†…å­˜è¦æ±‚ä¼¼ä¹è¿˜æŒºé«˜ã€‚2. `CheckSchemaConflict` æ£€æŸ¥ç›®æ ‡æ•°æ®åº“çš„ Schema æ˜¯ä¸æ˜¯æœ‰å†²çªã€‚\n\n## RestoreController\n\nlightning çš„å¯¼å…¥è¿‡ç¨‹ç”± `RestoreController` è¿›è¡Œæ§åˆ¶ã€‚`Run` ä¸­çš„ `opts` å®šä¹‰äº†å¯¼å…¥è¿‡ç¨‹æ‰€æœ‰çš„æ“ä½œã€‚\n\n### CheckRequirements\n\né€šè¿‡å¤šæ€å®ç°ï¼Œä¸‰ç§ backend æ‰§è¡Œä¸åŒçš„æ£€æŸ¥ã€‚\n\n### SetGlobalVariables\n\nåœ¨ Server æ¨¡å¼ä¸‹ï¼Œç›®æ ‡æ•°æ®åº“çš„ `Collation` è®¾ç½®éƒ½å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥æ¯æ¬¡æ‰§è¡Œä»»åŠ¡éƒ½éœ€è¦è®¾ç½®ä¸€ä¸‹ã€‚\n\n### RestoreSchema\n\nä»è¿™é‡Œï¼Œlightning çœŸæ­£å¼€å§‹å¯¼å…¥æ•°æ®ã€‚é¦–å…ˆï¼Œå¯¼å…¥ Schemaã€‚Schema åŒ…å« `database`, `table`, `view` ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«å¯¹åº”ç€ä¹‹å‰ä» MyDumper ä¸­å¯¼å‡ºçš„ä¸‰ä¸ªéƒ¨åˆ†ã€‚Lightning ä½¿ç”¨ Glue ä¸­å°è£…çš„ç›®æ ‡æ•°æ®åº“è¿æ¥ï¼Œæ‰§è¡Œ SQLï¼Œå¯¼å…¥ Schema ä¿¡æ¯ã€‚\n\nè¿™é‡Œ lightning ä½¿ç”¨äº†ä¸€ç§éå¸¸ Go é£æ ¼çš„å®ç°æ–¹æ³•ã€‚å…ˆåˆ›å»ºå‡ºå¤šä¸ª goroutineï¼Œæ¯ä¸ª goroutine éƒ½ç›‘å¬ç€åŒä¸€ä¸ª channelã€‚ä¹‹åå†ä¸æ–­å‘ channel ä¸­åŠ å…¥è¦æ‰§è¡Œçš„ SQL ä»»åŠ¡ï¼Œä»è€Œå®ç°ä¸€ä¸ªç±»ä¼¼äºçº¿ç¨‹æ± çš„åŠŸèƒ½ã€‚\n\nåœ¨å¯¼å…¥ Schema æˆåŠŸåï¼ŒRestoreSchema è¿˜ä¼šè´Ÿè´£åˆå§‹åŒ– Checkpointï¼Œå¹¶åˆ›å»ºä¸€ä¸ª goroutineï¼Œç”¨æ¥ç›‘å¬ Checkpoint çš„å˜åŒ–ï¼Œå°†å¤šä¸ª Checkpoint åˆå¹¶åˆ°ä¸€èµ·ã€‚\n\næœ€åï¼ŒRestoreSchema è¿˜ä¼šæ ¹æ® Schema ä¸­åŒ…å«çš„å…ƒä¿¡æ¯ï¼Œå¯¹ä¹‹åå¯¼å…¥æ•°æ®æ—¶åˆ’åˆ†çš„ chunk æ•°é‡è¿›è¡Œä¸€ä¸ªä¼°è®¡ã€‚\n\n### RestoreTables\n\nRestoreTables è´Ÿè´£ä»æºæ•°æ®åº“ä¸­å¯¼å‡ºæ•°æ®åˆ°ç›®æ ‡æ•°æ®åº“ä¸­ã€‚\n\né¦–å…ˆï¼Œåœ¨ `populateChunks` å‡½æ•°ä¸­ï¼Œä½¿ç”¨ MyDumper å°†æ•°æ®åˆ’åˆ†æˆå¤šä¸ª chunkï¼Œæ¥ç€å°† chunk åŠ å…¥åˆ°å…¶å¯¹åº”çš„æ•°æ® engine ä¸­ã€‚ç„¶åæ·»åŠ ä¸€ä¸ªç´¢å¼• engine çš„ Checkpointã€‚\n\nç„¶åï¼Œé€šè¿‡ `InsertEngineCheckpoint` åˆ›å»ºæ¯å¼ è¡¨çš„ Checkpointã€‚\n\nç„¶åï¼Œåœ¨ `restoreEngines` ä¸­ï¼Œå…ˆå°†æºæ•°æ®åº“çš„æ•°æ®ä»å¯¼å‡ºçš„æ–‡ä»¶ï¼Œå¹¶å‘åœ°è½¬åŒ–æˆ KV æ ¼å¼çš„ engineï¼Œç„¶åå†å¯¼å…¥åˆ°ç›®æ ‡æ•°æ®åº“ä¸­ã€‚å…³äº engine çš„çŠ¶æ€æœºæ¨¡å‹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡[æ–‡ç« ](https://blog.abingcbc.cn/2021/03/17/tikv-importer)ä¸­çš„æ€»ç»“ã€‚è¿™ä¸ªå‡½æ•°ä¸­åŒ…å«äº† lightning æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼Œæ‰€ä»¥æ¯”è¾ƒå¤æ‚ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š\n\n1. åœ¨ chunkRestore çš„ `restore` ä¸­ï¼Œåœ¨ `encodeLoop` ä¸­ï¼Œåˆ©ç”¨ MyDumper çš„ parserï¼Œå°†æ•°æ®ä»ä¸åŒçš„å¯¼å‡ºæ ¼å¼ç»Ÿä¸€è½¬æ¢æˆ KV æ ¼å¼ï¼Œæ’å…¥åˆ° engine ä¸­ã€‚æ­¤æ—¶ï¼Œæ‰€æœ‰çš„ Checkpointï¼ŒåŒ…æ‹¬ data å’Œ indexï¼Œéƒ½å·²ç»å†™å…¥å®Œæˆã€‚\n2. æ¥ç€ï¼Œæ ¹æ® engine çš„çŠ¶æ€æœºï¼Œå…³é—­ engine æ‰èƒ½å¼€å§‹å¯¼å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨éœ€è¦å°† engine çš„çŠ¶æ€ç½®ä¸º closeã€‚\n3. å…³é—­åï¼Œå¼€å§‹è°ƒç”¨ backend å¯¼å…¥ engineã€‚åœ¨æ‰€æœ‰çš„ data engine å¯¼å…¥å®Œæˆåï¼Œå¼€å§‹å¯¼å…¥ index engineã€‚\n\nè¿™é‡Œï¼Œåˆä½¿ç”¨äº†ä¸€ç§éå¸¸ Go é£æ ¼çš„æ–¹å¼å®ç°çº¿ç¨‹æ± çš„åŠŸèƒ½ã€‚åˆ©ç”¨ channel çš„ç¼“å†²ç‰¹æ€§ï¼Œå‘å…¶ä¸­æ·»åŠ  workerï¼Œä½¿ç”¨æ—¶å–èµ°ï¼Œä½¿ç”¨å®Œå†æ”¾å›åˆ° channel ä¸­ã€‚\n\næœ€åï¼Œå¯¹äºæŸäº›éœ€è¦æ‰§è¡Œ post process çš„ä»»åŠ¡ï¼Œæ‰§è¡Œä¸€ä¸‹ç›¸åº”çš„ä»»åŠ¡ã€‚\n\n### FullCompact\n\nè°ƒç”¨ TiKV çš„æ¥å£ï¼Œå¯¹æ‰€æœ‰æ–°å¯¼å…¥çš„æ•°æ®è¿›è¡Œå‹ç¼©ã€‚ä½†æ˜¯ç”±äºä¹‹å‰å¯¼å…¥æ•°æ®çš„æ—¶å€™ï¼Œä¼šæ ¹æ®æ˜¯å¦å­˜åœ¨å‹ç¼©ä»»åŠ¡ï¼Œå»å°è¯•æ‰§è¡Œ level-1 çš„å‹ç¼©ï¼Œæ‰€ä»¥è¿›è¡Œå…¨é‡å‹ç¼©çš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾…ä¹‹å‰å¯åŠ¨çš„ level-1 å‹ç¼©ä»»åŠ¡ç»“æŸã€‚\n\n### SwitchToNormalMode\n\nå°† TiKV åˆ‡æ¢æˆæ­£å¸¸æ¨¡å¼\n\n### CleanCheckpoints\n\næ‰€æœ‰çš„å¯¼å…¥ä»»åŠ¡éƒ½ç»“æŸäº†ï¼Œæ­¤æ—¶ checkpoint å·²ç»æ— ç”¨äº†ã€‚æ‰€ä»¥ï¼Œæ ¹æ®ç”¨æˆ·é…ç½®æ˜¯å¦åˆ é™¤ï¼Œå¤„ç† checkpointã€‚","source":"_posts/tidb-lightning.md","raw":"---\ntitle: \"[CodeRead] TiDB Lightning\"\ndate: 2021-03-19 18:48:44\nupdated: 2021-03-19 18:48:44\n---\n\nTiDB Lightning æ˜¯ä¸€ä¸ªå°†æ•°æ®å¯¼å…¥åˆ° TiDB ä¸­çš„å·¥å…·ï¼Œä½¿ç”¨ Go ç¼–å†™ã€‚æ”¯æŒ `Local`, `Importer`, `TiDB` ä¸‰ç§å¯¼å…¥æ¨¡å¼ã€‚åœ¨ TiDB çš„å®˜ç½‘ä¸­ï¼Œå¯¹å…¶[åŸç†]()æœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚\n\næœ¬æ–‡ä»ä»£ç çš„è§’åº¦ï¼Œå¸¦é¢†å¤§å®¶èµ°è¿‡ä¸€ä¸ªæ•°æ®å¯¼å…¥çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥åªå…³æ³¨ä¸€äº›é€»è¾‘ä¸Šé‡è¦çš„æ­¥éª¤ï¼Œè€Œä¸€äº›å…¶ä»–çš„ç»†èŠ‚å¯èƒ½ä¸ä¼šæ¶‰åŠåˆ°ã€‚\n<!-- more -->\n\n![](/asset/tidb-lightning/1.png)\né¦–å…ˆï¼Œè¿›å…¥ main å‡½æ•°ï¼Œç¨‹åºè°ƒç”¨äº†ä¸¤ä¸ªä¸»è¦çš„å¯åŠ¨å‡½æ•°ï¼š`GoServer` å’Œ `RunServer`ã€‚\n\n## GoServer\n\n[https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L96](https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L96)\n\nGoServer å¯åŠ¨äº†ä¸€ä¸ª Api Serverï¼Œæœ‰ç€ä»¥ä¸‹è¿™äº› endpoint\n- /web\n- /metrics\n- /debug\n- /tasks\n- /progress\n- /pause\n- /resume\n- /loglevel\n\nApi Server ä¸ºæ•´ä¸ª lightning æä¾›äº†æ§åˆ¶ï¼Œç›‘æ§å’ŒæŸ¥çœ‹è¿›åº¦ç­‰åŠŸèƒ½ã€‚æ˜¯ç”¨æˆ·ä¸ lightning äº¤äº’çš„å…¥å£ã€‚è€Œå½“ç”¨æˆ·é€šè¿‡ `POST /tasks` æäº¤äº†ä¸€ä¸ªæ•°æ®å¯¼å…¥ä»»åŠ¡æ—¶ï¼ŒApi Server å°±ä¼šå‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œè€ŒåŒæ ·åœ¨ç›‘å¬ç€é˜Ÿåˆ—çš„ RunServer å°±ä¼šå¼€å§‹æ‰§è¡Œã€‚\n\n## RunServer\n\n[https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L194](https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L194)\n\nRunServer æ˜¯çœŸæ­£æ‰§è¡Œå¯¼å…¥çš„åœ°æ–¹ã€‚ä¸€ä¸ª for å¾ªç¯ä¸€ç›´ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡é…ç½®ã€‚åœ¨è·å–åˆ°ä¸€ä¸ªä»»åŠ¡çš„é…ç½®åï¼Œå¼€å§‹æ­£å¼æ‰§è¡Œå¯¼å…¥ä»»åŠ¡ã€‚\n\n### RegisterMySQL\n\nè¿™ä¸ªå‡½æ•°çš„å‘½åæœ‰ç‚¹è¿·æƒ‘ï¼Œä½†æ‰€å¹¸æœ‰æ³¨é‡Šã€‚RegisterMySQL åŒæ—¶åŒ…å«äº†å‘ gomysql driver é…ç½® TLS å’Œè§£é™¤é…ç½®çš„ä¸¤ä¸ªä½œç”¨ã€‚åœ¨è¿è¡Œçš„ä¸€å¼€å§‹ï¼Œæ³¨å†Œ TiDB çš„ TLS é…ç½®ï¼Œè¿™æ ·ç›´æ¥å¯ä»¥ä½¿ç”¨ `sql.open()` è¿æ¥ TiDBã€‚åœ¨æ‰§è¡Œå¯¼å…¥ä»»åŠ¡ç»“æŸåï¼Œé€šè¿‡å°† `CAPath` ç½®ä¸ºç©ºï¼Œåˆ é™¤ TLS é…ç½®ã€‚\n\n### Glue\n\nGlue å°†æ•°æ®å’Œå¯¼å…¥ç²˜åˆåœ¨ä¸€èµ·ã€‚è¿™é‡Œåœ¨åˆ›å»º Glue æ—¶ï¼Œå°±å°† TiDB è®¾ä¸ºäº†å¯¼å…¥æ¨¡å¼ã€‚\n\n### MyDumper\n\nç¡®å®šå¥½ç›®æ ‡æ•°æ®åº“ä¹Ÿå°±æ˜¯ backend åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹æ•°æ®å¯¼å…¥çš„ frontend äº†ã€‚`MyDumper` æ˜¯ä¸€æ¬¾ç”± PingCAP åŸºäºç¤¾åŒºç‰ˆï¼Œä¸º TiDB å®šåˆ¶åŒ–å¼€å‘çš„æ•°æ®å¯¼å‡ºå·¥å…·ã€‚ä½†æ˜¯ç›®å‰ä¼¼ä¹å·²ç»ä¸æ¨èä½¿ç”¨äº†ï¼Œæ¨èæ”¹ç”¨ `dumpling` äº†ã€‚\n\nåœ¨è¿™é‡Œåˆ›å»º MyDumper æ—¶ï¼Œå°±ä¼šåœ¨ `setup` ä¸­ä» SQL æ–‡ä»¶ä¸­ã€‚ è¿™é‡Œä¼šå¯¹è¡¨æŒ‰ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œè®©å°è¡¨ä¹‹åå…ˆè¿›è¡Œå¯¼å…¥ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤§è¡¨å¯¼å…¥æ—¶é˜»å¡å°è¡¨é‡Šæ”¾ index workerã€‚\n\n```go\ntype mdLoaderSetup struct {\n\tloader        *MDLoader\n\tdbSchemas     []FileInfo\n\ttableSchemas  []FileInfo\n\tviewSchemas   []FileInfo\n\ttableDatas    []FileInfo\n\tdbIndexMap    map[string]int\n\ttableIndexMap map[filter.Table]int\n}\n```\n\n### Check\n\nåˆå§‹åŒ–å¹¶é…ç½®å¥½ MyDumper åï¼Œåœ¨æ­£å¼å¼€è·‘å‰ï¼Œç¨‹åºè¿˜éœ€è¦è¿›è¡Œæ£€æŸ¥ã€‚è¿™é‡Œæ£€æŸ¥äº†ä¸¤é¡¹ï¼š1. `CheckSystemRequirement` ç³»ç»Ÿè¦æ±‚æ˜¯å¦æ»¡è¶³ï¼Œlightning å¯¹äºå†…å­˜è¦æ±‚ä¼¼ä¹è¿˜æŒºé«˜ã€‚2. `CheckSchemaConflict` æ£€æŸ¥ç›®æ ‡æ•°æ®åº“çš„ Schema æ˜¯ä¸æ˜¯æœ‰å†²çªã€‚\n\n## RestoreController\n\nlightning çš„å¯¼å…¥è¿‡ç¨‹ç”± `RestoreController` è¿›è¡Œæ§åˆ¶ã€‚`Run` ä¸­çš„ `opts` å®šä¹‰äº†å¯¼å…¥è¿‡ç¨‹æ‰€æœ‰çš„æ“ä½œã€‚\n\n### CheckRequirements\n\né€šè¿‡å¤šæ€å®ç°ï¼Œä¸‰ç§ backend æ‰§è¡Œä¸åŒçš„æ£€æŸ¥ã€‚\n\n### SetGlobalVariables\n\nåœ¨ Server æ¨¡å¼ä¸‹ï¼Œç›®æ ‡æ•°æ®åº“çš„ `Collation` è®¾ç½®éƒ½å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥æ¯æ¬¡æ‰§è¡Œä»»åŠ¡éƒ½éœ€è¦è®¾ç½®ä¸€ä¸‹ã€‚\n\n### RestoreSchema\n\nä»è¿™é‡Œï¼Œlightning çœŸæ­£å¼€å§‹å¯¼å…¥æ•°æ®ã€‚é¦–å…ˆï¼Œå¯¼å…¥ Schemaã€‚Schema åŒ…å« `database`, `table`, `view` ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«å¯¹åº”ç€ä¹‹å‰ä» MyDumper ä¸­å¯¼å‡ºçš„ä¸‰ä¸ªéƒ¨åˆ†ã€‚Lightning ä½¿ç”¨ Glue ä¸­å°è£…çš„ç›®æ ‡æ•°æ®åº“è¿æ¥ï¼Œæ‰§è¡Œ SQLï¼Œå¯¼å…¥ Schema ä¿¡æ¯ã€‚\n\nè¿™é‡Œ lightning ä½¿ç”¨äº†ä¸€ç§éå¸¸ Go é£æ ¼çš„å®ç°æ–¹æ³•ã€‚å…ˆåˆ›å»ºå‡ºå¤šä¸ª goroutineï¼Œæ¯ä¸ª goroutine éƒ½ç›‘å¬ç€åŒä¸€ä¸ª channelã€‚ä¹‹åå†ä¸æ–­å‘ channel ä¸­åŠ å…¥è¦æ‰§è¡Œçš„ SQL ä»»åŠ¡ï¼Œä»è€Œå®ç°ä¸€ä¸ªç±»ä¼¼äºçº¿ç¨‹æ± çš„åŠŸèƒ½ã€‚\n\nåœ¨å¯¼å…¥ Schema æˆåŠŸåï¼ŒRestoreSchema è¿˜ä¼šè´Ÿè´£åˆå§‹åŒ– Checkpointï¼Œå¹¶åˆ›å»ºä¸€ä¸ª goroutineï¼Œç”¨æ¥ç›‘å¬ Checkpoint çš„å˜åŒ–ï¼Œå°†å¤šä¸ª Checkpoint åˆå¹¶åˆ°ä¸€èµ·ã€‚\n\næœ€åï¼ŒRestoreSchema è¿˜ä¼šæ ¹æ® Schema ä¸­åŒ…å«çš„å…ƒä¿¡æ¯ï¼Œå¯¹ä¹‹åå¯¼å…¥æ•°æ®æ—¶åˆ’åˆ†çš„ chunk æ•°é‡è¿›è¡Œä¸€ä¸ªä¼°è®¡ã€‚\n\n### RestoreTables\n\nRestoreTables è´Ÿè´£ä»æºæ•°æ®åº“ä¸­å¯¼å‡ºæ•°æ®åˆ°ç›®æ ‡æ•°æ®åº“ä¸­ã€‚\n\né¦–å…ˆï¼Œåœ¨ `populateChunks` å‡½æ•°ä¸­ï¼Œä½¿ç”¨ MyDumper å°†æ•°æ®åˆ’åˆ†æˆå¤šä¸ª chunkï¼Œæ¥ç€å°† chunk åŠ å…¥åˆ°å…¶å¯¹åº”çš„æ•°æ® engine ä¸­ã€‚ç„¶åæ·»åŠ ä¸€ä¸ªç´¢å¼• engine çš„ Checkpointã€‚\n\nç„¶åï¼Œé€šè¿‡ `InsertEngineCheckpoint` åˆ›å»ºæ¯å¼ è¡¨çš„ Checkpointã€‚\n\nç„¶åï¼Œåœ¨ `restoreEngines` ä¸­ï¼Œå…ˆå°†æºæ•°æ®åº“çš„æ•°æ®ä»å¯¼å‡ºçš„æ–‡ä»¶ï¼Œå¹¶å‘åœ°è½¬åŒ–æˆ KV æ ¼å¼çš„ engineï¼Œç„¶åå†å¯¼å…¥åˆ°ç›®æ ‡æ•°æ®åº“ä¸­ã€‚å…³äº engine çš„çŠ¶æ€æœºæ¨¡å‹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡[æ–‡ç« ](https://blog.abingcbc.cn/2021/03/17/tikv-importer)ä¸­çš„æ€»ç»“ã€‚è¿™ä¸ªå‡½æ•°ä¸­åŒ…å«äº† lightning æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼Œæ‰€ä»¥æ¯”è¾ƒå¤æ‚ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š\n\n1. åœ¨ chunkRestore çš„ `restore` ä¸­ï¼Œåœ¨ `encodeLoop` ä¸­ï¼Œåˆ©ç”¨ MyDumper çš„ parserï¼Œå°†æ•°æ®ä»ä¸åŒçš„å¯¼å‡ºæ ¼å¼ç»Ÿä¸€è½¬æ¢æˆ KV æ ¼å¼ï¼Œæ’å…¥åˆ° engine ä¸­ã€‚æ­¤æ—¶ï¼Œæ‰€æœ‰çš„ Checkpointï¼ŒåŒ…æ‹¬ data å’Œ indexï¼Œéƒ½å·²ç»å†™å…¥å®Œæˆã€‚\n2. æ¥ç€ï¼Œæ ¹æ® engine çš„çŠ¶æ€æœºï¼Œå…³é—­ engine æ‰èƒ½å¼€å§‹å¯¼å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨éœ€è¦å°† engine çš„çŠ¶æ€ç½®ä¸º closeã€‚\n3. å…³é—­åï¼Œå¼€å§‹è°ƒç”¨ backend å¯¼å…¥ engineã€‚åœ¨æ‰€æœ‰çš„ data engine å¯¼å…¥å®Œæˆåï¼Œå¼€å§‹å¯¼å…¥ index engineã€‚\n\nè¿™é‡Œï¼Œåˆä½¿ç”¨äº†ä¸€ç§éå¸¸ Go é£æ ¼çš„æ–¹å¼å®ç°çº¿ç¨‹æ± çš„åŠŸèƒ½ã€‚åˆ©ç”¨ channel çš„ç¼“å†²ç‰¹æ€§ï¼Œå‘å…¶ä¸­æ·»åŠ  workerï¼Œä½¿ç”¨æ—¶å–èµ°ï¼Œä½¿ç”¨å®Œå†æ”¾å›åˆ° channel ä¸­ã€‚\n\næœ€åï¼Œå¯¹äºæŸäº›éœ€è¦æ‰§è¡Œ post process çš„ä»»åŠ¡ï¼Œæ‰§è¡Œä¸€ä¸‹ç›¸åº”çš„ä»»åŠ¡ã€‚\n\n### FullCompact\n\nè°ƒç”¨ TiKV çš„æ¥å£ï¼Œå¯¹æ‰€æœ‰æ–°å¯¼å…¥çš„æ•°æ®è¿›è¡Œå‹ç¼©ã€‚ä½†æ˜¯ç”±äºä¹‹å‰å¯¼å…¥æ•°æ®çš„æ—¶å€™ï¼Œä¼šæ ¹æ®æ˜¯å¦å­˜åœ¨å‹ç¼©ä»»åŠ¡ï¼Œå»å°è¯•æ‰§è¡Œ level-1 çš„å‹ç¼©ï¼Œæ‰€ä»¥è¿›è¡Œå…¨é‡å‹ç¼©çš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾…ä¹‹å‰å¯åŠ¨çš„ level-1 å‹ç¼©ä»»åŠ¡ç»“æŸã€‚\n\n### SwitchToNormalMode\n\nå°† TiKV åˆ‡æ¢æˆæ­£å¸¸æ¨¡å¼\n\n### CleanCheckpoints\n\næ‰€æœ‰çš„å¯¼å…¥ä»»åŠ¡éƒ½ç»“æŸäº†ï¼Œæ­¤æ—¶ checkpoint å·²ç»æ— ç”¨äº†ã€‚æ‰€ä»¥ï¼Œæ ¹æ®ç”¨æˆ·é…ç½®æ˜¯å¦åˆ é™¤ï¼Œå¤„ç† checkpointã€‚","slug":"tidb-lightning","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"cl5i8k7y600081rpfgnmsa04r","content":"<p>TiDB Lightning æ˜¯ä¸€ä¸ªå°†æ•°æ®å¯¼å…¥åˆ° TiDB ä¸­çš„å·¥å…·ï¼Œä½¿ç”¨ Go ç¼–å†™ã€‚æ”¯æŒ <code>Local</code>, <code>Importer</code>, <code>TiDB</code> ä¸‰ç§å¯¼å…¥æ¨¡å¼ã€‚åœ¨ TiDB çš„å®˜ç½‘ä¸­ï¼Œå¯¹å…¶<a href=\"\">åŸç†</a>æœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚</p>\n<p>æœ¬æ–‡ä»ä»£ç çš„è§’åº¦ï¼Œå¸¦é¢†å¤§å®¶èµ°è¿‡ä¸€ä¸ªæ•°æ®å¯¼å…¥çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥åªå…³æ³¨ä¸€äº›é€»è¾‘ä¸Šé‡è¦çš„æ­¥éª¤ï¼Œè€Œä¸€äº›å…¶ä»–çš„ç»†èŠ‚å¯èƒ½ä¸ä¼šæ¶‰åŠåˆ°ã€‚</p>\n<span id=\"more\"></span>\n\n<p><img src=\"/asset/tidb-lightning/1.png\"><br>é¦–å…ˆï¼Œè¿›å…¥ main å‡½æ•°ï¼Œç¨‹åºè°ƒç”¨äº†ä¸¤ä¸ªä¸»è¦çš„å¯åŠ¨å‡½æ•°ï¼š<code>GoServer</code> å’Œ <code>RunServer</code>ã€‚</p>\n<h2 id=\"GoServer\"><a href=\"#GoServer\" class=\"headerlink\" title=\"GoServer\"></a>GoServer</h2><p><a href=\"https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L96\">https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L96</a></p>\n<p>GoServer å¯åŠ¨äº†ä¸€ä¸ª Api Serverï¼Œæœ‰ç€ä»¥ä¸‹è¿™äº› endpoint</p>\n<ul>\n<li>/web</li>\n<li>/metrics</li>\n<li>/debug</li>\n<li>/tasks</li>\n<li>/progress</li>\n<li>/pause</li>\n<li>/resume</li>\n<li>/loglevel</li>\n</ul>\n<p>Api Server ä¸ºæ•´ä¸ª lightning æä¾›äº†æ§åˆ¶ï¼Œç›‘æ§å’ŒæŸ¥çœ‹è¿›åº¦ç­‰åŠŸèƒ½ã€‚æ˜¯ç”¨æˆ·ä¸ lightning äº¤äº’çš„å…¥å£ã€‚è€Œå½“ç”¨æˆ·é€šè¿‡ <code>POST /tasks</code> æäº¤äº†ä¸€ä¸ªæ•°æ®å¯¼å…¥ä»»åŠ¡æ—¶ï¼ŒApi Server å°±ä¼šå‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œè€ŒåŒæ ·åœ¨ç›‘å¬ç€é˜Ÿåˆ—çš„ RunServer å°±ä¼šå¼€å§‹æ‰§è¡Œã€‚</p>\n<h2 id=\"RunServer\"><a href=\"#RunServer\" class=\"headerlink\" title=\"RunServer\"></a>RunServer</h2><p><a href=\"https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L194\">https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L194</a></p>\n<p>RunServer æ˜¯çœŸæ­£æ‰§è¡Œå¯¼å…¥çš„åœ°æ–¹ã€‚ä¸€ä¸ª for å¾ªç¯ä¸€ç›´ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡é…ç½®ã€‚åœ¨è·å–åˆ°ä¸€ä¸ªä»»åŠ¡çš„é…ç½®åï¼Œå¼€å§‹æ­£å¼æ‰§è¡Œå¯¼å…¥ä»»åŠ¡ã€‚</p>\n<h3 id=\"RegisterMySQL\"><a href=\"#RegisterMySQL\" class=\"headerlink\" title=\"RegisterMySQL\"></a>RegisterMySQL</h3><p>è¿™ä¸ªå‡½æ•°çš„å‘½åæœ‰ç‚¹è¿·æƒ‘ï¼Œä½†æ‰€å¹¸æœ‰æ³¨é‡Šã€‚RegisterMySQL åŒæ—¶åŒ…å«äº†å‘ gomysql driver é…ç½® TLS å’Œè§£é™¤é…ç½®çš„ä¸¤ä¸ªä½œç”¨ã€‚åœ¨è¿è¡Œçš„ä¸€å¼€å§‹ï¼Œæ³¨å†Œ TiDB çš„ TLS é…ç½®ï¼Œè¿™æ ·ç›´æ¥å¯ä»¥ä½¿ç”¨ <code>sql.open()</code> è¿æ¥ TiDBã€‚åœ¨æ‰§è¡Œå¯¼å…¥ä»»åŠ¡ç»“æŸåï¼Œé€šè¿‡å°† <code>CAPath</code> ç½®ä¸ºç©ºï¼Œåˆ é™¤ TLS é…ç½®ã€‚</p>\n<h3 id=\"Glue\"><a href=\"#Glue\" class=\"headerlink\" title=\"Glue\"></a>Glue</h3><p>Glue å°†æ•°æ®å’Œå¯¼å…¥ç²˜åˆåœ¨ä¸€èµ·ã€‚è¿™é‡Œåœ¨åˆ›å»º Glue æ—¶ï¼Œå°±å°† TiDB è®¾ä¸ºäº†å¯¼å…¥æ¨¡å¼ã€‚</p>\n<h3 id=\"MyDumper\"><a href=\"#MyDumper\" class=\"headerlink\" title=\"MyDumper\"></a>MyDumper</h3><p>ç¡®å®šå¥½ç›®æ ‡æ•°æ®åº“ä¹Ÿå°±æ˜¯ backend åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹æ•°æ®å¯¼å…¥çš„ frontend äº†ã€‚<code>MyDumper</code> æ˜¯ä¸€æ¬¾ç”± PingCAP åŸºäºç¤¾åŒºç‰ˆï¼Œä¸º TiDB å®šåˆ¶åŒ–å¼€å‘çš„æ•°æ®å¯¼å‡ºå·¥å…·ã€‚ä½†æ˜¯ç›®å‰ä¼¼ä¹å·²ç»ä¸æ¨èä½¿ç”¨äº†ï¼Œæ¨èæ”¹ç”¨ <code>dumpling</code> äº†ã€‚</p>\n<p>åœ¨è¿™é‡Œåˆ›å»º MyDumper æ—¶ï¼Œå°±ä¼šåœ¨ <code>setup</code> ä¸­ä» SQL æ–‡ä»¶ä¸­ã€‚ è¿™é‡Œä¼šå¯¹è¡¨æŒ‰ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œè®©å°è¡¨ä¹‹åå…ˆè¿›è¡Œå¯¼å…¥ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤§è¡¨å¯¼å…¥æ—¶é˜»å¡å°è¡¨é‡Šæ”¾ index workerã€‚</p>\n<pre><code class=\"go\">type mdLoaderSetup struct &#123;\n    loader        *MDLoader\n    dbSchemas     []FileInfo\n    tableSchemas  []FileInfo\n    viewSchemas   []FileInfo\n    tableDatas    []FileInfo\n    dbIndexMap    map[string]int\n    tableIndexMap map[filter.Table]int\n&#125;\n</code></pre>\n<h3 id=\"Check\"><a href=\"#Check\" class=\"headerlink\" title=\"Check\"></a>Check</h3><p>åˆå§‹åŒ–å¹¶é…ç½®å¥½ MyDumper åï¼Œåœ¨æ­£å¼å¼€è·‘å‰ï¼Œç¨‹åºè¿˜éœ€è¦è¿›è¡Œæ£€æŸ¥ã€‚è¿™é‡Œæ£€æŸ¥äº†ä¸¤é¡¹ï¼š1. <code>CheckSystemRequirement</code> ç³»ç»Ÿè¦æ±‚æ˜¯å¦æ»¡è¶³ï¼Œlightning å¯¹äºå†…å­˜è¦æ±‚ä¼¼ä¹è¿˜æŒºé«˜ã€‚2. <code>CheckSchemaConflict</code> æ£€æŸ¥ç›®æ ‡æ•°æ®åº“çš„ Schema æ˜¯ä¸æ˜¯æœ‰å†²çªã€‚</p>\n<h2 id=\"RestoreController\"><a href=\"#RestoreController\" class=\"headerlink\" title=\"RestoreController\"></a>RestoreController</h2><p>lightning çš„å¯¼å…¥è¿‡ç¨‹ç”± <code>RestoreController</code> è¿›è¡Œæ§åˆ¶ã€‚<code>Run</code> ä¸­çš„ <code>opts</code> å®šä¹‰äº†å¯¼å…¥è¿‡ç¨‹æ‰€æœ‰çš„æ“ä½œã€‚</p>\n<h3 id=\"CheckRequirements\"><a href=\"#CheckRequirements\" class=\"headerlink\" title=\"CheckRequirements\"></a>CheckRequirements</h3><p>é€šè¿‡å¤šæ€å®ç°ï¼Œä¸‰ç§ backend æ‰§è¡Œä¸åŒçš„æ£€æŸ¥ã€‚</p>\n<h3 id=\"SetGlobalVariables\"><a href=\"#SetGlobalVariables\" class=\"headerlink\" title=\"SetGlobalVariables\"></a>SetGlobalVariables</h3><p>åœ¨ Server æ¨¡å¼ä¸‹ï¼Œç›®æ ‡æ•°æ®åº“çš„ <code>Collation</code> è®¾ç½®éƒ½å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥æ¯æ¬¡æ‰§è¡Œä»»åŠ¡éƒ½éœ€è¦è®¾ç½®ä¸€ä¸‹ã€‚</p>\n<h3 id=\"RestoreSchema\"><a href=\"#RestoreSchema\" class=\"headerlink\" title=\"RestoreSchema\"></a>RestoreSchema</h3><p>ä»è¿™é‡Œï¼Œlightning çœŸæ­£å¼€å§‹å¯¼å…¥æ•°æ®ã€‚é¦–å…ˆï¼Œå¯¼å…¥ Schemaã€‚Schema åŒ…å« <code>database</code>, <code>table</code>, <code>view</code> ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«å¯¹åº”ç€ä¹‹å‰ä» MyDumper ä¸­å¯¼å‡ºçš„ä¸‰ä¸ªéƒ¨åˆ†ã€‚Lightning ä½¿ç”¨ Glue ä¸­å°è£…çš„ç›®æ ‡æ•°æ®åº“è¿æ¥ï¼Œæ‰§è¡Œ SQLï¼Œå¯¼å…¥ Schema ä¿¡æ¯ã€‚</p>\n<p>è¿™é‡Œ lightning ä½¿ç”¨äº†ä¸€ç§éå¸¸ Go é£æ ¼çš„å®ç°æ–¹æ³•ã€‚å…ˆåˆ›å»ºå‡ºå¤šä¸ª goroutineï¼Œæ¯ä¸ª goroutine éƒ½ç›‘å¬ç€åŒä¸€ä¸ª channelã€‚ä¹‹åå†ä¸æ–­å‘ channel ä¸­åŠ å…¥è¦æ‰§è¡Œçš„ SQL ä»»åŠ¡ï¼Œä»è€Œå®ç°ä¸€ä¸ªç±»ä¼¼äºçº¿ç¨‹æ± çš„åŠŸèƒ½ã€‚</p>\n<p>åœ¨å¯¼å…¥ Schema æˆåŠŸåï¼ŒRestoreSchema è¿˜ä¼šè´Ÿè´£åˆå§‹åŒ– Checkpointï¼Œå¹¶åˆ›å»ºä¸€ä¸ª goroutineï¼Œç”¨æ¥ç›‘å¬ Checkpoint çš„å˜åŒ–ï¼Œå°†å¤šä¸ª Checkpoint åˆå¹¶åˆ°ä¸€èµ·ã€‚</p>\n<p>æœ€åï¼ŒRestoreSchema è¿˜ä¼šæ ¹æ® Schema ä¸­åŒ…å«çš„å…ƒä¿¡æ¯ï¼Œå¯¹ä¹‹åå¯¼å…¥æ•°æ®æ—¶åˆ’åˆ†çš„ chunk æ•°é‡è¿›è¡Œä¸€ä¸ªä¼°è®¡ã€‚</p>\n<h3 id=\"RestoreTables\"><a href=\"#RestoreTables\" class=\"headerlink\" title=\"RestoreTables\"></a>RestoreTables</h3><p>RestoreTables è´Ÿè´£ä»æºæ•°æ®åº“ä¸­å¯¼å‡ºæ•°æ®åˆ°ç›®æ ‡æ•°æ®åº“ä¸­ã€‚</p>\n<p>é¦–å…ˆï¼Œåœ¨ <code>populateChunks</code> å‡½æ•°ä¸­ï¼Œä½¿ç”¨ MyDumper å°†æ•°æ®åˆ’åˆ†æˆå¤šä¸ª chunkï¼Œæ¥ç€å°† chunk åŠ å…¥åˆ°å…¶å¯¹åº”çš„æ•°æ® engine ä¸­ã€‚ç„¶åæ·»åŠ ä¸€ä¸ªç´¢å¼• engine çš„ Checkpointã€‚</p>\n<p>ç„¶åï¼Œé€šè¿‡ <code>InsertEngineCheckpoint</code> åˆ›å»ºæ¯å¼ è¡¨çš„ Checkpointã€‚</p>\n<p>ç„¶åï¼Œåœ¨ <code>restoreEngines</code> ä¸­ï¼Œå…ˆå°†æºæ•°æ®åº“çš„æ•°æ®ä»å¯¼å‡ºçš„æ–‡ä»¶ï¼Œå¹¶å‘åœ°è½¬åŒ–æˆ KV æ ¼å¼çš„ engineï¼Œç„¶åå†å¯¼å…¥åˆ°ç›®æ ‡æ•°æ®åº“ä¸­ã€‚å…³äº engine çš„çŠ¶æ€æœºæ¨¡å‹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡<a href=\"https://blog.abingcbc.cn/2021/03/17/tikv-importer\">æ–‡ç« </a>ä¸­çš„æ€»ç»“ã€‚è¿™ä¸ªå‡½æ•°ä¸­åŒ…å«äº† lightning æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼Œæ‰€ä»¥æ¯”è¾ƒå¤æ‚ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š</p>\n<ol>\n<li>åœ¨ chunkRestore çš„ <code>restore</code> ä¸­ï¼Œåœ¨ <code>encodeLoop</code> ä¸­ï¼Œåˆ©ç”¨ MyDumper çš„ parserï¼Œå°†æ•°æ®ä»ä¸åŒçš„å¯¼å‡ºæ ¼å¼ç»Ÿä¸€è½¬æ¢æˆ KV æ ¼å¼ï¼Œæ’å…¥åˆ° engine ä¸­ã€‚æ­¤æ—¶ï¼Œæ‰€æœ‰çš„ Checkpointï¼ŒåŒ…æ‹¬ data å’Œ indexï¼Œéƒ½å·²ç»å†™å…¥å®Œæˆã€‚</li>\n<li>æ¥ç€ï¼Œæ ¹æ® engine çš„çŠ¶æ€æœºï¼Œå…³é—­ engine æ‰èƒ½å¼€å§‹å¯¼å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨éœ€è¦å°† engine çš„çŠ¶æ€ç½®ä¸º closeã€‚</li>\n<li>å…³é—­åï¼Œå¼€å§‹è°ƒç”¨ backend å¯¼å…¥ engineã€‚åœ¨æ‰€æœ‰çš„ data engine å¯¼å…¥å®Œæˆåï¼Œå¼€å§‹å¯¼å…¥ index engineã€‚</li>\n</ol>\n<p>è¿™é‡Œï¼Œåˆä½¿ç”¨äº†ä¸€ç§éå¸¸ Go é£æ ¼çš„æ–¹å¼å®ç°çº¿ç¨‹æ± çš„åŠŸèƒ½ã€‚åˆ©ç”¨ channel çš„ç¼“å†²ç‰¹æ€§ï¼Œå‘å…¶ä¸­æ·»åŠ  workerï¼Œä½¿ç”¨æ—¶å–èµ°ï¼Œä½¿ç”¨å®Œå†æ”¾å›åˆ° channel ä¸­ã€‚</p>\n<p>æœ€åï¼Œå¯¹äºæŸäº›éœ€è¦æ‰§è¡Œ post process çš„ä»»åŠ¡ï¼Œæ‰§è¡Œä¸€ä¸‹ç›¸åº”çš„ä»»åŠ¡ã€‚</p>\n<h3 id=\"FullCompact\"><a href=\"#FullCompact\" class=\"headerlink\" title=\"FullCompact\"></a>FullCompact</h3><p>è°ƒç”¨ TiKV çš„æ¥å£ï¼Œå¯¹æ‰€æœ‰æ–°å¯¼å…¥çš„æ•°æ®è¿›è¡Œå‹ç¼©ã€‚ä½†æ˜¯ç”±äºä¹‹å‰å¯¼å…¥æ•°æ®çš„æ—¶å€™ï¼Œä¼šæ ¹æ®æ˜¯å¦å­˜åœ¨å‹ç¼©ä»»åŠ¡ï¼Œå»å°è¯•æ‰§è¡Œ level-1 çš„å‹ç¼©ï¼Œæ‰€ä»¥è¿›è¡Œå…¨é‡å‹ç¼©çš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾…ä¹‹å‰å¯åŠ¨çš„ level-1 å‹ç¼©ä»»åŠ¡ç»“æŸã€‚</p>\n<h3 id=\"SwitchToNormalMode\"><a href=\"#SwitchToNormalMode\" class=\"headerlink\" title=\"SwitchToNormalMode\"></a>SwitchToNormalMode</h3><p>å°† TiKV åˆ‡æ¢æˆæ­£å¸¸æ¨¡å¼</p>\n<h3 id=\"CleanCheckpoints\"><a href=\"#CleanCheckpoints\" class=\"headerlink\" title=\"CleanCheckpoints\"></a>CleanCheckpoints</h3><p>æ‰€æœ‰çš„å¯¼å…¥ä»»åŠ¡éƒ½ç»“æŸäº†ï¼Œæ­¤æ—¶ checkpoint å·²ç»æ— ç”¨äº†ã€‚æ‰€ä»¥ï¼Œæ ¹æ®ç”¨æˆ·é…ç½®æ˜¯å¦åˆ é™¤ï¼Œå¤„ç† checkpointã€‚</p>\n","site":{"data":{}},"excerpt":"<p>TiDB Lightning æ˜¯ä¸€ä¸ªå°†æ•°æ®å¯¼å…¥åˆ° TiDB ä¸­çš„å·¥å…·ï¼Œä½¿ç”¨ Go ç¼–å†™ã€‚æ”¯æŒ <code>Local</code>, <code>Importer</code>, <code>TiDB</code> ä¸‰ç§å¯¼å…¥æ¨¡å¼ã€‚åœ¨ TiDB çš„å®˜ç½‘ä¸­ï¼Œå¯¹å…¶<a href=\"\">åŸç†</a>æœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚</p>\n<p>æœ¬æ–‡ä»ä»£ç çš„è§’åº¦ï¼Œå¸¦é¢†å¤§å®¶èµ°è¿‡ä¸€ä¸ªæ•°æ®å¯¼å…¥çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥åªå…³æ³¨ä¸€äº›é€»è¾‘ä¸Šé‡è¦çš„æ­¥éª¤ï¼Œè€Œä¸€äº›å…¶ä»–çš„ç»†èŠ‚å¯èƒ½ä¸ä¼šæ¶‰åŠåˆ°ã€‚</p>","more":"<p><img src=\"/asset/tidb-lightning/1.png\"><br>é¦–å…ˆï¼Œè¿›å…¥ main å‡½æ•°ï¼Œç¨‹åºè°ƒç”¨äº†ä¸¤ä¸ªä¸»è¦çš„å¯åŠ¨å‡½æ•°ï¼š<code>GoServer</code> å’Œ <code>RunServer</code>ã€‚</p>\n<h2 id=\"GoServer\"><a href=\"#GoServer\" class=\"headerlink\" title=\"GoServer\"></a>GoServer</h2><p><a href=\"https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L96\">https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L96</a></p>\n<p>GoServer å¯åŠ¨äº†ä¸€ä¸ª Api Serverï¼Œæœ‰ç€ä»¥ä¸‹è¿™äº› endpoint</p>\n<ul>\n<li>/web</li>\n<li>/metrics</li>\n<li>/debug</li>\n<li>/tasks</li>\n<li>/progress</li>\n<li>/pause</li>\n<li>/resume</li>\n<li>/loglevel</li>\n</ul>\n<p>Api Server ä¸ºæ•´ä¸ª lightning æä¾›äº†æ§åˆ¶ï¼Œç›‘æ§å’ŒæŸ¥çœ‹è¿›åº¦ç­‰åŠŸèƒ½ã€‚æ˜¯ç”¨æˆ·ä¸ lightning äº¤äº’çš„å…¥å£ã€‚è€Œå½“ç”¨æˆ·é€šè¿‡ <code>POST /tasks</code> æäº¤äº†ä¸€ä¸ªæ•°æ®å¯¼å…¥ä»»åŠ¡æ—¶ï¼ŒApi Server å°±ä¼šå‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œè€ŒåŒæ ·åœ¨ç›‘å¬ç€é˜Ÿåˆ—çš„ RunServer å°±ä¼šå¼€å§‹æ‰§è¡Œã€‚</p>\n<h2 id=\"RunServer\"><a href=\"#RunServer\" class=\"headerlink\" title=\"RunServer\"></a>RunServer</h2><p><a href=\"https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L194\">https://github.com/pingcap/br/blob/0b223bc5358cbe7ef6a54ad10fdd7aca81bf547f/pkg/lightning/lightning.go#L194</a></p>\n<p>RunServer æ˜¯çœŸæ­£æ‰§è¡Œå¯¼å…¥çš„åœ°æ–¹ã€‚ä¸€ä¸ª for å¾ªç¯ä¸€ç›´ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡é…ç½®ã€‚åœ¨è·å–åˆ°ä¸€ä¸ªä»»åŠ¡çš„é…ç½®åï¼Œå¼€å§‹æ­£å¼æ‰§è¡Œå¯¼å…¥ä»»åŠ¡ã€‚</p>\n<h3 id=\"RegisterMySQL\"><a href=\"#RegisterMySQL\" class=\"headerlink\" title=\"RegisterMySQL\"></a>RegisterMySQL</h3><p>è¿™ä¸ªå‡½æ•°çš„å‘½åæœ‰ç‚¹è¿·æƒ‘ï¼Œä½†æ‰€å¹¸æœ‰æ³¨é‡Šã€‚RegisterMySQL åŒæ—¶åŒ…å«äº†å‘ gomysql driver é…ç½® TLS å’Œè§£é™¤é…ç½®çš„ä¸¤ä¸ªä½œç”¨ã€‚åœ¨è¿è¡Œçš„ä¸€å¼€å§‹ï¼Œæ³¨å†Œ TiDB çš„ TLS é…ç½®ï¼Œè¿™æ ·ç›´æ¥å¯ä»¥ä½¿ç”¨ <code>sql.open()</code> è¿æ¥ TiDBã€‚åœ¨æ‰§è¡Œå¯¼å…¥ä»»åŠ¡ç»“æŸåï¼Œé€šè¿‡å°† <code>CAPath</code> ç½®ä¸ºç©ºï¼Œåˆ é™¤ TLS é…ç½®ã€‚</p>\n<h3 id=\"Glue\"><a href=\"#Glue\" class=\"headerlink\" title=\"Glue\"></a>Glue</h3><p>Glue å°†æ•°æ®å’Œå¯¼å…¥ç²˜åˆåœ¨ä¸€èµ·ã€‚è¿™é‡Œåœ¨åˆ›å»º Glue æ—¶ï¼Œå°±å°† TiDB è®¾ä¸ºäº†å¯¼å…¥æ¨¡å¼ã€‚</p>\n<h3 id=\"MyDumper\"><a href=\"#MyDumper\" class=\"headerlink\" title=\"MyDumper\"></a>MyDumper</h3><p>ç¡®å®šå¥½ç›®æ ‡æ•°æ®åº“ä¹Ÿå°±æ˜¯ backend åï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹æ•°æ®å¯¼å…¥çš„ frontend äº†ã€‚<code>MyDumper</code> æ˜¯ä¸€æ¬¾ç”± PingCAP åŸºäºç¤¾åŒºç‰ˆï¼Œä¸º TiDB å®šåˆ¶åŒ–å¼€å‘çš„æ•°æ®å¯¼å‡ºå·¥å…·ã€‚ä½†æ˜¯ç›®å‰ä¼¼ä¹å·²ç»ä¸æ¨èä½¿ç”¨äº†ï¼Œæ¨èæ”¹ç”¨ <code>dumpling</code> äº†ã€‚</p>\n<p>åœ¨è¿™é‡Œåˆ›å»º MyDumper æ—¶ï¼Œå°±ä¼šåœ¨ <code>setup</code> ä¸­ä» SQL æ–‡ä»¶ä¸­ã€‚ è¿™é‡Œä¼šå¯¹è¡¨æŒ‰ä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œè®©å°è¡¨ä¹‹åå…ˆè¿›è¡Œå¯¼å…¥ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤§è¡¨å¯¼å…¥æ—¶é˜»å¡å°è¡¨é‡Šæ”¾ index workerã€‚</p>\n<pre><code class=\"go\">type mdLoaderSetup struct &#123;\n    loader        *MDLoader\n    dbSchemas     []FileInfo\n    tableSchemas  []FileInfo\n    viewSchemas   []FileInfo\n    tableDatas    []FileInfo\n    dbIndexMap    map[string]int\n    tableIndexMap map[filter.Table]int\n&#125;\n</code></pre>\n<h3 id=\"Check\"><a href=\"#Check\" class=\"headerlink\" title=\"Check\"></a>Check</h3><p>åˆå§‹åŒ–å¹¶é…ç½®å¥½ MyDumper åï¼Œåœ¨æ­£å¼å¼€è·‘å‰ï¼Œç¨‹åºè¿˜éœ€è¦è¿›è¡Œæ£€æŸ¥ã€‚è¿™é‡Œæ£€æŸ¥äº†ä¸¤é¡¹ï¼š1. <code>CheckSystemRequirement</code> ç³»ç»Ÿè¦æ±‚æ˜¯å¦æ»¡è¶³ï¼Œlightning å¯¹äºå†…å­˜è¦æ±‚ä¼¼ä¹è¿˜æŒºé«˜ã€‚2. <code>CheckSchemaConflict</code> æ£€æŸ¥ç›®æ ‡æ•°æ®åº“çš„ Schema æ˜¯ä¸æ˜¯æœ‰å†²çªã€‚</p>\n<h2 id=\"RestoreController\"><a href=\"#RestoreController\" class=\"headerlink\" title=\"RestoreController\"></a>RestoreController</h2><p>lightning çš„å¯¼å…¥è¿‡ç¨‹ç”± <code>RestoreController</code> è¿›è¡Œæ§åˆ¶ã€‚<code>Run</code> ä¸­çš„ <code>opts</code> å®šä¹‰äº†å¯¼å…¥è¿‡ç¨‹æ‰€æœ‰çš„æ“ä½œã€‚</p>\n<h3 id=\"CheckRequirements\"><a href=\"#CheckRequirements\" class=\"headerlink\" title=\"CheckRequirements\"></a>CheckRequirements</h3><p>é€šè¿‡å¤šæ€å®ç°ï¼Œä¸‰ç§ backend æ‰§è¡Œä¸åŒçš„æ£€æŸ¥ã€‚</p>\n<h3 id=\"SetGlobalVariables\"><a href=\"#SetGlobalVariables\" class=\"headerlink\" title=\"SetGlobalVariables\"></a>SetGlobalVariables</h3><p>åœ¨ Server æ¨¡å¼ä¸‹ï¼Œç›®æ ‡æ•°æ®åº“çš„ <code>Collation</code> è®¾ç½®éƒ½å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥æ¯æ¬¡æ‰§è¡Œä»»åŠ¡éƒ½éœ€è¦è®¾ç½®ä¸€ä¸‹ã€‚</p>\n<h3 id=\"RestoreSchema\"><a href=\"#RestoreSchema\" class=\"headerlink\" title=\"RestoreSchema\"></a>RestoreSchema</h3><p>ä»è¿™é‡Œï¼Œlightning çœŸæ­£å¼€å§‹å¯¼å…¥æ•°æ®ã€‚é¦–å…ˆï¼Œå¯¼å…¥ Schemaã€‚Schema åŒ…å« <code>database</code>, <code>table</code>, <code>view</code> ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«å¯¹åº”ç€ä¹‹å‰ä» MyDumper ä¸­å¯¼å‡ºçš„ä¸‰ä¸ªéƒ¨åˆ†ã€‚Lightning ä½¿ç”¨ Glue ä¸­å°è£…çš„ç›®æ ‡æ•°æ®åº“è¿æ¥ï¼Œæ‰§è¡Œ SQLï¼Œå¯¼å…¥ Schema ä¿¡æ¯ã€‚</p>\n<p>è¿™é‡Œ lightning ä½¿ç”¨äº†ä¸€ç§éå¸¸ Go é£æ ¼çš„å®ç°æ–¹æ³•ã€‚å…ˆåˆ›å»ºå‡ºå¤šä¸ª goroutineï¼Œæ¯ä¸ª goroutine éƒ½ç›‘å¬ç€åŒä¸€ä¸ª channelã€‚ä¹‹åå†ä¸æ–­å‘ channel ä¸­åŠ å…¥è¦æ‰§è¡Œçš„ SQL ä»»åŠ¡ï¼Œä»è€Œå®ç°ä¸€ä¸ªç±»ä¼¼äºçº¿ç¨‹æ± çš„åŠŸèƒ½ã€‚</p>\n<p>åœ¨å¯¼å…¥ Schema æˆåŠŸåï¼ŒRestoreSchema è¿˜ä¼šè´Ÿè´£åˆå§‹åŒ– Checkpointï¼Œå¹¶åˆ›å»ºä¸€ä¸ª goroutineï¼Œç”¨æ¥ç›‘å¬ Checkpoint çš„å˜åŒ–ï¼Œå°†å¤šä¸ª Checkpoint åˆå¹¶åˆ°ä¸€èµ·ã€‚</p>\n<p>æœ€åï¼ŒRestoreSchema è¿˜ä¼šæ ¹æ® Schema ä¸­åŒ…å«çš„å…ƒä¿¡æ¯ï¼Œå¯¹ä¹‹åå¯¼å…¥æ•°æ®æ—¶åˆ’åˆ†çš„ chunk æ•°é‡è¿›è¡Œä¸€ä¸ªä¼°è®¡ã€‚</p>\n<h3 id=\"RestoreTables\"><a href=\"#RestoreTables\" class=\"headerlink\" title=\"RestoreTables\"></a>RestoreTables</h3><p>RestoreTables è´Ÿè´£ä»æºæ•°æ®åº“ä¸­å¯¼å‡ºæ•°æ®åˆ°ç›®æ ‡æ•°æ®åº“ä¸­ã€‚</p>\n<p>é¦–å…ˆï¼Œåœ¨ <code>populateChunks</code> å‡½æ•°ä¸­ï¼Œä½¿ç”¨ MyDumper å°†æ•°æ®åˆ’åˆ†æˆå¤šä¸ª chunkï¼Œæ¥ç€å°† chunk åŠ å…¥åˆ°å…¶å¯¹åº”çš„æ•°æ® engine ä¸­ã€‚ç„¶åæ·»åŠ ä¸€ä¸ªç´¢å¼• engine çš„ Checkpointã€‚</p>\n<p>ç„¶åï¼Œé€šè¿‡ <code>InsertEngineCheckpoint</code> åˆ›å»ºæ¯å¼ è¡¨çš„ Checkpointã€‚</p>\n<p>ç„¶åï¼Œåœ¨ <code>restoreEngines</code> ä¸­ï¼Œå…ˆå°†æºæ•°æ®åº“çš„æ•°æ®ä»å¯¼å‡ºçš„æ–‡ä»¶ï¼Œå¹¶å‘åœ°è½¬åŒ–æˆ KV æ ¼å¼çš„ engineï¼Œç„¶åå†å¯¼å…¥åˆ°ç›®æ ‡æ•°æ®åº“ä¸­ã€‚å…³äº engine çš„çŠ¶æ€æœºæ¨¡å‹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡<a href=\"https://blog.abingcbc.cn/2021/03/17/tikv-importer\">æ–‡ç« </a>ä¸­çš„æ€»ç»“ã€‚è¿™ä¸ªå‡½æ•°ä¸­åŒ…å«äº† lightning æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼Œæ‰€ä»¥æ¯”è¾ƒå¤æ‚ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š</p>\n<ol>\n<li>åœ¨ chunkRestore çš„ <code>restore</code> ä¸­ï¼Œåœ¨ <code>encodeLoop</code> ä¸­ï¼Œåˆ©ç”¨ MyDumper çš„ parserï¼Œå°†æ•°æ®ä»ä¸åŒçš„å¯¼å‡ºæ ¼å¼ç»Ÿä¸€è½¬æ¢æˆ KV æ ¼å¼ï¼Œæ’å…¥åˆ° engine ä¸­ã€‚æ­¤æ—¶ï¼Œæ‰€æœ‰çš„ Checkpointï¼ŒåŒ…æ‹¬ data å’Œ indexï¼Œéƒ½å·²ç»å†™å…¥å®Œæˆã€‚</li>\n<li>æ¥ç€ï¼Œæ ¹æ® engine çš„çŠ¶æ€æœºï¼Œå…³é—­ engine æ‰èƒ½å¼€å§‹å¯¼å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨éœ€è¦å°† engine çš„çŠ¶æ€ç½®ä¸º closeã€‚</li>\n<li>å…³é—­åï¼Œå¼€å§‹è°ƒç”¨ backend å¯¼å…¥ engineã€‚åœ¨æ‰€æœ‰çš„ data engine å¯¼å…¥å®Œæˆåï¼Œå¼€å§‹å¯¼å…¥ index engineã€‚</li>\n</ol>\n<p>è¿™é‡Œï¼Œåˆä½¿ç”¨äº†ä¸€ç§éå¸¸ Go é£æ ¼çš„æ–¹å¼å®ç°çº¿ç¨‹æ± çš„åŠŸèƒ½ã€‚åˆ©ç”¨ channel çš„ç¼“å†²ç‰¹æ€§ï¼Œå‘å…¶ä¸­æ·»åŠ  workerï¼Œä½¿ç”¨æ—¶å–èµ°ï¼Œä½¿ç”¨å®Œå†æ”¾å›åˆ° channel ä¸­ã€‚</p>\n<p>æœ€åï¼Œå¯¹äºæŸäº›éœ€è¦æ‰§è¡Œ post process çš„ä»»åŠ¡ï¼Œæ‰§è¡Œä¸€ä¸‹ç›¸åº”çš„ä»»åŠ¡ã€‚</p>\n<h3 id=\"FullCompact\"><a href=\"#FullCompact\" class=\"headerlink\" title=\"FullCompact\"></a>FullCompact</h3><p>è°ƒç”¨ TiKV çš„æ¥å£ï¼Œå¯¹æ‰€æœ‰æ–°å¯¼å…¥çš„æ•°æ®è¿›è¡Œå‹ç¼©ã€‚ä½†æ˜¯ç”±äºä¹‹å‰å¯¼å…¥æ•°æ®çš„æ—¶å€™ï¼Œä¼šæ ¹æ®æ˜¯å¦å­˜åœ¨å‹ç¼©ä»»åŠ¡ï¼Œå»å°è¯•æ‰§è¡Œ level-1 çš„å‹ç¼©ï¼Œæ‰€ä»¥è¿›è¡Œå…¨é‡å‹ç¼©çš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾…ä¹‹å‰å¯åŠ¨çš„ level-1 å‹ç¼©ä»»åŠ¡ç»“æŸã€‚</p>\n<h3 id=\"SwitchToNormalMode\"><a href=\"#SwitchToNormalMode\" class=\"headerlink\" title=\"SwitchToNormalMode\"></a>SwitchToNormalMode</h3><p>å°† TiKV åˆ‡æ¢æˆæ­£å¸¸æ¨¡å¼</p>\n<h3 id=\"CleanCheckpoints\"><a href=\"#CleanCheckpoints\" class=\"headerlink\" title=\"CleanCheckpoints\"></a>CleanCheckpoints</h3><p>æ‰€æœ‰çš„å¯¼å…¥ä»»åŠ¡éƒ½ç»“æŸäº†ï¼Œæ­¤æ—¶ checkpoint å·²ç»æ— ç”¨äº†ã€‚æ‰€ä»¥ï¼Œæ ¹æ®ç”¨æˆ·é…ç½®æ˜¯å¦åˆ é™¤ï¼Œå¤„ç† checkpointã€‚</p>"},{"title":"[PaperRead] Time2graph: Revisiting time series modeling with dynamic shapelets","date":"2021-09-06T18:39:53.000Z","updated":"2021-09-06T18:39:53.000Z","_content":"\nShapelet [<sup>1</sup>](#shapelet) æ˜¯ä¸€ç§å¸¸è§çš„å¯¹æ—¶åºæ•°æ®è¿›è¡Œå»ºæ¨¡çš„æ–¹æ³•ä¹‹ä¸€ã€‚ä» 2009 å¹´åœ¨ KDD ä¸Šå‘å¸ƒç¬¬ä¸€ç¯‡è®ºæ–‡ä»¥æ¥ï¼Œå…¶ç»è¿‡äº†å„å¼å„æ ·çš„å˜å½¢å’Œæ”¹è¿›ã€‚Time2graph [<sup>2</sup>](#time2graph) è§‚å¯Ÿåˆ° shapelet å…·æœ‰ time-aware çš„æ€§è´¨ï¼Œå› æ­¤æå‡ºäº†ä¸€ç§åŸºäº shapelet çš„æ—¶åºæ•°æ®çš„å»ºæ¨¡æ–¹æ³•ï¼Œå°†æ•°æ®å»ºæ¨¡æˆå›¾ç»“æ„ã€‚\n<!-- more -->\n\n## What\n### Shapelet\nA shapelet is a segment that is representative of a certain class.\nShapelet æ˜¯ä¸€æ®µå…·æœ‰ä»£è¡¨æ€§çš„å­åºåˆ—ï¼Œå®ƒå¯ä»¥å°†ä¸€æ¡æ—¶åºæ•°æ®çš„æ‰€æœ‰åˆ†æ®µåˆ†æˆä¸¤ç±»ï¼Œä¸€ç±»ä¸å…¶ç›¸ä¼¼ï¼Œå¦ä¸€ç±»ä¸å…¶ä¸åŒã€‚\n### Time-aware shapelet\nTime2graph ä¸­æ‰€åˆ›æ–°æ€§æå‡ºçš„åŒ…å«æ—¶é—´ä¿¡æ¯çš„ shapeletï¼Œåˆ©ç”¨å›¾å¯¹å…¶åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„å˜åŒ–è¿›è¡Œæ•æ‰ã€‚\n\n## Why\nä¼ ç»Ÿçš„ shaplet ä»¥åŠå…¶æ”¹è¿›å½¢å¼éƒ½å¿½ç•¥äº† shapelet åœ¨ä¸åŒçš„æ—¶é—´åŒºé—´ä¸Šçš„è¡¨ç°èƒ½åŠ›ã€‚è¿™é€ æˆä¸¤ç‚¹ä¸è¶³ï¼š\n1. ç›¸åŒ shapelet åœ¨ä¸åŒæ—¶é—´åŒºé—´ä¸Šçš„å«ä¹‰ä¸åŒã€‚\n2. shapelet ä¹‹é—´çš„å˜åŒ–å…³ç³»ä¹Ÿè¡¨ç¤ºäº†æ—¶åºæ•°æ®çš„ä¸€äº›ä¿¡æ¯ã€‚\n\n## How\n### Time-Aware Shapelet Extraction\nTime-aware shapelet çš„æŠ½å–å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤\n1. åˆ†æ®µ\n\n    è¿™é‡Œéœ€è¦è¶…å‚æ•°å¦‚ï¼šæ¯ä¸ªåˆ†æ®µçš„é•¿åº¦\n2. é€‰å– Candidate\n\n    è¿™ä¸€éƒ¨åˆ†åœ¨è®ºæ–‡ä¸­æ²¡æœ‰å™è¿°ï¼Œä½†é˜…è¯»æºä»£ç åï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œé’ˆå¯¹æ‰€æœ‰åˆ†æ®µåå¾—åˆ°çš„ç‰‡æ®µï¼Œæœ‰ä¸¤ç§æ–¹æ³•ä»ä¸­å¾—åˆ° candidate shapeletã€‚ç¬¬ä¸€ç§æ˜¯é€šè¿‡èšç±»ï¼Œä¾‹å¦‚ K-Meansï¼Œå’Œ DTW ä½œä¸ºè·ç¦»è¿›è¡Œèšç±»ï¼Œç„¶åé€‰å–ç±»ä¸­å¿ƒçš„ç‰‡æ®µä½œä¸º candidateã€‚ç¬¬äºŒç§åˆ™æ˜¯è´ªå©ªçš„æ–¹æ³•ï¼Œå³éå†è®¡ç®—ä¸€ä¸ªç‰‡æ®µä¸å…¶ä»–æ‰€æœ‰ç‰‡æ®µä¹‹é—´çš„è·ç¦»ï¼Œç„¶åé€‰å–å¹³å‡æœ€å°çš„ç‰‡æ®µä½œä¸º candidateã€‚\n3. è®¡ç®—è¯„åˆ†\n\n    Time2graph è®¾è®¡äº†æ–°çš„è¯„åˆ†æ–¹æ³•æ¥è¡¡é‡ shapelet åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„é‡è¦åº¦ï¼Œè¿™éƒ¨åˆ†æ¯”è¾ƒå¤æ‚ï¼Œåæ–‡ä¼šè¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚å¯¹æ‰€æœ‰çš„ shapelet candidate æ‰“åˆ†åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€‰å– top-k ä½œä¸ºçœŸæ­£çš„ shapeletã€‚\n\n#### Distance\nTime2graph è®¾è®¡äº†ä¸¤ä¸ªéœ€è¦è®­ç»ƒçš„å‚æ•°ï¼Œlocal factor **w** å’Œ global factor **u** æ¥åˆ†åˆ«è¡¡é‡ shapelet å†…éƒ¨æ¯ä¸ªå…ƒç´ çš„é‡è¦åº¦ä»¥åŠ shapelet åœ¨ä¸åŒæ—¶é—´æ®µä¸Šçš„é‡è¦åº¦ã€‚\n\nè®­ç»ƒçš„è¿‡ç¨‹éœ€è¦è¿›è¡Œæ¢¯åº¦ä¸‹é™ï¼ŒæŸå¤±å‡½æ•°å¦‚ä¸‹å›¾æ‰€ç¤º\n![](/asset/time2graph/loss_function.png)\n\n```\nv: shapelet\nT: time series\nSâˆ—(v, T): the set of distances with respect to a specific group Tâˆ—\ng: differentiable function measures the distances between distributions of two finite sets \n```\næœ€åä¸¤é¡¹ä¸º penaltiesã€‚å½“æ¢¯åº¦ä¸‹é™ä½¿å¾—æŸå¤±å‡½æ•°çš„å€¼è¶Šæ¥è¶Šå°æ—¶ï¼Œ`w` å’Œ `u` å°±è¶Šæ¥è¶Šå¯ä»¥ä½¿å¾— shapelet åˆ° positive å’Œ negative çš„è·ç¦»ä¹‹å·®è¶Šæ¥è¶Šå¤§ï¼Œè¿™æ · shapelet å°±è¶Šèƒ½ä»£è¡¨ä¸€ä¸ªç±»ã€‚\n\næ¥ä¸‹æ¥ï¼Œè¯¦ç»†ä»‹ç»æŸå¤±å‡½æ•°ä¸­æ‰€ç”¨åˆ°çš„ä¸¤ä¸ªè·ç¦»å‡½æ•°ã€‚\n\n1. shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»\n\n![](/asset/time2graph/dist_seg.png)\n\n```\nw: local factor éœ€è¦å­¦ä¹ çš„å‚æ•°\nu: global factor éœ€è¦å­¦ä¹ çš„å‚æ•°\ns: segment\na: alignmentï¼Œåˆ©ç”¨ DTW å¯å°†é•¿åº¦ä¸º i çš„ v å’Œé•¿åº¦ä¸º j çš„ s å¯¹é½æˆé•¿åº¦ä¸º p çš„ a1 å’Œ a2\n```\n\nå¯¹äº DTW alignmentï¼Œä¸‹é¢è¿™å¼ å›¾å½¢è±¡åœ°è§£é‡Šäº†æ•´ä¸ªå¯¹é½çš„è¿‡ç¨‹\n\n![](/asset/time2graph/dtw.png)\n\nå¯¹äºåºåˆ— s1 å’Œ s2ï¼Œs1 ä¸­çš„ä¸€ä¸ªç‚¹å¯èƒ½å¯¹åº” s2 ä¸­çš„å¤šä¸ªç‚¹ï¼ŒåŒæ—¶ s2 ä¸­çš„ä¸€ä¸ªç‚¹ä¹Ÿå¯èƒ½å¯¹åº” s1 ä¸­çš„å¤šä¸ªç‚¹ã€‚æ‰€ä»¥ï¼Œä¸¤è€…å¯¹é½åï¼Œä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„é•¿åº¦çš„åºåˆ—ã€‚è€Œ shapelet ä¸ segment çš„è·ç¦»ï¼Œå…¶å®å°±æ˜¯è®¡ç®—ä¸¤è€…å¯¹é½åçš„æ¬§æ°è·ç¦»ã€‚\n\n2. shapelet ä¸ time series ä¹‹é—´çš„è·ç¦»\n\n![](/asset/time2graph/dist_series.png)\n\nè¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œ`d` å³ä¸ºåˆšåˆšä»‹ç»çš„ shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»ã€‚shapelet ä¸ time series çš„è·ç¦»å³ä¸ºä¸ time series çš„æ‰€æœ‰åˆ†æ®µä¸­çš„æƒé‡æœ€å°å€¼ã€‚\n\n### Shapelet Evolution Graph\næ¥ä¸‹æ¥ï¼Œå°±æ˜¯è¦æ„å»ºå›¾æ¥è¡¨ç¤º shapelet ä¹‹é—´çš„è½¬ç§»å…³ç³»ã€‚\n\n![](/asset/time2graph/graph.png)\n\nç®—æ³•å…ˆå°† shapelet ä¸ segment å…³è”èµ·æ¥ï¼Œedge çš„æƒé‡ç”±ä»¥ä¸‹è¿™ä¸ªå…¬å¼è®¡ç®—\n\n![](/asset/time2graph/edge_weight.png)\n\nå…¬å¼è®¡ç®—çš„æ˜¯ shapelet ä¸ segment ç›¸å…³çš„æ¦‚ç‡ï¼Œå¦‚æœ shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»è¶Šè¿‘ï¼Œé‚£ä¹ˆç›¸å…³çš„æ¦‚ç‡è¶Šé«˜ã€‚\n\næ¥ä¸‹æ¥ï¼Œç®—æ³•å°†ç›¸é‚»çš„ segment çš„ shapelet è¿æ¥èµ·æ¥ï¼Œè€Œ edge çš„æƒé‡åˆ™æ˜¯å‰åä¸¤ä¸ª segment ä¸å„è‡ª shapelet ä¹‹é—´å…³è”æ¦‚ç‡çš„ä¹˜ç§¯ï¼Œä»£è¡¨äº†ä»å‰ä¸€ä¸ª shapelet è¿ç§»åˆ°åä¸€ä¸ª shapelet çš„æ¦‚ç‡ã€‚\n\n![](/asset/time2graph/transition.png)\n\næœ€åï¼Œç®—æ³•å°†ä¸€ä¸ª shapelet æ‰€æœ‰è¿ç§»å‡ºå»çš„ edge çš„æƒé‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å…¶å’Œä¸º 1ã€‚\n\nç®—æ³•çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤º\n\n![](/asset/time2graph/graph_algo.png)\n\n### Representation Learning\næœ€åï¼Œtime2graph é‡‡ç”¨äº† DeepWalk [<sup>3</sup>](#deepwalk)çš„ç®—æ³•ï¼Œå°† shapelet è½¬æ¢ä¸º embedding çš„å½¢å¼ã€‚\n\næ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥åˆ©ç”¨ shapelet çš„ embedding æ¥è¡¨ç¤º segment å’Œ time seriesã€‚\n\nsegment çš„å‘é‡åŒ–è¡¨ç¤ºå¦‚ä¸‹é¢è¿™ä¸ªå…¬å¼ï¼Œå°±æ˜¯å…¶ç›¸å…³ shapelet çš„ embedding çš„æ¦‚ç‡æƒé‡å’Œ\n\n![](/asset/time2graph/segment.png)\n\nè€Œ time series çš„å‘é‡åŒ–è¡¨ç¤ºå°±æ˜¯å°†å…¶æ‰€æœ‰ segment çš„ embedding çš„æ‹¼æ¥ã€‚\n\nç®—æ³•çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤º\n\n![](/asset/time2graph/representation.png)\n\n### Apply Time2graph\nè‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæ•´çš„äº†è§£äº† time2graph çš„è®­ç»ƒè¿‡ç¨‹ã€‚é‚£ä¹ˆ time2graph çš„åº”ç”¨è¿‡ç¨‹ä¹Ÿä¸ä¹‹ç±»ä¼¼ã€‚\n\né¦–å…ˆï¼Œç®—æ³•çš„è¾“å…¥ä»ç„¶æ˜¯ä¸€ä¸ª time seriesã€‚ç®—æ³•ä¼šå…ˆå¯¹å…¶è¿›è¡Œåˆ†æ®µï¼Œç„¶åä¸ºæ¯ä¸ª segment åˆ†é…ç›¸å…³çš„ shapeletã€‚æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥å¾—åˆ° segment å’Œ time series çš„ embeddingï¼Œè¿›è¡Œåç»­èšç±»æˆ–è€…å…¶ä»–æ“ä½œã€‚\n\n## Reference\n<div id=\"shapelet\" />\n- [1] Ye, Lexiang, and Eamonn Keogh. \"Time series shapelets: a new primitive for data mining.\"Â Proceedings of the 15th ACM SIGKDD international conference on Knowledge discovery and data mining. 2009.\n\n<div id=\"time2graph\" />\n- [2] Cheng, Ziqiang, et al. \"Time2graph: Revisiting time series modeling with dynamic shapelets.\"Â Proceedings of the AAAI Conference on Artificial Intelligence. Vol. 34. No. 04. 2020.\n\n<div id=\"deepwalk\" />\n- [3] Perozzi, Bryan, Rami Al-Rfou, and Steven Skiena. \"Deepwalk: Online learning of social representations.\"Â Proceedings of the 20th ACM SIGKDD international conference on Knowledge discovery and data mining. 2014.","source":"_posts/time2graph.md","raw":"---\ntitle: \"[PaperRead] Time2graph: Revisiting time series modeling with dynamic shapelets\"\ndate: 2021-09-06 18:39:53\nupdated: 2021-09-06 18:39:53\n---\n\nShapelet [<sup>1</sup>](#shapelet) æ˜¯ä¸€ç§å¸¸è§çš„å¯¹æ—¶åºæ•°æ®è¿›è¡Œå»ºæ¨¡çš„æ–¹æ³•ä¹‹ä¸€ã€‚ä» 2009 å¹´åœ¨ KDD ä¸Šå‘å¸ƒç¬¬ä¸€ç¯‡è®ºæ–‡ä»¥æ¥ï¼Œå…¶ç»è¿‡äº†å„å¼å„æ ·çš„å˜å½¢å’Œæ”¹è¿›ã€‚Time2graph [<sup>2</sup>](#time2graph) è§‚å¯Ÿåˆ° shapelet å…·æœ‰ time-aware çš„æ€§è´¨ï¼Œå› æ­¤æå‡ºäº†ä¸€ç§åŸºäº shapelet çš„æ—¶åºæ•°æ®çš„å»ºæ¨¡æ–¹æ³•ï¼Œå°†æ•°æ®å»ºæ¨¡æˆå›¾ç»“æ„ã€‚\n<!-- more -->\n\n## What\n### Shapelet\nA shapelet is a segment that is representative of a certain class.\nShapelet æ˜¯ä¸€æ®µå…·æœ‰ä»£è¡¨æ€§çš„å­åºåˆ—ï¼Œå®ƒå¯ä»¥å°†ä¸€æ¡æ—¶åºæ•°æ®çš„æ‰€æœ‰åˆ†æ®µåˆ†æˆä¸¤ç±»ï¼Œä¸€ç±»ä¸å…¶ç›¸ä¼¼ï¼Œå¦ä¸€ç±»ä¸å…¶ä¸åŒã€‚\n### Time-aware shapelet\nTime2graph ä¸­æ‰€åˆ›æ–°æ€§æå‡ºçš„åŒ…å«æ—¶é—´ä¿¡æ¯çš„ shapeletï¼Œåˆ©ç”¨å›¾å¯¹å…¶åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„å˜åŒ–è¿›è¡Œæ•æ‰ã€‚\n\n## Why\nä¼ ç»Ÿçš„ shaplet ä»¥åŠå…¶æ”¹è¿›å½¢å¼éƒ½å¿½ç•¥äº† shapelet åœ¨ä¸åŒçš„æ—¶é—´åŒºé—´ä¸Šçš„è¡¨ç°èƒ½åŠ›ã€‚è¿™é€ æˆä¸¤ç‚¹ä¸è¶³ï¼š\n1. ç›¸åŒ shapelet åœ¨ä¸åŒæ—¶é—´åŒºé—´ä¸Šçš„å«ä¹‰ä¸åŒã€‚\n2. shapelet ä¹‹é—´çš„å˜åŒ–å…³ç³»ä¹Ÿè¡¨ç¤ºäº†æ—¶åºæ•°æ®çš„ä¸€äº›ä¿¡æ¯ã€‚\n\n## How\n### Time-Aware Shapelet Extraction\nTime-aware shapelet çš„æŠ½å–å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤\n1. åˆ†æ®µ\n\n    è¿™é‡Œéœ€è¦è¶…å‚æ•°å¦‚ï¼šæ¯ä¸ªåˆ†æ®µçš„é•¿åº¦\n2. é€‰å– Candidate\n\n    è¿™ä¸€éƒ¨åˆ†åœ¨è®ºæ–‡ä¸­æ²¡æœ‰å™è¿°ï¼Œä½†é˜…è¯»æºä»£ç åï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œé’ˆå¯¹æ‰€æœ‰åˆ†æ®µåå¾—åˆ°çš„ç‰‡æ®µï¼Œæœ‰ä¸¤ç§æ–¹æ³•ä»ä¸­å¾—åˆ° candidate shapeletã€‚ç¬¬ä¸€ç§æ˜¯é€šè¿‡èšç±»ï¼Œä¾‹å¦‚ K-Meansï¼Œå’Œ DTW ä½œä¸ºè·ç¦»è¿›è¡Œèšç±»ï¼Œç„¶åé€‰å–ç±»ä¸­å¿ƒçš„ç‰‡æ®µä½œä¸º candidateã€‚ç¬¬äºŒç§åˆ™æ˜¯è´ªå©ªçš„æ–¹æ³•ï¼Œå³éå†è®¡ç®—ä¸€ä¸ªç‰‡æ®µä¸å…¶ä»–æ‰€æœ‰ç‰‡æ®µä¹‹é—´çš„è·ç¦»ï¼Œç„¶åé€‰å–å¹³å‡æœ€å°çš„ç‰‡æ®µä½œä¸º candidateã€‚\n3. è®¡ç®—è¯„åˆ†\n\n    Time2graph è®¾è®¡äº†æ–°çš„è¯„åˆ†æ–¹æ³•æ¥è¡¡é‡ shapelet åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„é‡è¦åº¦ï¼Œè¿™éƒ¨åˆ†æ¯”è¾ƒå¤æ‚ï¼Œåæ–‡ä¼šè¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚å¯¹æ‰€æœ‰çš„ shapelet candidate æ‰“åˆ†åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€‰å– top-k ä½œä¸ºçœŸæ­£çš„ shapeletã€‚\n\n#### Distance\nTime2graph è®¾è®¡äº†ä¸¤ä¸ªéœ€è¦è®­ç»ƒçš„å‚æ•°ï¼Œlocal factor **w** å’Œ global factor **u** æ¥åˆ†åˆ«è¡¡é‡ shapelet å†…éƒ¨æ¯ä¸ªå…ƒç´ çš„é‡è¦åº¦ä»¥åŠ shapelet åœ¨ä¸åŒæ—¶é—´æ®µä¸Šçš„é‡è¦åº¦ã€‚\n\nè®­ç»ƒçš„è¿‡ç¨‹éœ€è¦è¿›è¡Œæ¢¯åº¦ä¸‹é™ï¼ŒæŸå¤±å‡½æ•°å¦‚ä¸‹å›¾æ‰€ç¤º\n![](/asset/time2graph/loss_function.png)\n\n```\nv: shapelet\nT: time series\nSâˆ—(v, T): the set of distances with respect to a specific group Tâˆ—\ng: differentiable function measures the distances between distributions of two finite sets \n```\næœ€åä¸¤é¡¹ä¸º penaltiesã€‚å½“æ¢¯åº¦ä¸‹é™ä½¿å¾—æŸå¤±å‡½æ•°çš„å€¼è¶Šæ¥è¶Šå°æ—¶ï¼Œ`w` å’Œ `u` å°±è¶Šæ¥è¶Šå¯ä»¥ä½¿å¾— shapelet åˆ° positive å’Œ negative çš„è·ç¦»ä¹‹å·®è¶Šæ¥è¶Šå¤§ï¼Œè¿™æ · shapelet å°±è¶Šèƒ½ä»£è¡¨ä¸€ä¸ªç±»ã€‚\n\næ¥ä¸‹æ¥ï¼Œè¯¦ç»†ä»‹ç»æŸå¤±å‡½æ•°ä¸­æ‰€ç”¨åˆ°çš„ä¸¤ä¸ªè·ç¦»å‡½æ•°ã€‚\n\n1. shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»\n\n![](/asset/time2graph/dist_seg.png)\n\n```\nw: local factor éœ€è¦å­¦ä¹ çš„å‚æ•°\nu: global factor éœ€è¦å­¦ä¹ çš„å‚æ•°\ns: segment\na: alignmentï¼Œåˆ©ç”¨ DTW å¯å°†é•¿åº¦ä¸º i çš„ v å’Œé•¿åº¦ä¸º j çš„ s å¯¹é½æˆé•¿åº¦ä¸º p çš„ a1 å’Œ a2\n```\n\nå¯¹äº DTW alignmentï¼Œä¸‹é¢è¿™å¼ å›¾å½¢è±¡åœ°è§£é‡Šäº†æ•´ä¸ªå¯¹é½çš„è¿‡ç¨‹\n\n![](/asset/time2graph/dtw.png)\n\nå¯¹äºåºåˆ— s1 å’Œ s2ï¼Œs1 ä¸­çš„ä¸€ä¸ªç‚¹å¯èƒ½å¯¹åº” s2 ä¸­çš„å¤šä¸ªç‚¹ï¼ŒåŒæ—¶ s2 ä¸­çš„ä¸€ä¸ªç‚¹ä¹Ÿå¯èƒ½å¯¹åº” s1 ä¸­çš„å¤šä¸ªç‚¹ã€‚æ‰€ä»¥ï¼Œä¸¤è€…å¯¹é½åï¼Œä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„é•¿åº¦çš„åºåˆ—ã€‚è€Œ shapelet ä¸ segment çš„è·ç¦»ï¼Œå…¶å®å°±æ˜¯è®¡ç®—ä¸¤è€…å¯¹é½åçš„æ¬§æ°è·ç¦»ã€‚\n\n2. shapelet ä¸ time series ä¹‹é—´çš„è·ç¦»\n\n![](/asset/time2graph/dist_series.png)\n\nè¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œ`d` å³ä¸ºåˆšåˆšä»‹ç»çš„ shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»ã€‚shapelet ä¸ time series çš„è·ç¦»å³ä¸ºä¸ time series çš„æ‰€æœ‰åˆ†æ®µä¸­çš„æƒé‡æœ€å°å€¼ã€‚\n\n### Shapelet Evolution Graph\næ¥ä¸‹æ¥ï¼Œå°±æ˜¯è¦æ„å»ºå›¾æ¥è¡¨ç¤º shapelet ä¹‹é—´çš„è½¬ç§»å…³ç³»ã€‚\n\n![](/asset/time2graph/graph.png)\n\nç®—æ³•å…ˆå°† shapelet ä¸ segment å…³è”èµ·æ¥ï¼Œedge çš„æƒé‡ç”±ä»¥ä¸‹è¿™ä¸ªå…¬å¼è®¡ç®—\n\n![](/asset/time2graph/edge_weight.png)\n\nå…¬å¼è®¡ç®—çš„æ˜¯ shapelet ä¸ segment ç›¸å…³çš„æ¦‚ç‡ï¼Œå¦‚æœ shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»è¶Šè¿‘ï¼Œé‚£ä¹ˆç›¸å…³çš„æ¦‚ç‡è¶Šé«˜ã€‚\n\næ¥ä¸‹æ¥ï¼Œç®—æ³•å°†ç›¸é‚»çš„ segment çš„ shapelet è¿æ¥èµ·æ¥ï¼Œè€Œ edge çš„æƒé‡åˆ™æ˜¯å‰åä¸¤ä¸ª segment ä¸å„è‡ª shapelet ä¹‹é—´å…³è”æ¦‚ç‡çš„ä¹˜ç§¯ï¼Œä»£è¡¨äº†ä»å‰ä¸€ä¸ª shapelet è¿ç§»åˆ°åä¸€ä¸ª shapelet çš„æ¦‚ç‡ã€‚\n\n![](/asset/time2graph/transition.png)\n\næœ€åï¼Œç®—æ³•å°†ä¸€ä¸ª shapelet æ‰€æœ‰è¿ç§»å‡ºå»çš„ edge çš„æƒé‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å…¶å’Œä¸º 1ã€‚\n\nç®—æ³•çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤º\n\n![](/asset/time2graph/graph_algo.png)\n\n### Representation Learning\næœ€åï¼Œtime2graph é‡‡ç”¨äº† DeepWalk [<sup>3</sup>](#deepwalk)çš„ç®—æ³•ï¼Œå°† shapelet è½¬æ¢ä¸º embedding çš„å½¢å¼ã€‚\n\næ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥åˆ©ç”¨ shapelet çš„ embedding æ¥è¡¨ç¤º segment å’Œ time seriesã€‚\n\nsegment çš„å‘é‡åŒ–è¡¨ç¤ºå¦‚ä¸‹é¢è¿™ä¸ªå…¬å¼ï¼Œå°±æ˜¯å…¶ç›¸å…³ shapelet çš„ embedding çš„æ¦‚ç‡æƒé‡å’Œ\n\n![](/asset/time2graph/segment.png)\n\nè€Œ time series çš„å‘é‡åŒ–è¡¨ç¤ºå°±æ˜¯å°†å…¶æ‰€æœ‰ segment çš„ embedding çš„æ‹¼æ¥ã€‚\n\nç®—æ³•çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤º\n\n![](/asset/time2graph/representation.png)\n\n### Apply Time2graph\nè‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæ•´çš„äº†è§£äº† time2graph çš„è®­ç»ƒè¿‡ç¨‹ã€‚é‚£ä¹ˆ time2graph çš„åº”ç”¨è¿‡ç¨‹ä¹Ÿä¸ä¹‹ç±»ä¼¼ã€‚\n\né¦–å…ˆï¼Œç®—æ³•çš„è¾“å…¥ä»ç„¶æ˜¯ä¸€ä¸ª time seriesã€‚ç®—æ³•ä¼šå…ˆå¯¹å…¶è¿›è¡Œåˆ†æ®µï¼Œç„¶åä¸ºæ¯ä¸ª segment åˆ†é…ç›¸å…³çš„ shapeletã€‚æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥å¾—åˆ° segment å’Œ time series çš„ embeddingï¼Œè¿›è¡Œåç»­èšç±»æˆ–è€…å…¶ä»–æ“ä½œã€‚\n\n## Reference\n<div id=\"shapelet\" />\n- [1] Ye, Lexiang, and Eamonn Keogh. \"Time series shapelets: a new primitive for data mining.\"Â Proceedings of the 15th ACM SIGKDD international conference on Knowledge discovery and data mining. 2009.\n\n<div id=\"time2graph\" />\n- [2] Cheng, Ziqiang, et al. \"Time2graph: Revisiting time series modeling with dynamic shapelets.\"Â Proceedings of the AAAI Conference on Artificial Intelligence. Vol. 34. No. 04. 2020.\n\n<div id=\"deepwalk\" />\n- [3] Perozzi, Bryan, Rami Al-Rfou, and Steven Skiena. \"Deepwalk: Online learning of social representations.\"Â Proceedings of the 20th ACM SIGKDD international conference on Knowledge discovery and data mining. 2014.","slug":"time2graph","published":1,"comments":1,"layout":"post","photos":[],"link":"","_id":"cl5i8k7y700091rpfhnt9ehwq","content":"<p>Shapelet <a href=\"#shapelet\"><sup>1</sup></a> æ˜¯ä¸€ç§å¸¸è§çš„å¯¹æ—¶åºæ•°æ®è¿›è¡Œå»ºæ¨¡çš„æ–¹æ³•ä¹‹ä¸€ã€‚ä» 2009 å¹´åœ¨ KDD ä¸Šå‘å¸ƒç¬¬ä¸€ç¯‡è®ºæ–‡ä»¥æ¥ï¼Œå…¶ç»è¿‡äº†å„å¼å„æ ·çš„å˜å½¢å’Œæ”¹è¿›ã€‚Time2graph <a href=\"#time2graph\"><sup>2</sup></a> è§‚å¯Ÿåˆ° shapelet å…·æœ‰ time-aware çš„æ€§è´¨ï¼Œå› æ­¤æå‡ºäº†ä¸€ç§åŸºäº shapelet çš„æ—¶åºæ•°æ®çš„å»ºæ¨¡æ–¹æ³•ï¼Œå°†æ•°æ®å»ºæ¨¡æˆå›¾ç»“æ„ã€‚</p>\n<span id=\"more\"></span>\n\n<h2 id=\"What\"><a href=\"#What\" class=\"headerlink\" title=\"What\"></a>What</h2><h3 id=\"Shapelet\"><a href=\"#Shapelet\" class=\"headerlink\" title=\"Shapelet\"></a>Shapelet</h3><p>A shapelet is a segment that is representative of a certain class.<br>Shapelet æ˜¯ä¸€æ®µå…·æœ‰ä»£è¡¨æ€§çš„å­åºåˆ—ï¼Œå®ƒå¯ä»¥å°†ä¸€æ¡æ—¶åºæ•°æ®çš„æ‰€æœ‰åˆ†æ®µåˆ†æˆä¸¤ç±»ï¼Œä¸€ç±»ä¸å…¶ç›¸ä¼¼ï¼Œå¦ä¸€ç±»ä¸å…¶ä¸åŒã€‚</p>\n<h3 id=\"Time-aware-shapelet\"><a href=\"#Time-aware-shapelet\" class=\"headerlink\" title=\"Time-aware shapelet\"></a>Time-aware shapelet</h3><p>Time2graph ä¸­æ‰€åˆ›æ–°æ€§æå‡ºçš„åŒ…å«æ—¶é—´ä¿¡æ¯çš„ shapeletï¼Œåˆ©ç”¨å›¾å¯¹å…¶åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„å˜åŒ–è¿›è¡Œæ•æ‰ã€‚</p>\n<h2 id=\"Why\"><a href=\"#Why\" class=\"headerlink\" title=\"Why\"></a>Why</h2><p>ä¼ ç»Ÿçš„ shaplet ä»¥åŠå…¶æ”¹è¿›å½¢å¼éƒ½å¿½ç•¥äº† shapelet åœ¨ä¸åŒçš„æ—¶é—´åŒºé—´ä¸Šçš„è¡¨ç°èƒ½åŠ›ã€‚è¿™é€ æˆä¸¤ç‚¹ä¸è¶³ï¼š</p>\n<ol>\n<li>ç›¸åŒ shapelet åœ¨ä¸åŒæ—¶é—´åŒºé—´ä¸Šçš„å«ä¹‰ä¸åŒã€‚</li>\n<li>shapelet ä¹‹é—´çš„å˜åŒ–å…³ç³»ä¹Ÿè¡¨ç¤ºäº†æ—¶åºæ•°æ®çš„ä¸€äº›ä¿¡æ¯ã€‚</li>\n</ol>\n<h2 id=\"How\"><a href=\"#How\" class=\"headerlink\" title=\"How\"></a>How</h2><h3 id=\"Time-Aware-Shapelet-Extraction\"><a href=\"#Time-Aware-Shapelet-Extraction\" class=\"headerlink\" title=\"Time-Aware Shapelet Extraction\"></a>Time-Aware Shapelet Extraction</h3><p>Time-aware shapelet çš„æŠ½å–å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤</p>\n<ol>\n<li><p>åˆ†æ®µ</p>\n<p> è¿™é‡Œéœ€è¦è¶…å‚æ•°å¦‚ï¼šæ¯ä¸ªåˆ†æ®µçš„é•¿åº¦</p>\n</li>\n<li><p>é€‰å– Candidate</p>\n<p> è¿™ä¸€éƒ¨åˆ†åœ¨è®ºæ–‡ä¸­æ²¡æœ‰å™è¿°ï¼Œä½†é˜…è¯»æºä»£ç åï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œé’ˆå¯¹æ‰€æœ‰åˆ†æ®µåå¾—åˆ°çš„ç‰‡æ®µï¼Œæœ‰ä¸¤ç§æ–¹æ³•ä»ä¸­å¾—åˆ° candidate shapeletã€‚ç¬¬ä¸€ç§æ˜¯é€šè¿‡èšç±»ï¼Œä¾‹å¦‚ K-Meansï¼Œå’Œ DTW ä½œä¸ºè·ç¦»è¿›è¡Œèšç±»ï¼Œç„¶åé€‰å–ç±»ä¸­å¿ƒçš„ç‰‡æ®µä½œä¸º candidateã€‚ç¬¬äºŒç§åˆ™æ˜¯è´ªå©ªçš„æ–¹æ³•ï¼Œå³éå†è®¡ç®—ä¸€ä¸ªç‰‡æ®µä¸å…¶ä»–æ‰€æœ‰ç‰‡æ®µä¹‹é—´çš„è·ç¦»ï¼Œç„¶åé€‰å–å¹³å‡æœ€å°çš„ç‰‡æ®µä½œä¸º candidateã€‚</p>\n</li>\n<li><p>è®¡ç®—è¯„åˆ†</p>\n<p> Time2graph è®¾è®¡äº†æ–°çš„è¯„åˆ†æ–¹æ³•æ¥è¡¡é‡ shapelet åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„é‡è¦åº¦ï¼Œè¿™éƒ¨åˆ†æ¯”è¾ƒå¤æ‚ï¼Œåæ–‡ä¼šè¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚å¯¹æ‰€æœ‰çš„ shapelet candidate æ‰“åˆ†åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€‰å– top-k ä½œä¸ºçœŸæ­£çš„ shapeletã€‚</p>\n</li>\n</ol>\n<h4 id=\"Distance\"><a href=\"#Distance\" class=\"headerlink\" title=\"Distance\"></a>Distance</h4><p>Time2graph è®¾è®¡äº†ä¸¤ä¸ªéœ€è¦è®­ç»ƒçš„å‚æ•°ï¼Œlocal factor <strong>w</strong> å’Œ global factor <strong>u</strong> æ¥åˆ†åˆ«è¡¡é‡ shapelet å†…éƒ¨æ¯ä¸ªå…ƒç´ çš„é‡è¦åº¦ä»¥åŠ shapelet åœ¨ä¸åŒæ—¶é—´æ®µä¸Šçš„é‡è¦åº¦ã€‚</p>\n<p>è®­ç»ƒçš„è¿‡ç¨‹éœ€è¦è¿›è¡Œæ¢¯åº¦ä¸‹é™ï¼ŒæŸå¤±å‡½æ•°å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src=\"/asset/time2graph/loss_function.png\"></p>\n<pre><code>v: shapelet\nT: time series\nSâˆ—(v, T): the set of distances with respect to a specific group Tâˆ—\ng: differentiable function measures the distances between distributions of two finite sets \n</code></pre>\n<p>æœ€åä¸¤é¡¹ä¸º penaltiesã€‚å½“æ¢¯åº¦ä¸‹é™ä½¿å¾—æŸå¤±å‡½æ•°çš„å€¼è¶Šæ¥è¶Šå°æ—¶ï¼Œ<code>w</code> å’Œ <code>u</code> å°±è¶Šæ¥è¶Šå¯ä»¥ä½¿å¾— shapelet åˆ° positive å’Œ negative çš„è·ç¦»ä¹‹å·®è¶Šæ¥è¶Šå¤§ï¼Œè¿™æ · shapelet å°±è¶Šèƒ½ä»£è¡¨ä¸€ä¸ªç±»ã€‚</p>\n<p>æ¥ä¸‹æ¥ï¼Œè¯¦ç»†ä»‹ç»æŸå¤±å‡½æ•°ä¸­æ‰€ç”¨åˆ°çš„ä¸¤ä¸ªè·ç¦»å‡½æ•°ã€‚</p>\n<ol>\n<li>shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»</li>\n</ol>\n<p><img src=\"/asset/time2graph/dist_seg.png\"></p>\n<pre><code>w: local factor éœ€è¦å­¦ä¹ çš„å‚æ•°\nu: global factor éœ€è¦å­¦ä¹ çš„å‚æ•°\ns: segment\na: alignmentï¼Œåˆ©ç”¨ DTW å¯å°†é•¿åº¦ä¸º i çš„ v å’Œé•¿åº¦ä¸º j çš„ s å¯¹é½æˆé•¿åº¦ä¸º p çš„ a1 å’Œ a2\n</code></pre>\n<p>å¯¹äº DTW alignmentï¼Œä¸‹é¢è¿™å¼ å›¾å½¢è±¡åœ°è§£é‡Šäº†æ•´ä¸ªå¯¹é½çš„è¿‡ç¨‹</p>\n<p><img src=\"/asset/time2graph/dtw.png\"></p>\n<p>å¯¹äºåºåˆ— s1 å’Œ s2ï¼Œs1 ä¸­çš„ä¸€ä¸ªç‚¹å¯èƒ½å¯¹åº” s2 ä¸­çš„å¤šä¸ªç‚¹ï¼ŒåŒæ—¶ s2 ä¸­çš„ä¸€ä¸ªç‚¹ä¹Ÿå¯èƒ½å¯¹åº” s1 ä¸­çš„å¤šä¸ªç‚¹ã€‚æ‰€ä»¥ï¼Œä¸¤è€…å¯¹é½åï¼Œä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„é•¿åº¦çš„åºåˆ—ã€‚è€Œ shapelet ä¸ segment çš„è·ç¦»ï¼Œå…¶å®å°±æ˜¯è®¡ç®—ä¸¤è€…å¯¹é½åçš„æ¬§æ°è·ç¦»ã€‚</p>\n<ol start=\"2\">\n<li>shapelet ä¸ time series ä¹‹é—´çš„è·ç¦»</li>\n</ol>\n<p><img src=\"/asset/time2graph/dist_series.png\"></p>\n<p>è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œ<code>d</code> å³ä¸ºåˆšåˆšä»‹ç»çš„ shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»ã€‚shapelet ä¸ time series çš„è·ç¦»å³ä¸ºä¸ time series çš„æ‰€æœ‰åˆ†æ®µä¸­çš„æƒé‡æœ€å°å€¼ã€‚</p>\n<h3 id=\"Shapelet-Evolution-Graph\"><a href=\"#Shapelet-Evolution-Graph\" class=\"headerlink\" title=\"Shapelet Evolution Graph\"></a>Shapelet Evolution Graph</h3><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯è¦æ„å»ºå›¾æ¥è¡¨ç¤º shapelet ä¹‹é—´çš„è½¬ç§»å…³ç³»ã€‚</p>\n<p><img src=\"/asset/time2graph/graph.png\"></p>\n<p>ç®—æ³•å…ˆå°† shapelet ä¸ segment å…³è”èµ·æ¥ï¼Œedge çš„æƒé‡ç”±ä»¥ä¸‹è¿™ä¸ªå…¬å¼è®¡ç®—</p>\n<p><img src=\"/asset/time2graph/edge_weight.png\"></p>\n<p>å…¬å¼è®¡ç®—çš„æ˜¯ shapelet ä¸ segment ç›¸å…³çš„æ¦‚ç‡ï¼Œå¦‚æœ shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»è¶Šè¿‘ï¼Œé‚£ä¹ˆç›¸å…³çš„æ¦‚ç‡è¶Šé«˜ã€‚</p>\n<p>æ¥ä¸‹æ¥ï¼Œç®—æ³•å°†ç›¸é‚»çš„ segment çš„ shapelet è¿æ¥èµ·æ¥ï¼Œè€Œ edge çš„æƒé‡åˆ™æ˜¯å‰åä¸¤ä¸ª segment ä¸å„è‡ª shapelet ä¹‹é—´å…³è”æ¦‚ç‡çš„ä¹˜ç§¯ï¼Œä»£è¡¨äº†ä»å‰ä¸€ä¸ª shapelet è¿ç§»åˆ°åä¸€ä¸ª shapelet çš„æ¦‚ç‡ã€‚</p>\n<p><img src=\"/asset/time2graph/transition.png\"></p>\n<p>æœ€åï¼Œç®—æ³•å°†ä¸€ä¸ª shapelet æ‰€æœ‰è¿ç§»å‡ºå»çš„ edge çš„æƒé‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å…¶å’Œä¸º 1ã€‚</p>\n<p>ç®—æ³•çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤º</p>\n<p><img src=\"/asset/time2graph/graph_algo.png\"></p>\n<h3 id=\"Representation-Learning\"><a href=\"#Representation-Learning\" class=\"headerlink\" title=\"Representation Learning\"></a>Representation Learning</h3><p>æœ€åï¼Œtime2graph é‡‡ç”¨äº† DeepWalk <a href=\"#deepwalk\"><sup>3</sup></a>çš„ç®—æ³•ï¼Œå°† shapelet è½¬æ¢ä¸º embedding çš„å½¢å¼ã€‚</p>\n<p>æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥åˆ©ç”¨ shapelet çš„ embedding æ¥è¡¨ç¤º segment å’Œ time seriesã€‚</p>\n<p>segment çš„å‘é‡åŒ–è¡¨ç¤ºå¦‚ä¸‹é¢è¿™ä¸ªå…¬å¼ï¼Œå°±æ˜¯å…¶ç›¸å…³ shapelet çš„ embedding çš„æ¦‚ç‡æƒé‡å’Œ</p>\n<p><img src=\"/asset/time2graph/segment.png\"></p>\n<p>è€Œ time series çš„å‘é‡åŒ–è¡¨ç¤ºå°±æ˜¯å°†å…¶æ‰€æœ‰ segment çš„ embedding çš„æ‹¼æ¥ã€‚</p>\n<p>ç®—æ³•çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤º</p>\n<p><img src=\"/asset/time2graph/representation.png\"></p>\n<h3 id=\"Apply-Time2graph\"><a href=\"#Apply-Time2graph\" class=\"headerlink\" title=\"Apply Time2graph\"></a>Apply Time2graph</h3><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæ•´çš„äº†è§£äº† time2graph çš„è®­ç»ƒè¿‡ç¨‹ã€‚é‚£ä¹ˆ time2graph çš„åº”ç”¨è¿‡ç¨‹ä¹Ÿä¸ä¹‹ç±»ä¼¼ã€‚</p>\n<p>é¦–å…ˆï¼Œç®—æ³•çš„è¾“å…¥ä»ç„¶æ˜¯ä¸€ä¸ª time seriesã€‚ç®—æ³•ä¼šå…ˆå¯¹å…¶è¿›è¡Œåˆ†æ®µï¼Œç„¶åä¸ºæ¯ä¸ª segment åˆ†é…ç›¸å…³çš„ shapeletã€‚æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥å¾—åˆ° segment å’Œ time series çš„ embeddingï¼Œè¿›è¡Œåç»­èšç±»æˆ–è€…å…¶ä»–æ“ä½œã€‚</p>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><div id=\"shapelet\" />\n- [1] Ye, Lexiang, and Eamonn Keogh. \"Time series shapelets: a new primitive for data mining.\"Â Proceedings of the 15th ACM SIGKDD international conference on Knowledge discovery and data mining. 2009.\n\n<div id=\"time2graph\" />\n- [2] Cheng, Ziqiang, et al. \"Time2graph: Revisiting time series modeling with dynamic shapelets.\"Â Proceedings of the AAAI Conference on Artificial Intelligence. Vol. 34. No. 04. 2020.\n\n<div id=\"deepwalk\" />\n- [3] Perozzi, Bryan, Rami Al-Rfou, and Steven Skiena. \"Deepwalk: Online learning of social representations.\"Â Proceedings of the 20th ACM SIGKDD international conference on Knowledge discovery and data mining. 2014.","site":{"data":{}},"excerpt":"<p>Shapelet <a href=\"#shapelet\"><sup>1</sup></a> æ˜¯ä¸€ç§å¸¸è§çš„å¯¹æ—¶åºæ•°æ®è¿›è¡Œå»ºæ¨¡çš„æ–¹æ³•ä¹‹ä¸€ã€‚ä» 2009 å¹´åœ¨ KDD ä¸Šå‘å¸ƒç¬¬ä¸€ç¯‡è®ºæ–‡ä»¥æ¥ï¼Œå…¶ç»è¿‡äº†å„å¼å„æ ·çš„å˜å½¢å’Œæ”¹è¿›ã€‚Time2graph <a href=\"#time2graph\"><sup>2</sup></a> è§‚å¯Ÿåˆ° shapelet å…·æœ‰ time-aware çš„æ€§è´¨ï¼Œå› æ­¤æå‡ºäº†ä¸€ç§åŸºäº shapelet çš„æ—¶åºæ•°æ®çš„å»ºæ¨¡æ–¹æ³•ï¼Œå°†æ•°æ®å»ºæ¨¡æˆå›¾ç»“æ„ã€‚</p>","more":"<h2 id=\"What\"><a href=\"#What\" class=\"headerlink\" title=\"What\"></a>What</h2><h3 id=\"Shapelet\"><a href=\"#Shapelet\" class=\"headerlink\" title=\"Shapelet\"></a>Shapelet</h3><p>A shapelet is a segment that is representative of a certain class.<br>Shapelet æ˜¯ä¸€æ®µå…·æœ‰ä»£è¡¨æ€§çš„å­åºåˆ—ï¼Œå®ƒå¯ä»¥å°†ä¸€æ¡æ—¶åºæ•°æ®çš„æ‰€æœ‰åˆ†æ®µåˆ†æˆä¸¤ç±»ï¼Œä¸€ç±»ä¸å…¶ç›¸ä¼¼ï¼Œå¦ä¸€ç±»ä¸å…¶ä¸åŒã€‚</p>\n<h3 id=\"Time-aware-shapelet\"><a href=\"#Time-aware-shapelet\" class=\"headerlink\" title=\"Time-aware shapelet\"></a>Time-aware shapelet</h3><p>Time2graph ä¸­æ‰€åˆ›æ–°æ€§æå‡ºçš„åŒ…å«æ—¶é—´ä¿¡æ¯çš„ shapeletï¼Œåˆ©ç”¨å›¾å¯¹å…¶åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„å˜åŒ–è¿›è¡Œæ•æ‰ã€‚</p>\n<h2 id=\"Why\"><a href=\"#Why\" class=\"headerlink\" title=\"Why\"></a>Why</h2><p>ä¼ ç»Ÿçš„ shaplet ä»¥åŠå…¶æ”¹è¿›å½¢å¼éƒ½å¿½ç•¥äº† shapelet åœ¨ä¸åŒçš„æ—¶é—´åŒºé—´ä¸Šçš„è¡¨ç°èƒ½åŠ›ã€‚è¿™é€ æˆä¸¤ç‚¹ä¸è¶³ï¼š</p>\n<ol>\n<li>ç›¸åŒ shapelet åœ¨ä¸åŒæ—¶é—´åŒºé—´ä¸Šçš„å«ä¹‰ä¸åŒã€‚</li>\n<li>shapelet ä¹‹é—´çš„å˜åŒ–å…³ç³»ä¹Ÿè¡¨ç¤ºäº†æ—¶åºæ•°æ®çš„ä¸€äº›ä¿¡æ¯ã€‚</li>\n</ol>\n<h2 id=\"How\"><a href=\"#How\" class=\"headerlink\" title=\"How\"></a>How</h2><h3 id=\"Time-Aware-Shapelet-Extraction\"><a href=\"#Time-Aware-Shapelet-Extraction\" class=\"headerlink\" title=\"Time-Aware Shapelet Extraction\"></a>Time-Aware Shapelet Extraction</h3><p>Time-aware shapelet çš„æŠ½å–å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤</p>\n<ol>\n<li><p>åˆ†æ®µ</p>\n<p> è¿™é‡Œéœ€è¦è¶…å‚æ•°å¦‚ï¼šæ¯ä¸ªåˆ†æ®µçš„é•¿åº¦</p>\n</li>\n<li><p>é€‰å– Candidate</p>\n<p> è¿™ä¸€éƒ¨åˆ†åœ¨è®ºæ–‡ä¸­æ²¡æœ‰å™è¿°ï¼Œä½†é˜…è¯»æºä»£ç åï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œé’ˆå¯¹æ‰€æœ‰åˆ†æ®µåå¾—åˆ°çš„ç‰‡æ®µï¼Œæœ‰ä¸¤ç§æ–¹æ³•ä»ä¸­å¾—åˆ° candidate shapeletã€‚ç¬¬ä¸€ç§æ˜¯é€šè¿‡èšç±»ï¼Œä¾‹å¦‚ K-Meansï¼Œå’Œ DTW ä½œä¸ºè·ç¦»è¿›è¡Œèšç±»ï¼Œç„¶åé€‰å–ç±»ä¸­å¿ƒçš„ç‰‡æ®µä½œä¸º candidateã€‚ç¬¬äºŒç§åˆ™æ˜¯è´ªå©ªçš„æ–¹æ³•ï¼Œå³éå†è®¡ç®—ä¸€ä¸ªç‰‡æ®µä¸å…¶ä»–æ‰€æœ‰ç‰‡æ®µä¹‹é—´çš„è·ç¦»ï¼Œç„¶åé€‰å–å¹³å‡æœ€å°çš„ç‰‡æ®µä½œä¸º candidateã€‚</p>\n</li>\n<li><p>è®¡ç®—è¯„åˆ†</p>\n<p> Time2graph è®¾è®¡äº†æ–°çš„è¯„åˆ†æ–¹æ³•æ¥è¡¡é‡ shapelet åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„é‡è¦åº¦ï¼Œè¿™éƒ¨åˆ†æ¯”è¾ƒå¤æ‚ï¼Œåæ–‡ä¼šè¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚å¯¹æ‰€æœ‰çš„ shapelet candidate æ‰“åˆ†åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€‰å– top-k ä½œä¸ºçœŸæ­£çš„ shapeletã€‚</p>\n</li>\n</ol>\n<h4 id=\"Distance\"><a href=\"#Distance\" class=\"headerlink\" title=\"Distance\"></a>Distance</h4><p>Time2graph è®¾è®¡äº†ä¸¤ä¸ªéœ€è¦è®­ç»ƒçš„å‚æ•°ï¼Œlocal factor <strong>w</strong> å’Œ global factor <strong>u</strong> æ¥åˆ†åˆ«è¡¡é‡ shapelet å†…éƒ¨æ¯ä¸ªå…ƒç´ çš„é‡è¦åº¦ä»¥åŠ shapelet åœ¨ä¸åŒæ—¶é—´æ®µä¸Šçš„é‡è¦åº¦ã€‚</p>\n<p>è®­ç»ƒçš„è¿‡ç¨‹éœ€è¦è¿›è¡Œæ¢¯åº¦ä¸‹é™ï¼ŒæŸå¤±å‡½æ•°å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src=\"/asset/time2graph/loss_function.png\"></p>\n<pre><code>v: shapelet\nT: time series\nSâˆ—(v, T): the set of distances with respect to a specific group Tâˆ—\ng: differentiable function measures the distances between distributions of two finite sets \n</code></pre>\n<p>æœ€åä¸¤é¡¹ä¸º penaltiesã€‚å½“æ¢¯åº¦ä¸‹é™ä½¿å¾—æŸå¤±å‡½æ•°çš„å€¼è¶Šæ¥è¶Šå°æ—¶ï¼Œ<code>w</code> å’Œ <code>u</code> å°±è¶Šæ¥è¶Šå¯ä»¥ä½¿å¾— shapelet åˆ° positive å’Œ negative çš„è·ç¦»ä¹‹å·®è¶Šæ¥è¶Šå¤§ï¼Œè¿™æ · shapelet å°±è¶Šèƒ½ä»£è¡¨ä¸€ä¸ªç±»ã€‚</p>\n<p>æ¥ä¸‹æ¥ï¼Œè¯¦ç»†ä»‹ç»æŸå¤±å‡½æ•°ä¸­æ‰€ç”¨åˆ°çš„ä¸¤ä¸ªè·ç¦»å‡½æ•°ã€‚</p>\n<ol>\n<li>shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»</li>\n</ol>\n<p><img src=\"/asset/time2graph/dist_seg.png\"></p>\n<pre><code>w: local factor éœ€è¦å­¦ä¹ çš„å‚æ•°\nu: global factor éœ€è¦å­¦ä¹ çš„å‚æ•°\ns: segment\na: alignmentï¼Œåˆ©ç”¨ DTW å¯å°†é•¿åº¦ä¸º i çš„ v å’Œé•¿åº¦ä¸º j çš„ s å¯¹é½æˆé•¿åº¦ä¸º p çš„ a1 å’Œ a2\n</code></pre>\n<p>å¯¹äº DTW alignmentï¼Œä¸‹é¢è¿™å¼ å›¾å½¢è±¡åœ°è§£é‡Šäº†æ•´ä¸ªå¯¹é½çš„è¿‡ç¨‹</p>\n<p><img src=\"/asset/time2graph/dtw.png\"></p>\n<p>å¯¹äºåºåˆ— s1 å’Œ s2ï¼Œs1 ä¸­çš„ä¸€ä¸ªç‚¹å¯èƒ½å¯¹åº” s2 ä¸­çš„å¤šä¸ªç‚¹ï¼ŒåŒæ—¶ s2 ä¸­çš„ä¸€ä¸ªç‚¹ä¹Ÿå¯èƒ½å¯¹åº” s1 ä¸­çš„å¤šä¸ªç‚¹ã€‚æ‰€ä»¥ï¼Œä¸¤è€…å¯¹é½åï¼Œä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„é•¿åº¦çš„åºåˆ—ã€‚è€Œ shapelet ä¸ segment çš„è·ç¦»ï¼Œå…¶å®å°±æ˜¯è®¡ç®—ä¸¤è€…å¯¹é½åçš„æ¬§æ°è·ç¦»ã€‚</p>\n<ol start=\"2\">\n<li>shapelet ä¸ time series ä¹‹é—´çš„è·ç¦»</li>\n</ol>\n<p><img src=\"/asset/time2graph/dist_series.png\"></p>\n<p>è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œ<code>d</code> å³ä¸ºåˆšåˆšä»‹ç»çš„ shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»ã€‚shapelet ä¸ time series çš„è·ç¦»å³ä¸ºä¸ time series çš„æ‰€æœ‰åˆ†æ®µä¸­çš„æƒé‡æœ€å°å€¼ã€‚</p>\n<h3 id=\"Shapelet-Evolution-Graph\"><a href=\"#Shapelet-Evolution-Graph\" class=\"headerlink\" title=\"Shapelet Evolution Graph\"></a>Shapelet Evolution Graph</h3><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯è¦æ„å»ºå›¾æ¥è¡¨ç¤º shapelet ä¹‹é—´çš„è½¬ç§»å…³ç³»ã€‚</p>\n<p><img src=\"/asset/time2graph/graph.png\"></p>\n<p>ç®—æ³•å…ˆå°† shapelet ä¸ segment å…³è”èµ·æ¥ï¼Œedge çš„æƒé‡ç”±ä»¥ä¸‹è¿™ä¸ªå…¬å¼è®¡ç®—</p>\n<p><img src=\"/asset/time2graph/edge_weight.png\"></p>\n<p>å…¬å¼è®¡ç®—çš„æ˜¯ shapelet ä¸ segment ç›¸å…³çš„æ¦‚ç‡ï¼Œå¦‚æœ shapelet ä¸ segment ä¹‹é—´çš„è·ç¦»è¶Šè¿‘ï¼Œé‚£ä¹ˆç›¸å…³çš„æ¦‚ç‡è¶Šé«˜ã€‚</p>\n<p>æ¥ä¸‹æ¥ï¼Œç®—æ³•å°†ç›¸é‚»çš„ segment çš„ shapelet è¿æ¥èµ·æ¥ï¼Œè€Œ edge çš„æƒé‡åˆ™æ˜¯å‰åä¸¤ä¸ª segment ä¸å„è‡ª shapelet ä¹‹é—´å…³è”æ¦‚ç‡çš„ä¹˜ç§¯ï¼Œä»£è¡¨äº†ä»å‰ä¸€ä¸ª shapelet è¿ç§»åˆ°åä¸€ä¸ª shapelet çš„æ¦‚ç‡ã€‚</p>\n<p><img src=\"/asset/time2graph/transition.png\"></p>\n<p>æœ€åï¼Œç®—æ³•å°†ä¸€ä¸ª shapelet æ‰€æœ‰è¿ç§»å‡ºå»çš„ edge çš„æƒé‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å…¶å’Œä¸º 1ã€‚</p>\n<p>ç®—æ³•çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤º</p>\n<p><img src=\"/asset/time2graph/graph_algo.png\"></p>\n<h3 id=\"Representation-Learning\"><a href=\"#Representation-Learning\" class=\"headerlink\" title=\"Representation Learning\"></a>Representation Learning</h3><p>æœ€åï¼Œtime2graph é‡‡ç”¨äº† DeepWalk <a href=\"#deepwalk\"><sup>3</sup></a>çš„ç®—æ³•ï¼Œå°† shapelet è½¬æ¢ä¸º embedding çš„å½¢å¼ã€‚</p>\n<p>æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥åˆ©ç”¨ shapelet çš„ embedding æ¥è¡¨ç¤º segment å’Œ time seriesã€‚</p>\n<p>segment çš„å‘é‡åŒ–è¡¨ç¤ºå¦‚ä¸‹é¢è¿™ä¸ªå…¬å¼ï¼Œå°±æ˜¯å…¶ç›¸å…³ shapelet çš„ embedding çš„æ¦‚ç‡æƒé‡å’Œ</p>\n<p><img src=\"/asset/time2graph/segment.png\"></p>\n<p>è€Œ time series çš„å‘é‡åŒ–è¡¨ç¤ºå°±æ˜¯å°†å…¶æ‰€æœ‰ segment çš„ embedding çš„æ‹¼æ¥ã€‚</p>\n<p>ç®—æ³•çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤º</p>\n<p><img src=\"/asset/time2graph/representation.png\"></p>\n<h3 id=\"Apply-Time2graph\"><a href=\"#Apply-Time2graph\" class=\"headerlink\" title=\"Apply Time2graph\"></a>Apply Time2graph</h3><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæ•´çš„äº†è§£äº† time2graph çš„è®­ç»ƒè¿‡ç¨‹ã€‚é‚£ä¹ˆ time2graph çš„åº”ç”¨è¿‡ç¨‹ä¹Ÿä¸ä¹‹ç±»ä¼¼ã€‚</p>\n<p>é¦–å…ˆï¼Œç®—æ³•çš„è¾“å…¥ä»ç„¶æ˜¯ä¸€ä¸ª time seriesã€‚ç®—æ³•ä¼šå…ˆå¯¹å…¶è¿›è¡Œåˆ†æ®µï¼Œç„¶åä¸ºæ¯ä¸ª segment åˆ†é…ç›¸å…³çš„ shapeletã€‚æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥å¾—åˆ° segment å’Œ time series çš„ embeddingï¼Œè¿›è¡Œåç»­èšç±»æˆ–è€…å…¶ä»–æ“ä½œã€‚</p>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><div id=\"shapelet\" />\n- [1] Ye, Lexiang, and Eamonn Keogh. \"Time series shapelets: a new primitive for data mining.\"Â Proceedings of the 15th ACM SIGKDD international conference on Knowledge discovery and data mining. 2009.\n\n<div id=\"time2graph\" />\n- [2] Cheng, Ziqiang, et al. \"Time2graph: Revisiting time series modeling with dynamic shapelets.\"Â Proceedings of the AAAI Conference on Artificial Intelligence. Vol. 34. No. 04. 2020.\n\n<div id=\"deepwalk\" />\n- [3] Perozzi, Bryan, Rami Al-Rfou, and Steven Skiena. \"Deepwalk: Online learning of social representations.\"Â Proceedings of the 20th ACM SIGKDD international conference on Knowledge discovery and data mining. 2014."}],"PostAsset":[],"PostCategory":[],"PostTag":[],"Tag":[]}}